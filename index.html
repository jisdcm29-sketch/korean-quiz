<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Korean Quiz</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#121b2f;
      --card2:#0f172a;
      --text:#e7ecff;
      --muted:#aab6e6;
      --line:rgba(255,255,255,.10);
      --primary:#3b82f6;
      --primary2:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, sans-serif;
      background: radial-gradient(1000px 800px at 30% -10%, rgba(59,130,246,.35), transparent 55%),
                  radial-gradient(900px 700px at 90% 0%, rgba(34,197,94,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
      min-height:100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px 14px 22px;
    }
    .wrap{width:min(520px, 100%);}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hdr{
      padding:18px 18px 10px;
      text-align:center;
    }
    .brand{
      font-size:22px;
      font-weight:800;
      letter-spacing:.2px;
      margin:0 0 6px;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.45;
    }
    .content{padding: 14px 16px 18px;}
    .sectionTitle{
      margin: 6px 0 12px;
      font-size:16px;
      font-weight:800;
      text-align:center;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin: 12px 0;
    }
    label{
      font-size:14px;
      color:var(--muted);
      font-weight:700;
    }
    input, select{
      width:100%;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,15,25,.55);
      color: var(--text);
      padding: 14px 14px;
      font-size:18px;
      outline:none;
    }
    input::placeholder{color: rgba(231,236,255,.45)}
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .btn{
      width:100%;
      border:0;
      border-radius: 18px;
      padding: 15px 14px;
      font-size:20px;
      font-weight:900;
      color:white;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.30);
      transition: transform .06s ease, filter .15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: translateY(1px) scale(.99)}
    .btnPrimary{background: linear-gradient(180deg, #4f8cff, #2563eb);}
    .btnGreen{background: linear-gradient(180deg, #34d399, #16a34a);}
    .btnAmber{background: linear-gradient(180deg, #fbbf24, #f59e0b); color:#1b1406;}
    .btnGhost{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:none;
      color: var(--text);
      font-size:16px;
      padding: 12px 12px;
      border-radius: 16px;
      font-weight:800;
    }
    .note{
      margin: 10px 0 0;
      text-align:center;
      color: var(--muted);
      font-size:13px;
      line-height:1.5;
    }
    .err{
      margin: 10px 0 0;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(239,68,68,.14);
      border:1px solid rgba(239,68,68,.35);
      color: #ffd3d3;
      font-size:14px;
      font-weight:700;
      text-align:center;
      display:none;
    }
    .ok{
      margin: 10px 0 0;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(34,197,94,.14);
      border:1px solid rgba(34,197,94,.35);
      color: #d6ffe6;
      font-size:14px;
      font-weight:800;
      text-align:center;
      display:none;
    }
    .dashTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    .who{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .who .name{
      font-weight:900;
      font-size:16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .who .klass{
      font-size:13px;
      color: var(--muted);
      font-weight:800;
    }
    .gridBtns{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 14px 16px 18px;
    }
    .smallRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 0 16px 16px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:900;
      color: rgba(231,236,255,.85);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      padding: 6px 10px;
      border-radius: 999px;
      gap:8px;
    }
    .footerMini{
      padding: 12px 16px 16px;
      border-top:1px solid var(--line);
      color: rgba(231,236,255,.55);
      font-size:12px;
      text-align:center;
      line-height:1.5;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="app"></div>
  </div>

<script>
(() => {
  // ====== CONFIG (필요 시 여기만 수정) ======
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBe6Y0W3IJKjWV8MLFnR5b9OMePDPHGVACPekJQpvLWRrlayRmHBJCezamKqN9rZg6/exec";
  const PASSWORD = "tae";
  const AUTO_LOGOUT_MIN = 30;

  // 버튼 이동 경로(현재 레포 구조에 맞게 조정 가능)
  const PATHS = {
    SNU: "/korean-quiz/snu/index.html",
    TOPIK1: "/korean-quiz/topik1/index.html",
    TOPIK2: "/korean-quiz/topik2/index.html",
  };

  // ====== Utils ======
  const $app = document.getElementById("app");
  const LS_KEY = "kq_session_v1";
  const DEV_KEY = "kq_deviceId_v1";

  const now = () => Date.now();

  function qs(obj){
    const p = new URLSearchParams();
    Object.keys(obj).forEach(k => {
      if (obj[k] === undefined || obj[k] === null) return;
      p.set(k, String(obj[k]));
    });
    return p.toString();
  }

  function getDeviceId(){
    let id = localStorage.getItem(DEV_KEY);
    if (!id){
      id = "dev_" + Math.random().toString(16).slice(2) + "_" + now().toString(16);
      localStorage.setItem(DEV_KEY, id);
    }
    return id;
  }

  function safeTrim(s){ return (s || "").toString().trim(); }

  function genToken(){
    return "t_" + Math.random().toString(16).slice(2) + "_" + now().toString(16);
  }

  function readSession(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return null;
      const s = JSON.parse(raw);
      if (!s || !s.name || !s.klass || !s.token) return null;
      if (!s.lastActive) s.lastActive = now();
      return s;
    }catch(e){
      return null;
    }
  }

  function writeSession(s){
    localStorage.setItem(LS_KEY, JSON.stringify(s));
  }

  function clearSession(){
    localStorage.removeItem(LS_KEY);
  }

  function updateLastActive(){
    const s = readSession();
    if (!s) return;
    s.lastActive = now();
    writeSession(s);
  }

  function isExpired(s){
    const maxMs = AUTO_LOGOUT_MIN * 60 * 1000;
    return (now() - (s.lastActive || 0)) > maxMs;
  }

  function buildUrlWithParams(basePath, params){
    const u = new URL(basePath, location.origin);
    Object.keys(params).forEach(k => u.searchParams.set(k, params[k]));
    return u.toString();
  }

  // JSONP helper
  function jsonp(url, params, timeoutMs = 8000){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const timer = setTimeout(() => {
        cleanup();
        reject(new Error("JSONP timeout"));
      }, timeoutMs);

      function cleanup(){
        clearTimeout(timer);
        try{ delete window[cb]; }catch(e){}
        if (script && script.parentNode) script.parentNode.removeChild(script);
      }

      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };

      const full = url + (url.includes("?") ? "&" : "?") + qs({...params, callback: cb});
      const script = document.createElement("script");
      script.src = full;
      script.async = true;
      script.onerror = () => {
        cleanup();
        reject(new Error("JSONP network error"));
      };
      document.head.appendChild(script);
    });
  }

  async function sendLoginLog(session){
    // 권한 제거(모두 사용) 정책이므로, 로그인 자체를 "시도 기록"으로 남김.
    // Apps Script가 token 검증을 하더라도 최소한의 필드로 전송(실패해도 앱 진행).
    const payload = {
      action: "log",
      token: session.token,
      deviceId: getDeviceId(),
      klass: session.klass,
      name: session.name,
      book: "LOGIN",
      lesson: "index",
      score: 0,
      attempts: 0,
      ua: navigator.userAgent || ""
    };
    try{
      await jsonp(SCRIPT_URL, payload, 8000);
      return true;
    }catch(e){
      return false;
    }
  }

  // ====== UI Render ======
  function renderLogin(){
    $app.innerHTML = `
      <div class="hdr">
        <p class="brand">Korean Quiz</p>
        <p class="sub">비밀번호 입력 후 시작합니다</p>
      </div>
      <div class="content">
        <div class="sectionTitle">로그인</div>

        <div class="field">
          <label for="pw">비밀번호</label>
          <input id="pw" type="password" inputmode="text" autocomplete="off" placeholder="tae" />
        </div>

        <div class="field">
          <label for="name">이름</label>
          <input id="name" type="text" inputmode="text" autocomplete="name" placeholder="예: 바트" />
        </div>

        <div class="field">
          <label for="klass">반 선택</label>
          <select id="klass">
            <option value="BBTA1반">BBTA1반</option>
            <option value="EKO1반">EKO1반</option>
            <option value="EKO2반">EKO2반</option>
            <option value="토픽반">토픽반</option>
            <option value="기타반">기타반</option>
          </select>
        </div>

        <button class="btn btnPrimary" id="btnLogin">로그인</button>
        <div class="err" id="err"></div>
        <div class="ok" id="ok"></div>

        <p class="note">
          로그인 후 <b>서울대 / TOPIK1 / TOPIK2</b>를 선택할 수 있습니다.<br/>
          <span class="pill">자동 로그아웃 ${AUTO_LOGOUT_MIN}분</span>
        </p>
      </div>
      <div class="footerMini">
        <span class="mono">device</span>는 자동 생성되어 기록됩니다.
      </div>
    `;

    const $pw = document.getElementById("pw");
    const $name = document.getElementById("name");
    const $klass = document.getElementById("klass");
    const $err = document.getElementById("err");
    const $ok = document.getElementById("ok");
    const $btn = document.getElementById("btnLogin");

    function showErr(msg){
      $ok.style.display = "none";
      $err.textContent = msg;
      $err.style.display = "block";
    }
    function showOk(msg){
      $err.style.display = "none";
      $ok.textContent = msg;
      $ok.style.display = "block";
    }

    async function doLogin(){
      const pw = safeTrim($pw.value);
      const name = safeTrim($name.value);
      const klass = safeTrim($klass.value);

      if (pw !== PASSWORD) return showErr("비밀번호가 틀렸습니다.");
      if (!name) return showErr("이름을 입력해 주세요.");
      if (!klass) return showErr("반을 선택해 주세요.");

      const session = {
        name,
        klass,
        token: genToken(),
        deviceId: getDeviceId(),
        lastActive: now(),
        loginAt: now()
      };
      writeSession(session);

      showOk("로그인 기록 저장 중…");
      const ok = await sendLoginLog(session);
      showOk(ok ? "로그인 완료! 선택 화면으로 이동합니다." : "로그인 완료! (기록 전송은 네트워크 상황에 따라 실패할 수 있어요)");

      setTimeout(() => renderDashboard(), 350);
    }

    $btn.addEventListener("click", doLogin);
    $pw.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
    $name.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
  }

  function renderDashboard(){
    const s = readSession();
    if (!s) return renderLogin();
    if (isExpired(s)){
      clearSession();
      return renderLogin();
    }

    $app.innerHTML = `
      <div class="dashTop">
        <div class="who">
          <div class="name">${escapeHtml(s.name)}</div>
          <div class="klass">${escapeHtml(s.klass)} · <span class="mono">${AUTO_LOGOUT_MIN}m</span> auto</div>
        </div>
        <button class="btn btnGhost" id="btnLogout">로그아웃</button>
      </div>

      <div class="hdr" style="padding-top:14px">
        <p class="brand" style="margin-bottom:4px">선택</p>
        <p class="sub">아래에서 학습을 선택하세요</p>
      </div>

      <div class="gridBtns">
        <button class="btn btnPrimary" id="goSnu">서울대</button>
        <button class="btn btnGreen" id="goTopik1">TOPIK 1</button>
        <button class="btn btnAmber" id="goTopik2">TOPIK 2</button>
      </div>

      <div class="smallRow">
        <div class="pill"><span>이름</span><b>${escapeHtml(s.name)}</b></div>
        <div class="pill"><span>반</span><b>${escapeHtml(s.klass)}</b></div>
      </div>

      <div class="footerMini">
        이동 시 <span class="mono">name/klass/token</span> 파라미터가 자동으로 전달됩니다.
      </div>
    `;

    document.getElementById("btnLogout").addEventListener("click", () => {
      clearSession();
      renderLogin();
    });

    document.getElementById("goSnu").addEventListener("click", () => nav(PATHS.SNU));
    document.getElementById("goTopik1").addEventListener("click", () => nav(PATHS.TOPIK1));
    document.getElementById("goTopik2").addEventListener("click", () => nav(PATHS.TOPIK2));

    function nav(path){
      updateLastActive();
      const ss = readSession();
      const url = buildUrlWithParams(path, {
        name: ss.name,
        klass: ss.klass,
        token: ss.token
      });
      location.href = url;
    }
  }

  function escapeHtml(str){
    return (str||"").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // ====== Auto logout by inactivity ======
  let inactivityTimer = null;
  const activityEvents = ["pointerdown","pointermove","keydown","scroll","touchstart","click"];

  function resetInactivity(){
    const s = readSession();
    if (!s) return;
    updateLastActive();
    if (inactivityTimer) clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
      // 만료되면 즉시 로그아웃
      const ss = readSession();
      if (ss && isExpired(ss)){
        clearSession();
        renderLogin();
      }
    }, (AUTO_LOGOUT_MIN * 60 * 1000) + 500);
  }

  activityEvents.forEach(evt => {
    window.addEventListener(evt, () => {
      const s = readSession();
      if (!s) return;
      resetInactivity();
    }, {passive:true});
  });

  // 추가 안전: 주기적 만료 체크
  setInterval(() => {
    const s = readSession();
    if (!s) return;
    if (isExpired(s)){
      clearSession();
      renderLogin();
    }
  }, 10_000);

  // ====== Boot ======
  const s = readSession();
  if (s && !isExpired(s)){
    resetInactivity();
    renderDashboard();
  }else{
    clearSession();
    renderLogin();
  }
})();
</script>
</body>
</html>
