<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Үгийн сангийн тест</title>

  <style>
    :root{
      --bg:#f0f4f8; --card:#ffffff; --primary:#2d6cdf; --primary2:#1f4ea5;
      --text:#223047; --muted:#6a7a8e; --line:#d9e4f5;
      --warnbg:#fff5f5; --warnline:#feb2b2;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:20px; font-family:Arial,sans-serif; background:var(--bg); color:var(--text); text-align:center;}
    .container{max-width:820px; margin:0 auto; background:var(--card); padding:26px; border-radius:20px; border:1px solid var(--line); box-shadow:0 10px 20px rgba(0,0,0,0.08);}
    h1{margin:0; font-size:24px; color:#1f2f45;}
    .sub{margin:10px 0 0; color:var(--muted); font-size:15px; line-height:1.45;}
    input{width:92%; padding:14px; margin:10px 0; border:2px solid #e0e0e0; border-radius:12px; font-size:18px; text-align:center; outline:none;}
    input:focus{border-color:#b7cdfd; box-shadow:0 0 0 4px rgba(45,108,223,0.12);}
    .btn{width:100%; background:var(--primary); color:#fff; padding:15px 16px; border:none; border-radius:12px; cursor:pointer; font-size:18px; font-weight:900; transition:.2s;}
    .btn:hover{background:var(--primary2);}
    .btn-gray{background:#eef2f7; color:#2c3e50; border:1px solid #d7dee7;}
    .btn-gray:hover{background:#e2e8f0;}
    .topbar{display:flex; gap:10px; margin-top:14px;}
    .topbar .btn{width:33.33%;}
    .panel{margin-top:16px; padding:14px; border:1px solid var(--line); border-radius:14px; background:#fff; text-align:left;}
    .grid{display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; margin-top:12px;}
    @media (max-width:560px){ .grid{grid-template-columns:1fr;} }
    .cardBtn{
      width:100%; background:#fff; color:var(--text);
      border:2px solid var(--primary); border-radius:12px;
      padding:14px; font-size:18px; font-weight:900; cursor:pointer;
      transition:.15s; text-align:center;
    }
    .cardBtn:hover{background:var(--primary); color:#fff; transform:translateY(-1px);}
    .meta{margin-top:10px; color:var(--muted); font-size:13px; line-height:1.45;}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #d7dee7; background:#f6f9ff; font-size:12px; color:#2c3e50; font-weight:900;}
    .warn{margin-top:14px; background:var(--warnbg); border:1px solid var(--warnline); border-radius:12px; padding:12px; color:#7a1f1f; font-size:14px; line-height:1.45;}
    .ok{color:#0f7a3d; font-weight:900;}
    .crumb{margin-top:12px; color:#4b5b6f; font-size:14px;}
    .crumb b{color:#1f2f45;}
    .hidden{display:none;}
  </style>
</head>

<body>
<div class="container">

  <!-- 0) Нэвтрэх -->
  <div id="scr-login">
    <h1>Үгийн сангийн тест</h1>
    <p class="sub">Нууц үг ба нэрээ оруулна уу. Дараа нь дахин асуухгүй.</p>

    <input id="pinInput" type="password" placeholder="Нууц үг" />
    <input id="nameInput" type="text" placeholder="Таны нэр" autocomplete="name" />

    <div class="topbar" style="margin-top:10px;">
      <button class="btn btn-gray" onclick="clearSaved()">Цэвэрлэх</button>
      <button class="btn btn-gray" onclick="prefillFromStorage()">Сэргээх</button>
      <button class="btn" onclick="login()">Орох</button>
    </div>

    <div class="meta" id="loginHint">Жич: КакаоТок холбоос дээр <b>?v=1</b> нэмбэл кэш багасна.</div>
  </div>

  <!-- 1) Ангилал -->
  <div id="scr-cat" class="hidden">
    <h1>Ангилал сонгох</h1>
    <p class="sub">Дараагийн алхмыг сонгоно уу.</p>

    <div class="topbar">
      <button class="btn btn-gray" onclick="logout()">Гарах</button>
      <button class="btn btn-gray" onclick="reloadFiles()">Дахин унших</button>
      <button class="btn" onclick="startFirst()">Эхний хичээл</button>
    </div>

    <div class="panel">
      <div style="font-weight:900; color:#1f2f45;">Сонголт</div>
      <div class="grid" style="margin-top:12px;">
        <button class="cardBtn" onclick="goSnuBooks()">Сурах бичиг</button>
        <button class="cardBtn" onclick="goTopikLevels()">TOPIK</button>
      </div>
      <div class="meta" id="statusText">Файлуудыг уншиж байна...</div>
      <div class="warn hidden" id="warnBox"></div>
    </div>
  </div>

  <!-- 2) Сурах бичиг: ном -->
  <div id="scr-snu" class="hidden">
    <h1>Сурах бичиг</h1>
    <p class="sub">Номоо сонгоно уу. (1A, 1B, 2A, 2B ...)</p>

    <div class="topbar">
      <button class="btn btn-gray" onclick="goCat()">Буцах</button>
      <button class="btn btn-gray" onclick="reloadFiles()">Дахин унших</button>
      <button class="btn" onclick="startFirst()">Эхний хичээл</button>
    </div>

    <div class="panel">
      <div style="font-weight:900; color:#1f2f45;">Олдсон номууд: <span class="tag" id="snuBookCount">0</span></div>
      <div class="meta" id="snuStatus">Бэлэн.</div>
      <div class="grid" id="snuBookGrid"></div>
      <div class="warn hidden" id="snuWarn"></div>
    </div>
  </div>

  <!-- 3) TOPIK: 1/2 -->
  <div id="scr-topik" class="hidden">
    <h1>TOPIK</h1>
    <p class="sub">Түвшнээ сонгоно уу.</p>

    <div class="topbar">
      <button class="btn btn-gray" onclick="goCat()">Буцах</button>
      <button class="btn btn-gray" onclick="reloadFiles()">Дахин унших</button>
      <button class="btn" onclick="startFirst()">Эхний хичээл</button>
    </div>

    <div class="panel">
      <div style="font-weight:900; color:#1f2f45;">Сонголт</div>
      <div class="grid" style="margin-top:12px;">
        <button class="cardBtn" onclick="goTopikLessons('TOPIK1')">TOPIK 1</button>
        <button class="cardBtn" onclick="goTopikLessons('TOPIK2')">TOPIK 2</button>
      </div>
      <div class="meta" id="topikStatus">Бэлэн.</div>
      <div class="warn hidden" id="topikWarn"></div>
    </div>
  </div>

  <!-- 4) Хичээл -->
  <div id="scr-lessons" class="hidden">
    <h1>Хичээл сонгох</h1>
    <p class="sub">Сонгосон бүлгийн хичээлүүд</p>

    <div class="topbar">
      <button class="btn btn-gray" onclick="backFromLessons()">Буцах</button>
      <button class="btn btn-gray" onclick="reloadFiles()">Дахин унших</button>
      <button class="btn" onclick="startFirst()">Эхний хичээл</button>
    </div>

    <div class="crumb" id="crumb"></div>

    <div class="panel">
      <div style="font-weight:900; color:#1f2f45;">Олдсон хичээлүүд: <span class="tag" id="lessonCount">0</span></div>
      <div class="meta" id="lessonStatus">Бэлэн.</div>
      <div class="grid" id="lessonGrid"></div>
      <div class="warn hidden" id="lessonWarn"></div>
    </div>
  </div>

</div>

<script>
/* ✅ 사장님 설정 */
const CORRECT_PASSWORD = "sejong123";
const LESSON_DIR = ""; // 예: "lessons"

/* 파일명 규칙
   - 서울대: SNU-1A-lesson01.html
   - TOPIK: TOPIK1-lesson01.html / TOPIK2-lesson01.html
*/
const RE_SNU   = /^SNU-([0-9]+[A-Za-z])-lesson(\d{1,3})\.html$/i;
const RE_TOPIK = /^TOPIK([12])-lesson(\d{1,3})\.html$/i;

const KEY_AUTH = "kq_auth_v2"; // {ok:true, name:"...", ts:...}

const scrLogin = document.getElementById("scr-login");
const scrCat = document.getElementById("scr-cat");
const scrSnu = document.getElementById("scr-snu");
const scrTopik = document.getElementById("scr-topik");
const scrLessons = document.getElementById("scr-lessons");

const pinInput = document.getElementById("pinInput");
const nameInput = document.getElementById("nameInput");

const statusText = document.getElementById("statusText");
const warnBox = document.getElementById("warnBox");

const snuBookCount = document.getElementById("snuBookCount");
const snuStatus = document.getElementById("snuStatus");
const snuBookGrid = document.getElementById("snuBookGrid");
const snuWarn = document.getElementById("snuWarn");

const topikStatus = document.getElementById("topikStatus");
const topikWarn = document.getElementById("topikWarn");

const crumb = document.getElementById("crumb");
const lessonCount = document.getElementById("lessonCount");
const lessonStatus = document.getElementById("lessonStatus");
const lessonGrid = document.getElementById("lessonGrid");
const lessonWarn = document.getElementById("lessonWarn");

function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }

function lessonPathPrefix(){
  if (!LESSON_DIR) return "";
  return LESSON_DIR.replace(/\/+$/,"") + "/";
}

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
}

function getRepoInfo(){
  const host = location.hostname;
  if (!host.endsWith(".github.io")) return null;
  const owner = host.replace(".github.io","");
  const parts = location.pathname.split("/").filter(Boolean);
  if (parts.length === 0) return {owner, repo: owner + ".github.io"};
  return {owner, repo: parts[0]};
}

/* ✅ 로그인 상태: 한 번만 입력하고 저장 */
function setAuth(name){
  localStorage.setItem(KEY_AUTH, JSON.stringify({ok:true, name, ts: Date.now()}));
}
function getAuth(){
  try{
    const v = JSON.parse(localStorage.getItem(KEY_AUTH) || "null");
    if (v && v.ok && typeof v.name === "string" && v.name.trim()) return v;
  }catch(e){}
  return null;
}
function clearAuth(){
  localStorage.removeItem(KEY_AUTH);
}

function prefillFromStorage(){
  const a = getAuth();
  if (a){
    nameInput.value = a.name;
  }
}

function clearSaved(){
  pinInput.value = "";
  nameInput.value = "";
  clearAuth();
  alert("Цэвэрлэлээ.");
}

function logout(){
  clearAuth();
  goLogin();
}

function goLogin(){ hide(scrCat); hide(scrSnu); hide(scrTopik); hide(scrLessons); show(scrLogin); }
function goCat(){ hide(scrLogin); hide(scrSnu); hide(scrTopik); hide(scrLessons); show(scrCat); }
function goSnuBooks(){
  lastScreenBeforeLessons = "SNU";
  hide(scrLogin); hide(scrCat); hide(scrTopik); hide(scrLessons);
  show(scrSnu); renderSnuBooks();
}
function goTopikLevels(){
  lastScreenBeforeLessons = "TOPIK";
  hide(scrLogin); hide(scrCat); hide(scrSnu); hide(scrLessons);
  show(scrTopik); renderTopikInfo();
}
function backFromLessons(){
  hide(scrLessons);
  if (lastScreenBeforeLessons === "SNU") show(scrSnu);
  else if (lastScreenBeforeLessons === "TOPIK") show(scrTopik);
  else show(scrCat);
}

function ensureAuthOrKick(){
  const a = getAuth();
  if (!a) { goLogin(); return null; }
  return a;
}

function login(){
  const pw = (pinInput.value || "").trim();
  const nm = (nameInput.value || "").trim();

  if (!pw || !nm){ alert("Нууц үг ба нэрээ оруулна уу!"); return; }
  if (pw !== CORRECT_PASSWORD){ alert("Нууц үг буруу байна!"); return; }

  setAuth(nm);
  goCat();
  reloadFiles();
}

/* 파일 파싱 */
let parsed = { SNU: [], TOPIK1: [], TOPIK2: [] };
let snuBooks = [];
let currentGroup = null;
let lastScreenBeforeLessons = "CAT";

async function fetchContents(){
  const info = getRepoInfo();
  if (!info) throw new Error("github.io домэйн биш байна.");
  const dir = LESSON_DIR ? LESSON_DIR.replace(/^\/+|\/+$/g,"") : "";
  const apiUrl = `https://api.github.com/repos/${info.owner}/${info.repo}/contents/${encodeURIComponent(dir)}`;
  const res = await fetch(apiUrl, { cache:"no-store" });
  if (!res.ok) throw new Error("GitHub API уншиж чадсангүй. (" + res.status + ")");
  const data = await res.json();
  if (!Array.isArray(data)) throw new Error("Файлын жагсаалт буруу байна.");
  return data;
}

function parseFiles(items){
  const out = { SNU: [], TOPIK1: [], TOPIK2: [] };
  items.forEach(it=>{
    if (!it || it.type !== "file" || typeof it.name !== "string") return;
    const name = it.name;
    if (!name.toLowerCase().endsWith(".html")) return;
    if (name.toLowerCase() === "index.html") return;
    if (name.toLowerCase() === "404.html") return;

    let m = name.match(RE_SNU);
    if (m){ out.SNU.push({file:name, book:m[1].toUpperCase(), num:parseInt(m[2],10)}); return; }

    m = name.match(RE_TOPIK);
    if (m){
      const level = (m[1] === "1") ? "TOPIK1" : "TOPIK2";
      out[level].push({file:name, level, num:parseInt(m[2],10)});
      return;
    }
  });
  out.SNU.sort((a,b)=> a.book.localeCompare(b.book) || (a.num-b.num));
  out.TOPIK1.sort((a,b)=> a.num-b.num);
  out.TOPIK2.sort((a,b)=> a.num-b.num);
  return out;
}

function renderSnuBooks(){
  const set = new Set(parsed.SNU.map(x=>x.book));
  snuBooks = Array.from(set).sort((a,b)=> a.localeCompare(b));
  snuBookGrid.innerHTML = "";
  snuBookCount.textContent = String(snuBooks.length);
  snuWarn.classList.add("hidden");

  if (snuBooks.length === 0){
    snuStatus.textContent = "Ном олдсонгүй.";
    snuWarn.innerHTML =
      `<b>Анхаар!</b><br>Файл нэрийн дүрмийг шалгана уу.<br><br>`+
      `Жишээ: SNU-1A-lesson01.html`;
    snuWarn.classList.remove("hidden");
    return;
  }

  snuStatus.innerHTML = `<span class="ok">Бэлэн.</span> Номоо сонгоно уу.`;
  snuBooks.forEach(book=>{
    const btn = document.createElement("button");
    btn.className = "cardBtn";
    btn.textContent = book;
    btn.onclick = ()=> { currentGroup={type:"SNU_BOOK", book}; lastScreenBeforeLessons="SNU"; showLessons(); };
    snuBookGrid.appendChild(btn);
  });
}

function renderTopikInfo(){
  topikWarn.classList.add("hidden");
  topikStatus.innerHTML = `<span class="ok">Бэлэн.</span> TOPIK 1: ${parsed.TOPIK1.length} · TOPIK 2: ${parsed.TOPIK2.length}`;
}

function goTopikLessons(level){
  currentGroup = {type:"TOPIK", level};
  lastScreenBeforeLessons = "TOPIK";
  showLessons();
}

function showLessons(){
  const auth = ensureAuthOrKick();
  if (!auth) return;

  hide(scrLogin); hide(scrCat); hide(scrSnu); hide(scrTopik);
  show(scrLessons);

  lessonGrid.innerHTML = "";
  lessonWarn.classList.add("hidden");

  let list = [];
  let title = "";

  if (currentGroup.type === "SNU_BOOK"){
    list = parsed.SNU.filter(x=>x.book===currentGroup.book).sort((a,b)=>a.num-b.num);
    title = `Сурах бичиг · ${currentGroup.book}`;
  } else {
    list = parsed[currentGroup.level].slice().sort((a,b)=>a.num-b.num);
    title = `TOPIK · ${currentGroup.level==="TOPIK1" ? "1" : "2"}`;
  }

  crumb.innerHTML = `Сонголт: <b>${escapeHtml(title)}</b> · Нэр: <b>${escapeHtml(auth.name)}</b>`;
  lessonCount.textContent = String(list.length);

  if (list.length === 0){
    lessonStatus.textContent = "Хичээл олдсонгүй.";
    lessonWarn.textContent = "Файл нэрийн дүрмийг шалгана уу.";
    lessonWarn.classList.remove("hidden");
    return;
  }

  lessonStatus.innerHTML = `<span class="ok">Бэлэн.</span> Хичээлээ сонгоно уу.`;
  list.forEach(item=>{
    const btn = document.createElement("button");
    btn.className = "cardBtn";
    btn.textContent = `${item.num}-р хичээл`;
    btn.onclick = ()=> openLesson(item.file);
    lessonGrid.appendChild(btn);
  });
}

function openLesson(fileName){
  const auth = ensureAuthOrKick();
  if (!auth) return;

  const prefix = lessonPathPrefix();
  const group = currentGroup.type === "SNU_BOOK" ? `SNU-${currentGroup.book}` : currentGroup.level;
  const url = `${prefix}${fileName}?name=${encodeURIComponent(auth.name)}&group=${encodeURIComponent(group)}&v=${Date.now()}`;
  location.href = url;
}

function startFirst(){
  const auth = ensureAuthOrKick();
  if (!auth) return;

  // 현재 그룹 첫 과
  if (currentGroup){
    let first = null;
    if (currentGroup.type === "SNU_BOOK"){
      first = parsed.SNU.filter(x=>x.book===currentGroup.book).sort((a,b)=>a.num-b.num)[0];
    } else {
      first = parsed[currentGroup.level].slice().sort((a,b)=>a.num-b.num)[0];
    }
    if (first){ openLesson(first.file); return; }
  }

  // 전체 첫 과
  const firstSnu = parsed.SNU[0];
  if (firstSnu){
    currentGroup = {type:"SNU_BOOK", book:firstSnu.book};
    lastScreenBeforeLessons = "SNU";
    openLesson(firstSnu.file);
    return;
  }
  const firstT1 = parsed.TOPIK1[0];
  if (firstT1){
    currentGroup = {type:"TOPIK", level:"TOPIK1"};
    lastScreenBeforeLessons = "TOPIK";
    openLesson(firstT1.file);
    return;
  }
  const firstT2 = parsed.TOPIK2[0];
  if (firstT2){
    currentGroup = {type:"TOPIK", level:"TOPIK2"};
    lastScreenBeforeLessons = "TOPIK";
    openLesson(firstT2.file);
    return;
  }

  alert("Хичээл олдсонгүй.");
}

async function reloadFiles(){
  const auth = getAuth();
  if (!auth) { goLogin(); return; }

  statusText.textContent = "Файлуудыг уншиж байна...";
  warnBox.classList.add("hidden");

  try{
    const items = await fetchContents();
    parsed = parseFiles(items);
    const total = parsed.SNU.length + parsed.TOPIK1.length + parsed.TOPIK2.length;
    statusText.innerHTML = `<span class="ok">Бэлэн.</span> Нийт: ${total} файл`;
  }catch(err){
    statusText.textContent = "Алдаа гарлаа.";
    warnBox.textContent = String(err && err.message ? err.message : err);
    warnBox.classList.remove("hidden");
  }
}

/* 초기 진입: 저장된 이름이 있으면 바로 카테고리 화면 */
(function init(){
  const auth = getAuth();
  if (auth){
    goCat();
    reloadFiles();
  } else {
    goLogin();
  }
})();
</script>
</body>
</html>
