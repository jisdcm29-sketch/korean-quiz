<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Сургалтын тест · Korean Quiz</title>

  <!-- ✅ OG (공유 미리보기) -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Сургалтын тест · Korean Quiz">
  <meta property="og:description" content="Нууц үг, нэр, ангиа оруулаад тестээ эхлүүлнэ үү.">
  <meta property="og:url" content="https://jisdcm29-sketch.github.io/korean-quiz/">
  <meta property="og:image" content="https://jisdcm29-sketch.github.io/korean-quiz/og.png">
  <meta name="twitter:card" content="summary_large_image">

  <style>
    :root{
      --bg:#f0f4f8; --card:#fff; --primary:#2d6cdf; --primary2:#1f4ea5; --line:#d9e4f5;
      --text:#223047; --muted:#6a7a8e; --ok:#0f7a3d;
      --warnbg:#fff5f5; --warnline:#feb2b2; --warntext:#7a1f1f;
      --okbg:#f0fff4; --okline:#b7f0c7; --oktext:#0f7a3d;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:20px; background:var(--bg); font-family:Arial,sans-serif; text-align:center; color:var(--text);}
    .container{max-width:560px; margin:0 auto; background:var(--card); padding:26px; border-radius:20px; border:1px solid var(--line); box-shadow:0 10px 20px rgba(0,0,0,0.08);}
    h1{margin:0; font-size:22px;}
    .sub{margin:10px 0 0; color:var(--muted); font-size:14px; line-height:1.45;}

    input{
      width:100%; padding:14px 12px; margin-top:12px;
      border:2px solid #d7dee7; border-radius:12px;
      font-size:16px; text-align:center;
    }

    .btn{
      width:100%; padding:14px 12px; margin-top:12px;
      border:none; border-radius:12px;
      background:var(--primary); color:#fff;
      font-size:16px; font-weight:900; cursor:pointer;
      transition:.2s;
    }
    .btn:hover{background:var(--primary2);}
    .btnGray{background:#eef2f7; color:#223047; border:1px solid #d7dee7;}
    .btnGray:hover{background:#e2e8f0;}

    .grid{display:grid; gap:10px; margin-top:16px;}

    /* ✅ 레벨(1A~4B) : 기본 2열 */
    .grid2{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:14px;
      margin-top:16px;
    }
    @media (max-width:340px){
      .grid2{ grid-template-columns:1fr; }
    }

    .cardBtn{
      padding:16px 12px; border-radius:14px;
      border:2px solid var(--primary); background:#fff;
      font-weight:900; cursor:pointer;
      transition:.15s;
      user-select:none;
    }
    .cardBtn:hover{background:var(--primary); color:#fff;}
    .cardOk{border-color:var(--ok);}
    .cardOk:hover{background:var(--ok); color:#fff;}

    /* ✅ 반 선택: 버튼형 2열 */
    .klassGrid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:14px;
      margin-top:12px;
    }
    @media (max-width:340px){
      .klassGrid{ grid-template-columns:1fr; }
    }
    .klassBtn{
      width:100%;
      padding:16px 12px;
      border-radius:14px;
      border:2px solid #d7dee7;
      background:#fff;
      font-weight:900;
      cursor:pointer;
      transition:.15s;
      user-select:none;
    }
    .klassBtn:hover{ border-color: var(--primary); }
    .klassBtn.active{
      border-color: var(--primary);
      background: var(--primary);
      color:#fff;
    }

    .hidden{display:none;}

    .warn{
      margin-top:14px; padding:12px; border-radius:12px;
      background:var(--warnbg); border:1px solid var(--warnline);
      color:var(--warntext); font-size:14px; line-height:1.45; text-align:left;
      white-space:pre-line;
    }
    .okbox{
      margin-top:14px; padding:12px; border-radius:12px;
      background:var(--okbg); border:1px solid var(--okline);
      color:var(--oktext); font-size:14px; line-height:1.45; text-align:left;
      white-space:pre-line;
    }
    .tiny{font-size:12px; color:var(--muted); margin-top:8px; text-align:left;}
    .rowTop{display:flex; gap:10px; margin-top:12px;}
    .rowTop .btn{margin-top:0;}
  </style>
</head>

<body>
<div class="container" id="app">
  <h1>Сургалтын тест</h1>
  <p class="sub">Нууц үг, нэр, ангиа оруулаад үргэлжлүүлнэ үү.</p>

  <!-- Step 1: Login -->
  <div id="step1">
    <!-- (요청) 상단 Messenger 안내 박스 + 링크 버튼 삭제 유지 -->

    <input id="pass" type="password" placeholder="Нууц үг"/>
    <input id="name" type="text" placeholder="Таны нэр"/>

    <!-- 반 선택: 버튼형 -->
    <input id="klass" type="hidden" value="" />
    <div id="klassGrid" class="klassGrid"></div>

    <button class="btn" onclick="login()">Үргэлжлүүлэх</button>

    <div class="tiny">
      Safari/Chrome дээр нээвэл илүү тогтвортой ажиллана.
    </div>
  </div>

  <!-- Step 2: Word / Grammar -->
  <div id="step2" class="hidden">
    <div class="rowTop">
      <button class="btn btnGray" style="flex:1" onclick="backToLogin()">Буцах</button>
      <button class="btn btnGray" style="flex:1" onclick="logout()">Гарах</button>
    </div>

    <p class="sub" style="margin-top:16px;">Тестийн төрлөө сонгоно уу.</p>
    <div class="grid">
      <div class="cardBtn" onclick="selectType('WORD')">Үг</div>
      <div class="cardBtn cardOk" onclick="selectType('GRAMMAR')">Дүрэм</div>
    </div>
  </div>

  <!-- Step 3: WORD main -->
  <div id="stepWordMain" class="hidden">
    <p class="sub" style="margin-top:16px;">Төрөл сонгоно уу.</p>
    <div class="grid">
      <div class="cardBtn" onclick="selectWordMain('SNU')">SNU</div>
      <div class="cardBtn" onclick="selectWordMain('TOPIK')">TOPIK</div>
    </div>
    <button class="btn btnGray" onclick="backToType()">Буцах</button>
  </div>

  <!-- Step: SNU level (1A~4B) -->
  <div id="stepSnu" class="hidden">
    <p class="sub" style="margin-top:16px;">Түвшнээ сонгоно уу.</p>
    <div class="grid2">
      <div class="cardBtn" onclick="goWordHub('SNU','1A')">1A</div>
      <div class="cardBtn" onclick="goWordHub('SNU','1B')">1B</div>
      <div class="cardBtn" onclick="goWordHub('SNU','2A')">2A</div>
      <div class="cardBtn" onclick="goWordHub('SNU','2B')">2B</div>
      <div class="cardBtn" onclick="goWordHub('SNU','3A')">3A</div>
      <div class="cardBtn" onclick="goWordHub('SNU','3B')">3B</div>
      <div class="cardBtn" onclick="goWordHub('SNU','4A')">4A</div>
      <div class="cardBtn" onclick="goWordHub('SNU','4B')">4B</div>
    </div>
    <button class="btn btnGray" onclick="backToWordMain()">Буцах</button>
  </div>

  <!-- Step: TOPIK -->
  <div id="stepTopik" class="hidden">
    <p class="sub" style="margin-top:16px;">TOPIK түвшин сонгоно уу.</p>
    <div class="grid">
      <div class="cardBtn" onclick="goWordHub('TOPIK','1')">TOPIK 1</div>
      <div class="cardBtn" onclick="goWordHub('TOPIK','2')">TOPIK 2</div>
    </div>
    <button class="btn btnGray" onclick="backToWordMain()">Буцах</button>
  </div>

  <!-- Step: GRAMMAR -->
  <div id="stepGrammar" class="hidden">
    <p class="sub" style="margin-top:16px;">Дүрмийн тест рүү орно.</p>
    <div class="okbox">
      ✅ Бэлэн. Доорх товчийг дарна уу.\n
      Нэр/анги/token автоматаар дамжина.
    </div>
    <button class="btn" style="background:var(--ok);" onclick="goGrammarHub()">Дүрэм рүү орох</button>
    <button class="btn btnGray" onclick="backToType()">Буцах</button>
  </div>

  <div id="warn" class="warn hidden"></div>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby_n5xrEIRduxeo2upw4D0nsishR6zwBOY5JO472-7wU3EAYip94-4BncYw5r7dWHj6/exec";

  // ✅ 반 목록: 여기만 수정하면 됨
  const KLASS_OPTIONS = [
  { value:"BBTA1반", label:"BBTA1반" },
  { value:"EKO2반", label:"EKO2반" },
  { value:"EKO1반", label:"EKO1반" },
];


  // ✅ 로그인 유지 키
  const STORAGE_KEY = "kquiz_state_v2";
  const SESSION_KEY = "kquiz_state_v2_session";
  const STATE_TTL_MS = 8 * 60 * 60 * 1000; // 8시간 (원하면 늘려도 됨)

  let STATE = { pass:"", name:"", klass:"", deviceId:"", token:"", ts:0 };

  function $(id){ return document.getElementById(id); }

  function scrollToTop(){
    const app = $("app");
    if(app) app.scrollIntoView({ behavior: "smooth", block: "start" });
    else window.scrollTo({ top:0, behavior:"smooth" });
  }

  function showWarn(msg){
    const w = $("warn");
    w.textContent = msg;
    w.classList.remove("hidden");
  }
  function clearWarn(){
    const w = $("warn");
    if(w) w.classList.add("hidden");
  }

  function hideAllSteps(){
    $("step1").classList.add("hidden");
    $("step2").classList.add("hidden");
    $("stepWordMain").classList.add("hidden");
    $("stepSnu").classList.add("hidden");
    $("stepTopik").classList.add("hidden");
    $("stepGrammar").classList.add("hidden");
  }

  function showStep(stepId){
    hideAllSteps();
    const el = $(stepId);
    if(el) el.classList.remove("hidden");
    if(stepId === "step1") renderKlassButtons();
    scrollToTop();
  }

  function jsonpRequest(baseUrl, params, timeoutMs = 12000){
    return new Promise((resolve, reject)=>{
      const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
      const qs = new URLSearchParams({ ...params, callback: cbName }).toString();
      const url = baseUrl + (baseUrl.includes("?") ? "&" : "?") + qs;

      let done = false;
      const script = document.createElement("script");

      function cleanup(){
        try { delete window[cbName]; } catch(e){ window[cbName] = undefined; }
        if(script && script.parentNode) script.parentNode.removeChild(script);
      }

      const timer = setTimeout(()=>{
        if(done) return;
        done = true;
        cleanup();
        reject(new Error("JSONP timeout"));
      }, timeoutMs);

      window[cbName] = (data)=>{
        if(done) return;
        done = true;
        clearTimeout(timer);
        cleanup();
        resolve(data);
      };

      script.onerror = ()=>{
        if(done) return;
        done = true;
        clearTimeout(timer);
        cleanup();
        reject(new Error("JSONP script load error"));
      };

      script.src = url;
      document.head.appendChild(script);
    });
  }

  function getDeviceId(){
    const k = "kquiz_deviceId";
    let id = localStorage.getItem(k);
    if(!id){
      const canUUID = (window.crypto && typeof window.crypto.randomUUID === "function");
      id = canUUID ? window.crypto.randomUUID() : ("d_" + Date.now() + "_" + Math.floor(Math.random()*1e9));
      localStorage.setItem(k, id);
    }
    return id;
  }

  function saveState(next){
    const s = { ...next, ts: Date.now() };
    STATE = s;

    // ✅ 앱 닫기 전까지: sessionStorage가 기본
    try{ sessionStorage.setItem(SESSION_KEY, JSON.stringify(s)); }catch(e){}

    // ✅ 인앱 세션 날림 대비: localStorage 백업(짧은 TTL)
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){}
  }

  function clearState(){
    STATE = { pass:"", name:"", klass:"", deviceId:getDeviceId(), token:"", ts:0 };
    try{ sessionStorage.removeItem(SESSION_KEY); }catch(e){}
    try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  }

  function loadState(){
    // 1) session 우선
    let raw = null;
    try{ raw = sessionStorage.getItem(SESSION_KEY); }catch(e){}
    // 2) 없으면 local backup
    if(!raw){
      try{ raw = localStorage.getItem(STORAGE_KEY); }catch(e){}
    }

    if(raw){
      try{
        const parsed = JSON.parse(raw);
        const now = Date.now();
        const ts = parsed && parsed.ts ? parsed.ts : 0;
        const okTTL = ts && (now - ts) <= STATE_TTL_MS;
        const okToken = parsed && parsed.token && String(parsed.token).length > 5;

        if(okTTL && okToken){
          STATE = parsed;
          // session에도 다시 심어서 “앱 닫기 전 유지”를 안정화
          try{ sessionStorage.setItem(SESSION_KEY, JSON.stringify(parsed)); }catch(e){}
        }else{
          clearState();
        }
      }catch(e){
        clearState();
      }
    }else{
      // 최초 진입
      STATE.deviceId = getDeviceId();
    }

    // UI에 반영
    if(STATE.klass && $("klass")) $("klass").value = STATE.klass;
    renderKlassButtons();
  }

  function renderKlassButtons(){
    const wrap = $("klassGrid");
    const hidden = $("klass");
    if(!wrap || !hidden) return;

    const current = (hidden.value || "").trim();
    wrap.innerHTML = "";

    KLASS_OPTIONS.forEach(opt=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "klassBtn" + (opt.value === current ? " active" : "");
      b.textContent = opt.label;
      b.onclick = ()=>{
        hidden.value = opt.value;
        [...wrap.querySelectorAll(".klassBtn")].forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        clearWarn();
      };
      wrap.appendChild(b);
    });
  }

  async function login(){
    clearWarn();

    const pass = ($("pass").value || "").trim();
    const name = ($("name").value || "").trim();
    const klass = ($("klass").value || "").trim();
    if(!pass || !name || !klass){
      showWarn("Нууц үг, нэр, анги гурвыг бүгдийг нь оруулна уу.");
      return;
    }

    const deviceId = getDeviceId();

    try{
      const res = await jsonpRequest(SCRIPT_URL, { action: "issue", pass, name, klass, deviceId });
      if(!res || !res.ok || !res.token){
        showWarn("Нэвтрэх боломжгүй байна.\n(Нууц үг буруу эсвэл серверийн алдаа)");
        return;
      }

      saveState({ pass, name, klass, deviceId, token: res.token });
      showStep("step2");
      showWarn("Амжилттай.\nОдоо тестийн төрлөө сонгоно уу.");
    }catch(e){
      showWarn("Сервертэй холбогдож чадсангүй.\nДахин оролдоно уу.");
    }
  }

  function logout(){
    clearWarn();
    clearState();
    // 입력칸도 초기화
    if($("pass")) $("pass").value = "";
    if($("name")) $("name").value = "";
    if($("klass")) $("klass").value = "";
    renderKlassButtons();
    showStep("step1");
    showWarn("Гарлаа. Дахин нэвтэрнэ үү.");
  }

  function backToLogin(){
    clearWarn();
    showStep("step1");
  }

  function selectType(type){
    clearWarn();
    loadState();
    if(!STATE.token){
      showWarn("Эхлээд нэвтэрнэ үү.");
      showStep("step1");
      return;
    }
    if(type === "WORD") showStep("stepWordMain");
    else showStep("stepGrammar");
  }

  function backToType(){
    clearWarn();
    showStep("step2");
  }

  function selectWordMain(type){
    clearWarn();
    loadState();
    if(!STATE.token){
      showWarn("Эхлээд нэвтэрнэ үү.");
      showStep("step1");
      return;
    }
    if(type==="SNU") showStep("stepSnu");
    else showStep("stepTopik");
  }

  function backToWordMain(){
    clearWarn();
    showStep("stepWordMain");
  }

  function goWordHub(book, level){
    loadState();
    if(!STATE.token){
      showWarn("Эхлээд нэвтэрнэ үү.");
      showStep("step1");
      return;
    }
    const next =
      `lessonHub.html?book=${encodeURIComponent(book)}` +
      `&level=${encodeURIComponent(level)}` +
      `&name=${encodeURIComponent(STATE.name)}` +
      `&klass=${encodeURIComponent(STATE.klass)}` +
      `&token=${encodeURIComponent(STATE.token)}`;
    location.href = next;
  }

  function goGrammarHub(){
    loadState();
    if(!STATE.token){
      showWarn("Эхлээд нэвтэрнэ үү.");
      showStep("step1");
      return;
    }
    const qs =
      `?name=${encodeURIComponent(STATE.name)}` +
      `&klass=${encodeURIComponent(STATE.klass)}` +
      `&token=${encodeURIComponent(STATE.token)}`;
    location.href = "grammar/index.html" + qs;
  }

  (function boot(){
    loadState();
    if(STATE && STATE.token) showStep("step2");
    else showStep("step1");
  })();
</script>
</body>
</html>

