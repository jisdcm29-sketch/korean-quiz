<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- 캐시 최소화 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Үгийн сангийн тест · Эхлэл</title>

  <style>
    :root{
      --bg:#f0f4f8; --card:#ffffff; --primary:#2d6cdf; --primary2:#1f4ea5;
      --text:#223047; --muted:#6a7a8e; --line:#d9e4f5;
      --warnbg:#fff5f5; --warnline:#feb2b2;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:20px; font-family:Arial,sans-serif; background:var(--bg); color:var(--text); text-align:center;}
    .container{max-width:640px; margin:0 auto; background:var(--card); padding:26px; border-radius:20px; border:1px solid var(--line); box-shadow:0 10px 20px rgba(0,0,0,0.08);}
    h2{margin:0; font-size:22px; color:#1f2f45;}
    .sub{margin:10px 0 0; color:var(--muted); font-size:15px; line-height:1.45;}
    input{width:92%; padding:14px; margin:14px 0 10px; border:2px solid #e0e0e0; border-radius:12px; font-size:18px; text-align:center; outline:none;}
    input:focus{border-color:#b7cdfd; box-shadow:0 0 0 4px rgba(45,108,223,0.12);}
    .btn{width:100%; background:var(--primary); color:#fff; padding:15px 16px; border:none; border-radius:12px; cursor:pointer; font-size:18px; font-weight:900; transition:.2s;}
    .btn:hover{background:var(--primary2);}
    .btn-gray{background:#eef2f7; color:#2c3e50; border:1px solid #d7dee7;}
    .btn-gray:hover{background:#e2e8f0;}
    .row{display:flex; gap:10px; margin-top:12px;}
    .row .btn{width:50%;}
    .meta{color:var(--muted); font-size:13px; margin-top:10px; line-height:1.45;}
    .panel{margin-top:16px; padding:14px; border:1px solid var(--line); border-radius:14px; background:#fff;}
    .grid{display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; margin-top:12px;}
    @media (max-width:520px){ .grid{grid-template-columns:1fr;} }
    .lessonBtn{
      width:100%;
      background:#ffffff;
      color:var(--text);
      border:2px solid var(--primary);
      border-radius:12px;
      padding:14px;
      font-size:18px;
      font-weight:900;
      cursor:pointer;
      transition:.15s;
    }
    .lessonBtn:hover{background:var(--primary); color:#fff;}
    .warn{margin-top:14px; background:var(--warnbg); border:1px solid var(--warnline); border-radius:12px; padding:12px; color:#7a1f1f; font-size:14px; text-align:left; line-height:1.45;}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #d7dee7; background:#f6f9ff; font-size:12px; color:#2c3e50; font-weight:900;}
  </style>
</head>

<body>
  <div class="container">
    <h2>Үгийн сангийн тест · Эхлэл</h2>
    <p class="sub">
      Нэрээ оруулаад, хичээлээ сонгоно уу.<br>
      (Хичээлүүд автоматаар илэрнэ.)
    </p>

    <input id="userName" type="text" placeholder="Таны нэр" autocomplete="name" />
    <div class="row">
      <button class="btn btn-gray" onclick="refreshLessons()">Дахин хайх</button>
      <button class="btn" onclick="goFirstLesson()">Эхний хичээл</button>
    </div>

    <div class="panel">
      <div style="font-weight:900; color:#1f2f45;">
        Олдсон хичээлүүд <span class="tag" id="countTag">0</span>
      </div>
      <div class="meta" id="statusText">Хайж байна...</div>
      <div class="grid" id="lessonGrid"></div>

      <div class="warn" id="helpBox" style="display:none;">
        <b>Анхаар!</b><br>
        Энэ index.html нь <b>файл нэрийн дүрэм</b>-ээр хичээлүүдийг хайж олдог.<br><br>
        ✅ Файл нэрийн дүрэм (зөв):<br>
        • lesson01.html, lesson02.html, lesson03.html ...<br><br>
        Хэрэв өөрөөр нэрлэвэл, index автоматаар олж чадахгүй.
      </div>
    </div>

    <div class="meta" style="margin-top:14px;">
      Зөвлөгөө: холбоосоо илгээхдээ <b>?v=1</b> нэмвэл кэш багасна.<br>
      Жишээ: index.html?v=1
    </div>
  </div>

<script>
/** =========================
 *  사장님이 앞으로 바꿀 수 있는 “설정값 3개”
 *  ========================= */
const FILE_PREFIX = "lesson";     // lesson01.html ...
const FILE_SUFFIX = ".html";
const MAX_LESSONS_TO_SCAN = 60;   // 1~60까지 자동 탐색(필요하면 100으로)

const NAME_STORE_KEY = "student_name_global";

/** =========================
 *  내부 상태
 *  ========================= */
let foundLessons = []; // [{num, file}]
const grid = document.getElementById("lessonGrid");
const statusText = document.getElementById("statusText");
const countTag = document.getElementById("countTag");
const helpBox = document.getElementById("helpBox");
const nameInput = document.getElementById("userName");

// 저장된 이름 복원
nameInput.value = localStorage.getItem(NAME_STORE_KEY) || "";
nameInput.addEventListener("input", ()=> {
  localStorage.setItem(NAME_STORE_KEY, nameInput.value.trim());
});
nameInput.addEventListener("keydown", (e)=> {
  if (e.key === "Enter") goFirstLesson();
});

function pad2(n){ return String(n).padStart(2, "0"); }

function makeLessonFile(n){
  return `${FILE_PREFIX}${pad2(n)}${FILE_SUFFIX}`;
}

function setStatus(msg){
  statusText.textContent = msg;
}

function renderLessons(){
  grid.innerHTML = "";
  countTag.textContent = String(foundLessons.length);

  if (foundLessons.length === 0){
    setStatus("Хичээл олдсонгүй. Файл нэрийг шалгана уу.");
    helpBox.style.display = "block";
    return;
  }

  helpBox.style.display = "none";
  setStatus("Хичээлээ сонгоно уу.");

  foundLessons.forEach(item => {
    const btn = document.createElement("button");
    btn.className = "lessonBtn";
    btn.textContent = `${item.num}-р хичээл`;
    btn.onclick = () => openLesson(item.file, item.num);
    grid.appendChild(btn);
  });
}

/** GitHub Pages에서 파일 존재 여부 확인 (HEAD → 안되면 GET) */
async function existsFile(url){
  // 1) HEAD 시도
  try{
    const r = await fetch(url, { method:"HEAD", cache:"no-store" });
    if (r.ok) return true;
    // 일부 상황: 404면 false
    if (r.status === 404) return false;
    // 다른 코드면 GET로 재확인
  } catch(e){ /* ignore */ }

  // 2) GET(짧게 확인)
  try{
    const r2 = await fetch(url, { method:"GET", cache:"no-store" });
    if (r2.ok) return true;
    return false;
  } catch(e){
    return false;
  }
}

async function scanLessons(){
  foundLessons = [];
  renderLessons();
  setStatus("Хичээлүүдийг хайж байна...");

  // 같은 폴더에 lessonNN.html이 있다고 가정
  for (let n=1; n<=MAX_LESSONS_TO_SCAN; n++){
    const file = makeLessonFile(n);
    const ok = await existsFile(file + "?probe=" + Date.now());
    if (ok){
      foundLessons.push({ num:n, file });
      renderLessons();
    }
  }

  if (foundLessons.length === 0){
    renderLessons();
  } else {
    setStatus("Бэлэн боллоо. Хичээлээ сонгоно уу.");
  }
}

function ensureName(){
  const name = (nameInput.value || "").trim();
  if (!name){
    alert("Нэрээ оруулна уу!");
    return null;
  }
  localStorage.setItem(NAME_STORE_KEY, name);
  return name;
}

function openLesson(file, num){
  const name = ensureName();
  if (!name) return;

  // 이름 전달(과 파일에서 사용 가능)
  // 과 파일(lessonNN.html)에서는 URLSearchParams로 name을 읽거나,
  // localStorage(NAME_STORE_KEY)로 이름을 읽으면 됩니다.
  const url = `${file}?name=${encodeURIComponent(name)}&lesson=${num}&v=${Date.now()}`;
  window.location.href = url;
}

function goFirstLesson(){
  const name = ensureName();
  if (!name) return;

  // 찾은 것 중 가장 첫 번째로 이동
  if (foundLessons.length > 0){
    openLesson(foundLessons[0].file, foundLessons[0].num);
    return;
  }
  // 아직 탐색 전이면 탐색 후 이동
  refreshLessons(true);
}

async function refreshLessons(goAfter=false){
  await scanLessons();
  if (goAfter && foundLessons.length > 0){
    openLesson(foundLessons[0].file, foundLessons[0].num);
  }
}

// 최초 자동 스캔
scanLessons();
</script>
</body>
</html>
