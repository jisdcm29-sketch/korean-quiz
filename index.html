<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Үгийн сангийн тест · Эхлэл</title>

  <style>
    :root{
      --bg:#f0f4f8; --card:#fff; --primary:#2d6cdf; --primary2:#1f4ea5; --line:#d9e4f5;
      --text:#223047; --muted:#6a7a8e;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:20px; background:var(--bg); font-family:Arial,sans-serif; text-align:center; color:var(--text);}
    .container{max-width:560px; margin:0 auto; background:var(--card); padding:26px; border-radius:20px; border:1px solid var(--line); box-shadow:0 10px 20px rgba(0,0,0,0.08);}
    h1{margin:0; font-size:22px;}
    .sub{margin:10px 0 0; color:var(--muted); font-size:14px; line-height:1.45;}
    input, select{width:100%; padding:14px 12px; margin-top:12px; border:2px solid #d7dee7; border-radius:12px; font-size:16px; text-align:center;}
    .btn{width:100%; padding:14px 12px; margin-top:12px; border:none; border-radius:12px; background:var(--primary); color:#fff; font-size:16px; font-weight:900; cursor:pointer;}
    .btn:hover{background:var(--primary2);}
    .btnGray{background:#eef2f7; color:#223047; border:1px solid #d7dee7;}
    .btnGray:hover{background:#e2e8f0;}
    .grid{display:grid; gap:10px; margin-top:16px;}
    .cardBtn{padding:16px 12px; border-radius:14px; border:2px solid var(--primary); background:#fff; font-weight:900; cursor:pointer;}
    .cardBtn:hover{background:var(--primary); color:#fff;}
    .hidden{display:none;}
    .warn{margin-top:14px; padding:12px; border-radius:12px; background:#fff5f5; border:1px solid #feb2b2; color:#7a1f1f; font-size:14px; line-height:1.45; text-align:left;}
  </style>
</head>
<body>
<div class="container">
  <h1>Үгийн сангийн тест</h1>
  <p class="sub">Нууц үг, нэр, ангиа оруулаад үргэлжлүүлнэ үү.</p>

  <input id="pass" type="password" placeholder="Нууц үг"/>
  <input id="name" type="text" placeholder="Таны нэр"/>

  <select id="klass">
    <option value="">Анги сонгох</option>
    <option value="BBTA1반">BBTA1반</option>
    <option value="EKO2반">EKO2반</option>
  </select>

  <button class="btn" onclick="login()">Үргэлжлүүлэх</button>

  <div id="step2" class="hidden">
    <p class="sub" style="margin-top:16px;">Төрөл сонгоно уу.</p>
    <div class="grid">
      <div class="cardBtn" onclick="selectMain('SNU')">서울대 교재</div>
      <div class="cardBtn" onclick="selectMain('TOPIK')">TOPIK</div>
    </div>
  </div>

  <div id="stepSnu" class="hidden">
    <p class="sub" style="margin-top:16px;">교재 сонгоно уу.</p>
    <div class="grid">
      <div class="cardBtn" onclick="goHub('SNU','1A')">1A</div>
      <div class="cardBtn" onclick="goHub('SNU','1B')">1B</div>
      <div class="cardBtn" onclick="goHub('SNU','2A')">2A</div>
      <div class="cardBtn" onclick="goHub('SNU','2B')">2B</div>
    </div>
    <button class="btn btnGray" onclick="backToMain()">Буцах</button>
  </div>

  <div id="stepTopik" class="hidden">
    <p class="sub" style="margin-top:16px;">TOPIK сонгоно уу.</p>
    <div class="grid">
      <div class="cardBtn" onclick="goHub('TOPIK','1')">TOPIK 1</div>
      <div class="cardBtn" onclick="goHub('TOPIK','2')">TOPIK 2</div>
    </div>
    <button class="btn btnGray" onclick="backToMain()">Буцах</button>
  </div>

  <div id="warn" class="warn hidden"></div>
</div>

<script>
  // ✅ 사장님이 복사한 Apps Script 웹앱 URL
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBe6Y0W3IJKjWV8MLFnR5b9OMePDPHGVACPekJQpvLWRrlayRmHBJCezamKqN9rZg6/exec";

  let STATE = { pass:"", name:"", klass:"", deviceId:"", token:"" };

  function getDeviceId(){
    const k = "kquiz_deviceId";
    let id = localStorage.getItem(k);
    if(!id){
      id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+"_"+Math.random()).replace(".","");
      localStorage.setItem(k, id);
    }
    return id;
  }

  function showWarn(msg){
    const w = document.getElementById("warn");
    w.textContent = msg;
    w.classList.remove("hidden");
  }
  function clearWarn(){
    document.getElementById("warn").classList.add("hidden");
  }

  // JSONP helper (iPhone/Android 모두 안정적으로)
  function jsonp(url, cbName){
    return new Promise((resolve, reject)=>{
      const callback = cbName + "_" + Date.now() + "_" + Math.floor(Math.random()*10000);
      window[callback] = (data)=>{
        resolve(data);
        script.remove();
        delete window[callback];
      };
      const script = document.createElement("script");
      script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + callback;
      script.onerror = ()=>{ reject(new Error("jsonp_error")); script.remove(); delete window[callback]; };
      document.body.appendChild(script);
    });
  }

  async function login(){
    clearWarn();
    const pass = document.getElementById("pass").value.trim();
    const name = document.getElementById("name").value.trim();
    const klass = document.getElementById("klass").value.trim();
    if(!pass || !name || !klass){
      showWarn("Нууц үг, нэр, анги гурвыг бүгдийг нь оруулна уу.");
      return;
    }

    const deviceId = getDeviceId();

    // 1) 토큰 발급
    const url = `${SCRIPT_URL}?action=issue&pass=${encodeURIComponent(pass)}&name=${encodeURIComponent(name)}&klass=${encodeURIComponent(klass)}&deviceId=${encodeURIComponent(deviceId)}`;
    try{
      const res = await jsonp(url, "cb");
      if(!res || !res.ok){
        showWarn("Нэвтрэх боломжгүй байна. (Нууц үг буруу эсвэл сервер алдаа)");
        return;
      }
      STATE = { pass, name, klass, deviceId, token: res.token };
      sessionStorage.setItem("kquiz_state", JSON.stringify(STATE));

      document.getElementById("step2").classList.remove("hidden");
      showWarn("Амжилттай. Одоо төрөл сонгоно уу.");
    }catch(e){
      showWarn("Сервертэй холбогдож чадсангүй. Дахин оролдоно уу.");
    }
  }

  function selectMain(type){
    clearWarn();
    const s = sessionStorage.getItem("kquiz_state");
    if(s) STATE = JSON.parse(s);

    if(!STATE.token){
      showWarn("Эхлээд нэвтэрнэ үү.");
      return;
    }

    if(type==="SNU"){
      document.getElementById("stepSnu").classList.remove("hidden");
      document.getElementById("stepTopik").classList.add("hidden");
    }else{
      document.getElementById("stepTopik").classList.remove("hidden");
      document.getElementById("stepSnu").classList.add("hidden");
    }
  }

  function backToMain(){
    document.getElementById("stepSnu").classList.add("hidden");
    document.getElementById("stepTopik").classList.add("hidden");
  }

  // ✅ 다음 화면(과 목록 화면)으로 이동: lessonHub.html을 사용할 예정
  function goHub(book, level){
    const s = sessionStorage.getItem("kquiz_state");
    if(s) STATE = JSON.parse(s);

    if(!STATE.token){
      showWarn("Эхлээд нэвтэрнэ үү.");
      return;
    }

    const next = `lessonHub.html?book=${encodeURIComponent(book)}&level=${encodeURIComponent(level)}`;
    location.href = next;
  }
</script>
</body>
</html>
