<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Korean Quiz</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e7ecff;
      --muted:#aab6e6;
      --line:rgba(255,255,255,.10);
      --primary:#3b82f6;
      --green:#22c55e;
      --amber:#f59e0b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, sans-serif;
      background: radial-gradient(1000px 800px at 30% -10%, rgba(59,130,246,.35), transparent 55%),
                  radial-gradient(900px 700px at 90% 0%, rgba(34,197,94,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
      min-height:100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px 14px 22px;
    }
    .wrap{width:min(520px, 100%);}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topBar{
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.16);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .langToggle{display:flex; gap:8px; align-items:center;}
    .langBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(231,236,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      min-width:84px;
      text-align:center;
    }
    .langBtn.active{
      background: linear-gradient(180deg, rgba(79,140,255,.95), rgba(37,99,235,.95));
      border-color: rgba(79,140,255,.9);
      color:#fff;
      box-shadow: 0 8px 18px rgba(37,99,235,.25);
    }
    .topHint{
      font-size:12px;
      color: rgba(231,236,255,.55);
      font-weight:800;
      white-space:nowrap;
    }

    .hdr{padding:18px 18px 10px; text-align:center;}
    .brand{font-size:22px; font-weight:800; letter-spacing:.2px; margin:0 0 6px;}
    .sub{margin:0; color:var(--muted); font-size:14px; line-height:1.45;}
    .content{padding: 14px 16px 18px;}
    .sectionTitle{margin: 6px 0 12px; font-size:16px; font-weight:800; text-align:center;}

    .field{display:flex; flex-direction:column; gap:8px; margin: 12px 0;}
    label{font-size:14px; color:var(--muted); font-weight:700;}
    input, select{
      width:100%;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,15,25,.55);
      color: var(--text);
      padding: 14px 14px;
      font-size:18px;
      outline:none;
    }
    input::placeholder{color: rgba(231,236,255,.45)}

    .btn{
      width:100%;
      border:0;
      border-radius: 18px;
      padding: 15px 14px;
      font-size:20px;
      font-weight:900;
      color:white;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.30);
      transition: transform .06s ease, filter .15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: translateY(1px) scale(.99)}
    .btnPrimary{background: linear-gradient(180deg, #4f8cff, #2563eb);}
    .btnGreen{background: linear-gradient(180deg, #34d399, #16a34a);}
    .btnAmber{background: linear-gradient(180deg, #fbbf24, #f59e0b); color:#1b1406;}
    .btnGhost{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:none;
      color: var(--text);
      font-size:16px;
      padding: 12px 12px;
      border-radius: 16px;
      font-weight:900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .note{margin: 10px 0 0; text-align:center; color: var(--muted); font-size:13px; line-height:1.5;}
    .err{
      margin: 10px 0 0;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(239,68,68,.14);
      border:1px solid rgba(239,68,68,.35);
      color: #ffd3d3;
      font-size:14px;
      font-weight:800;
      text-align:center;
      display:none;
    }
    .ok{
      margin: 10px 0 0;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(34,197,94,.14);
      border:1px solid rgba(34,197,94,.35);
      color: #d6ffe6;
      font-size:14px;
      font-weight:900;
      text-align:center;
      display:none;
    }

    .dashTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    .who{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .who .name{font-weight:900; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .who .klass{font-size:13px; color: var(--muted); font-weight:900;}

    .gridBtns{display:grid; grid-template-columns: 1fr; gap: 12px; padding: 14px 16px 18px;}
    .smallRow{display:grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 16px 16px;}

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:900;
      color: rgba(231,236,255,.85);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      padding: 6px 10px;
      border-radius: 999px;
      gap:8px;
      min-height:32px;
      text-align:center;
      line-height:1.2;
    }
    .footerMini{
      padding: 12px 16px 16px;
      border-top:1px solid var(--line);
      color: rgba(231,236,255,.55);
      font-size:12px;
      text-align:center;
      line-height:1.5;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="app"></div>
  </div>

<script>
(() => {
  // ====== CONFIG (여기만 수정하면 됨) ======
  // 1) 아래 URL을 “내가 배포한 웹앱 URL”로 바꿔주세요.
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz6WBgnJXTAperJK2NwX-VwkmPEQrU4SluCcXjbmYYgcywYM2AcHZwkymBse6E9Kaqg/exec";
  const PASSWORD = "tae";
  const AUTO_LOGOUT_MIN = 30;

  const PATHS = {
    SNU: "/korean-quiz/snu/index.html",
    TOPIK1: "/korean-quiz/topik1/index.html",
    TOPIK2: "/korean-quiz/topik2/index.html",
  };

  // ====== i18n ======
  const LANG_KEY = "kq_lang_v1"; // 'ko' | 'mn'
  const I18N = {
    ko: {
      topHint: "언어 선택",
      appTitle: "Korean Quiz",
      loginSubtitle: "비밀번호 입력 후 시작합니다",
      loginTitle: "로그인",
      pw: "비밀번호",
      pwPh: "tae",
      name: "이름",
      namePh: "예: 바트",
      klass: "반 선택",
      loginBtn: "로그인",
      wrongPw: "비밀번호가 틀렸습니다.",
      needName: "이름을 입력해 주세요.",
      needKlass: "반을 선택해 주세요.",
      logging: "기록 저장 중…",
      loginOk: "로그인 완료! 선택 화면으로 이동합니다.",
      loginOkNoLog: "로그인 완료! (기록 전송은 네트워크 상황에 따라 실패할 수 있어요)",
      noteAfterLogin: "로그인 후 서울대 / TOPIK1 / TOPIK2를 선택할 수 있습니다.",
      autoLogout: "자동 로그아웃",
      dashTitle: "선택",
      dashSub: "아래에서 학습을 선택하세요",
      logout: "로그아웃",
      snu: "서울대",
      topik1: "TOPIK 1",
      topik2: "TOPIK 2",
      pillName: "이름",
      pillKlass: "반",
      footer: "이동 시 name/klass/token/lang 파라미터가 자동으로 전달됩니다."
    },
    mn: {
      topHint: "Хэл",
      appTitle: "Korean Quiz",
      loginSubtitle: "Нууц үгээ оруулаад эхэлнэ",
      loginTitle: "Нэвтрэх",
      pw: "Нууц үг",
      pwPh: "tae",
      name: "Нэр",
      namePh: "Жишээ: Бат",
      klass: "Анги сонгох",
      loginBtn: "Нэвтрэх",
      wrongPw: "Нууц үг буруу байна.",
      needName: "Нэрээ оруулна уу.",
      needKlass: "Ангиа сонгоно уу.",
      logging: "Бүртгэл илгээж байна…",
      loginOk: "Амжилттай! Сонголтын дэлгэц рүү шилжинэ.",
      loginOkNoLog: "Амжилттай! (Сүлжээнээс шалтгаалж илгээх амжилтгүй байж болно)",
      noteAfterLogin: "Нэвтэрсний дараа Seoul / TOPIK1 / TOPIK2-оос сонгоно.",
      autoLogout: "Автоматаар гарах",
      dashTitle: "Сонгох",
      dashSub: "Доороос хичээлээ сонгоно уу",
      logout: "Гарах",
      snu: "Seoul",
      topik1: "TOPIK 1",
      topik2: "TOPIK 2",
      pillName: "Нэр",
      pillKlass: "Анги",
      footer: "Шилжих үед name/klass/token/lang параметр автоматаар дамжина."
    }
  };

  // ====== Utils ======
  const $app = document.getElementById("app");
  const LS_KEY = "kq_session_v1";
  const DEV_KEY = "kq_deviceId_v1";

  const now = () => Date.now();

  function qs(obj){
    const p = new URLSearchParams();
    Object.keys(obj).forEach(k => {
      if (obj[k] === undefined || obj[k] === null) return;
      p.set(k, String(obj[k]));
    });
    return p.toString();
  }

  function getDeviceId(){
    let id = localStorage.getItem(DEV_KEY);
    if (!id){
      id = "dev_" + Math.random().toString(16).slice(2) + "_" + now().toString(16);
      localStorage.setItem(DEV_KEY, id);
    }
    return id;
  }

  function safeTrim(s){ return (s || "").toString().trim(); }

  function genToken(){
    return "t_" + Math.random().toString(16).slice(2) + "_" + now().toString(16);
  }
  function genSessionId(){
    return "s_" + Math.random().toString(16).slice(2) + "_" + now().toString(16);
  }

  function getLang(){
    const v = localStorage.getItem(LANG_KEY);
    return (v === "mn" || v === "ko") ? v : "ko";
  }
  function setLang(v){
    localStorage.setItem(LANG_KEY, (v === "mn") ? "mn" : "ko");
    document.documentElement.lang = getLang();
  }
  function t(key){
    const lang = getLang();
    return (I18N[lang] && I18N[lang][key]) ? I18N[lang][key] : (I18N.ko[key] || key);
  }

  function readSession(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return null;
      const s = JSON.parse(raw);
      if (!s || !s.name || !s.klass || !s.token || !s.sessionId || !s.loginAt) return null;
      if (!s.lastActive) s.lastActive = now();
      return s;
    }catch(e){
      return null;
    }
  }

  function writeSession(s){
    localStorage.setItem(LS_KEY, JSON.stringify(s));
  }

  function clearSession(){
    localStorage.removeItem(LS_KEY);
  }

  function updateLastActive(){
    const s = readSession();
    if (!s) return;
    s.lastActive = now();
    writeSession(s);
  }

  function isExpired(s){
    const maxMs = AUTO_LOGOUT_MIN * 60 * 1000;
    return (now() - (s.lastActive || 0)) > maxMs;
  }

  function buildUrlWithParams(basePath, params){
    const u = new URL(basePath, location.origin);
    Object.keys(params).forEach(k => u.searchParams.set(k, params[k]));
    return u.toString();
  }

  // JSONP helper
  function jsonp(url, params, timeoutMs = 8000){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const timer = setTimeout(() => {
        cleanup();
        reject(new Error("JSONP timeout"));
      }, timeoutMs);

      function cleanup(){
        clearTimeout(timer);
        try{ delete window[cb]; }catch(e){}
        if (script && script.parentNode) script.parentNode.removeChild(script);
      }

      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };

      const full = url + (url.includes("?") ? "&" : "?") + qs({...params, callback: cb});
      const script = document.createElement("script");
      script.src = full;
      script.async = true;
      script.onerror = () => {
        cleanup();
        reject(new Error("JSONP network error"));
      };
      document.head.appendChild(script);
    });
  }

  function escapeHtml(str){
    return (str||"").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // ===== 기록 전송 (로그 + 세션) =====
  async function sendLoginLog(session){
    const payload = {
      action: "log",
      token: session.token,
      deviceId: getDeviceId(),
      klass: session.klass,
      name: session.name,
      book: "LOGIN",
      lesson: "index",
      score: 0,
      attempts: 0,
      ua: navigator.userAgent || "",
      lang: getLang()
    };
    try{ await jsonp(SCRIPT_URL, payload, 8000); return true; }catch(e){ return false; }
  }

  async function sendSessionStart(session){
    const payload = {
      action: "session_start",
      sessionId: session.sessionId,
      loginAt: session.loginAt,
      token: session.token,
      deviceId: getDeviceId(),
      klass: session.klass,
      name: session.name,
      ua: navigator.userAgent || "",
      lang: getLang()
    };
    try{ await jsonp(SCRIPT_URL, payload, 8000); return true; }catch(e){ return false; }
  }

  async function sendSessionEnd(session, reason){
    const logoutAt = new Date().toISOString();
    const payload = {
      action: "session_end",
      sessionId: session.sessionId,
      loginAt: session.loginAt,
      logoutAt,
      reason: reason || "logout",
      token: session.token,
      deviceId: getDeviceId(),
      klass: session.klass,
      name: session.name,
      ua: navigator.userAgent || "",
      lang: getLang()
    };
    try{ await jsonp(SCRIPT_URL, payload, 8000); return true; }catch(e){ return false; }
  }

  // ===== UI: TopBar =====
  function renderTopBar(){
    const lang = getLang();
    return `
      <div class="topBar">
        <div class="langToggle" role="group" aria-label="Language toggle">
          <button class="langBtn ${lang==="ko" ? "active":""}" id="langKo">한국어</button>
          <button class="langBtn ${lang==="mn" ? "active":""}" id="langMn">Монгол</button>
        </div>
        <div class="topHint">${escapeHtml(t("topHint"))}</div>
      </div>
    `;
  }

  function bindTopBar(onChange){
    const $ko = document.getElementById("langKo");
    const $mn = document.getElementById("langMn");
    if ($ko) $ko.addEventListener("click", () => { setLang("ko"); onChange(); });
    if ($mn) $mn.addEventListener("click", () => { setLang("mn"); onChange(); });
  }

  // ===== UI: Login =====
  function renderLogin(){
    $app.innerHTML = `
      ${renderTopBar()}
      <div class="hdr">
        <p class="brand">${escapeHtml(t("appTitle"))}</p>
        <p class="sub">${escapeHtml(t("loginSubtitle"))}</p>
      </div>
      <div class="content">
        <div class="sectionTitle">${escapeHtml(t("loginTitle"))}</div>

        <div class="field">
          <label for="pw">${escapeHtml(t("pw"))}</label>
          <input id="pw" type="password" inputmode="text" autocomplete="off" placeholder="${escapeHtml(t("pwPh"))}" />
        </div>

        <div class="field">
          <label for="name">${escapeHtml(t("name"))}</label>
          <input id="name" type="text" inputmode="text" autocomplete="name" placeholder="${escapeHtml(t("namePh"))}" />
        </div>

        <div class="field">
          <label for="klass">${escapeHtml(t("klass"))}</label>
          <select id="klass">
            <option value="BBTA1반">BBTA1반</option>
            <option value="EKO1반">EKO1반</option>
            <option value="EKO2반">EKO2반</option>
            <option value="토픽반">토픽반</option>
            <option value="기타반">기타반</option>
          </select>
        </div>

        <button class="btn btnPrimary" id="btnLogin">${escapeHtml(t("loginBtn"))}</button>
        <div class="err" id="err"></div>
        <div class="ok" id="ok"></div>

        <p class="note">
          ${escapeHtml(t("noteAfterLogin"))}<br/>
          <span class="pill">${escapeHtml(t("autoLogout"))} ${AUTO_LOGOUT_MIN}분</span>
        </p>
      </div>
      <div class="footerMini">
        <span class="mono">device</span>는 자동 생성되어 기록됩니다.
      </div>
    `;

    bindTopBar(renderLogin);

    const $pw = document.getElementById("pw");
    const $name = document.getElementById("name");
    const $klass = document.getElementById("klass");
    const $err = document.getElementById("err");
    const $ok = document.getElementById("ok");
    const $btn = document.getElementById("btnLogin");

    function showErr(msg){
      $ok.style.display = "none";
      $err.textContent = msg;
      $err.style.display = "block";
    }
    function showOk(msg){
      $err.style.display = "none";
      $ok.textContent = msg;
      $ok.style.display = "block";
    }

    async function doLogin(){
      const pw = safeTrim($pw.value);
      const name = safeTrim($name.value);
      const klass = safeTrim($klass.value);

      if (pw !== PASSWORD) return showErr(t("wrongPw"));
      if (!name) return showErr(t("needName"));
      if (!klass) return showErr(t("needKlass"));

      const session = {
        name,
        klass,
        token: genToken(),
        sessionId: genSessionId(),
        deviceId: getDeviceId(),
        lastActive: now(),
        loginAt: new Date().toISOString()
      };
      writeSession(session);

      showOk(t("logging"));

      // (1) 세션 시작(로그인 시간) 기록 → Sessions 시트에 저장
      await sendSessionStart(session);

      // (2) 기존 로그인 이벤트도 Log 시트에 남김(원하면 유지)
      const ok = await sendLoginLog(session);
      showOk(ok ? t("loginOk") : t("loginOkNoLog"));

      setTimeout(() => renderDashboard(), 350);
    }

    $btn.addEventListener("click", doLogin);
    $pw.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
    $name.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
  }

  // ===== UI: Dashboard =====
  function renderDashboard(){
    const s = readSession();
    if (!s) return renderLogin();
    if (isExpired(s)){
      (async () => { await sendSessionEnd(s, "timeout"); })();
      clearSession();
      return renderLogin();
    }

    $app.innerHTML = `
      ${renderTopBar()}
      <div class="dashTop">
        <div class="who">
          <div class="name">${escapeHtml(s.name)}</div>
          <div class="klass">${escapeHtml(s.klass)} · <span class="mono">${AUTO_LOGOUT_MIN}m</span> auto</div>
        </div>
        <button class="btnGhost" id="btnLogout">${escapeHtml(t("logout"))}</button>
      </div>

      <div class="hdr" style="padding-top:14px">
        <p class="brand" style="margin-bottom:4px">${escapeHtml(t("dashTitle"))}</p>
        <p class="sub">${escapeHtml(t("dashSub"))}</p>
      </div>

      <div class="gridBtns">
        <button class="btn btnPrimary" id="goSnu">${escapeHtml(t("snu"))}</button>
        <button class="btn btnGreen" id="goTopik1">${escapeHtml(t("topik1"))}</button>
        <button class="btn btnAmber" id="goTopik2">${escapeHtml(t("topik2"))}</button>
      </div>

      <div class="smallRow">
        <div class="pill"><span>${escapeHtml(t("pillName"))}</span><b>${escapeHtml(s.name)}</b></div>
        <div class="pill"><span>${escapeHtml(t("pillKlass"))}</span><b>${escapeHtml(s.klass)}</b></div>
      </div>

      <div class="footerMini">
        ${escapeHtml(t("footer"))}
      </div>
    `;

    bindTopBar(renderDashboard);

    document.getElementById("btnLogout").addEventListener("click", async () => {
      const ss = readSession();
      if (ss) await sendSessionEnd(ss, "manual");
      clearSession();
      renderLogin();
    });

    document.getElementById("goSnu").addEventListener("click", () => nav(PATHS.SNU));
    document.getElementById("goTopik1").addEventListener("click", () => nav(PATHS.TOPIK1));
    document.getElementById("goTopik2").addEventListener("click", () => nav(PATHS.TOPIK2));

    function nav(path){
      updateLastActive();
      const ss = readSession();
      const url = buildUrlWithParams(path, {
        name: ss.name,
        klass: ss.klass,
        token: ss.token,
        lang: getLang()
      });
      location.href = url;
    }
  }

  // ===== 자동 로그아웃(30분 미사용) =====
  let inactivityTimer = null;
  const activityEvents = ["pointerdown","pointermove","keydown","scroll","touchstart","click"];

  function resetInactivity(){
    const s = readSession();
    if (!s) return;
    updateLastActive();
    if (inactivityTimer) clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
      const ss = readSession();
      if (ss && isExpired(ss)){
        (async () => {
          await sendSessionEnd(ss, "timeout");
          clearSession();
          renderLogin();
        })();
      }
    }, (AUTO_LOGOUT_MIN * 60 * 1000) + 500);
  }

  activityEvents.forEach(evt => {
    window.addEventListener(evt, () => {
      const s = readSession();
      if (!s) return;
      resetInactivity();
    }, {passive:true});
  });

  // 추가 안전: 10초마다 만료 체크
  setInterval(() => {
    const s = readSession();
    if (!s) return;
    if (isExpired(s)){
      (async () => {
        await sendSessionEnd(s, "timeout");
        clearSession();
        renderLogin();
      })();
    }
  }, 10_000);

  // ===== Boot =====
  document.documentElement.lang = getLang();
  const s = readSession();
  if (s && !isExpired(s)){
    resetInactivity();
    renderDashboard();
  }else{
    clearSession();
    renderLogin();
  }
})();
</script>
</body>
</html>
