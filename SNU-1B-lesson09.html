<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>1B · 9-р хичээл · Үгийн тест</title>

  <style>
    :root{
      --bg:#f0f4f8; --card:#ffffff; --primary:#2d6cdf; --primary2:#1f4ea5;
      --text:#223047; --muted:#6a7a8e; --line:#d9e4f5;
      --warnbg:#fff5f5; --warnline:#feb2b2; --warntext:#7a1f1f;
      --ok:#0f7a3d; --bad:#c0392b; --orange:#e67e22;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:20px; font-family:Arial,sans-serif; background:var(--bg); color:var(--text); text-align:center;}
    .container{max-width:560px; margin:0 auto; background:var(--card); padding:26px; border-radius:20px; border:1px solid var(--line); box-shadow:0 10px 20px rgba(0,0,0,0.08);}
    h1{margin:0; font-size:22px; color:#1f2f45;}
    .topline{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:10px; flex-wrap:wrap;}
    .badge{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #d7dee7; background:#f6f9ff; font-size:12px; font-weight:900; color:#2c3e50;}
    .nameBox{font-size:14px; color:#4b5b6f; text-align:left;}
    .nameBox b{color:#1f2f45;}
    .btn{width:100%; background:var(--primary); color:#fff; padding:14px 12px; border:none; border-radius:12px; cursor:pointer; font-size:16px; font-weight:900; transition:.2s;}
    .btn:hover{background:var(--primary2);}
    .btnGray{background:#eef2f7; color:#223047; border:1px solid #d7dee7;}
    .btnGray:hover{background:#e2e8f0;}
    .btnRow{display:flex; gap:10px; margin-top:14px;}
    .qno{margin-top:14px; color:var(--primary); font-weight:900; font-size:15px;}
    .inst{margin-top:10px; background:#eef2f7; border:1px solid #d7dee7; padding:10px; border-radius:10px; color:#223047; font-size:14px;}
    .question{margin:18px 0 10px; font-size:34px; font-weight:900; color:#1f2f45; word-break:keep-all;}
    .choice{
      width:100%; margin:10px 0; padding:14px 12px; border-radius:12px;
      border:2px solid var(--primary); background:#fff; color:#223047;
      font-size:18px; font-weight:900; cursor:pointer; transition:.15s;
      white-space:pre-wrap;
    }
    .choice:hover{background:var(--primary); color:#fff;}
    .hidden{display:none;}
    .warn{margin-top:14px; background:var(--warnbg); border:1px solid var(--warnline); border-radius:12px; padding:12px; color:var(--warntext); font-size:14px; line-height:1.45; text-align:left;}
    .panel{margin-top:16px; padding:14px; border:1px solid var(--line); border-radius:14px; background:#fff; text-align:left;}
    .score{font-size:26px; font-weight:900; color:var(--bad); margin:10px 0;}
    .wrongList{max-height:300px; overflow:auto; padding:12px; border-radius:12px; border:1px solid var(--warnline); background:var(--warnbg);}
    .wrongItem{padding:8px 0; border-bottom:1px dashed var(--warnline); font-size:15px;}
    .wrongItem:last-child{border-bottom:none;}
    .note{margin-top:10px; color:var(--muted); font-size:13px; line-height:1.45;}
    .resultCard{border:2px solid #cfe0ff; background:#f6f9ff; border-radius:14px; padding:14px; margin-top:14px; text-align:left;}
    .resultCard p{margin:8px 0; font-size:15px; line-height:1.55;}
    .bigMsg{font-size:18px; font-weight:900;}
    .center{text-align:center;}
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; padding:18px;}
    .modal{max-width:560px; width:100%; background:#fff; border-radius:16px; padding:16px; border:1px solid #d7dee7; box-shadow:0 10px 25px rgba(0,0,0,0.18); text-align:left;}
    .modal h2{margin:0; font-size:18px; color:#1f2f45;}
    .modal p{margin:10px 0; color:#223047; line-height:1.55; font-size:14px;}
  </style>
</head>

<body>
<div class="container">
  <div class="topline">
    <div class="nameBox">
      <div><span class="badge">1B · 9-р хичээл</span></div>
      <div style="margin-top:6px;">Нэр: <b id="studentName">—</b></div>
      <div>Анги: <b id="klassName">—</b></div>
    </div>
    <button class="btn btnGray" onclick="goHome()">Эхлэл</button>
  </div>

  <div id="errorSection" class="warn hidden"></div>

  <div id="quizSection" class="hidden">
    <div class="qno" id="qno"></div>
    <div class="inst" id="inst"></div>
    <div class="question" id="qtext"></div>
    <div id="choices"></div>
    <div class="note">Санамж: Алдаа гаргасан үгсийг төгсгөлд нь дахин харуулна.</div>
  </div>

  <div id="reviewSection" class="hidden">
    <h1 style="color:var(--orange);">Алдаагаа шалгана уу</h1>
    <p class="note">Эдгээр үгсийг дахин хараад, дараа нь дахин оролдоно уу.</p>

    <div class="panel">
      <div class="score" id="reviewScore"></div>
      <div class="wrongList" id="wrongList"></div>
      <div class="note" id="attemptInfo"></div>

      <div class="btnRow">
        <button class="btn" style="background:var(--orange);" onclick="retry()">Дахин оролдох</button>
        <button class="btn btnGray" onclick="goHome()">Эхлэл</button>
      </div>
    </div>
  </div>

  <div id="resultSection" class="hidden">
    <h1 style="color:var(--ok);">Тэнцлээ!</h1>

    <div class="resultCard">
      <p class="bigMsg" id="resultLine1"></p>
      <p class="center"><span class="score" id="finalScore"></span></p>
      <p id="resultLine2"></p>
      <p id="resultDate"></p>
      <p style="margin-top:12px; font-weight:900; color:#1f2f45;">
        Энэ дэлгэцийг скриншот хийж багш руугаа илгээнэ үү.
      </p>
      <p class="note" id="logStatus"></p>
    </div>

    <div class="btnRow">
      <button class="btn" style="background:var(--ok);" onclick="captureOrHelp()">Капчер</button>
      <button class="btn btnGray" onclick="goHome()">Эхлэл</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeModal(event)">
  <div class="modal">
    <h2>Капчер/Скриншот хийх арга</h2>
    <p>
      <b>iPhone:</b> Талын товч + Дуу нэмэх товчийг зэрэг дарна уу.<br>
      <b>Android:</b> Асаах товч + Дуу хасах товчийг зэрэг дарна уу.
    </p>
    <p style="font-weight:900; color:#1f2f45;">Дараа нь багш руугаа илгээнэ үү.</p>
    <button class="btn btnGray" onclick="closeModal()">Хаах</button>
  </div>
</div>

<script>
/* Google Apps Script (샘플과 동일 구조 유지) */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBe6Y0W3IJKjWV8MLFnR5b9OMePDPHGVACPekJQpvLWRrlayRmHBJCezamKqN9rZg6/exec";

/* 1B · 9-р хичээл (PDF 정답지(암기용) 표기 그대로 46개) */
const rawWords = [
  { kor:"가족", mon:"гэр бүл", pos:"n" },
  { kor:"할머니", mon:"эмээ", pos:"n" },
  { kor:"할아버지", mon:"өвөө", pos:"n" },
  { kor:"누나", mon:"эгч (эрэгтэй хүнээс)", pos:"n" },
  { kor:"형", mon:"ах (эрэгтэй хүнээс)", pos:"n" },
  { kor:"언니", mon:"эгч (эмэгтэй хүнээс)", pos:"n" },
  { kor:"여동생", mon:"дүү охин", pos:"n" },
  { kor:"남동생", mon:"дүү хүү", pos:"n" },
  { kor:"아내", mon:"эхнэр", pos:"n" },
  { kor:"남편", mon:"нөхөр", pos:"n" },
  { kor:"딸", mon:"охин", pos:"n" },
  { kor:"아들", mon:"хүү", pos:"n" },
  { kor:"살(나이 단위)", mon:"настай (насны нэгж)", pos:"n" },
  { kor:"스물", mon:"хорин", pos:"n" },
  { kor:"서른", mon:"гучин", pos:"n" },
  { kor:"마흔", mon:"дөчин", pos:"n" },
  { kor:"쉰", mon:"тавин", pos:"n" },
  { kor:"예순", mon:"жаран", pos:"n" },
  { kor:"일흔", mon:"далан", pos:"n" },
  { kor:"여든", mon:"наян", pos:"n" },
  { kor:"아흔", mon:"ерэн", pos:"n" },
  { kor:"백", mon:"зуу", pos:"n" },
  { kor:"나이", mon:"нас", pos:"n" },
  { kor:"연세", mon:"нас (хүндэтгэлийн)", pos:"n" },
  { kor:"드시다", mon:"идэх/уух\n(хүндэтгэлийн)", pos:"v" },
  { kor:"분(사람 단위)", mon:"хүн (тоо хэмжүүр)", pos:"n" },
  { kor:"성함", mon:"нэр\n(хүндэтгэлийн)", pos:"n" },
  { kor:"계시다", mon:"байх\n(хүндэтгэлийн)", pos:"v" },
  { kor:"주무시다", mon:"унтах\n(хүндэтгэлийн)", pos:"v" },
  { kor:"댁", mon:"гэр (хүндэтгэлийн)", pos:"n" },
  { kor:"쪽(방향)", mon:"тал (чиглэл)", pos:"n" },
  { kor:"동아리", mon:"дугуйлан (клуб)", pos:"n" },
  { kor:"같은 과", mon:"ижил анги/салбар", pos:"n" },
  { kor:"역사", mon:"түүх", pos:"n" },
  { kor:"수영", mon:"усанд сэлэлт", pos:"n" },
  { kor:"회사에 다니다", mon:"компанид\nажилдаа явах\n(ажиллах)", pos:"v" },
  { kor:"신문사", mon:"сонины газар\n(хэвлэлийн газар)", pos:"n" },
  { kor:"중학교", mon:"дунд сургууль", pos:"n" },
  { kor:"소개하다", mon:"танилцуулах", pos:"v" },
  { kor:"모두", mon:"бүгд", pos:"n" },
  { kor:"항상", mon:"үргэлж", pos:"o" },
  { kor:"웃으시다", mon:"инээх\n(хүндэтгэлийн)", pos:"v" },
  { kor:"친절하다", mon:"найрсаг", pos:"a" },
  { kor:"대학생", mon:"их сургуулийн\nоюутан", pos:"n" },
  { kor:"사랑하다", mon:"хайрлах", pos:"v" },
  { kor:"주부", mon:"гэрийн эзэгтэй", pos:"n" }
];

/* Guards: 언어 섞임 최소화(경고만) */
const reKorean = /[ㄱ-ㅎㅏ-ㅣ가-힣]/;
const reCyrillic = /[\u0400-\u04FF]/;
for(const w of rawWords){
  if(reKorean.test(w.mon)) console.warn("MN contains Korean:", w);
  if(reCyrillic.test(w.kor)) console.warn("KO contains Cyrillic:", w);
}

/* Utils */
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Date.now()+"_"+Math.floor(Math.random()*10000);
    window[cb]=(data)=>{ resolve(data); script.remove(); delete window[cb]; };
    const script=document.createElement("script");
    script.src=url+(url.includes("?")?"&":"?")+"callback="+cb;
    script.onerror=()=>{ reject(new Error("jsonp_error")); script.remove(); delete window[cb]; };
    document.body.appendChild(script);
  });
}
function getDeviceId(){
  const k="kquiz_deviceId";
  let id=localStorage.getItem(k);
  if(!id){
    id=(crypto&&crypto.randomUUID)?crypto.randomUUID():(Date.now()+"_"+Math.random()).replace(".","");
    localStorage.setItem(k,id);
  }
  return id;
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/* Always 4 choices (샘플 로직 그대로) */
function buildChoices({answer, type, pos}){
  const pick = (w) => (type==="kor" ? w.mon : w.kor);
  const samePos = rawWords.filter(w => w.pos === pos);
  const candSame = samePos.map(pick).filter(x => x && x !== answer);
  const candAll  = rawWords.map(pick).filter(x => x && x !== answer);

  const set = new Set([answer]);
  for(const c of shuffle(candSame)){ set.add(c); if(set.size>=4) break; }
  if(set.size<4){
    for(const c of shuffle(candAll)){ set.add(c); if(set.size>=4) break; }
  }
  let list=Array.from(set);
  while(list.length<4) list.push(answer);
  return shuffle(list.slice(0,4));
}

/* State */
const lessonId = "SNU-1B-lesson09";
let name="", klass="", token="", deviceId="";
let attempts=0;
let questions=[], idx=0, score=0, wrong=[];

/* DOM */
const studentNameEl = document.getElementById("studentName");
const klassNameEl = document.getElementById("klassName");
const errorSection = document.getElementById("errorSection");
const quizSection = document.getElementById("quizSection");
const reviewSection = document.getElementById("reviewSection");
const resultSection = document.getElementById("resultSection");
const qnoEl = document.getElementById("qno");
const instEl = document.getElementById("inst");
const qtextEl = document.getElementById("qtext");
const choicesEl = document.getElementById("choices");
const reviewScoreEl = document.getElementById("reviewScore");
const wrongListEl = document.getElementById("wrongList");
const attemptInfoEl = document.getElementById("attemptInfo");
const resultLine1El = document.getElementById("resultLine1");
const finalScoreEl = document.getElementById("finalScore");
const resultLine2El = document.getElementById("resultLine2");
const resultDateEl = document.getElementById("resultDate");
const logStatusEl = document.getElementById("logStatus");
const overlay = document.getElementById("overlay");

/* Helpers */
function showError(msg){
  errorSection.textContent = msg;
  errorSection.classList.remove("hidden");
  quizSection.classList.add("hidden");
  reviewSection.classList.add("hidden");
  resultSection.classList.add("hidden");
}
function getParams(){
  const p = new URLSearchParams(location.search);
  return {
    name:(p.get("name")||"").trim(),
    klass:(p.get("klass")||"").trim(),
    token:(p.get("token")||"").trim()
  };
}
async function validateToken(){
  const cached = sessionStorage.getItem("result_"+token);
  if(cached) return true;
  const url = `${SCRIPT_URL}?action=validate&token=${encodeURIComponent(token)}&deviceId=${encodeURIComponent(deviceId)}&klass=${encodeURIComponent(klass)}&name=${encodeURIComponent(name)}`;
  const res = await jsonp(url);
  return !!(res && res.ok);
}

/* Attempts (per student) */
function loadAttempts(){
  const k = `attempts_${lessonId}_${name}`;
  attempts = parseInt(localStorage.getItem(k)||"0",10) || 0;
}
function saveAttempts(){
  const k = `attempts_${lessonId}_${name}`;
  localStorage.setItem(k, String(attempts));
}
function clearAttempts(){
  const k = `attempts_${lessonId}_${name}`;
  localStorage.removeItem(k);
}

/* Quiz */
function prepareQuestions(){
  const shuffled = shuffle(rawWords);
  questions = shuffled.map(w=>{
    const isKorQuestion = Math.random()<0.5;
    const q = isKorQuestion ? w.kor : w.mon;
    const a = isKorQuestion ? w.mon : w.kor;
    const type = isKorQuestion ? "kor" : "mon";
    return { q,a,type,pos:w.pos, choices: buildChoices({answer:a, type, pos:w.pos}) };
  });
  idx=0; score=0; wrong=[];
}
function showQuiz(){
  errorSection.classList.add("hidden");
  reviewSection.classList.add("hidden");
  resultSection.classList.add("hidden");
  quizSection.classList.remove("hidden");
  showQuestion();
}
function showQuestion(){
  if(idx>=questions.length){ finish(); return; }
  const item = questions[idx];
  qnoEl.textContent = `${idx+1} / ${questions.length}`;
  instEl.textContent = (item.type==="kor") ? "Зөв монгол утгыг сонгоно уу." : "Зөв солонгос үгийг сонгоно уу.";
  qtextEl.textContent = item.q;
  choicesEl.innerHTML="";
  item.choices.forEach(c=>{
    const btn=document.createElement("button");
    btn.className="choice";
    btn.textContent=c;
    btn.onclick=()=>answer(c);
    choicesEl.appendChild(btn);
  });
}
function answer(choice){
  const item=questions[idx];
  if(choice===item.a){ score += (100/questions.length); }
  else{ wrong.push(item); }
  idx++;
  showQuestion();
}
function finish(){
  attempts++;
  saveAttempts();
  const finalScore=Math.round(score);
  if(finalScore>=80 || attempts>=5) showResult(finalScore);
  else showReview(finalScore);
}
function showReview(finalScore){
  quizSection.classList.add("hidden");
  resultSection.classList.add("hidden");
  reviewSection.classList.remove("hidden");
  reviewScoreEl.innerHTML = `Таны дүн: <b style="color:var(--bad);">${finalScore} оноо</b>`;
  attemptInfoEl.textContent = `Оролдлого: ${attempts} (5 удаа хүрвэл автоматаар тэнцэнэ)`;
  wrongListEl.innerHTML="";
  wrong.forEach(w=>{
    const div=document.createElement("div");
    div.className="wrongItem";
    div.innerHTML = `❓ <b>${escapeHtml(w.q)}</b> → ✅ <b>${escapeHtml(w.a)}</b>`;
    wrongListEl.appendChild(div);
  });
}

/* Log to sheet (샘플과 동일 JSONP 방식) */
async function sendLog(finalScore){
  try{
    const ua = navigator.userAgent || "";
    const url =
      `${SCRIPT_URL}?action=log` +
      `&token=${encodeURIComponent(token)}` +
      `&deviceId=${encodeURIComponent(deviceId)}` +
      `&book=${encodeURIComponent("SNU")}` +
      `&lesson=${encodeURIComponent("1B-lesson09")}` +
      `&score=${encodeURIComponent(String(finalScore))}` +
      `&attempts=${encodeURIComponent(String(attempts))}` +
      `&ua=${encodeURIComponent(ua)}`;
    const res = await jsonp(url);
    if(res && res.ok){
      logStatusEl.textContent = "Бүртгэл амжилттай илгээгдлээ.";
      sessionStorage.setItem("result_"+token, JSON.stringify({ name, klass, finalScore, attempts, t: Date.now() }));
    }else{
      logStatusEl.textContent = "Бүртгэл илгээхэд алдаа гарлаа. Дахин оролдоно уу.";
    }
  }catch(e){
    logStatusEl.textContent = "Бүртгэл илгээхэд алдаа гарлаа. Дахин оролдоно уу.";
  }
}

async function showResult(finalScore){
  quizSection.classList.add("hidden");
  reviewSection.classList.add("hidden");
  resultSection.classList.remove("hidden");
  clearAttempts();

  resultLine1El.textContent = `${name}, баяр хүргэе!`;
  finalScoreEl.textContent = `Дүн: ${finalScore} оноо`;
  resultLine2El.textContent = `Оролдлого: ${attempts}`;

  const now = new Date();
  const fmt = new Intl.DateTimeFormat("mn-MN", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  resultDateEl.textContent = `Огноо: ${fmt.format(now)}`;

  logStatusEl.textContent = "Бүртгэл илгээж байна...";
  await sendLog(finalScore);
}

/* Buttons */
function retry(){ prepareQuestions(); showQuiz(); }
function goHome(){ location.href = `index.html?v=${Date.now()}`; }

/* Capture (share -> fallback modal) */
async function captureOrHelp(){
  const now = new Date();
  const fmt = new Intl.DateTimeFormat("mn-MN", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  const summary =
`[SNU-1B-lesson09]
Name: ${name}
Class: ${klass}
Score: ${Math.round(score)}
Attempts: ${attempts}
Date: ${fmt.format(now)}
Token: ${token}`;

  if(navigator.share){
    try{
      await navigator.share({ text: summary });
      return;
    }catch(e){}
  }
  openScreenshotHelp();
}

/* Screenshot help modal */
function openScreenshotHelp(){ overlay.style.display="flex"; }
function closeModal(e){
  if(e && e.target && e.target !== overlay) return;
  overlay.style.display="none";
}

/* Init */
(async function init(){
  const p=getParams();
  name=p.name; klass=p.klass; token=p.token;
  deviceId=getDeviceId();

  studentNameEl.textContent = name || "—";
  klassNameEl.textContent = klass || "—";

  if(!name || !klass || !token){
    showError("Нэвтрэх мэдээлэл дутуу байна. Эхлэл хуудас руу буцаад дахин нэвтэрнэ үү.");
    return;
  }

  const cached = sessionStorage.getItem("result_"+token);
  if(cached){
    try{
      const obj = JSON.parse(cached);
      attempts = obj.attempts || 0;
      await showResult(obj.finalScore || 0);
      return;
    }catch(e){}
  }

  try{
    const ok = await validateToken();
    if(!ok){
      showError("Энэ холбоос хүчинтэй биш байна. Эхлэл хуудас руу буцаад дахин нэвтэрнэ үү.");
      return;
    }
  }catch(e){
    showError("Сервертэй холбогдож чадсангүй. Дахин оролдоно уу.");
    return;
  }

  loadAttempts();
  prepareQuestions();
  showQuiz();
})();
</script>
</body>
</html>
