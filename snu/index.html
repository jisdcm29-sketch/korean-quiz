<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SNU</title>
  <style>
    :root{
      --bg:#0b1220;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--line:#243044;
      --accent:#60a5fa;
    }
    *{box-sizing:border-box}
    html,body{overflow-x:hidden}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif;
      background:linear-gradient(180deg,#050814,var(--bg));
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}

    /* ===== Topbar ===== */
    .topbar{
      position:sticky;top:0;z-index:50;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 12px;
      background:rgba(5,8,20,.78);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
    .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:#0b1020;color:var(--muted);font-size:13px
    }

    /* ✅ 버튼(뒤로 / 언어 / 홈) 크게 + 선명한 색상 */
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      border-radius:16px;border:1px solid var(--line);
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      min-height:46px;
      padding:12px 16px;
      font-size:16px;
      font-weight:900;
      color:var(--text);
      background:#0b1020;
      white-space:nowrap;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btnBack{
      background:linear-gradient(135deg,rgba(96,165,250,.22), rgba(11,16,32,.95));
      border-color:rgba(96,165,250,.55);
    }
    .btnLang{
      background:linear-gradient(135deg,rgba(52,211,153,.20), rgba(11,16,32,.95));
      border-color:rgba(52,211,153,.55);
    }
    .btnHome{
      background:linear-gradient(135deg,rgba(248,113,113,.18), rgba(11,16,32,.95));
      border-color:rgba(248,113,113,.48);
      text-decoration:none;
    }

    /* ===== Layout ===== */
    .container{max-width:980px;margin:0 auto;padding:12px}
    .card{
      background:rgba(17,24,39,.9);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .muted{color:var(--muted);line-height:1.6}
    .small{font-size:12px}
    .bar{height:1px;background:var(--line);margin:12px 0}
    .hidden{display:none !important;}

    /* ===== Tiles ===== */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
      margin-top:12px;
    }
    .tile{
      display:flex;align-items:center;justify-content:center;
      text-align:center;
      padding:18px 14px;
      border-radius:18px;
      border:1px solid var(--line);
      background:#0b1020;
      min-height:90px;
      -webkit-tap-highlight-color:transparent;
    }
    .tile:hover{filter:brightness(1.06)}
    .tileInner{width:100%}
    .tileTitle{
      font-size:22px;
      font-weight:950;
      line-height:1.1;
      text-align:center;
      letter-spacing:.2px;
    }
    .tileMeta{
      font-size:12px;
      margin-top:6px;
      color:rgba(229,231,235,.78);
      text-align:center;
    }

    /* 교재(책)별 색상 */
    .bk-1a{background:linear-gradient(135deg,rgba(96,165,250,.18), rgba(11,16,32,.96));border-color:rgba(96,165,250,.42);}
    .bk-1b{background:linear-gradient(135deg,rgba(52,211,153,.18), rgba(11,16,32,.96));border-color:rgba(52,211,153,.42);}
    .bk-2a{background:linear-gradient(135deg,rgba(251,191,36,.16), rgba(11,16,32,.96));border-color:rgba(251,191,36,.38);}
    .bk-2b{background:linear-gradient(135deg,rgba(248,113,113,.14), rgba(11,16,32,.96));border-color:rgba(248,113,113,.34);}
    .bk-3a{background:linear-gradient(135deg,rgba(167,139,250,.16), rgba(11,16,32,.96));border-color:rgba(167,139,250,.38);}
    .bk-3b{background:linear-gradient(135deg,rgba(34,211,238,.14), rgba(11,16,32,.96));border-color:rgba(34,211,238,.34);}
    .bk-4a{background:linear-gradient(135deg,rgba(244,114,182,.14), rgba(11,16,32,.96));border-color:rgba(244,114,182,.34);}
    .bk-4b{background:linear-gradient(135deg,rgba(156,163,175,.14), rgba(11,16,32,.96));border-color:rgba(156,163,175,.34);}

    /* 레슨 버튼도 선명하게 */
    .lessonBtn{
      display:flex;align-items:center;justify-content:center;
      width:100%;
      padding:18px 12px;
      border-radius:18px;
      border:1px solid var(--line);
      background:linear-gradient(135deg,rgba(96,165,250,.12), rgba(11,16,32,.96));
      border-color:rgba(96,165,250,.30);
      color:var(--text);
      text-align:center;
      font-weight:950;
      font-size:18px;
      min-height:66px;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      white-space:nowrap;
    }
    .lessonBtn:hover{filter:brightness(1.06)}
    .lessonBtn:active{transform:translateY(1px)}

    .err{
      border:1px solid rgba(248,113,113,.35);
      background:rgba(248,113,113,.06);
      padding:12px;border-radius:14px;
      margin-top:12px;
      color:#ffd6d6;
      white-space:pre-wrap;
    }

    @media (min-width: 700px){
      .grid{grid-template-columns:repeat(4,1fr)}
    }

    /* ✅ 모바일에서 버튼을 “2배 느낌”으로 더 크게 */
    @media (max-width: 520px){
      .container{padding:10px}
      .card{padding:12px}

      .right .pill{display:none} /* 모바일에서는 pill 숨겨서 공간 확보 */

      .btn{
        min-height:54px;
        padding:14px 18px;
        font-size:18px;
        border-radius:18px;
      }

      .tile{padding:18px 12px;min-height:94px}
      .tileTitle{font-size:24px}
      .tileMeta{font-size:12px;margin-top:5px}

      .lessonBtn{
        min-height:70px;
        font-size:19px;
        padding:18px 10px;
      }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <span class="dot"></span>
      <a id="brandLink" href="../index.html">Korean Quiz</a>
    </div>

    <div class="right">
      <span class="pill" id="pillName">학습자: -</span>
      <span class="pill" id="pillToken">token: -</span>

      <button class="btn btnBack" id="btnBack" type="button">←</button>
      <button class="btn btnLang" id="btnLang" type="button">KR</button>
      <a class="btn btnHome" id="btnHome" href="../index.html">홈</a>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-end">
        <div>
          <div class="muted" id="subtitle" style="font-weight:900;color:var(--text);font-size:16px;">
            교재 선택 → 해당 교재 과만 표시
          </div>
          <div class="muted small" id="help" style="margin-top:6px;">교재를 먼저 고르세요.</div>
        </div>
        <div class="muted small" id="status"></div>
      </div>

      <div class="bar"></div>

      <!-- BOOKS -->
      <div id="bookWrap">
        <div class="grid" id="bookGrid"></div>
      </div>

      <!-- LESSONS -->
      <div id="lessonWrap" class="hidden">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
          <div>
            <div class="muted small" id="pickedLabel">선택됨</div>
            <div style="font-weight:950;font-size:22px;margin-top:4px;text-align:left" id="pickedBook">-</div>
            <div class="muted small" id="pickedSub" style="margin-top:2px;"></div>
          </div>
          <button class="btn" id="btnReset" type="button">교재 다시 선택</button>
        </div>
        <div class="grid" id="lessonGrid"></div>
      </div>

      <div id="errBox" class="err hidden"></div>
    </section>
  </main>

  <script>
    const I18N = {
      KR: {
        home: "홈",
        loading: "불러오는 중...",
        loaded: "로드 완료",
        subtitle: "교재 선택 → 해당 교재 과만 표시",
        help: "교재를 먼저 고르세요.",
        picked: "선택됨",
        reset: "교재 다시 선택",
        learner: "학습자: ",
        books: "교재"
      },
      MN: {
        home: "Нүүр",
        loading: "Ачаалж байна...",
        loaded: "Ачааллаа",
        subtitle: "Ном сонгох → тухайн номын хичээлүүдийг л харуулна",
        help: "Эхлээд ном сонгоно уу.",
        picked: "Сонгосон",
        reset: "Ном дахин сонгох",
        learner: "Сурагч: ",
        books: "Ном"
      }
    };

    function getLang(){
      const u = new URL(location.href);
      const q = (u.searchParams.get("lang")||"").toUpperCase();
      const s = (localStorage.getItem("kq_lang")||localStorage.getItem("lang")||"").toUpperCase();
      const pick = (q==="MN"||q==="KR") ? q : s;
      return (pick==="MN") ? "MN" : "KR";
    }
    function setLang(l){
      localStorage.setItem("kq_lang", l);
      localStorage.setItem("lang", l);
    }
    function tr(k){
      const L = getLang();
      return (I18N[L] && I18N[L][k]) ? I18N[L][k] : (I18N.KR[k] || k);
    }

    function getParam(k){
      const u = new URL(location.href);
      return u.searchParams.get(k) || "";
    }
    function passthroughQS(){
      const u = new URL(location.href);
      const p = new URLSearchParams();
      ["name","klass","token","lang"].forEach(k=>{
        const v = u.searchParams.get(k);
        if(v) p.set(k, v);
      });
      if(!p.get("lang")) p.set("lang", getLang());
      return p.toString();
    }
    function withQS(url){
      const qs = passthroughQS();
      return url + (url.includes("?") ? "&" : "?") + qs;
    }

    const brandLink = document.getElementById("brandLink");
    const btnHome = document.getElementById("btnHome");
    const btnLang = document.getElementById("btnLang");
    const btnBack = document.getElementById("btnBack");
    const statusEl = document.getElementById("status");
    const subtitleEl = document.getElementById("subtitle");
    const helpEl = document.getElementById("help");
    const pillName = document.getElementById("pillName");
    const pillToken = document.getElementById("pillToken");

    const bookWrap = document.getElementById("bookWrap");
    const bookGrid = document.getElementById("bookGrid");
    const lessonWrap = document.getElementById("lessonWrap");
    const lessonGrid = document.getElementById("lessonGrid");
    const pickedLabel = document.getElementById("pickedLabel");
    const pickedBook = document.getElementById("pickedBook");
    const pickedSub = document.getElementById("pickedSub");
    const btnReset = document.getElementById("btnReset");
    const errBox = document.getElementById("errBox");

    let MANIFEST = null;
    let PICKED = null;

    function showErr(msg){
      errBox.textContent = msg;
      errBox.classList.remove("hidden");
    }
    function clearErr(){
      errBox.classList.add("hidden");
      errBox.textContent = "";
    }

    function bookCss(id){
      const s = String(id||"").toLowerCase();
      if(s==="1a") return "bk-1a";
      if(s==="1b") return "bk-1b";
      if(s==="2a") return "bk-2a";
      if(s==="2b") return "bk-2b";
      if(s==="3a") return "bk-3a";
      if(s==="3b") return "bk-3b";
      if(s==="4a") return "bk-4a";
      if(s==="4b") return "bk-4b";
      return "";
    }

    function applyTop(){
      const qs = passthroughQS();
      brandLink.href = "../index.html" + (qs ? "?" + qs : "");
      btnHome.href = "../index.html" + (qs ? "?" + qs : "");
      btnHome.textContent = tr("home");
      btnLang.textContent = getLang();

      subtitleEl.textContent = tr("subtitle");
      helpEl.textContent = tr("help");
      pickedLabel.textContent = tr("picked");
      btnReset.textContent = tr("reset");

      const name = getParam("name") || "-";
      const token = getParam("token") || "-";
      pillName.textContent = tr("learner") + name;
      pillToken.textContent = "token: " + token;

      document.documentElement.lang = (getLang()==="MN") ? "mn" : "ko";
    }

    function backToBooks(){
      PICKED = null;
      lessonWrap.classList.add("hidden");
      bookWrap.classList.remove("hidden");
      helpEl.classList.remove("hidden");
    }

    function renderBooks(){
      bookGrid.innerHTML = "";
      if(!MANIFEST || !Array.isArray(MANIFEST.books)) return;

      MANIFEST.books.forEach(b=>{
        const a = document.createElement("a");
        a.className = "tile " + bookCss(b.id);
        a.href = "javascript:void(0)";
        a.innerHTML = `
          <div class="tileInner">
            <div class="tileTitle">${(b.id||"").toUpperCase()}</div>
            <div class="tileMeta">${b.subtitle || ""}</div>
          </div>
        `;
        a.addEventListener("click", ()=>{
          PICKED = b;
          renderLessons();
        });
        bookGrid.appendChild(a);
      });
    }

    function renderLessons(){
      if(!PICKED) return;

      pickedBook.textContent = (PICKED.id || "").toUpperCase();
      pickedSub.textContent = PICKED.subtitle || "";

      lessonGrid.innerHTML = "";
      const lessons = Array.isArray(PICKED.lessons) ? PICKED.lessons : [];

      lessons.forEach(ls=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "lessonBtn";
        btn.textContent = (ls.label || (ls.no ? (ls.no + "과") : "레슨"));

        btn.addEventListener("click", ()=>{
          const u = new URL("./lesson.html", location.href);

          // data 경로는 manifest 값 그대로 넣되, URL에 맞게 자동 인코딩
          // (lesson.html 쪽에서 new URL(data, location.href)로 처리 가능)
          u.searchParams.set("data", ls.data);

          // name/klass/token/lang 전달
          const p = new URLSearchParams(passthroughQS());
          p.forEach((v,k)=>{
            if(k !== "data") u.searchParams.set(k, v);
          });

          location.href = u.toString();
        });

        lessonGrid.appendChild(btn);
      });

      bookWrap.classList.add("hidden");
      lessonWrap.classList.remove("hidden");
      helpEl.classList.add("hidden");
    }

    btnReset.addEventListener("click", backToBooks);

    btnBack.addEventListener("click", ()=>{
      // 레슨 목록 화면이면 → 교재 목록으로
      if(!lessonWrap.classList.contains("hidden")){
        backToBooks();
        return;
      }
      // 교재 목록 화면이면 → 이전 페이지(없으면 홈)
      if(history.length > 1) history.back();
      else location.href = withQS("../index.html");
    });

    btnLang.addEventListener("click", ()=>{
      const next = (getLang()==="KR") ? "MN" : "KR";
      setLang(next);
      applyTop();
    });

    async function loadManifest(){
      clearErr();
      applyTop();
      statusEl.textContent = tr("loading");

      try{
        const url = new URL("../data/snu/manifest.json", location.href).toString();
        const res = await fetch(url, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status + "\n" + url);
        MANIFEST = await res.json();

        statusEl.textContent = tr("loaded");
        renderBooks();
      }catch(e){
        statusEl.textContent = "오류";
        showErr("manifest.json을 불러오지 못했습니다.\n" + (e.message || e));
      }
    }

    loadManifest();
  </script>
</body>
</html>
