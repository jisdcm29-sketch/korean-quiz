<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SNU Hub</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --text:#eaf0ff;
      --muted:#a9b6d6;
      --line:rgba(255,255,255,.10);
      --accent:#7aa2ff;
      --btn:#1b2a4a;
      --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:linear-gradient(180deg,#060a14, var(--bg));
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 40px}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{font-size:18px;margin:0}
    .title .sub{font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding:8px 10px;border-radius:999px;
      color:var(--muted);font-size:12px;
      max-width:70vw;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      appearance:none;border:1px solid var(--line);
      background:var(--btn);color:var(--text);
      padding:10px 12px;border-radius:12px;
      font-size:14px;cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent}
    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (min-width:760px){
      .grid{grid-template-columns:repeat(4,minmax(0,1fr))}
    }
    .book{
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      cursor:pointer;
      min-height:88px;
      display:flex;flex-direction:column;justify-content:space-between;gap:10px;
      user-select:none;
    }
    .book.active{outline:2px solid rgba(122,162,255,.55)}
    .book .k{font-size:16px;font-weight:700}
    .book .m{font-size:12px;color:var(--muted)}
    .panel{
      margin-top:12px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
    }
    .panelHead{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      border-bottom:1px solid var(--line);
    }
    .panelHead .left{display:flex;flex-direction:column;gap:2px}
    .panelHead .left .h{font-size:15px;font-weight:700}
    .panelHead .left .s{font-size:12px;color:var(--muted)}
    .lessons{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      padding:12px;
    }
    @media (min-width:760px){
      .lessons{grid-template-columns:repeat(4,minmax(0,1fr))}
    }
    .lesson{
      background:rgba(15,23,48,.55);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      display:flex;flex-direction:column;gap:8px;
      cursor:pointer;
      text-decoration:none;color:inherit;
      min-height:78px;
    }
    .lesson:hover{border-color:rgba(122,162,255,.45)}
    .lesson .n{font-weight:800;font-size:14px}
    .lesson .t{font-size:12px;color:var(--muted);line-height:1.2}
    .warn{
      margin-top:12px;
      border:1px solid rgba(255,107,107,.35);
      background:rgba(255,107,107,.08);
      color:#ffd6d6;
      padding:10px 12px;
      border-radius:14px;
      font-size:12px;
    }
    .footerNote{margin-top:14px;color:var(--muted);font-size:12px;line-height:1.4}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    a{color:inherit}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>ì„œìš¸ëŒ€ í•œêµ­ì–´ (ìƒˆ ë°©ì‹)</h1>
        <div class="sub">êµì¬ ì„ íƒ â†’ í•´ë‹¹ êµì¬ ê³¼ë§Œ í¼ì³ì§</div>
      </div>
      <div class="row">
        <button class="btn secondary" id="btnHome">í™ˆ</button>
      </div>
    </div>

    <div class="row" style="margin-bottom:8px">
      <div class="pill" id="who"></div>
      <div class="pill mono" id="params"></div>
    </div>

    <div class="grid" id="bookGrid"></div>

    <div class="panel" id="panel" style="display:none">
      <div class="panelHead">
        <div class="left">
          <div class="h" id="panelTitle">-</div>
          <div class="s" id="panelSub">-</div>
        </div>
        <div class="row">
          <button class="btn secondary" id="btnCollapse">ì ‘ê¸°</button>
        </div>
      </div>
      <div class="lessons" id="lessonGrid"></div>
    </div>

    <div class="warn" id="errBox" style="display:none"></div>

    <div class="footerNote">
      <div>â€¢ ë ˆìŠ¨ ë§í¬ëŠ” <span class="mono">/snu/lesson.html?data=...</span> í˜•íƒœë¡œ ìƒì„±ë©ë‹ˆë‹¤.</div>
      <div>â€¢ name/klass/token íŒŒë¼ë¯¸í„°ëŠ” ê·¸ëŒ€ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <script>
    // âœ… GitHub Pages(/korean-quiz/) / ë¡œì»¬ / ì„œë¸Œí´ë” ë“±ì—ì„œ manifest.jsonì„ ì•ˆì •ì ìœ¼ë¡œ ì°¾ê¸° ìœ„í•œ í›„ë³´ë“¤
    const MANIFEST_CANDIDATES = (function(){
      const path = location.pathname || "";
      const m = path.match(/^(.*)\/snu\/index\.html$/);
      const repoBase = m ? m[1] : ""; // ì˜ˆ: /korean-quiz
      const abs1 = new URL("../data/snu/manifest.json", location.href).toString(); // ìƒëŒ€ê²½ë¡œë¥¼ ì ˆëŒ€ URLë¡œ ë³€í™˜(ê°€ì¥ ì•ˆì „)
      const abs2 = repoBase ? (location.origin + repoBase + "/data/snu/manifest.json") : "";
      const abs3 = location.origin + "/data/snu/manifest.json"; // ë£¨íŠ¸ ë°°ì¹˜í•œ ê²½ìš° ëŒ€ë¹„
      const list = [abs1, abs2, abs3].filter(Boolean);
      return Array.from(new Set(list));
    })();

    function qs(k){ return new URLSearchParams(location.search).get(k) || ""; }
    function esc(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

    function buildCarryParams(){
      const name = qs("name");
      const klass = qs("klass");
      const token = qs("token");
      const p = new URLSearchParams();
      if(name) p.set("name", name);
      if(klass) p.set("klass", klass);
      if(token) p.set("token", token);
      const s = p.toString();
      return s ? ("&" + s) : "";
    }

    function goHome(){
      const carry = buildCarryParams().replace(/^&/,"");
      location.href = "../index.html" + (carry ? ("?" + carry) : "");
    }

    let manifest = null;
    let activeBookId = "";

    function setErr(msgHtml){
      const el = document.getElementById("errBox");
      el.style.display = "block";
      el.innerHTML = msgHtml;
    }

    function clearErr(){
      const el = document.getElementById("errBox");
      el.style.display = "none";
      el.innerHTML = "";
    }

    function setHeader(){
      const name = qs("name") || "í•™ìŠµì";
      const klass = qs("klass") || "-";
      document.getElementById("who").textContent = `ğŸ‘¤ ${name} / ${klass}`;
      const token = qs("token");
      document.getElementById("params").textContent = `token=${token ? token.slice(0,6)+"â€¦" : "-"}`;
    }

    function renderBooks(){
      const grid = document.getElementById("bookGrid");
      grid.innerHTML = "";
      (manifest.books||[]).forEach(b=>{
        const div = document.createElement("div");
        div.className = "book" + (b.id===activeBookId ? " active":"");
        div.innerHTML = `
          <div class="k">${esc(b.title || b.id)}</div>
          <div class="m">${esc(b.subtitle || ((b.lessons||[]).length + "ê³¼"))}</div>
        `;
        div.addEventListener("click", ()=>selectBook(b.id));
        grid.appendChild(div);
      });
    }

    function renderLessons(book){
      const panel = document.getElementById("panel");
      const lg = document.getElementById("lessonGrid");
      lg.innerHTML = "";
      document.getElementById("panelTitle").textContent = book.title || book.id;
      document.getElementById("panelSub").textContent =
        (book.subtitle || "") + (book.subtitle ? " Â· " : "") + ((book.lessons||[]).length + "ê³¼");

      const carry = buildCarryParams();
      (book.lessons||[]).forEach(ls=>{
        const a = document.createElement("a");
        a.className = "lesson";
        const dataPath = ls.data || "";
        a.href = `lesson.html?data=${encodeURIComponent(dataPath)}${carry}`;
        a.innerHTML = `
          <div class="n">${esc(ls.label || ("Lesson " + (ls.no||"")))}</div>
          <div class="t">${esc(ls.title || "")}</div>
        `;
        lg.appendChild(a);
      });

      panel.style.display = "block";
      panel.scrollIntoView({behavior:"smooth", block:"start"});
    }

    function selectBook(id){
      activeBookId = id;
      renderBooks();
      const book = (manifest.books||[]).find(b=>b.id===id);
      if(book) renderLessons(book);
    }

    async function loadManifest(){
      let lastErr = "";
      for(const url of MANIFEST_CANDIDATES){
        try{
          const r = await fetch(url, {cache:"no-store"});
          if(!r.ok) throw new Error("HTTP " + r.status + " (" + r.statusText + ")");
          const text = await r.text();
          let data;
          try{ data = JSON.parse(text); }
          catch(e){ throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨: " + (e && e.message ? e.message : e)); }
          return { data, url };
        }catch(e){
          lastErr = `- ì‹œë„ URL: ${url}\n  ì˜¤ë¥˜: ${(e && e.message) ? e.message : e}`;
        }
      }
      return { data:null, url:null, err:lastErr };
    }

    async function boot(){
      setHeader();
      document.getElementById("btnHome").addEventListener("click", goHome);
      document.getElementById("btnCollapse").addEventListener("click", ()=>{
        document.getElementById("panel").style.display = "none";
        activeBookId = "";
        renderBooks();
        window.scrollTo({top:0, behavior:"smooth"});
      });

      const { data, url, err } = await loadManifest();
      if(!data){
        const links = MANIFEST_CANDIDATES.map(u=>(
          `<div>â€¢ <a href="${esc(u)}" style="color:#b9c9ff" target="_blank" rel="noopener">${esc(u)}</a></div>`
        )).join("");
        setErr(
          `<div style="font-weight:800;margin-bottom:6px">manifest.jsonì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>
           <div style="margin-bottom:10px;white-space:pre-wrap">${esc(err || "")}</div>
           <div style="opacity:.9;margin-bottom:6px">ì•„ë˜ ë§í¬ ì¤‘ í•˜ë‚˜ë¥¼ ëˆŒëŸ¬ â€œíŒŒì¼ì´ ì‹¤ì œë¡œ ì—´ë¦¬ëŠ”ì§€(404 ì—¬ë¶€)â€ í™•ì¸í•˜ì„¸ìš”:</div>
           ${links}
           <div style="margin-top:10px;opacity:.85">
             â€» ë³´í†µ ì›ì¸: (1) íŒŒì¼ ê²½ë¡œ/ëŒ€ì†Œë¬¸ì ì˜¤ë¥˜ (2) manifest.json ë¬¸ë²• ì˜¤ë¥˜(ì½¤ë§ˆ/ê´„í˜¸) (3) ì»¤ë°‹/ë°°í¬ ë¯¸ë°˜ì˜
           </div>`
        );
        return;
      }

      manifest = data;
      clearErr();

      if(!manifest || !Array.isArray(manifest.books)){
        setErr(`<div style="font-weight:800;margin-bottom:6px">manifest.json í˜•ì‹ ì˜¤ë¥˜</div>
                <div>books[] ë°°ì—´ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
                <div style="margin-top:8px;opacity:.85">ë¡œë“œëœ URL: <span class="mono">${esc(url || "")}</span></div>`);
        return;
      }

      renderBooks();
      const first = (manifest.books[0]||{}).id || "";
      if(first) selectBook(first);
    }

    boot();
  </script>
</body>
</html>
