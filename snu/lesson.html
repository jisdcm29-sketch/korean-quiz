<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>서울대 레슨</title>

  <style>
    :root{
      --bg:#0b1220;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--line:#243044;
      --accent:#60a5fa;--ok:#34d399;--bad:#f87171;
    }
    *{box-sizing:border-box}
    html,body{overflow-x:hidden}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif;
      background:linear-gradient(180deg,#050814,var(--bg));
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .topbar{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 16px;background:rgba(5,8,20,.75);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
    .container{max-width:980px;margin:0 auto;padding:16px}
    .card{
      background:rgba(17,24,39,.9);
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .muted{color:var(--muted);line-height:1.6}
    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:#0b1020;color:var(--text);cursor:pointer;display:inline-block
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btnRow{display:flex;gap:8px;flex-wrap:wrap}
    .tag{
      display:inline-block;padding:2px 8px;border:1px solid var(--line);
      border-radius:999px;background:#0b1020;color:var(--muted);font-size:12px
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:#0b1020;color:var(--text);cursor:pointer
    }
    .tab.active{border-color:rgba(96,165,250,.7);color:var(--text)}
    .panel{display:none;margin-top:12px}
    .panel.active{display:block}
    .bar{height:1px;background:var(--line);margin:12px 0}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:10px;vertical-align:top}
    th{color:var(--muted);text-align:left}

    /* ===== Quiz UI base ===== */
    .qbox{border:1px solid var(--line);background:#0b1020;border-radius:16px;padding:14px}
    .qbox .qHead{display:block;text-align:center}
    .qbox .qLabel{color:var(--muted);font-size:13px}
    .qbox .qPrompt{
      font-weight:900;
      font-size:22px;              /* 기본(PC/태블릿) */
      line-height:1.15;
      margin-top:8px;
      text-align:center;
      word-break:keep-all;
      overflow-wrap:anywhere;
    }

    /* 선택지: 기존 그리드(PC) */
    .choices{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    @media(max-width:800px){.choices{grid-template-columns:1fr}}

    .choice{
      padding:12px;border-radius:14px;border:1px solid var(--line);
      background:#0b1020;color:var(--text);cursor:pointer;
      text-align:center;           /* ✅ 가운데 */
      line-height:1.2;
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:keep-all;
      font-size:18px;              /* 기본(PC/태블릿) */
    }
    .choice:hover{border-color:rgba(96,165,250,.6)}

    .result{margin-top:10px;padding:12px;border-radius:14px;border:1px solid var(--line);background:rgba(11,16,32,.7)}
    .result.ok{border-color:rgba(52,211,153,.6)}
    .result.bad{border-color:rgba(248,113,113,.6)}
    .small{font-size:13px}

    /* ===== ✅ Mobile: 질문 더 크게 + 중앙 + 간격 축소 + 한 화면에 더 많이 보이게 ===== */
    @media (max-width: 520px){
      .container{padding:10px}
      .card{padding:12px}
      .topbar{padding:10px 12px}
      .btn{padding:9px 10px}
      .tabs{gap:6px;margin-top:10px}
      .tab{padding:9px 10px}
      .bar{margin:10px 0}

      /* 퀴즈 박스 */
      .qbox{padding:12px}
      .qbox .qHead{display:flex;flex-direction:column;align-items:center}
      .qbox .qLabel{text-align:center}

      /* ✅ 질문: 선택지보다 확실히 크게 */
      .qbox .qPrompt{
        font-size:28px;            /* ✅ 질문 크게 */
        margin-top:8px;
        margin-bottom:6px;
        text-align:center;
      }

      /* ✅ 선택지: 간격 줄이고(스크롤 줄이기) 글자 약간 작게 */
      .choices{
        display:flex;              /* ✅ 모바일은 세로로 고정 */
        flex-direction:column;
        gap:6px;                   /* ✅ 간격 축소 */
        margin-top:10px;
      }
      .choice{
        font-size:20px;            /* ✅ 선택지(20) < 질문(28) */
        padding:10px 12px;         /* ✅ 버튼 높이 줄여 한 화면에 더 많이 */
        border-radius:14px;
      }

      /* 결과 박스도 조금 더 타이트 */
      .result{padding:10px;margin-top:8px}
      .muted.small{font-size:12px}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand"><span class="dot"></span><a href="../index.html">Korean Quiz</a></div>
    <div class="btnRow">
      <button class="btn" id="btnLang">KR</button>
      <a class="btn" href="./index.html" id="btnSnuList">서울대 목록</a>
      <a class="btn" href="../index.html" id="btnDashboard">대시보드</a>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-end">
        <div>
          <h1 style="margin:0 0 6px;" id="title">레슨</h1>
          <div class="muted" id="subtitle">불러오는 중...</div>
        </div>
        <div class="muted small" id="status"></div>
      </div>

      <div class="tabs" role="tablist" aria-label="lesson tabs">
        <button class="tab active" id="tab-vocab" type="button">어휘 보기</button>
        <button class="tab" id="tab-quiz" type="button">어휘 테스트</button>
        <button class="tab" id="tab-grammar" type="button">문법</button>
      </div>

      <div class="bar"></div>

      <div class="panel active" id="panel-vocab">
        <div class="btnRow" id="legacyRowVocab" style="margin-bottom:10px;display:none;">
          <a class="btn" id="legacyBtnVocab" href="#">기존 어휘(HTML) 보기</a>
        </div>
        <div id="vocab"></div>
      </div>

      <div class="panel" id="panel-quiz">
        <div class="btnRow" style="margin-bottom:10px;">
          <button class="btn" id="btnMode" type="button">방향: 한국어 → 몽골어</button>
          <button class="btn" id="btnNew" type="button">새 문제</button>
          <a class="btn" id="legacyBtnQuiz" href="#" style="display:none;">기존 자료(HTML) 보기</a>
        </div>
        <div class="muted small" id="quizHint"></div>
        <div class="bar"></div>
        <div id="quiz"></div>
      </div>

      <div class="panel" id="panel-grammar">
        <div id="grammar"></div>
      </div>
    </section>
  </main>

  <script>
    // ---- i18n ----
    const I18N = {
      KR: {
        dashboard: "대시보드",
        snuList: "서울대 목록",
        loading: "불러오는 중...",
        loaded: "로드 완료",
        vocabView: "어휘 보기",
        vocabQuiz: "어휘 테스트",
        grammar: "문법",
        legacyVocab: "기존 어휘(HTML) 보기",
        legacyHtml: "기존 자료(HTML) 보기",
        thKo: "한국어",
        thMn: "몽골어",
        thEx: "예문",
        noVocab: "어휘 데이터가 없습니다.",
        useLegacy: "아래 버튼으로 기존 자료를 사용할 수 있습니다.",
        noGrammar: "문법이 없습니다.",
        modeK2M: "방향: 한국어 → 몽골어",
        modeM2K: "방향: 몽골어 → 한국어",
        newQ: "새 문제",
        quizHint: (n)=> n ? `어휘 ${n}개로 테스트합니다. (4지선다, 랜덤)` : "어휘 데이터가 없어서 테스트를 만들 수 없습니다.",
        qLabel: "문제",
        correct: "정답!",
        wrong: "오답!",
        answer: "정답"
      },
      MN: {
        dashboard: "Самбар",
        snuList: "СӨҮ (жагсаалт)",
        loading: "Ачаалж байна...",
        loaded: "Ачааллаа",
        vocabView: "Үг харах",
        vocabQuiz: "Үг шалгалт",
        grammar: "Дүрэм",
        legacyVocab: "Хуучин үгс (HTML) харах",
        legacyHtml: "Хуучин материал (HTML) харах",
        thKo: "Солонгос",
        thMn: "Монгол",
        thEx: "Жишээ",
        noVocab: "Үгийн өгөгдөл алга.",
        useLegacy: "Доорх товчоор хуучин материалыг ашиглаж болно.",
        noGrammar: "Дүрэм байхгүй.",
        modeK2M: "Чиглэл: Солонгос → Монгол",
        modeM2K: "Чиглэл: Монгол → Солонгос",
        newQ: "Шинэ асуулт",
        quizHint: (n)=> n ? `Үг ${n} ширхэгээр шалгана. (4 сонголт, санамсаргүй)` : "Үг байхгүй тул шалгалт үүсгэж чадсангүй.",
        qLabel: "Асуулт",
        correct: "Зөв!",
        wrong: "Буруу!",
        answer: "Зөв хариулт"
      }
    };

    function getLang(){
      const u = new URL(location.href);
      const q = (u.searchParams.get("lang")||"").toUpperCase();
      const s1 = (localStorage.getItem("lang")||"").toUpperCase();
      const s2 = (localStorage.getItem("kq_lang")||"").toUpperCase();
      const s3 = (localStorage.getItem("language")||"").toUpperCase();
      const pick = (q==="MN"||q==="KR") ? q : (s2||s1||s3);
      return (pick==="MN") ? "MN" : "KR";
    }
    function setLang(l){
      localStorage.setItem("lang", l);
      localStorage.setItem("kq_lang", l);
      localStorage.setItem("language", l);
    }
    function tr(key, arg){
      const L = getLang();
      const v = (I18N[L] && I18N[L][key]) ? I18N[L][key] : I18N.KR[key];
      return (typeof v === "function") ? v(arg) : v;
    }

    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function setActiveTab(which){
      const tabs = [
        {t:document.getElementById("tab-vocab"), p:document.getElementById("panel-vocab"), k:"vocab"},
        {t:document.getElementById("tab-quiz"), p:document.getElementById("panel-quiz"), k:"quiz"},
        {t:document.getElementById("tab-grammar"), p:document.getElementById("panel-grammar"), k:"grammar"}
      ];
      tabs.forEach(x=>{
        const on = x.k===which;
        x.t.classList.toggle("active", on);
        x.p.classList.toggle("active", on);
      });
    }

    let LESSON = null;
    let QUIZ_MODE = "KO2MN"; // or MN2KO

    function applyTexts(){
      document.documentElement.lang = (getLang()==="MN") ? "mn" : "ko";
      document.getElementById("btnLang").textContent = getLang();
      document.getElementById("btnDashboard").textContent = tr("dashboard");
      document.getElementById("btnSnuList").textContent = tr("snuList");
      document.getElementById("subtitle").textContent = tr("loading");

      document.getElementById("tab-vocab").textContent = tr("vocabView");
      document.getElementById("tab-quiz").textContent = tr("vocabQuiz");
      document.getElementById("tab-grammar").textContent = tr("grammar");

      document.getElementById("legacyBtnVocab").textContent = tr("legacyVocab");
      document.getElementById("legacyBtnQuiz").textContent = tr("legacyHtml");

      document.getElementById("btnNew").textContent = tr("newQ");
      document.getElementById("btnMode").textContent = (QUIZ_MODE==="KO2MN") ? tr("modeK2M") : tr("modeM2K");
    }

    function renderVocab(d){
      const vocabDiv = document.getElementById("vocab");
      const legacyRow = document.getElementById("legacyRowVocab");
      const legacyBtn = document.getElementById("legacyBtnVocab");

      if(d.legacy_vocab_url){
        legacyBtn.href = d.legacy_vocab_url;
        legacyRow.style.display = "";
      } else {
        legacyRow.style.display = "none";
      }

      const vocab = d.vocab || [];
      if(vocab.length){
        let html = `<table><thead><tr>
          <th>${tr("thKo")}</th><th>${tr("thMn")}</th><th>${tr("thEx")}</th>
        </tr></thead><tbody>`;
        vocab.forEach(v=>{
          const ko = v.ko || "";
          const mn = v.mn || "";
          const pos = v.pos ? ` <span class="tag">${v.pos}</span>` : "";
          const exKr = v.example_kr || "";
          const exMn = v.example_mn || "";
          const ex = (exKr || exMn)
            ? `${exKr ? exKr : ""}${exMn ? "<br/><span class='muted'>" + exMn + "</span>" : ""}`
            : "<span class='muted'>-</span>";
          html += `<tr>
            <td><b>${ko}</b>${pos}</td>
            <td>${mn || "<span class='muted'>-</span>"}</td>
            <td>${ex}</td>
          </tr>`;
        });
        html += "</tbody></table>";
        vocabDiv.innerHTML = html;
      } else {
        vocabDiv.innerHTML =
          `<div class='muted'>${tr("noVocab")}</div>` +
          (d.legacy_vocab_url ? `<div class='muted small' style='margin-top:6px;'>${tr("useLegacy")}</div>` : "");
      }
    }

    function renderGrammar(d){
      const gramDiv = document.getElementById("grammar");
      const grammar = d.grammar || [];
      if(grammar.length){
        let html = "";
        grammar.forEach(g=>{
          const examples = (g.examples || []).map(e=>{
            const kr = e.kr || "";
            const mn = e.mn || "";
            return `<div style="margin-top:8px;">• ${kr}<br/><span class="muted">${mn}</span></div>`;
          }).join("");
          html += `<div class="card" style="margin-top:10px;">
            <div style="font-weight:900;">${g.title || ""} <span class="tag">${g.pattern || ""}</span></div>
            <div class="muted" style="margin-top:6px;">${g.use_kr || ""}</div>
            ${g.use_mn ? `<div class="muted" style="margin-top:6px;">${g.use_mn}</div>` : ""}
            ${examples ? `<div style="margin-top:10px;">${examples}</div>` : ""}
          </div>`;
        });
        gramDiv.innerHTML = html;
      } else {
        gramDiv.innerHTML = `<div class='muted'>${tr("noGrammar")}</div>`;
      }
    }

    function pickQuestion(vocab){
      const pool = (vocab || []).filter(v => (v && (v.ko || v.mn)));
      if(!pool.length) return null;

      // 유효한 문제(프롬프트/정답 모두 존재) 나올 때까지 최대 15번 재시도
      for(let tries=0; tries<15; tries++){
        const q = pool[Math.floor(Math.random()*pool.length)];
        const getPrompt = (v) => QUIZ_MODE==="KO2MN" ? (v.ko||"") : (v.mn||"");
        const getAnswer = (v) => QUIZ_MODE==="KO2MN" ? (v.mn||"") : (v.ko||"");

        const correct = getAnswer(q);
        const prompt = getPrompt(q);
        if(!prompt || !correct) continue;

        const others = pool.map(v => getAnswer(v)).filter(a => a && a !== correct);
        const uniq = Array.from(new Set(others));

        // 3개 부족하면(데이터가 적으면) 같은 pool에서 더 뽑아 채우기
        let distractors = shuffle(uniq).slice(0, 3);
        while(distractors.length < 3){
          const r = pool[Math.floor(Math.random()*pool.length)];
          const cand = getAnswer(r);
          if(cand && cand !== correct && !distractors.includes(cand)) distractors.push(cand);
          if(pool.length === 1) break;
        }

        const choices = shuffle([correct, ...distractors]).slice(0,4);
        if(choices.length === 4) return { prompt, correct, choices };
      }
      return null;
    }

    function renderQuiz(d){
      const quizDiv = document.getElementById("quiz");
      const hint = document.getElementById("quizHint");
      const legacyBtnQuiz = document.getElementById("legacyBtnQuiz");

      if(d.legacy_vocab_url){
        legacyBtnQuiz.href = d.legacy_vocab_url;
        legacyBtnQuiz.style.display = "";
      } else {
        legacyBtnQuiz.style.display = "none";
      }

      const vocab = d.vocab || [];
      hint.textContent = tr("quizHint", vocab.length);

      quizDiv.innerHTML = "";
      if(!vocab.length){
        quizDiv.innerHTML = `<div class='muted'>${tr("noVocab")}</div>`;
        return;
      }

      const q = pickQuestion(vocab);
      if(!q){
        quizDiv.innerHTML = "<div class='muted'>퀴즈를 만들 수 없습니다. (ko/mn 값 확인)</div>";
        return;
      }

      const box = document.createElement("div");
      box.className = "qbox";

      const head = document.createElement("div");
      head.className = "qHead";
      head.innerHTML = `<div class="qLabel">${tr("qLabel")}</div>
                        <div class="qPrompt" id="questionText">${q.prompt}</div>`;
      box.appendChild(head);

      const choicesWrap = document.createElement("div");
      choicesWrap.className = "choices";
      choicesWrap.id = "choices";

      const result = document.createElement("div");
      result.className = "result";
      result.style.display = "none";

      function lock(){
        [...choicesWrap.querySelectorAll("button")].forEach(b=>b.disabled=true);
      }

      q.choices.forEach(ch=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "choice";
        btn.textContent = ch;

        btn.addEventListener("click", ()=>{
          const ok = ch === q.correct;
          result.style.display = "";
          result.classList.remove("ok","bad");
          result.classList.add(ok ? "ok" : "bad");
          result.innerHTML = ok
            ? `<b>${tr("correct")}</b> <span class="muted small">(${tr("answer")}: ${q.correct})</span>`
            : `<b>${tr("wrong")}</b> <span class="muted small">${tr("answer")}: ${q.correct}</span>`;
          lock();
        });

        choicesWrap.appendChild(btn);
      });

      box.appendChild(choicesWrap);
      box.appendChild(result);
      quizDiv.appendChild(box);
    }

    async function main(){
      applyTexts();

      document.getElementById("tab-vocab").addEventListener("click", ()=>setActiveTab("vocab"));
      document.getElementById("tab-quiz").addEventListener("click", ()=>setActiveTab("quiz"));
      document.getElementById("tab-grammar").addEventListener("click", ()=>setActiveTab("grammar"));

      document.getElementById("btnLang").addEventListener("click", ()=>{
        const next = (getLang()==="KR") ? "MN" : "KR";
        setLang(next);
        applyTexts();
        if(LESSON){
          renderVocab(LESSON);
          renderGrammar(LESSON);
          renderQuiz(LESSON);
        }
      });

      document.getElementById("btnMode").addEventListener("click", ()=>{
        QUIZ_MODE = (QUIZ_MODE==="KO2MN") ? "MN2KO" : "KO2MN";
        applyTexts();
        if(LESSON) renderQuiz(LESSON);
      });

      document.getElementById("btnNew").addEventListener("click", ()=>{
        if(LESSON) renderQuiz(LESSON);
      });

      const dataPath = getParam("data");
      const title = document.getElementById("title");
      const subtitle = document.getElementById("subtitle");
      const status = document.getElementById("status");

      if(!dataPath){
        subtitle.textContent = "data 경로가 없습니다.";
        status.textContent = "오류";
        return;
      }

      try{
        const dataUrl = new URL(dataPath, location.href).toString();

        status.textContent = "Loading...";
        subtitle.textContent = tr("loading");

        const res = await fetch(dataUrl, { cache:"no-store" });
        if(!res.ok) throw new Error("레슨 JSON 로드 실패: " + res.status + " / " + dataUrl);

        const d = await res.json();
        LESSON = d;

        const meta = d.meta || {};
        const level = meta.level || d.level || "";
        const lesson = meta.lesson || d.lesson || "";
        const ttlKr = meta.title || d.title_kr || d.title || "";
        const ttlMn = d.title_mn || "";

        title.textContent = `${level} ${lesson} · ${ttlKr}`.trim();
        subtitle.textContent = ttlMn || "";
        status.textContent = tr("loaded");

        renderVocab(d);
        renderGrammar(d);
        renderQuiz(d);

      }catch(err){
        subtitle.textContent = "불러오기 오류: " + (err.message || err);
        status.textContent = "오류";
        console.log(err);
      }
    }

    main();
  </script>
</body>
</html>
