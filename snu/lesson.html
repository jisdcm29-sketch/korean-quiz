<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>서울대 레슨</title>

  <style>
    :root{
      --bg:#0b1220;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--line:#243044;
      --accent:#60a5fa;--ok:#34d399;--bad:#f87171;
    }
    *{box-sizing:border-box}
    html,body{overflow-x:hidden}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif;
      background:linear-gradient(180deg,#050814,var(--bg));
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}

    .topbar{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;background:rgba(5,8,20,.75);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
    .container{max-width:980px;margin:0 auto;padding:14px}
    .card{
      background:rgba(17,24,39,.9);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .muted{color:var(--muted);line-height:1.6}
    .btn{
      padding:12px 14px;border-radius:14px;border:1px solid var(--line);
      background:#0b1020;color:var(--text);cursor:pointer;display:inline-block;
      -webkit-tap-highlight-color:transparent;
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btnRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tag{
      display:inline-block;padding:2px 8px;border:1px solid var(--line);
      border-radius:999px;background:#0b1020;color:var(--muted);font-size:12px
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab{
      padding:12px 14px;border-radius:14px;border:1px solid var(--line);
      background:#0b1020;color:var(--text);cursor:pointer
    }
    .tab.active{border-color:rgba(96,165,250,.7);color:var(--text)}
    .panel{display:none;margin-top:12px}
    .panel.active{display:block}
    .bar{height:1px;background:var(--line);margin:12px 0}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:10px;vertical-align:top}
    th{color:var(--muted);text-align:left}

    .qbox{border:1px solid var(--line);background:#0b1020;border-radius:18px;padding:14px}
    .choices{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    @media(max-width:520px){.choices{grid-template-columns:1fr;gap:8px}}
    .choice{
      padding:14px;border-radius:16px;border:1px solid var(--line);
      background:#0b1020;color:var(--text);cursor:pointer;text-align:center;
      line-height:1.2;
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:keep-all;
    }
    .choice:hover{border-color:rgba(96,165,250,.6)}
    .result{margin-top:10px;padding:12px;border-radius:14px;border:1px solid var(--line);background:rgba(11,16,32,.7)}
    .result.ok{border-color:rgba(52,211,153,.6)}
    .result.bad{border-color:rgba(248,113,113,.6)}
    .small{font-size:13px}
    .err{
      border:1px solid rgba(248,113,113,.35);
      background:rgba(248,113,113,.06);
      padding:12px;border-radius:14px
    }

    @media (max-width:520px){
      .container{padding:12px}
      .card{padding:12px}
      .btn{padding:12px 14px;border-radius:14px}
      .tab{padding:12px 14px}
      .muted.small{font-size:12px}

      #quiz .qPrompt, #mix .qPrompt{
        font-size:24px !important;
        font-weight:900 !important;
        text-align:center !important;
        margin:8px auto 10px auto !important;
        line-height:1.15 !important;
      }
      #quiz .choice, #mix .choice{
        font-size:22px !important;
        padding:12px 12px !important;
        margin:0 !important;
      }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <span class="dot"></span>
      <a href="../index.html" id="homeLink">Korean Quiz</a>
    </div>
    <div class="btnRow">
      <button class="btn" id="btnBack" type="button">←</button>
      <button class="btn" id="btnLang" type="button">KR</button>
      <a class="btn" href="./index.html" id="btnSnuList">서울대 목록</a>
      <a class="btn" href="../index.html" id="btnDashboard">대시보드</a>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-end">
        <div>
          <h1 style="margin:0 0 6px;" id="title">레슨</h1>
          <div class="muted" id="subtitle">불러오는 중...</div>
        </div>
        <div class="muted small" id="status"></div>
      </div>

      <div class="tabs" role="tablist" aria-label="lesson tabs">
        <button class="tab active" id="tab-vocab" type="button">어휘 보기</button>
        <button class="tab" id="tab-quiz" type="button">어휘 테스트</button>
        <button class="tab" id="tab-grammar" type="button">문법</button>
        <button class="tab" id="tab-mix" type="button">종합 테스트</button>
      </div>

      <div class="bar"></div>

      <div class="panel active" id="panel-vocab">
        <div class="btnRow" id="legacyRowVocab" style="margin-bottom:10px;display:none;">
          <a class="btn" id="legacyBtnVocab" href="#">기존 어휘(HTML) 보기</a>
        </div>
        <div id="vocab"></div>
      </div>

      <div class="panel" id="panel-quiz">
        <div class="btnRow" style="margin-bottom:10px;">
          <button class="btn" id="btnMode" type="button">방향: 한국어 → 몽골어</button>
          <button class="btn" id="btnNew" type="button">새 문제</button>
          <a class="btn" id="legacyBtnQuiz" href="#" style="display:none;">기존 어휘 테스트(HTML) 사용</a>
        </div>
        <div class="muted small" id="quizHint"></div>
        <div class="bar"></div>
        <div id="quiz"></div>
      </div>

      <div class="panel" id="panel-grammar">
        <div id="grammar"></div>
      </div>

      <div class="panel" id="panel-mix">
        <div class="btnRow" style="margin-bottom:10px;">
          <button class="btn" id="btnMixNew" type="button">새 문제</button>
        </div>
        <div class="muted small" id="mixHint"></div>
        <div class="bar"></div>
        <div id="mix"></div>
      </div>

      <div id="errBox" class="err" style="display:none;margin-top:12px;"></div>
    </section>
  </main>

  <script>
    const I18N = {
      KR: {
        dashboard: "대시보드",
        snuList: "서울대 목록",
        loading: "불러오는 중...",
        loaded: "로드 완료",
        vocabView: "어휘 보기",
        vocabQuiz: "어휘 테스트",
        grammar: "문법",
        mix: "종합 테스트",
        legacyVocab: "기존 어휘(HTML) 보기",
        legacyQuiz: "기존 어휘 테스트(HTML) 사용",
        thKo: "한국어",
        thMn: "몽골어",
        noVocab: "어휘 데이터가 없습니다.",
        useLegacy: "아래 버튼으로 기존 자료를 사용할 수 있습니다.",
        noGrammar: "문법이 없습니다.",
        modeK2M: "방향: 한국어 → 몽골어",
        modeM2K: "방향: 몽골어 → 한국어",
        newQ: "새 문제",
        quizHint: (n)=> n ? `어휘 ${n}개로 테스트합니다. (4지선다, 랜덤)` : "어휘 데이터가 없어서 테스트를 만들 수 없습니다.",
        mixHint: (n)=> n ? `종합 테스트(현재는 어휘 기반). 어휘 ${n}개 사용.` : "어휘 데이터가 없어서 테스트를 만들 수 없습니다.",
        qLabel: "문제",
        correct: "정답!",
        wrong: "오답!",
        answer: "정답",
        cannotQuiz: "퀴즈를 만들 수 없습니다. (ko/mn 값 확인)",
        missingData: "data 경로가 없습니다."
      },
      MN: {
        dashboard: "Самбар",
        snuList: "СӨҮ (жагсаалт)",
        loading: "Ачаалж байна...",
        loaded: "Ачааллаа",
        vocabView: "Үг харах",
        vocabQuiz: "Үг шалгалт",
        grammar: "Дүрэм",
        mix: "Нэгдсэн тест",
        legacyVocab: "Хуучин үгс (HTML) харах",
        legacyQuiz: "Хуучин үгийн тест (HTML) ашиглах",
        thKo: "Солонгос",
        thMn: "Монгол",
        noVocab: "Үгийн өгөгдөл алга.",
        useLegacy: "Доорх товчоор хуучин материалыг ашиглаж болно.",
        noGrammar: "Дүрэм байхгүй.",
        modeK2M: "Чиглэл: Солонгос → Монгол",
        modeM2K: "Чиглэл: Монгол → Солонгос",
        newQ: "Шинэ асуулт",
        quizHint: (n)=> n ? `Үг ${n} ширхэгээр шалгана. (4 сонголт, санамсаргүй)` : "Үг байхгүй тул шалгалт үүсгэж чадсангүй.",
        mixHint: (n)=> n ? `Нэгдсэн тест (одоогоор үг дээр). Үг ${n} ширхэг ашиглана.` : "Үг байхгүй тул шалгалт үүсгэж чадсангүй.",
        qLabel: "Асуулт",
        correct: "Зөв!",
        wrong: "Буруу!",
        answer: "Зөв хариулт",
        cannotQuiz: "Асуулт үүсгэж чадсангүй. (ko/mn шалгана уу)",
        missingData: "data зам алга."
      }
    };

    function getLang(){
      const u = new URL(location.href);
      const q = (u.searchParams.get("lang")||"").toUpperCase();
      const s1 = (localStorage.getItem("lang")||"").toUpperCase();
      const s2 = (localStorage.getItem("kq_lang")||"").toUpperCase();
      const pick = (q==="MN"||q==="KR") ? q : (s2||s1);
      return (pick==="MN") ? "MN" : "KR";
    }
    function setLang(l){
      localStorage.setItem("lang", l);
      localStorage.setItem("kq_lang", l);
    }
    function tr(key, arg){
      const L = getLang();
      const v = (I18N[L] && I18N[L][key]) ? I18N[L][key] : I18N.KR[key];
      return (typeof v === "function") ? v(arg) : v;
    }

    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }

    function buildLegacyUrl(rawHref){
      if(!rawHref) return "#";
      const u = new URL(location.href);
      const keep = new URLSearchParams();
      ["name","klass","token","lang"].forEach(k=>{
        const v = u.searchParams.get(k);
        if(v) keep.set(k, v);
      });
      if(!keep.get("lang")){
        const l = (localStorage.getItem("kq_lang")||localStorage.getItem("lang")||"KR").toUpperCase();
        keep.set("lang", (l==="MN") ? "MN" : "KR");
      }
      const base = new URL(rawHref, location.href);
      keep.forEach((v,k)=>base.searchParams.set(k, v));
      return base.toString();
    }

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function setActiveTab(which){
      const tabs = [
        {t:document.getElementById("tab-vocab"), p:document.getElementById("panel-vocab"), k:"vocab"},
        {t:document.getElementById("tab-quiz"),  p:document.getElementById("panel-quiz"),  k:"quiz"},
        {t:document.getElementById("tab-grammar"),p:document.getElementById("panel-grammar"),k:"grammar"},
        {t:document.getElementById("tab-mix"),   p:document.getElementById("panel-mix"),   k:"mix"}
      ];
      tabs.forEach(x=>{
        const on = x.k===which;
        x.t.classList.toggle("active", on);
        x.p.classList.toggle("active", on);
      });
    }

    let LESSON = null;
    let QUIZ_MODE = "KO2MN";

    function applyTexts(){
      document.documentElement.lang = (getLang()==="MN") ? "mn" : "ko";
      document.getElementById("btnLang").textContent = getLang();
      document.getElementById("btnDashboard").textContent = tr("dashboard");
      document.getElementById("btnSnuList").textContent = tr("snuList");
      document.getElementById("subtitle").textContent = tr("loading");

      document.getElementById("tab-vocab").textContent = tr("vocabView");
      document.getElementById("tab-quiz").textContent = tr("vocabQuiz");
      document.getElementById("tab-grammar").textContent = tr("grammar");
      document.getElementById("tab-mix").textContent = tr("mix");

      document.getElementById("legacyBtnVocab").textContent = tr("legacyVocab");
      document.getElementById("legacyBtnQuiz").textContent = tr("legacyQuiz");

      document.getElementById("btnNew").textContent = tr("newQ");
      document.getElementById("btnMixNew").textContent = tr("newQ");
      document.getElementById("btnMode").textContent = (QUIZ_MODE==="KO2MN") ? tr("modeK2M") : tr("modeM2K");
    }

    function getMeta(d){
      const m = d.meta || {};
      const level = d.level || m.level || "";
      const lesson = d.lesson || m.lesson || "";
      const titleKR = d.title_kr || m.title_kr || d.title || m.title || "";
      const titleMN = d.title_mn || m.title_mn || "";
      return { level, lesson, titleKR, titleMN };
    }

    function renderVocab(d){
      const vocabDiv = document.getElementById("vocab");
      const legacyRow = document.getElementById("legacyRowVocab");
      const legacyBtn = document.getElementById("legacyBtnVocab");

      if(d.legacy_vocab_url){
        legacyBtn.href = buildLegacyUrl(d.legacy_vocab_url);
        legacyRow.style.display = "";
      } else {
        legacyRow.style.display = "none";
      }

      const vocab = d.vocab || [];
      if(vocab.length){
        let html = `<table><thead><tr>
          <th>${tr("thKo")}</th><th>${tr("thMn")}</th>
        </tr></thead><tbody>`;
        vocab.forEach(v=>{
          const ko = v.ko || "";
          const mn = v.mn || "";
          const pos = v.pos ? ` <span class="tag">${v.pos}</span>` : "";
          html += `<tr>
            <td><b>${ko}</b>${pos}</td>
            <td>${mn || "<span class='muted'>-</span>"}</td>
          </tr>`;
        });
        html += "</tbody></table>";
        vocabDiv.innerHTML = html;
      } else {
        vocabDiv.innerHTML =
          `<div class='muted'>${tr("noVocab")}</div>` +
          (d.legacy_vocab_url ? `<div class='muted small' style='margin-top:6px;'>${tr("useLegacy")}</div>` : "");
      }
    }

    function renderGrammar(d){
      const gramDiv = document.getElementById("grammar");
      const grammar = d.grammar || [];
      if(grammar.length){
        let html = "";
        grammar.forEach(g=>{
          const examples = (g.examples || []).map(e=>{
            const kr = e.kr || "";
            const mn = e.mn || "";
            return `<div style="margin-top:8px;">• ${kr}<br/><span class="muted">${mn}</span></div>`;
          }).join("");
          html += `<div class="card" style="margin-top:10px;">
            <div style="font-weight:900;">${g.title || ""} ${g.pattern ? `<span class="tag">${g.pattern}</span>` : ""}</div>
            ${g.use_kr ? `<div class="muted" style="margin-top:6px;">${g.use_kr}</div>` : ""}
            ${g.use_mn ? `<div class="muted" style="margin-top:6px;">${g.use_mn}</div>` : ""}
            ${examples ? `<div style="margin-top:10px;">${examples}</div>` : ""}
          </div>`;
        });
        gramDiv.innerHTML = html;
      } else {
        gramDiv.innerHTML = `<div class='muted'>${tr("noGrammar")}</div>`;
      }
    }

    function pickVocabQuestion(vocab){
      const pool = vocab.filter(v => (v.ko || v.mn));
      if(!pool.length) return null;

      const q = pool[Math.floor(Math.random()*pool.length)];
      const getPrompt = (v) => QUIZ_MODE==="KO2MN" ? (v.ko||"") : (v.mn||"");
      const getAnswer = (v) => QUIZ_MODE==="KO2MN" ? (v.mn||"") : (v.ko||"");

      const correct = getAnswer(q);
      const prompt = getPrompt(q);
      if(!prompt || !correct) return null;

      const others = pool.map(v => getAnswer(v)).filter(a => a && a !== correct);
      const uniq = Array.from(new Set(others));
      const distractors = shuffle(uniq).slice(0, 3);
      const choices = shuffle([correct, ...distractors]).slice(0,4);

      while(choices.length < 4){
        choices.push("—");
        if(choices.length === 4) break;
      }

      return { type:"vocab", prompt, correct, choices };
    }

    function renderMC(containerEl, q){
      containerEl.innerHTML = "";
      const box = document.createElement("div");
      box.className = "qbox";

      const head = document.createElement("div");
      head.innerHTML = `<div class="muted small">${tr("qLabel")}</div>
                        <div class="qPrompt" style="font-weight:900;font-size:20px;margin-top:6px;text-align:center;">${q.prompt}</div>`;
      box.appendChild(head);

      const choicesWrap = document.createElement("div");
      choicesWrap.className = "choices";

      const result = document.createElement("div");
      result.className = "result";
      result.style.display = "none";

      function lock(){
        [...choicesWrap.querySelectorAll("button")].forEach(b=>b.disabled=true);
      }

      q.choices.forEach(ch=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "choice";
        btn.textContent = ch;

        btn.addEventListener("click", ()=>{
          const ok = ch === q.correct;
          result.style.display = "";
          result.classList.remove("ok","bad");
          result.classList.add(ok ? "ok" : "bad");
          result.innerHTML = ok
            ? `<b>${tr("correct")}</b> <span class="muted small">(${tr("answer")}: ${q.correct})</span>`
            : `<b>${tr("wrong")}</b> <span class="muted small">${tr("answer")}: ${q.correct}</span>`;
          lock();
        });

        choicesWrap.appendChild(btn);
      });

      box.appendChild(choicesWrap);
      box.appendChild(result);
      containerEl.appendChild(box);
    }

    function renderQuiz(d){
      const quizDiv = document.getElementById("quiz");
      const hint = document.getElementById("quizHint");
      const legacyBtnQuiz = document.getElementById("legacyBtnQuiz");

      if(d.legacy_vocab_url){
        legacyBtnQuiz.href = buildLegacyUrl(d.legacy_vocab_url);
        legacyBtnQuiz.style.display = "";
      } else {
        legacyBtnQuiz.style.display = "none";
      }

      const vocab = d.vocab || [];
      hint.textContent = tr("quizHint", vocab.length);

      if(!vocab.length){
        quizDiv.innerHTML = `<div class='muted'>${tr("noVocab")}</div>`;
        return;
      }

      const q = pickVocabQuestion(vocab);
      if(!q){
        quizDiv.innerHTML = `<div class='muted'>${tr("cannotQuiz")}</div>`;
        return;
      }

      renderMC(quizDiv, q);
    }

    function renderMix(d){
      const mixDiv = document.getElementById("mix");
      const hint = document.getElementById("mixHint");

      const vocab = d.vocab || [];
      hint.textContent = tr("mixHint", vocab.length);

      if(!vocab.length){
        mixDiv.innerHTML = `<div class='muted'>${tr("noVocab")}</div>`;
        return;
      }

      const q = pickVocabQuestion(vocab);
      if(!q){
        mixDiv.innerHTML = `<div class='muted'>${tr("cannotQuiz")}</div>`;
        return;
      }

      renderMC(mixDiv, q);
    }

    function showErr(msg){
      const box = document.getElementById("errBox");
      box.style.display = "";
      box.innerHTML = msg;
    }

    async function main(){
      applyTexts();

      document.getElementById("btnBack").addEventListener("click", ()=>{
        if(history.length > 1) history.back();
        else location.href = "./index.html";
      });

      document.getElementById("tab-vocab").addEventListener("click", ()=>setActiveTab("vocab"));
      document.getElementById("tab-quiz").addEventListener("click", ()=>setActiveTab("quiz"));
      document.getElementById("tab-grammar").addEventListener("click", ()=>setActiveTab("grammar"));
      document.getElementById("tab-mix").addEventListener("click", ()=>setActiveTab("mix"));

      document.getElementById("btnLang").addEventListener("click", ()=>{
        const next = (getLang()==="KR") ? "MN" : "KR";
        setLang(next);
        applyTexts();
        if(LESSON){
          renderVocab(LESSON);
          renderGrammar(LESSON);
          renderQuiz(LESSON);
          renderMix(LESSON);
        }
      });

      document.getElementById("btnMode").addEventListener("click", ()=>{
        QUIZ_MODE = (QUIZ_MODE==="KO2MN") ? "MN2KO" : "KO2MN";
        applyTexts();
        if(LESSON) renderQuiz(LESSON);
      });

      document.getElementById("btnNew").addEventListener("click", ()=>{
        if(LESSON) renderQuiz(LESSON);
      });

      document.getElementById("btnMixNew").addEventListener("click", ()=>{
        if(LESSON) renderMix(LESSON);
      });

      const u = new URL(location.href);
      const keep = new URLSearchParams();
      ["name","klass","token","lang"].forEach(k=>{
        const v = u.searchParams.get(k);
        if(v) keep.set(k,v);
      });
      if(!keep.get("lang")) keep.set("lang", getLang());
      const qs = keep.toString();
      const withQS = (href)=>{
        if(!qs) return href;
        return href + (href.includes("?") ? "&" : "?") + qs;
      };
      document.getElementById("homeLink").href = withQS("../index.html");
      document.getElementById("btnSnuList").href = withQS("./index.html");
      document.getElementById("btnDashboard").href = withQS("../index.html");

      const dataPath = getParam("data");
      const title = document.getElementById("title");
      const subtitle = document.getElementById("subtitle");
      const status = document.getElementById("status");

      if(!dataPath){
        subtitle.textContent = tr("missingData");
        status.textContent = "오류";
        return;
      }

      try{
        const dataUrl = new URL(dataPath, location.href).toString();
        status.textContent = "Loading...";
        subtitle.textContent = tr("loading");

        const res = await fetch(dataUrl, { cache:"no-store" });
        if(!res.ok) throw new Error("레슨 JSON 로드 실패: HTTP " + res.status);

        const d = await res.json();
        LESSON = d;

        const meta = getMeta(d);
        const left = [meta.level, meta.lesson].filter(Boolean).join(" ");
        const h = [left, "·", meta.titleKR].filter(Boolean).join(" ").replace("·  ", "· ");
        title.textContent = h || "레슨";
        subtitle.textContent = meta.titleMN || "";
        status.textContent = tr("loaded");

        renderVocab(d);
        renderGrammar(d);
        renderQuiz(d);
        renderMix(d);
      } catch(err){
        subtitle.textContent = "불러오기 오류";
        status.textContent = "오류";
        showErr("불러오기 오류: " + (err.message || err));
        console.log(err);
      }
    }

    main();
  </script>
</body>
</html>
