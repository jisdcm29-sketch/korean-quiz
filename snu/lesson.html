<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>서울대 레슨</title>
  <style>
    :root{
      --bg:#0b1220;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--line:#243044;
      --blue:#60a5fa;--green:#34d399;--red:#f87171;--amber:#fbbf24;--violet:#a78bfa;--teal:#22d3ee;
      --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{overflow-x:hidden}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif;
      background:linear-gradient(180deg,#050814,var(--bg));
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}
    .container{max-width:980px;margin:0 auto;padding:16px}

    .topbar{
      position:sticky;top:0;z-index:30;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 10px;background:rgba(5,8,20,.78);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:950}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--blue)}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:#0b1020;color:var(--text);font-weight:850;font-size:13px;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
      white-space:nowrap;
    }

    .btn{
      padding:12px 16px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#0b1020;
      color:var(--text);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height:48px;
      font-size:16px;
      font-weight:900;
      letter-spacing:.2px;
      -webkit-tap-highlight-color:transparent;
      box-shadow:0 8px 18px rgba(0,0,0,.22);
      white-space:nowrap;
    }
    .btn:active{transform:translateY(1px)}
    .btn:hover{filter:brightness(1.06)}
    .btnBack{
      background:linear-gradient(135deg,rgba(167,139,250,.25), rgba(11,16,32,.96));
      border-color:rgba(167,139,250,.55);
      min-width:56px;
      font-size:18px;
    }
    .btnLang{
      background:linear-gradient(135deg,rgba(52,211,153,.22), rgba(11,16,32,.96));
      border-color:rgba(52,211,153,.55);
      min-width:64px;
      font-size:16px;
    }
    .btnLogout{
      background:linear-gradient(135deg,rgba(248,113,113,.16), rgba(11,16,32,.96));
      border-color:rgba(248,113,113,.46);
      font-size:14px;
      padding:10px 12px;
      min-height:44px;
      border-radius:14px;
    }

    .card{
      background:rgba(17,24,39,.9);
      border:1px solid var(--line);
      border-radius:20px;
      padding:16px;
      box-shadow:var(--shadow);
    }
    .muted{color:var(--muted);line-height:1.6}
    .small{font-size:13px}
    .bar{height:1px;background:var(--line);margin:12px 0}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .tab{
      padding:12px 16px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#0b1020;
      color:var(--text);
      cursor:pointer;
      font-weight:950;
      font-size:16px;
      min-height:48px;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
      -webkit-tap-highlight-color:transparent;
      white-space:nowrap;
    }
    .tab:active{transform:translateY(1px)}
    .tab.active{filter:brightness(1.10)}
    .tab.tab-vocab{background:linear-gradient(135deg,rgba(52,211,153,.18), rgba(11,16,32,.96));border-color:rgba(52,211,153,.50);}
    .tab.tab-quiz{background:linear-gradient(135deg,rgba(96,165,250,.20), rgba(11,16,32,.96));border-color:rgba(96,165,250,.55);}
    .tab.tab-grammar{background:linear-gradient(135deg,rgba(251,191,36,.18), rgba(11,16,32,.96));border-color:rgba(251,191,36,.50);}
    .tab.tab-mixed{background:linear-gradient(135deg,rgba(248,113,113,.16), rgba(11,16,32,.96));border-color:rgba(248,113,113,.46);}

    .panel{display:none;margin-top:12px}
    .panel.active{display:block}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:12px;vertical-align:top}
    th{color:var(--muted);text-align:left;font-weight:800}
    td b{font-weight:950}

    /* ===== QUIZ UI ===== */
    .qbox{
      border:1px solid var(--line);
      background:#0b1020;
      border-radius:18px;
      padding:14px;
    }
    .qHead{
      margin-bottom:10px;
      text-align:center;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(96,165,250,.20);
      background:linear-gradient(135deg,rgba(96,165,250,.14), rgba(11,16,32,.96));
      box-shadow:0 10px 22px rgba(0,0,0,.14);
    }
    .qLabel{color:var(--muted);font-size:13px;font-weight:800}
    .qText{
      font-weight:950;
      letter-spacing:.2px;
      margin-top:8px;
      text-align:center;
      line-height:1.12;
      font-size:24px;
      word-break:keep-all;
      overflow-wrap:anywhere;
    }

    .choices{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:8px;
      margin-top:10px;
    }
    @media(max-width:800px){.choices{grid-template-columns:1fr}}
    .choice{
      padding:13px 12px;
      border-radius:18px;
      border:1px solid var(--line);
      background:linear-gradient(135deg,rgba(255,255,255,.04), rgba(11,16,32,.96));
      color:var(--text);
      cursor:pointer;
      text-align:center;
      font-weight:900;
      font-size:21px;
      min-height:52px;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      white-space:normal;
      overflow-wrap:anywhere;
      -webkit-tap-highlight-color:transparent;
    }
    .choice:hover{filter:brightness(1.06)}
    .choice:active{transform:translateY(1px)}
    .result{margin-top:10px;padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(11,16,32,.7)}
    .result.ok{border-color:rgba(52,211,153,.6)}
    .result.bad{border-color:rgba(248,113,113,.6)}

    .btnMode{
      background:linear-gradient(135deg,rgba(34,211,238,.18), rgba(11,16,32,.96));
      border-color:rgba(34,211,238,.52);
    }
    .btnNew{
      background:linear-gradient(135deg,rgba(167,139,250,.20), rgba(11,16,32,.96));
      border-color:rgba(167,139,250,.52);
    }
    .btnLegacy{
      background:linear-gradient(135deg,rgba(251,191,36,.16), rgba(11,16,32,.96));
      border-color:rgba(251,191,36,.46);
    }

    /* ===== LOGIN OVERLAY ===== */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter:blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:999;
    }
    .overlay.show{display:flex}
    .loginCard{
      width:min(520px, 94vw);
      background:rgba(17,24,39,.92);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:0 18px 55px rgba(0,0,0,.40);
      padding:16px;
    }
    .loginTitle{
      font-size:22px;font-weight:950;margin:2px 0 10px;
      letter-spacing:.2px;
    }
    .formRow{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .label{font-size:13px;color:var(--muted);font-weight:800}
    .input, .select{
      width:100%;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#0b1020;
      color:var(--text);
      font-size:16px;
      font-weight:850;
      outline:none;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
    }
    .loginBtn{
      width:100%;
      margin-top:12px;
      background:linear-gradient(135deg,rgba(96,165,250,.22), rgba(11,16,32,.96));
      border-color:rgba(96,165,250,.55);
      font-size:16px;
      font-weight:950;
      min-height:52px;
      border-radius:16px;
    }
    .loginHint{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.45}
    .loginError{
      margin-top:10px;
      color:#fecaca;
      background:rgba(248,113,113,.10);
      border:1px solid rgba(248,113,113,.35);
      padding:10px 12px;border-radius:14px;
      display:none;
      font-size:13px;
      line-height:1.4;
    }

    /* ===== ✅ 모바일 우선 레이아웃 ===== */
    @media(max-width:520px){
      .container{padding:10px}
      .card{padding:14px;border-radius:18px}

      .btnRow{flex-wrap:nowrap;gap:8px}
      .btn{min-height:52px;font-size:16px;padding:10px 12px;border-radius:14px}
      .btnBack{font-size:19px;min-width:54px}
      .btnLang{min-width:64px;font-size:16px}
      .btnLogout{min-height:48px;font-size:14px}

      .pill{font-size:12px;padding:9px 10px}

      .tabs{
        display:grid;
        grid-template-columns:repeat(4,1fr);
        gap:8px;
        margin-top:10px;
      }
      .tab{
        min-height:44px;
        font-size:13px;
        padding:10px 8px;
        border-radius:14px;
        text-align:center;
      }

      #panel-quiz .btnRow{
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:8px;
        align-items:stretch;
      }
      #btnMode, #btnNew{
        width:100%;
        font-size:13px;
        padding:10px 10px;
        min-height:44px;
        border-radius:14px;
      }
      #legacyBtnQuiz{
        grid-column:1 / -1;
        width:100%;
        font-size:13px;
        padding:10px 10px;
        min-height:44px;
        border-radius:14px;
        text-align:center;
      }

      #btnNewMixed{font-size:13px;padding:10px 10px;min-height:44px;border-radius:14px}

      .qText{font-size:28px;}
      .choices{gap:6px;}
      .choice{font-size:23px;min-height:48px;padding:12px 10px;}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <span class="dot"></span>
      <span>Korean Quiz</span>
    </div>

    <div class="btnRow">
      <span class="pill" id="pillUser" style="display:none;"></span>
      <button class="btn btnBack" id="btnBack" type="button" aria-label="back">←</button>
      <button class="btn btnLang" id="btnLang" type="button">KR</button>
      <button class="btn btnLogout" id="btnLogout" type="button" style="display:none;">로그아웃</button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-end">
        <div>
          <h1 style="margin:0 0 6px;font-size:28px;font-weight:950;letter-spacing:.2px" id="title">레슨</h1>
          <div class="muted" id="subtitle">불러오는 중...</div>
        </div>
        <div class="muted small" id="status"></div>
      </div>

      <div class="tabs" role="tablist" aria-label="lesson tabs">
        <button class="tab tab-vocab active" id="tab-vocab" type="button">어휘 보기</button>
        <button class="tab tab-quiz" id="tab-quiz" type="button">어휘 테스트</button>
        <button class="tab tab-grammar" id="tab-grammar" type="button">문법</button>
        <button class="tab tab-mixed" id="tab-mixed" type="button">종합 테스트</button>
      </div>

      <div class="bar"></div>

      <div class="panel active" id="panel-vocab">
        <div class="btnRow" id="legacyRowVocab" style="margin-bottom:10px;display:none;">
          <a class="btn btnLegacy" id="legacyBtnVocab" href="#">기존 어휘(HTML) 보기</a>
        </div>
        <div id="vocab"></div>
      </div>

      <div class="panel" id="panel-quiz">
        <div class="btnRow" style="margin-bottom:10px;">
          <button class="btn btnMode" id="btnMode" type="button">방향: 한국어 → 몽골어</button>
          <button class="btn btnNew" id="btnNew" type="button">새 문제</button>
          <a class="btn btnLegacy" id="legacyBtnQuiz" href="#" style="display:none;">기존 자료(HTML) 보기</a>
        </div>
        <div class="muted small" id="quizHint"></div>
        <div class="bar"></div>
        <div id="quiz"></div>
      </div>

      <div class="panel" id="panel-grammar">
        <div id="grammar"></div>
      </div>

      <div class="panel" id="panel-mixed">
        <div class="btnRow" style="margin-bottom:10px;">
          <button class="btn btnNew" id="btnNewMixed" type="button">새 문제</button>
        </div>
        <div class="muted small" id="mixedHint"></div>
        <div class="bar"></div>
        <div id="mixed"></div>
      </div>
    </section>
  </main>

  <!-- LOGIN OVERLAY -->
  <div class="overlay" id="loginOverlay" role="dialog" aria-modal="true" aria-label="login">
    <div class="loginCard">
      <div class="loginTitle" id="loginTitle">로그인</div>
      <div class="muted small" id="loginSub">이름/비밀번호/반을 입력(선택)하세요.</div>

      <div class="formRow">
        <div>
          <div class="label" id="lblPw">비밀번호</div>
          <input class="input" id="inpPw" type="password" autocomplete="current-password" inputmode="text" placeholder="비밀번호" />
        </div>
        <div>
          <div class="label" id="lblName">이름</div>
          <input class="input" id="inpName" type="text" autocomplete="name" inputmode="text" placeholder="예: tae" />
        </div>
        <div>
          <div class="label" id="lblClass">반</div>
          <select class="select" id="selClass">
            <option value="BBTA1반">BBTA1반</option>
            <option value="EKO1반">EKO1반</option>
            <option value="EKO2반">EKO2반</option>
            <option value="토픽반">토픽반</option>
            <option value="기타반">기타반</option>
          </select>
        </div>
      </div>

      <button class="btn loginBtn" id="btnLogin" type="button">Start</button>
      <div class="loginError" id="loginError"></div>
      <div class="loginHint" id="loginHint">
        * 로그인 정보는 이 기기에 임시 저장됩니다. (권한 기능 없음: 로그인하면 모두 사용 가능)
      </div>
    </div>
  </div>

  <script>
    /*
      ✅ 구글시트 자동 기록(로그인/로그아웃/자동로그아웃)을 하려면
      1) Google Apps Script를 "웹 앱으로 배포"해서 URL을 만듭니다.
      2) 아래 GAS_WEBAPP_URL에 그 URL을 붙여넣으세요.
      3) GAS 쪽에서 doPost(e)로 JSON을 받아 시트에 append 하도록 구현하면 됩니다.
    */
    const GAS_WEBAPP_URL = ""; // 예: "https://script.google.com/macros/s/XXXXXXXXXXXX/exec"

    const APP = {
      PASSWORD: "tae",
      AUTO_LOGOUT_MINUTES: 30,
      STORAGE: {
        name: "kq_name",
        klass: "kq_klass",
        token: "kq_token",
        lastActive: "kq_last_active",
        session: "kq_session_id"
      }
    };

    const I18N = {
      KR: {
        loading: "불러오는 중...",
        loaded: "로드 완료",
        vocabView: "어휘 보기",
        vocabQuiz: "어휘 테스트",
        grammar: "문법",
        mixed: "종합 테스트",
        legacyVocab: "기존 어휘(HTML) 보기",
        legacyHtml: "기존 자료(HTML) 보기",
        thKo: "한국어",
        thMn: "몽골어",
        noVocab: "어휘 데이터가 없습니다.",
        useLegacy: "아래 버튼으로 기존 자료를 사용할 수 있습니다.",
        noGrammar: "문법이 없습니다.",
        modeK2M: "방향: 한국어 → 몽골어",
        modeM2K: "방향: 몽골어 → 한국어",
        newQ: "새 문제",
        quizHint: (n)=> n ? `어휘 ${n}개로 테스트합니다. (4지선다, 랜덤)` : "어휘 데이터가 없어서 테스트를 만들 수 없습니다.",
        mixedHint: (nv, ng)=> (nv||ng) ? `어휘/문법을 섞어 랜덤 출제합니다. (현재: 어휘 ${nv}개, 문법 ${ng}개)` : "어휘/문법 데이터가 없어서 테스트를 만들 수 없습니다.",
        qLabel: "문제",
        correct: "정답!",
        wrong: "오답!",
        answer: "정답",
        cant: "퀴즈를 만들 수 없습니다. (데이터 확인 필요)",
        loginTitle: "로그인",
        loginSub: "이름/비밀번호/반을 입력(선택)하세요.",
        lblPw: "비밀번호",
        lblName: "이름",
        lblClass: "반",
        start: "Start",
        logout: "로그아웃",
        pwWrong: "비밀번호가 틀렸습니다.",
        fillName: "이름을 입력해 주세요."
      },
      MN: {
        loading: "Ачаалж байна...",
        loaded: "Ачааллаа",
        vocabView: "Үг харах",
        vocabQuiz: "Үг шалгалт",
        grammar: "Дүрэм",
        mixed: "Нэгдсэн тест",
        legacyVocab: "Хуучин үгс (HTML) харах",
        legacyHtml: "Хуучин материал (HTML) харах",
        thKo: "Солонгос",
        thMn: "Монгол",
        noVocab: "Үгийн өгөгдөл алга.",
        useLegacy: "Доорх товчоор хуучин материалыг ашиглаж болно.",
        noGrammar: "Дүрэм байхгүй.",
        modeK2M: "Чиглэл: Солонгос → Монгол",
        modeM2K: "Чиглэл: Монгол → Солонгос",
        newQ: "Шинэ асуулт",
        quizHint: (n)=> n ? `Үг ${n} ширхэгээр шалгана. (4 сонголт, санамсаргүй)` : "Үг байхгүй тул шалгалт үүсгэж чадсангүй.",
        mixedHint: (nv, ng)=> (nv||ng) ? `Үг/Дүрмийг хольж санамсаргүй асууна. (Одоо: Үг ${nv}, Дүрэм ${ng})` : "Үг/Дүрэм байхгүй тул тест үүсгэж чадсангүй.",
        qLabel: "Асуулт",
        correct: "Зөв!",
        wrong: "Буруу!",
        answer: "Зөв хариулт",
        cant: "Шалгалт үүсгэж чадсангүй. (өгөгдөл шалгана уу)",
        loginTitle: "Нэвтрэх",
        loginSub: "Нэр/нууц үг/ангийг оруулна уу.",
        lblPw: "Нууц үг",
        lblName: "Нэр",
        lblClass: "Анги",
        start: "Start",
        logout: "Гарах",
        pwWrong: "Нууц үг буруу байна.",
        fillName: "Нэрээ оруулна уу."
      }
    };

    function getLang(){
      const u = new URL(location.href);
      const q = (u.searchParams.get("lang")||"").toUpperCase();
      const s1 = (localStorage.getItem("lang")||"").toUpperCase();
      const s2 = (localStorage.getItem("kq_lang")||"").toUpperCase();
      const pick = (q==="MN"||q==="KR") ? q : (s2||s1);
      return (pick==="MN") ? "MN" : "KR";
    }
    function setLang(l){
      localStorage.setItem("lang", l);
      localStorage.setItem("kq_lang", l);
    }
    function tr(key, a, b){
      const L = getLang();
      const v = (I18N[L] && I18N[L][key]) ? I18N[L][key] : I18N.KR[key];
      return (typeof v === "function") ? v(a, b) : v;
    }

    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }
    function setParam(name, value){
      const u = new URL(location.href);
      if(value===null || value===undefined || value==="") u.searchParams.delete(name);
      else u.searchParams.set(name, value);
      history.replaceState(null, "", u.toString());
    }

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function setActiveTab(which){
      const tabs = [
        {t:document.getElementById("tab-vocab"), p:document.getElementById("panel-vocab"), k:"vocab"},
        {t:document.getElementById("tab-quiz"), p:document.getElementById("panel-quiz"), k:"quiz"},
        {t:document.getElementById("tab-grammar"), p:document.getElementById("panel-grammar"), k:"grammar"},
        {t:document.getElementById("tab-mixed"), p:document.getElementById("panel-mixed"), k:"mixed"}
      ];
      tabs.forEach(x=>{
        const on = x.k===which;
        x.t.classList.toggle("active", on);
        x.p.classList.toggle("active", on);
      });
    }

    // ===== USER CONTEXT (LOGIN) =====
    function newSessionId(){
      return "sess_" + Math.random().toString(16).slice(2) + "_" + Date.now();
    }

    function getUserContext(){
      const name = (localStorage.getItem(APP.STORAGE.name) || "").trim();
      const klass = (localStorage.getItem(APP.STORAGE.klass) || "").trim();
      const token = (localStorage.getItem(APP.STORAGE.token) || "").trim();
      const sessionId = (localStorage.getItem(APP.STORAGE.session) || "").trim();
      return { name, klass, token, sessionId };
    }

    function setUserContext({name, klass, token}){
      localStorage.setItem(APP.STORAGE.name, name || "");
      localStorage.setItem(APP.STORAGE.klass, klass || "");
      if(token !== undefined) localStorage.setItem(APP.STORAGE.token, token || "");
      if(!localStorage.getItem(APP.STORAGE.session)) localStorage.setItem(APP.STORAGE.session, newSessionId());

      // URL에도 넣어서 유지(원하면 빼도 됨)
      setParam("name", name || "");
      setParam("klass", klass || "");
    }

    function clearUserContext(){
      localStorage.removeItem(APP.STORAGE.name);
      localStorage.removeItem(APP.STORAGE.klass);
      localStorage.removeItem(APP.STORAGE.lastActive);
      localStorage.removeItem(APP.STORAGE.session);
      setParam("name","");
      setParam("klass","");
    }

    function showUserPill(){
      const pill = document.getElementById("pillUser");
      const btnLogout = document.getElementById("btnLogout");
      const {name, klass} = getUserContext();
      if(name || klass){
        pill.style.display = "";
        pill.textContent = `${name || "-"} · ${klass || "-"}`;
        btnLogout.style.display = "";
      }else{
        pill.style.display = "none";
        btnLogout.style.display = "none";
      }
    }

    function openLogin(){
      document.getElementById("loginError").style.display = "none";
      const ov = document.getElementById("loginOverlay");
      ov.classList.add("show");
      // 기본값
      const ctx = getUserContext();
      const inpName = document.getElementById("inpName");
      const inpPw = document.getElementById("inpPw");
      const sel = document.getElementById("selClass");
      inpName.value = ctx.name || "tae";
      inpPw.value = "";
      if(ctx.klass) sel.value = ctx.klass;
      setTimeout(()=>inpPw.focus(), 50);
    }
    function closeLogin(){
      const ov = document.getElementById("loginOverlay");
      ov.classList.remove("show");
    }

    function applyLoginTexts(){
      document.getElementById("loginTitle").textContent = tr("loginTitle");
      document.getElementById("loginSub").textContent = tr("loginSub");
      document.getElementById("lblPw").textContent = tr("lblPw");
      document.getElementById("lblName").textContent = tr("lblName");
      document.getElementById("lblClass").textContent = tr("lblClass");
      document.getElementById("btnLogin").textContent = tr("start");
      document.getElementById("btnLogout").textContent = tr("logout");
    }

    function ensureLoginOrShow(){
      const {name, klass} = getUserContext();
      if(!name || !klass){
        openLogin();
        return false;
      }
      return true;
    }

    // ===== Google Sheet Logging via GAS =====
    async function sendToSheet(payload){
      if(!GAS_WEBAPP_URL || !/^https?:\/\//.test(GAS_WEBAPP_URL)) return;
      try{
        await fetch(GAS_WEBAPP_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload),
          mode: "cors",
          cache: "no-store"
        });
      }catch(e){
        // 실패해도 앱은 계속 동작
        console.log("GAS log failed:", e);
      }
    }

    function buildLogPayload(eventName, extra){
      const ctx = getUserContext();
      return {
        event: eventName,
        name: ctx.name || "",
        klass: ctx.klass || "",
        sessionId: ctx.sessionId || "",
        lang: getLang(),
        page: location.pathname,
        url: location.href,
        ts: new Date().toISOString(),
        ua: navigator.userAgent,
        ...((extra && typeof extra === "object") ? extra : {})
      };
    }

    // ===== Auto Logout after inactivity =====
    function touchActive(){
      localStorage.setItem(APP.STORAGE.lastActive, String(Date.now()));
    }
    function minutesSinceActive(){
      const v = parseInt(localStorage.getItem(APP.STORAGE.lastActive) || "0", 10);
      if(!v) return Infinity;
      return (Date.now() - v) / 60000;
    }
    async function autoLogoutIfNeeded(){
      if(!getUserContext().name) return;
      if(minutesSinceActive() >= APP.AUTO_LOGOUT_MINUTES){
        await doLogout("auto");
      }
    }
    function startActivityWatch(){
      const events = ["pointerdown","touchstart","keydown","scroll","mousemove"];
      const handler = ()=>touchActive();
      events.forEach(ev=>window.addEventListener(ev, handler, {passive:true}));
      touchActive();
      setInterval(autoLogoutIfNeeded, 15000);
      document.addEventListener("visibilitychange", ()=>{
        if(!document.hidden) touchActive();
      });
    }

    async function doLogout(reason){
      await sendToSheet(buildLogPayload("logout", {reason: reason || "manual"}));
      clearUserContext();
      showUserPill();
      openLogin();
    }

    // ===== QUIZ =====
    let LESSON = null;
    let QUIZ_MODE = "KO2MN";

    function applyTexts(){
      document.documentElement.lang = (getLang()==="MN") ? "mn" : "ko";
      document.getElementById("btnLang").textContent = getLang();
      document.getElementById("subtitle").textContent = tr("loading");

      document.getElementById("tab-vocab").textContent = tr("vocabView");
      document.getElementById("tab-quiz").textContent = tr("vocabQuiz");
      document.getElementById("tab-grammar").textContent = tr("grammar");
      document.getElementById("tab-mixed").textContent = tr("mixed");

      document.getElementById("legacyBtnVocab").textContent = tr("legacyVocab");
      document.getElementById("legacyBtnQuiz").textContent = tr("legacyHtml");

      document.getElementById("btnNew").textContent = tr("newQ");
      document.getElementById("btnNewMixed").textContent = tr("newQ");
      document.getElementById("btnMode").textContent = (QUIZ_MODE==="KO2MN") ? tr("modeK2M") : tr("modeM2K");

      applyLoginTexts();
      showUserPill();
    }

    function renderVocab(d){
      const vocabDiv = document.getElementById("vocab");
      const legacyRow = document.getElementById("legacyRowVocab");
      const legacyBtn = document.getElementById("legacyBtnVocab");

      if(d.legacy_vocab_url){
        legacyBtn.href = d.legacy_vocab_url;
        legacyRow.style.display = "";
      } else {
        legacyRow.style.display = "none";
      }

      const vocab = d.vocab || [];
      if(vocab.length){
        let html = `<table><thead><tr>
          <th>${tr("thKo")}</th><th>${tr("thMn")}</th>
        </tr></thead><tbody>`;
        vocab.forEach(v=>{
          const ko = v.ko || "";
          const mn = v.mn || "";
          html += `<tr>
            <td><b>${ko}</b></td>
            <td>${mn || "<span class='muted'>-</span>"}</td>
          </tr>`;
        });
        html += "</tbody></table>";
        vocabDiv.innerHTML = html;
      } else {
        vocabDiv.innerHTML =
          `<div class='muted'>${tr("noVocab")}</div>` +
          (d.legacy_vocab_url ? `<div class='muted small' style='margin-top:6px;'>${tr("useLegacy")}</div>` : "");
      }
    }

    function renderGrammar(d){
      const gramDiv = document.getElementById("grammar");
      const grammar = d.grammar || [];
      if(grammar.length){
        let html = "";
        grammar.forEach(g=>{
          const examples = (g.examples || []).map(e=>{
            const kr = e.kr || "";
            const mn = e.mn || "";
            return `<div style="margin-top:8px;">• ${kr}<br/><span class="muted">${mn}</span></div>`;
          }).join("");
          html += `<div class="card" style="margin-top:10px;">
            <div style="font-weight:950;font-size:18px;">${g.title || ""}</div>
            ${g.pattern ? `<div class="muted small" style="margin-top:6px;">${g.pattern}</div>` : ""}
            ${g.use_kr ? `<div class="muted" style="margin-top:8px;">${g.use_kr}</div>` : ""}
            ${g.use_mn ? `<div class="muted" style="margin-top:6px;">${g.use_mn}</div>` : ""}
            ${examples ? `<div style="margin-top:10px;">${examples}</div>` : ""}
          </div>`;
        });
        gramDiv.innerHTML = html;
      } else {
        gramDiv.innerHTML = `<div class='muted'>${tr("noGrammar")}</div>`;
      }
    }

    function pickVocabQuestion(vocab){
      const pool = vocab.filter(v => (v.ko || v.mn));
      if(!pool.length) return null;

      const q = pool[Math.floor(Math.random()*pool.length)];
      const getPrompt = (v) => QUIZ_MODE==="KO2MN" ? (v.ko||"") : (v.mn||"");
      const getAnswer = (v) => QUIZ_MODE==="KO2MN" ? (v.mn||"") : (v.ko||"");

      const correct = getAnswer(q);
      const prompt = getPrompt(q);
      if(!prompt || !correct) return null;

      const others = pool.map(v => getAnswer(v)).filter(a => a && a !== correct);
      const uniq = Array.from(new Set(others));
      const distractors = shuffle(uniq).slice(0, 3);
      const choices = shuffle([correct, ...distractors]);

      return { prompt, correct, choices };
    }

    function renderQuestionInto(containerEl, q){
      containerEl.innerHTML = "";
      if(!q){
        containerEl.innerHTML = `<div class='muted'>${tr("cant")}</div>`;
        return;
      }

      const box = document.createElement("div");
      box.className = "qbox";

      const head = document.createElement("div");
      head.className = "qHead";
      head.innerHTML = `<div class="qLabel">${tr("qLabel")}</div><div class="qText">${q.prompt}</div>`;
      box.appendChild(head);

      const choicesWrap = document.createElement("div");
      choicesWrap.className = "choices";

      const result = document.createElement("div");
      result.className = "result";
      result.style.display = "none";

      function lock(){
        [...choicesWrap.querySelectorAll("button")].forEach(b=>b.disabled=true);
      }

      q.choices.forEach(ch=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "choice";
        btn.textContent = ch;

        btn.addEventListener("click", ()=>{
          touchActive();
          const ok = ch === q.correct;
          result.style.display = "";
          result.classList.remove("ok","bad");
          result.classList.add(ok ? "ok" : "bad");
          result.innerHTML = ok
            ? `<b>${tr("correct")}</b> <span class="muted small">(${tr("answer")}: ${q.correct})</span>`
            : `<b>${tr("wrong")}</b> <span class="muted small">${tr("answer")}: ${q.correct}</span>`;
          lock();
        });

        choicesWrap.appendChild(btn);
      });

      box.appendChild(choicesWrap);
      box.appendChild(result);
      containerEl.appendChild(box);
    }

    function renderQuiz(d){
      const quizDiv = document.getElementById("quiz");
      const hint = document.getElementById("quizHint");
      const legacyBtnQuiz = document.getElementById("legacyBtnQuiz");

      if(d.legacy_vocab_url){
        legacyBtnQuiz.href = d.legacy_vocab_url;
        legacyBtnQuiz.style.display = "";
      } else {
        legacyBtnQuiz.style.display = "none";
      }

      const vocab = d.vocab || [];
      hint.textContent = tr("quizHint", vocab.length);

      if(!vocab.length){
        quizDiv.innerHTML = `<div class='muted'>${tr("noVocab")}</div>`;
        return;
      }
      const q = pickVocabQuestion(vocab);
      renderQuestionInto(quizDiv, q);
    }

    function buildMixedQuestion(d){
      const mq = Array.isArray(d.mixed_questions) ? d.mixed_questions : [];
      const usable = mq.filter(x => x && x.prompt && x.correct && Array.isArray(x.choices) && x.choices.length >= 2);
      if(usable.length){
        const pick = usable[Math.floor(Math.random()*usable.length)];
        const uniq = Array.from(new Set([pick.correct, ...pick.choices])).filter(Boolean);
        const fixed = shuffle(uniq).slice(0,4);
        while(fixed.length < 4 && pick.correct) fixed.push(pick.correct);
        const finalChoices = shuffle(Array.from(new Set(fixed))).slice(0,4);
        return { prompt: pick.prompt, correct: pick.correct, choices: finalChoices };
      }
      const vocab = d.vocab || [];
      return pickVocabQuestion(vocab);
    }

    function renderMixed(d){
      const mixedDiv = document.getElementById("mixed");
      const mixedHint = document.getElementById("mixedHint");
      const nv = (d.vocab||[]).length;
      const ng = (d.grammar||[]).length;
      mixedHint.textContent = tr("mixedHint", nv, ng);

      const q = buildMixedQuestion(d);
      if(!q){
        mixedDiv.innerHTML = `<div class='muted'>${tr("cant")}</div>`;
        return;
      }
      renderQuestionInto(mixedDiv, q);
    }

    function makeLessonLabel(lessonRaw){
      const n = parseInt(String(lessonRaw || "").replace(/[^\d]/g,""), 10);
      if(Number.isFinite(n)) return `${n}과`;
      return lessonRaw ? String(lessonRaw) : "";
    }

    async function main(){
      applyTexts();
      startActivityWatch();

      document.getElementById("tab-vocab").addEventListener("click", ()=>{ touchActive(); setActiveTab("vocab"); });
      document.getElementById("tab-quiz").addEventListener("click", ()=>{ touchActive(); setActiveTab("quiz"); });
      document.getElementById("tab-grammar").addEventListener("click", ()=>{ touchActive(); setActiveTab("grammar"); });
      document.getElementById("tab-mixed").addEventListener("click", ()=>{ touchActive(); setActiveTab("mixed"); });

      document.getElementById("btnBack").addEventListener("click", ()=>{ touchActive(); history.back(); });

      document.getElementById("btnLogout").addEventListener("click", ()=>doLogout("manual"));

      document.getElementById("btnLang").addEventListener("click", ()=>{
        touchActive();
        const next = (getLang()==="KR") ? "MN" : "KR";
        setLang(next);
        setParam("lang", next);
        applyTexts();
        if(LESSON){
          renderVocab(LESSON);
          renderGrammar(LESSON);
          renderQuiz(LESSON);
          renderMixed(LESSON);
        }
      });

      function showLoginError(msg){
        const el = document.getElementById("loginError");
        el.textContent = msg;
        el.style.display = "";
      }

      document.getElementById("btnLogin").addEventListener("click", async ()=>{
        touchActive();
        const pw = (document.getElementById("inpPw").value || "").trim();
        const name = (document.getElementById("inpName").value || "").trim();
        const klass = (document.getElementById("selClass").value || "").trim();

        if(pw !== APP.PASSWORD){
          showLoginError(tr("pwWrong"));
          return;
        }
        if(!name){
          showLoginError(tr("fillName"));
          return;
        }

        // 세션 설정
        if(!localStorage.getItem(APP.STORAGE.session)) localStorage.setItem(APP.STORAGE.session, newSessionId());
        setUserContext({name, klass});
        showUserPill();
        closeLogin();

        // 로그인 기록(구글시트)
        await sendToSheet(buildLogPayload("login", {reason:"manual"}));
      });

      // 엔터로 로그인
      document.getElementById("inpPw").addEventListener("keydown", (e)=>{
        if(e.key === "Enter") document.getElementById("btnLogin").click();
      });
      document.getElementById("inpName").addEventListener("keydown", (e)=>{
        if(e.key === "Enter") document.getElementById("btnLogin").click();
      });

      document.getElementById("btnMode").addEventListener("click", ()=>{
        touchActive();
        QUIZ_MODE = (QUIZ_MODE==="KO2MN") ? "MN2KO" : "KO2MN";
        applyTexts();
        if(LESSON) renderQuiz(LESSON);
      });

      document.getElementById("btnNew").addEventListener("click", ()=>{
        touchActive();
        if(LESSON) renderQuiz(LESSON);
      });

      document.getElementById("btnNewMixed").addEventListener("click", ()=>{
        touchActive();
        if(LESSON) renderMixed(LESSON);
      });

      // ✅ 로그인 없으면 먼저 로그인 창
      if(!ensureLoginOrShow()){
        applyTexts();
        return;
      }else{
        // 로그인 상태면 로드 시에도 한 번 기록(원하면 제거 가능)
        await sendToSheet(buildLogPayload("open_lesson"));
      }

      const dataPath = getParam("data");
      const title = document.getElementById("title");
      const subtitle = document.getElementById("subtitle");
      const status = document.getElementById("status");

      if(!dataPath){
        subtitle.textContent = "data 경로가 없습니다.";
        status.textContent = "오류";
        return;
      }

      try{
        const dataUrl = new URL(dataPath, location.href).toString();
        status.textContent = "Loading...";
        subtitle.textContent = tr("loading");

        const res = await fetch(dataUrl, { cache:"no-store" });
        if(!res.ok) throw new Error("레슨 JSON 로드 실패: " + res.status);

        const d = await res.json();
        LESSON = d;

        const level = (d.meta && d.meta.level) ? d.meta.level : (d.level || "");
        const lesson = (d.meta && d.meta.lesson) ? d.meta.lesson : (d.lesson || "");
        const lessonLabel = makeLessonLabel(lesson);
        const tmn = d.title_mn || (d.meta && d.meta.title_mn) || "";

        title.textContent = `${level} ${lessonLabel}`.trim() || "레슨";
        subtitle.textContent = tmn || "";
        status.textContent = tr("loaded");

        renderVocab(d);
        renderGrammar(d);
        renderQuiz(d);
        renderMixed(d);

      } catch(err){
        subtitle.textContent = "불러오기 오류: " + (err.message || err);
        status.textContent = "오류";
        console.log(err);
      }
    }

    main();
  </script>
</body>
</html>
