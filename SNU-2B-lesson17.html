<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>SNU 2B ¬∑ Lesson 17 ¬∑ “Æ–≥–∏–π–Ω —Ç–µ—Å—Ç</title>

  <style>
    :root{
      --bg:#f0f4f8; --card:#ffffff; --primary:#2d6cdf; --primary2:#1f4ea5;
      --line:#d9e4f5; --text:#223047; --muted:#6a7a8e; --ok:#0f7a3d; --bad:#c0392b;
      --warnbg:#fff5f5; --warnline:#feb2b2; --okbg:#f0fff4; --okline:#b7f0c7;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:8px; background:var(--bg); color:var(--text);
      font-family: Arial, system-ui, -apple-system, "Segoe UI", sans-serif;
      text-align:center; -webkit-text-size-adjust:100%;
    }
    .container{
      max-width:560px; margin:0 auto; height:calc(100vh - 16px);
      background:var(--card); border:1px solid var(--line); border-radius:18px;
      box-shadow:0 10px 20px rgba(0,0,0,.08);
      display:flex; flex-direction:column; gap:6px; padding:10px;
      overflow:hidden;
    }
    .header{position:sticky; top:0; background:var(--card); padding:2px 4px 0; z-index:5;}
    .title{margin:0; font-size:18px; font-weight:900;}
    .sub{margin:4px 0 0; color:var(--muted); font-size:12px; line-height:1.25;}
    .row{display:flex; gap:6px; align-items:center; justify-content:center; flex-wrap:wrap;}
    .pill{font-size:11px; padding:5px 9px; border-radius:999px; border:1px solid var(--line); background:#f7fbff;}
    .pill b{font-weight:900}

    .modeBtn, .speedBtn{
      border:2px solid var(--primary); background:#fff; color:var(--text);
      padding:7px 9px; border-radius:12px; font-weight:900; cursor:pointer;
      min-width:132px; font-size: clamp(11px, 3.1vw, 13px); line-height:1.15; white-space:normal;
    }
    .modeBtn.active, .speedBtn.active{background:var(--primary); color:#fff;}

    .main{flex:1; min-height:0; display:flex; flex-direction:column; gap:6px;}
    .qbox{
      border:1px solid var(--line); border-radius:16px; padding:10px; background:#fff;
      display:flex; flex-direction:column; gap:8px; flex:1; min-height:0;
      overflow:hidden;
    }
    .qNo{font-size:12px; color:var(--muted); text-align:left;}

    .qText{
      font-size: clamp(18px, 5.1vw, 28px);
      font-weight:900; line-height:1.10;
      word-break:keep-all; overflow-wrap:anywhere;
      margin:0; padding:0 2px;
      text-align:center;
    }

    .choices{display:grid; grid-template-columns:1fr; gap:10px; margin-top:2px;}

    .choice{
      width:100%; padding:12px 10px; border-radius:16px; border:2px solid var(--primary);
      background:#fff; color:var(--text); font-weight:900; cursor:pointer; transition:.15s;
      word-break:keep-all; overflow-wrap:anywhere; line-height:1.12;
      font-size: clamp(16px, 4.3vw, 22px);
      min-height:50px; display:flex; align-items:center; justify-content:center; text-align:center;
      overflow:hidden;
    }
    .choice:hover{background:var(--primary); color:#fff;}
    .choice.disabled{opacity:.55; cursor:not-allowed;}
    .choice.correct{border-color:var(--ok);}
    .choice.wrong{border-color:var(--bad);}

    .footerBtns{display:flex; gap:10px; margin-top:0;}
    .btn{
      flex:1; padding:10px; border:none; border-radius:12px; background:var(--primary);
      color:#fff; font-weight:900; cursor:pointer; font-size:13px;
    }
    .btn:hover{background:var(--primary2);}
    .btn.gray{background:#eef2f7; color:var(--text); border:1px solid #d7dee7;}
    .btn.gray:hover{background:#e2e8f0;}

    .msg{
      padding:9px 10px; border-radius:12px; text-align:left;
      font-size:12px; line-height:1.35; white-space:pre-line;
    }
    .msg.warn{background:var(--warnbg); border:1px solid var(--warnline); color:#7a1f1f;}
    .msg.ok{background:var(--okbg); border:1px solid var(--okline); color:#0f7a3d;}
    .hidden{display:none !important;}

    /* ===== Review ===== */
    .reviewHeadline{
      font-size: clamp(30px, 8.6vw, 48px);
      font-weight:900; margin:0; letter-spacing:-0.8px; line-height:1.02;
      color:#1f2b3d; text-align:center;
    }
    .reviewMsgBox{
      background: #f7fbff;
      border: 1px solid var(--line);
      color: #1f2b3d;
      border-radius: 12px;
      padding: 10px 12px;
      text-align:left;
      font-size: 13px;
      line-height: 1.35;
      white-space: pre-line;
    }
    .reviewList{
      text-align:left;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      overflow:auto;
      max-height:44vh;
      background:#fff;
    }
    .reviewItem{ padding:10px 0; border-bottom:1px dashed #e6eefb; }
    .reviewItem:last-child{border-bottom:none;}
    .reviewNo{ font-size:16px; font-weight:900; color:#1f2b3d; margin:0 0 6px; }
    .reviewQ{ font-size:14px; font-weight:900; color:#1f2b3d; margin:0 0 8px; }
    .reviewAns{ font-size:18px; font-weight:900; color: var(--ok); margin:0; }
    .badgeTimeout{
      display:inline-block; margin-left:8px; padding:2px 8px;
      border-radius:999px; border:1px solid var(--warnline);
      background:var(--warnbg); color:#7a1f1f; font-weight:900;
      font-size:11px; vertical-align:middle;
    }

    .small{font-size:11px; color:var(--muted);}

    @media (max-width: 390px){
      body{padding:6px;}
      .container{height:calc(100vh - 12px); padding:9px; gap:5px;}
      .sub{font-size:11px;}
      .pill{font-size:10.5px; padding:4px 8px;}
      .modeBtn, .speedBtn{
        min-width:128px; padding:6px 8px;
        font-size: clamp(10.5px, 3.0vw, 12px);
      }
      .qbox{padding:9px; gap:7px;}
      .qText{font-size: clamp(17px, 5.0vw, 26px);}
      .choices{gap:9px;}
      .choice{min-height:48px; padding:11px 10px; font-size: clamp(15px, 4.1vw, 21px);}
      .btn{padding:9px; font-size:12.5px;}
    }

    /* Review/ResultÏóêÏÑúÎäî ÏãúÍ∞Ñ/ÏÑ§Ï†ïÏù¥ Ï†àÎåÄ ÎÇòÏò§Î©¥ Ïïà Îê® */
    .hideOnReviewResult{display:block;}
    .screen-review .hideOnReviewResult,
    .screen-result .hideOnReviewResult{display:none !important;}

    /* ===== Result ===== */
    .resultHeadline{
      font-size: clamp(24px, 6.2vw, 38px);
      font-weight: 900;
      margin:0 0 6px;
      letter-spacing:-0.5px;
      line-height:1.03;
    }
    #resultBox{ overflow:hidden; }

    .resultCard{
      border: 2px solid var(--okline);
      background: #f3fff6;
      border-radius: 18px;
      padding: 10px 12px;
      text-align: left;

      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;

      justify-content: space-between;
      gap: 6px;
      overflow: hidden;
    }
    .resultLeft{
      color: var(--ok);
      font-weight: 900;
      line-height: 1.32;
      font-size: 14px;
      white-space: pre-line;
    }
    @media (max-width: 390px){
      .resultLeft{font-size: 13.5px;}
    }

    #blessLines{
      width:100%;
      margin-top: 6px;
      text-align:center;
      line-height:1.12;
      word-break:keep-all;
      overflow-wrap:anywhere;
      padding-bottom: 2px;
    }
    #blessLines > div{ display:block; white-space:normal; }
    #blessLines .line-red{
      color:#e53935; font-weight:900;
      font-size: clamp(18px, 4.6vw, 24px);
      margin-top: 2px;
    }
    #blessLines .line-purple{
      color:#6a1b9a; font-weight:900;
      font-size: clamp(18px, 4.6vw, 24px);
      margin-top: 12px;
    }
    #blessLines .line-blue{
      color:#1e88e5; font-weight:900;
      font-size: clamp(18px, 4.6vw, 24px);
      margin-top: 12px;
    }
  </style>
</head>

<body>
  <div class="container" id="appRoot">
    <div class="header">
      <h1 class="title">SNU 2B ¬∑ Lesson 17</h1>
      <p class="sub" id="userLine">...</p>

      <div class="row">
        <span class="pill">Score: <b id="scorePill">0</b>/100</span>
        <span class="pill">Attempts: <b id="attemptPill">0</b></span>
        <span class="pill hideOnReviewResult">Time: <b id="timePill">-</b>s</span>
        <span class="pill">Date: <b id="datePill">-</b></span>
      </div>

      <div class="row hideOnReviewResult" style="margin-top:8px;">
        <button class="modeBtn active" id="modeKo" onclick="setMode('KOQ')">ÌïúÍµ≠Ïñ¥ ÏßàÎ¨∏ ‚Üí Î™ΩÍ≥®Ïñ¥ Î≥¥Í∏∞</button>
        <button class="modeBtn" id="modeMn" onclick="setMode('MNQ')">–ú–æ–Ω–≥–æ–ª –∞—Å—É—É–ª—Ç ‚Üí ÌïúÍµ≠Ïñ¥ Î≥¥Í∏∞</button>
      </div>

      <div class="row hideOnReviewResult" style="margin-top:6px;">
        <button class="speedBtn active" id="speedNormal" onclick="setSpeed('normal')">Î≥¥ÌÜµ</button>
        <button class="speedBtn" id="speedSlow" onclick="setSpeed('slow')">ÎäêÎ¶º</button>
      </div>

      <div class="msg warn hidden" id="topMsg"></div>
    </div>

    <div class="main">
      <!-- QUIZ -->
      <div class="qbox" id="quizBox">
        <div class="qNo" id="qNo">Q 1 / 0</div>
        <div class="qText" id="qText">...</div>
        <div class="choices" id="choices"></div>

        <div class="footerBtns">
          <button class="btn gray" onclick="goBackHub()">‚Üê Hub</button>
          <button class="btn gray" onclick="restartQuiz()">Restart</button>
        </div>
        <div class="small">‚Äª 4 choices / Language-cross / JSONP log / timeout=wrong+next</div>
      </div>

      <!-- REVIEW (Ï†ïÏ±Ö: Ï†êÏàòÏôÄ ÏÉÅÍ¥ÄÏóÜÏù¥ Î¨¥Ï°∞Í±¥ Î®ºÏ†Ä) -->
      <div class="qbox hidden" id="reviewBox">
        <div class="reviewHeadline">Review</div>
        <div class="reviewMsgBox" id="reviewMsg"></div>
        <div class="reviewList" id="reviewList"></div>
        <div class="footerBtns">
          <button class="btn" onclick="restartQuiz()">Retry</button>
          <button class="btn gray" onclick="showResultScreen()">Result</button>
        </div>
      </div>

      <!-- RESULT -->
      <div class="qbox hidden" id="resultBox">
        <div class="resultHeadline" id="resultHeadline">–¢—ç–Ω—Ü–ª—ç—ç!</div>

        <div class="resultCard" id="resultCard">
          <div class="resultLeft" id="resultMeta"></div>

          <div id="blessLines">
            <div class="line-red">–ë–∞—è—Ä —Ö“Ø—Ä–≥—ç–µ!</div>
            <div class="line-purple">”®–Ω”©”©–¥—Ä–∏–π–Ω –∑“Ø—Ç–≥—ç–ª ‚Äî –¢–∞–Ω—ã –∏—Ä—ç—ç–¥“Ø–π</div>
            <div class="line-blue">–ï—Å“Ø—Å —Ç–∞–Ω–¥ —Ö–∞–π—Ä—Ç–∞–π!</div>
          </div>
        </div>

        <div class="footerBtns">
          <button class="btn gray" onclick="goBackHub()">‚Üê Hub</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby_n5xrEIRduxeo2upw4D0nsishR6zwBOY5JO472-7wU3EAYip94-4BncYw5r7dWHj6/exec";
  const BOOK = "SNU-2B";
  const LESSON = "lesson17";

  /* Îã®Ïñ¥ Í∂åÏû•: Î≥¥ÌÜµ 10Ï¥à / ÎäêÎ¶º 12Ï¥à (ÏãúÍ∞Ñ Ï¥àÍ≥º=Ïò§Îãµ+Îã§Ïùå) */
  const TIME_LIMIT = { normal: 10, slow: 12 };
  let SPEED = "normal";

  const WORDS = [
    { ko: "Í∏∏ÏóêÏÑú ÎÑòÏñ¥ÏßÄÎã§", mn: "–ì—É–¥–∞–º–∂–∏–Ω–¥ –±“Ø–¥—Ä—á —É–Ω–∞—Ö" },
    { ko: "Î≤ÑÏä§Î•º ÎÜìÏπòÎã§", mn: "–ê–≤—Ç–æ–±—É—Å–Ω–∞–∞—Å —Ö–æ—Ü—Ä–æ—Ö" },
    { ko: "ÎπÑÌñâÍ∏∞Î•º ÎÜìÏπòÎã§", mn: "–û–Ω–≥–æ—Ü–Ω–æ–æ—Å —Ö–æ—Ü—Ä–æ—Ö" },
    { ko: "Í∏∞Ï∞®Î•º ÎÜìÏπ† ÎªîÌïòÎã§", mn: "–ì–∞–ª—Ç —Ç—ç—Ä–≥—ç—ç—Å —Ö–æ—Ü—Ä–æ—Ö —à–∞—Ö–∞—Ö" },
    { ko: "ÏûÉÏñ¥Î≤ÑÎ¶¨Îã§", mn: "—Ö–∞—è—Ö" },
    { ko: "Ìú¥ÎåÄ Ï†ÑÌôîÎ•º Îñ®Ïñ¥Îú®Î¶¨Îã§", mn: "–ì–∞—Ä —É—Ç—Å–∞–∞ —É–Ω–∞–≥–∞—Ö" },
    { ko: "ÏªµÏùÑ Îñ®Ïñ¥Îú®Î¶¥ ÎªîÌïòÎã§", mn: "–ê—è–≥–∞ —É–Ω–∞–≥–∞—Ö —à–∞—Ö–∞—Ö" },
    { ko: "Îã§Î•∏ ÏÇ¨ÎûåÍ≥º Î∂ÄÎî™ÌûàÎã§", mn: "”®”©—Ä —Ö“Ø–Ω—Ç—ç–π –º”©—Ä–≥”©–ª–¥”©—Ö" },
    { ko: "ÏûêÎèôÏ∞®Ïóê Î∂ÄÎî™ÌûàÎã§", mn: "–ú–∞—à–∏–Ω—Ç–∞–π –º”©—Ä–≥”©–ª–¥”©—Ö" },
    { ko: "ÏÇ∞Ïóê Î∂àÏù¥ ÎÇòÎã§", mn: "–£—É–ª–∞–Ω–¥ –≥–∞–ª –≥–∞—Ä–∞—Ö" },
    { ko: "ÏßëÏóê Î∂àÏù¥ ÎÇòÎã§", mn: "–ì—ç—Ä—Ç –≥–∞–ª –≥–∞—Ä–∞—Ö" },
    { ko: "ÍµêÌÜµÏÇ¨Í≥†Í∞Ä ÎÇòÎã§", mn: "–ó–∞–º —Ç—ç—ç–≤—Ä–∏–π–Ω –æ—Å–æ–ª –≥–∞—Ä–∞—Ö" },
    { ko: "Í≥†Ïû•Ïù¥ ÎÇòÎã§", mn: "–≠–≤–¥—Ä—ç—Ö" },
    { ko: "ÏïΩÏÜç ÏãúÍ∞ÑÏóê Îä¶Îã§", mn: "—Ü–∞–≥–∞–∞—Å–∞–∞ —Ö–æ—Ü—Ä–æ—Ö" },
    { ko: "ÌïôÍµêÏóê ÏßÄÍ∞ÅÌïòÎã§", mn: "–°—É—Ä–≥—É—É–ª—å–∞–∞—Å —Ö–æ—Ü—Ä–æ—Ö" },
    { ko: "Îπ®Í∞ÑÏÉâ Ïò∑ÏùÑ ÏûÖÎã§", mn: "–£–ª–∞–∞–Ω ”©–Ω–≥–∏–π–Ω —Ö—É–≤—Ü–∞—Å ”©–º—Å”©—Ö" },
    { ko: "ÎÖ∏ÎûÄÏÉâÏù¥ Ïûò Ïñ¥Ïö∏Î¶¨Îã§", mn: "–®–∞—Ä ”©–Ω–≥”© —Å–∞–π–Ω –∑–æ—Ö–∏—Ö" },
    { ko: "ÌååÎûÄÏÉâ Íµ¨ÎëêÎ•º Ïã†Îã§", mn: "–¶—ç–Ω—Ö—ç—Ä ”©–Ω–≥–∏–π–Ω –ø–æ—Ç–∏–Ω–∫ ”©–º—Å”©—Ö" },
    { ko: "ÍπåÎßåÏÉâ Í∞ÄÎ∞©ÏùÑ Î©îÎã§", mn: "–•–∞—Ä ”©–Ω–≥–∏–π–Ω —Ü“Ø–Ω—Ö “Ø“Ø—Ä—ç—Ö" },
    { ko: "ÌïòÏñÄÏÉâ Î™®ÏûêÎ•º Ïì∞Îã§", mn: "–¶–∞–≥–∞–∞–Ω ”©–Ω–≥–∏–π–Ω –º–∞–ª–≥–∞–π ”©–º—Å”©—Ö" },

    { ko: "Ï§ÑÎ¨¥Îä¨ ÎÑ•ÌÉÄÏù¥Î•º ÌïòÎã§", mn: "–°—É–¥–∞–ª—Ç–∞–π –∑–∞–Ω–≥–∏–∞ –∑“Ø“Ø—Ö" },
    { ko: "ÍΩÉÎ¨¥Îä¨ ÏπòÎßàÎ•º ÏûÖÎã§", mn: "–¶—ç—Ü–≥—ç–Ω —Ö—ç—ç—Ç—ç–π –±–∞–Ω–∑–∞–ª ”©–º—Å”©—Ö" },
    { ko: "Ï≤¥ÌÅ¨Î¨¥Îä¨ ÎÇ®Î∞©ÏùÑ ÏûÖÎã§", mn: "–®–æ–æ—Ç–æ–π —Ü–∞–º—Ü ”©–º—Å”©—Ö" },
    { ko: "Î¨ºÎ∞©Ïö∏Î¨¥Îä¨Í∞Ä ÏûàÎã§", mn: "–¥—É—Å–ª–∞–Ω —Ö—ç—ç—Ç—ç–π" },
    { ko: "Ïù∏ÌòïÏù¥ Îã¨Î†§ ÏûàÎã§", mn: "–•“Ø“Ø—Ö—ç–ª–¥—ç–π ”©–ª–≥”©”©—Ç—ç–π –±–∞–π–Ω–∞" },
    { ko: "Ïù¥Î¶ÑÌëúÍ∞Ä Î∂ôÏñ¥ ÏûàÎã§", mn: "–ù—ç—Ä–∏–π–Ω —Ö—É—É–¥–∞—Å –Ω–∞–∞–ª—Ç—Ç–∞–π –±–∞–π–Ω–∞" },
    { ko: "Î≤ΩÏóê Í∑∏Î¶ºÏù¥ Í±∏Î†§ ÏûàÎã§", mn: "–•–∞–Ω–∞–Ω –¥—ç—ç—Ä –∑—É—Ä–∞–≥ ”©–ª–≥”©”©—Ç—ç–π –±–∞–π–Ω–∞" },
    { ko: "Î¨∏Ïù¥ Ïó¥Î†§ ÏûàÎã§", mn: "–•–∞–∞–ª–≥–∞ –æ–Ω–≥–æ—Ä—Ö–æ–π –±–∞–π–Ω–∞" },
    { ko: "Ï∞ΩÎ¨∏Ïù¥ Îã´ÌòÄ ÏûàÎã§", mn: "–¶–æ–Ω—Ö —Ö–∞–∞–ª—Ç—Ç–∞–π –±–∞–π–Ω–∞" },
    { ko: "ÏπúÍµ¨Î•º Îç∞Î†§Îã§ Ï£ºÎã§", mn: "–ù–∞–π–∑—ã–≥–∞–∞ —Ö“Ø—Ä–≥—ç–∂ ”©–≥”©—Ö" },
    { ko: "ÎèôÏÉùÏùÑ Îç∞Î†§Îã§ Ï£ºÎã§", mn: "–î“Ø“Ø–≥—ç—ç —Ö“Ø—Ä–≥—ç–∂ ”©–≥”©—Ö" },
    { ko: "Î∂ÄÎ™®ÎãòÏùÑ Î™®ÏÖîÎã§ ÎìúÎ¶¨Îã§", mn: "–≠—Ü—ç–≥ —ç—Ö—ç—ç —Ö“Ø—Ä–≥—ç–∂ —Ö“Ø—Ä–≥—ç—Ö" },
    { ko: "ÏßêÏùÑ Îì§Ïñ¥ Ï£ºÎã§", mn: "–ê—á–∞–∞ –±–∞—Ä—å–∂ ”©–≥”©—Ö" },
    { ko: "Ïö∞ÏÇ∞ÏùÑ ÏîåÏõå Ï£ºÎã§", mn: "–®“Ø—Ö—ç—Ä –±–∞—Ä—å–∂ ”©–≥”©—Ö" },
    { ko: "Î¨ºÍ±¥ÏùÑ ÎëêÍ≥† ÎÇ¥Î¶¨Îã§", mn: "–Æ–º–∞–∞ –æ—Ä—Ö–∏–∂ –±—É—É—Ö" },
    { ko: "ÏßÄÌïòÏ≤†Ïóê ÎÜìÍ≥† ÎÇ¥Î¶¨Îã§", mn: "–ú–µ—Ç—Ä–æ–Ω–¥ –æ—Ä—Ö–∏–∂ –±—É—É—Ö" },
    { ko: "Î∂ÑÏã§Î¨º ÏÑºÌÑ∞Ïóê Ïã†Í≥†ÌïòÎã§", mn: "–ì—ç—ç—Å—ç–Ω —ç–¥ –∑“Ø–π–ª–∏–π–Ω —Ç”©–≤–¥ –º—ç–¥—ç–≥–¥—ç—Ö" },
    { ko: "ÏûÉÏñ¥Î≤ÑÎ¶∞ Î¨ºÍ±¥ÏùÑ Ï∞æÎã§", mn: "–ì—ç—ç—Å—ç–Ω –∑“Ø–π–ª—ç—ç –æ–ª–æ—Ö" }
  ];

  const qs = new URLSearchParams(location.search);
  const NAME = (qs.get("name") || "").trim();
  const KLASS = (qs.get("klass") || "").trim();
  const TOKEN = (qs.get("token") || "").trim();

  const deviceId = getDeviceId_();
  const ua = navigator.userAgent || "";

  const attemptKey = `kquiz_attempt__${BOOK}__${LESSON}__${KLASS}__${NAME}`;
  let attempts = Number(localStorage.getItem(attemptKey) || "0");

  let MODE = "KOQ";
  let idx = 0;
  let score = 0;
  let questions = [];
  let wrongs = [];

  let remainSec = 0;
  let tickId = null;
  let questionLocked = false;

  const $ = (id)=>document.getElementById(id);

  function setTopMsg(type, text){
    const el = $("topMsg");
    if(!text){
      el.classList.add("hidden");
      el.textContent = "";
      return;
    }
    el.classList.remove("hidden");
    el.classList.toggle("warn", type==="warn");
    el.classList.toggle("ok", type==="ok");
    el.textContent = text;
  }

  function updatePills(){
    $("scorePill").textContent = String(score);
    $("attemptPill").textContent = String(attempts);
    $("datePill").textContent = new Date().toLocaleDateString();
    $("userLine").textContent = `${NAME} ¬∑ ${KLASS} ¬∑ ${BOOK} ¬∑ ${LESSON}`;
    $("timePill").textContent = (remainSec > 0 ? String(remainSec) : "0");
  }

  function setMode(mode){
    MODE = mode;
    $("modeKo").classList.toggle("active", MODE==="KOQ");
    $("modeMn").classList.toggle("active", MODE==="MNQ");
    restartQuiz();
  }

  function setSpeed(speed){
    SPEED = speed;
    $("speedNormal").classList.toggle("active", SPEED==="normal");
    $("speedSlow").classList.toggle("active", SPEED==="slow");
    if(!$("quizBox").classList.contains("hidden")){
      startTimer_();
    }
  }

  function setScreenClass_(cls){
    const root = $("appRoot");
    root.classList.remove("screen-quiz","screen-review","screen-result");
    root.classList.add(cls);
  }

  function showOnly(boxId){
    stopTimer_();
    $("quizBox").classList.add("hidden");
    $("reviewBox").classList.add("hidden");
    $("resultBox").classList.add("hidden");
    $(boxId).classList.remove("hidden");

    if(boxId==="quizBox") setScreenClass_("screen-quiz");
    if(boxId==="reviewBox") setScreenClass_("screen-review");
    if(boxId==="resultBox") setScreenClass_("screen-result");
  }

  function jsonpRequest_(baseUrl, params, timeoutMs=12000){
    return new Promise((resolve, reject)=>{
      const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
      const url = baseUrl + (baseUrl.includes("?") ? "&" : "?") +
        new URLSearchParams({ ...params, callback: cbName }).toString();

      let done = false;
      const script = document.createElement("script");

      function cleanup(){
        try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
        if(script && script.parentNode) script.parentNode.removeChild(script);
      }

      const timer = setTimeout(()=>{
        if(done) return;
        done = true;
        cleanup();
        reject(new Error("JSONP timeout"));
      }, timeoutMs);

      window[cbName] = (data)=>{
        if(done) return;
        done = true;
        clearTimeout(timer);
        cleanup();
        resolve(data);
      };

      script.onerror = ()=>{
        if(done) return;
        done = true;
        clearTimeout(timer);
        cleanup();
        reject(new Error("JSONP load error"));
      };

      script.src = url;
      document.head.appendChild(script);
    });
  }

  async function validateEntry_(){
    if(!NAME || !KLASS || !TOKEN){
      setTopMsg("warn", "‚ùó URL –ø–∞—Ä–∞–º–µ—Ç—Ä –¥—É—Ç—É—É –±–∞–π–Ω–∞.\n(name/klass/token —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π)");
      return false;
    }
    try{
      const res = await jsonpRequest_(SCRIPT_URL, {
        action: "validate",
        token: TOKEN,
        deviceId,
        name: NAME,
        klass: KLASS
      });
      if(!res || !res.ok){
        setTopMsg("warn", "‚ùó –ù—ç–≤—Ç—Ä—ç—Ö —ç—Ä—Ö–≥“Ø–π.\n–î–∞—Ö–∏–Ω index.html-—ç—ç—Ä –æ—Ä–Ω–æ —É—É.");
        return false;
      }
      return true;
    }catch(e){
      setTopMsg("warn", "‚ùó –°–µ—Ä–≤–µ—Ä—Ç—ç–π —Ö–æ–ª–±–æ–≥–¥–æ–∂ —á–∞–¥—Å–∞–Ω–≥“Ø–π.\n–î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.");
      return false;
    }
  }

  function buildQuestions_(){
    const pool = WORDS.slice().filter(x => x && x.ko && x.mn);
    if(pool.length < 4){
      setTopMsg("warn", "‚ùó WORDS –¥—É—Ç–∞–≥–¥–∞–ª—Ç–∞–π –±–∞–π–Ω–∞.\n(–î–æ–æ–¥ —Ç–∞–ª –Ω—å 4 “Ø–≥ —Ö—ç—Ä—ç–≥—Ç—ç–π)");
      return false;
    }
    shuffle_(pool);

    questions = pool.map(item => {
      const qText = (MODE==="KOQ") ? item.ko : item.mn;
      const correct = (MODE==="KOQ") ? item.mn : item.ko;

      const distractorPool = pool
        .map(x => (MODE==="KOQ") ? x.mn : x.ko)
        .filter(v => v && v !== correct);

      const choices = uniqueChoices_(correct, distractorPool, 4);
      shuffle_(choices);
      return { qText, correct, choices };
    });
    return true;
  }

  function uniqueChoices_(correct, pool, n){
    const out = [correct];
    const seen = new Set(out);

    for(const v of pool){
      if(out.length >= n) break;
      if(v && !seen.has(v)){
        out.push(v);
        seen.add(v);
      }
    }

    let guard = 0;
    while(out.length < n && guard < 500){
      guard++;
      const v = pool[Math.floor(Math.random()*pool.length)];
      if(v && !seen.has(v)){
        out.push(v);
        seen.add(v);
      }
    }

    while(out.length < n) out.push("‚Äî");
    return out;
  }

  function fitText_(el, maxPx, minPx, maxLines){
    if(!el) return;
    const parent = el.parentElement;
    const maxW = parent ? parent.clientWidth : el.clientWidth;

    el.style.wordBreak = "keep-all";
    el.style.overflowWrap = "anywhere";
    el.style.whiteSpace = "normal";

    let font = maxPx;
    let guard = 0;

    while(guard++ < 80 && font > minPx){
      el.style.fontSize = font + "px";

      const lh = font * 1.12;
      const allowedH = (maxLines * lh) + 2;

      const w = el.scrollWidth;
      const h = el.scrollHeight;

      if((maxW && w > maxW + 1) || (h > allowedH + 1)){
        font -= 1;
        continue;
      }
      break;
    }

    if(font <= minPx) el.style.fontSize = minPx + "px";
  }

  function renderQuestion_(){
    questionLocked = false;
    setTopMsg("", "");

    const total = questions.length;
    const q = questions[idx];

    $("qNo").textContent = `Q ${idx+1} / ${total}`;
    $("qText").textContent = q.qText;

    const wrap = $("choices");
    wrap.innerHTML = "";

    q.choices.forEach(choiceText => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.textContent = choiceText;
      btn.onclick = ()=> pickAnswer_(choiceText);
      wrap.appendChild(btn);
    });

    requestAnimationFrame(()=>{
      fitText_($("qText"), 28, 16, 3);
      const buttons = Array.from(document.querySelectorAll(".choice"));
      buttons.forEach(b => fitText_(b, 22, 14, 2));
    });

    startTimer_();
  }

  function startTimer_(){
    stopTimer_();
    remainSec = TIME_LIMIT[SPEED] ?? 10;
    updatePills();

    tickId = setInterval(()=>{
      remainSec--;
      if(remainSec <= 0){
        remainSec = 0;
        updatePills();
        stopTimer_();
        handleTimeout_();
        return;
      }
      updatePills();
    }, 1000);
  }

  function stopTimer_(){
    if(tickId){
      clearInterval(tickId);
      tickId = null;
    }
  }

  function handleTimeout_(){
    if(questionLocked) return;
    questionLocked = true;

    const q = questions[idx];
    wrongs.push({ q: q.qText, correct: q.correct, reason: "timeout" });

    const buttons = Array.from(document.querySelectorAll(".choice"));
    buttons.forEach(b => b.classList.add("disabled"));
    buttons.forEach(b=>{
      if(b.textContent === q.correct) b.classList.add("correct");
    });

    setTimeout(()=>{
      idx++;
      if(idx >= questions.length) finishQuiz_();
      else renderQuestion_();
    }, 180);
  }

  function pickAnswer_(picked){
    if(questionLocked) return;
    questionLocked = true;

    stopTimer_();

    const q = questions[idx];
    const buttons = Array.from(document.querySelectorAll(".choice"));
    buttons.forEach(b => b.classList.add("disabled"));

    const isCorrect = picked === q.correct;

    buttons.forEach(b=>{
      if(b.textContent === q.correct) b.classList.add("correct");
      if(b.textContent === picked && !isCorrect) b.classList.add("wrong");
    });

    if(!isCorrect){
      wrongs.push({ q: q.qText, correct: q.correct, reason: "wrong" });
    }

    setTimeout(()=>{
      idx++;
      if(idx >= questions.length) finishQuiz_();
      else renderQuestion_();
    }, 180);
  }

  function finishQuiz_(){
    stopTimer_();

    const total = questions.length;
    const correctCount = total - wrongs.length;
    score = Math.round((correctCount / Math.max(1,total)) * 100);

    attempts += 1;
    localStorage.setItem(attemptKey, String(attempts));

    updatePills();

    /* Ï†ïÏ±Ö: Ï†êÏàòÏôÄ Í¥ÄÍ≥ÑÏóÜÏù¥ Review Î®ºÏ†Ä -> Result */
    showReviewScreen_();

    /* Î™®Îì† ÏãúÎèÑ Î¨¥Ï°∞Í±¥ Ï†ÑÏÜ° */
    safeLog_(score, attempts);
  }

  function showReviewScreen_(){
    showOnly("reviewBox");

    $("reviewMsg").textContent =
      `Review\n` +
      `Score: ${score} / 100\n` +
      `Attempts: ${attempts}\n` +
      `Pass: ${score >= 80 ? "YES" : "NO"}`;

    const list = $("reviewList");
    list.innerHTML = "";

    if(wrongs.length === 0){
      const div = document.createElement("div");
      div.className = "reviewItem";
      div.innerHTML =
        `<div class="reviewNo">üéâ Perfect!</div>` +
        `<div class="reviewQ">All correct.</div>` +
        `<div class="reviewAns">Ans: ‚Äî</div>`;
      list.appendChild(div);
      return;
    }

    wrongs.forEach((w,i)=>{
      const timeoutBadge = (w.reason==="timeout") ? `<span class="badgeTimeout">ÏãúÍ∞Ñ Ï¥àÍ≥º</span>` : "";
      const div = document.createElement("div");
      div.className = "reviewItem";
      div.innerHTML =
        `<div class="reviewNo">#${i+1}${timeoutBadge}</div>` +
        `<div class="reviewQ">Q: ${escapeHtml_(w.q)}</div>` +
        `<div class="reviewAns">Ans: ${escapeHtml_(w.correct)}</div>`;
      list.appendChild(div);
    });
  }

  function showResultScreen(){
    showOnly("resultBox");

    const passed = (score >= 80);
    const date = new Date().toLocaleString();
    const headline = passed ? `${NAME} –¢—ç–Ω—Ü–ª—ç—ç!` : `${NAME} Result`;
    const hEl = $("resultHeadline");
    if(hEl) hEl.textContent = headline;

    const meta =
      `Name: ${NAME}\n` +
      `Class: ${KLASS}\n` +
      `Book: ${BOOK}\n` +
      `Lesson: ${LESSON}\n` +
      `Score: ${score} / 100\n` +
      `Attempts: ${attempts}\n` +
      `Date: ${date}`;

    const metaEl = $("resultMeta");
    if(metaEl) metaEl.textContent = meta;
  }

  async function safeLog_(scoreNum, attemptsNum){
    try{
      await jsonpRequest_(SCRIPT_URL, {
        action: "log",
        token: TOKEN,
        deviceId,
        name: NAME,
        klass: KLASS,
        book: BOOK,
        lesson: LESSON,
        score: String(scoreNum),
        attempts: String(attemptsNum),
        ua: ua.slice(0, 300)
      });
    }catch(e){
      console.log("log failed:", e);
    }
  }

  function goBackHub(){
    const base = "lessonHub.html";
    const url = `${base}?name=${encodeURIComponent(NAME)}&klass=${encodeURIComponent(KLASS)}&token=${encodeURIComponent(TOKEN)}`;
    location.href = url;
  }

  function restartQuiz(){
    stopTimer_();
    idx = 0;
    score = 0;
    wrongs = [];
    remainSec = 0;
    updatePills();
    const ok = buildQuestions_();
    if(!ok) return;
    showOnly("quizBox");
    renderQuestion_();
  }

  function shuffle_(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  function getDeviceId_(){
    const k = "kquiz_deviceId";
    let id = localStorage.getItem(k);
    if(!id){
      const canUUID = (typeof crypto !== "undefined" && crypto && typeof crypto.randomUUID === "function");
      id = canUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random()).replace(".","");
      localStorage.setItem(k, id);
    }
    return id;
  }

  function escapeHtml_(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  (async function boot(){
    updatePills();
    const ok = await validateEntry_();
    if(!ok){
      showOnly("quizBox");
      $("qText").textContent = "Access denied";
      $("choices").innerHTML = "";
      return;
    }
    setSpeed(SPEED);
    restartQuiz();
  })();
</script>
</body>
</html>
