<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>GRAM · TOPIK 2 · lesson01 · Grammar Test</title>

  <style>
    :root{
      --bg:#f0f4f8; --card:#ffffff; --primary:#2d6cdf; --primary2:#1f4ea5;
      --text:#223047; --muted:#6a7a8e; --line:#d9e4f5;
      --warnbg:#fff5f5; --warnline:#feb2b2; --warntext:#7a1f1f;
      --ok:#0f7a3d; --bad:#c0392b; --orange:#e67e22;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:20px; font-family:Arial,sans-serif; background:var(--bg); color:var(--text); text-align:center;}
    .container{max-width:560px; margin:0 auto; background:var(--card); padding:26px; border-radius:20px; border:1px solid var(--line); box-shadow:0 10px 20px rgba(0,0,0,0.08);}
    h1{margin:0; font-size:22px; color:#1f2f45;}
    .topline{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:10px; flex-wrap:wrap;}
    .badge{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #d7dee7; background:#f6f9ff; font-size:12px; font-weight:900; color:#2c3e50;}
    .nameBox{font-size:14px; color:#4b5b6f; text-align:left;}
    .nameBox b{color:#1f2f45;}
    .btn{width:100%; background:var(--primary); color:#fff; padding:14px 12px; border:none; border-radius:12px; cursor:pointer; font-size:16px; font-weight:900; transition:.2s;}
    .btn:hover{background:var(--primary2);}
    .btnGray{background:#eef2f7; color:#223047; border:1px solid #d7dee7;}
    .btnGray:hover{background:#e2e8f0;}
    .btnRow{display:flex; gap:10px; margin-top:14px;}
    .qno{margin-top:14px; color:var(--primary); font-weight:900; font-size:15px;}
    .inst{margin-top:10px; background:#eef2f7; border:1px solid #d7dee7; padding:10px; border-radius:10px; color:#223047; font-size:14px;}
    .question{margin:18px 0 10px; font-size:22px; font-weight:900; color:#1f2f45; line-height:1.35; word-break:keep-all;}
    .choice{
      width:100%; margin:10px 0; padding:14px 12px; border-radius:12px;
      border:2px solid var(--primary); background:#fff; color:#223047;
      font-size:16px; font-weight:900; cursor:pointer; transition:.15s; text-align:left;
    }
    .choice:hover{background:var(--primary); color:#fff;}
    .hidden{display:none;}
    .warn{margin-top:14px; background:var(--warnbg); border:1px solid var(--warnline); border-radius:12px; padding:12px; color:var(--warntext); font-size:14px; line-height:1.45; text-align:left;}
    .panel{margin-top:16px; padding:14px; border:1px solid var(--line); border-radius:14px; background:#fff; text-align:left;}
    .score{font-size:26px; font-weight:900; color:var(--bad); margin:10px 0;}
    .wrongList{max-height:300px; overflow:auto; padding:12px; border-radius:12px; border:1px solid var(--warnline); background:var(--warnbg);}
    .wrongItem{padding:8px 0; border-bottom:1px dashed var(--warnline); font-size:15px;}
    .wrongItem:last-child{border-bottom:none;}
    .note{margin-top:10px; color:var(--muted); font-size:13px; line-height:1.45;}
    .resultCard{border:2px solid #cfe0ff; background:#f6f9ff; border-radius:14px; padding:14px; margin-top:14px; text-align:left;}
    .resultCard p{margin:8px 0; font-size:15px; line-height:1.55;}
    .bigMsg{font-size:18px; font-weight:900;}
    .center{text-align:center;}
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; padding:18px;}
    .modal{max-width:560px; width:100%; background:#fff; border-radius:16px; padding:16px; border:1px solid #d7dee7; box-shadow:0 10px 25px rgba(0,0,0,0.18); text-align:left;}
    .modal h2{margin:0; font-size:18px; color:#1f2f45;}
    .modal p{margin:10px 0; color:#223047; line-height:1.55; font-size:14px;}
  </style>
</head>

<body>
<div class="container">
  <div class="topline">
    <div class="nameBox">
      <div><span class="badge">GRAM · TOPIK 2 · lesson01</span></div>
      <div style="margin-top:6px;">Нэр: <b id="studentName">—</b></div>
      <div>Анги: <b id="klassName">—</b></div>
    </div>
    <button class="btn btnGray" onclick="goBack()">Буцах</button>
  </div>

  <div id="errorSection" class="warn hidden"></div>

  <div id="quizSection" class="hidden">
    <div class="qno" id="qno"></div>
    <div class="inst" id="inst"></div>
    <div class="question" id="qtext"></div>
    <div id="choices"></div>
    <div class="note">Санамж: Алдаа гаргасан асуултуудыг төгсгөлд нь зөв хариутай нь харуулна.</div>
  </div>

  <div id="reviewSection" class="hidden">
    <h1 style="color:var(--orange);">Алдаагаа шалгана уу</h1>
    <p class="note">Эхлээд зөв хариуг хараад, дараа нь дахин оролдоно уу.</p>

    <div class="panel">
      <div class="score" id="reviewScore"></div>
      <div class="wrongList" id="wrongList"></div>
      <div class="note" id="attemptInfo"></div>

      <div class="note" id="logStatusReview" style="font-weight:900;"></div>

      <div class="btnRow">
        <button class="btn" style="background:var(--orange);" onclick="retry()">Дахин оролдох</button>
        <button class="btn btnGray" onclick="goBack()">Буцах</button>
      </div>
    </div>
  </div>

  <div id="resultSection" class="hidden">
    <h1 style="color:var(--ok);">Тэнцлээ!</h1>

    <div class="resultCard">
      <p class="bigMsg" id="resultLine1"></p>
      <p class="center"><span class="score" id="finalScore"></span></p>
      <p id="resultLine2"></p>
      <p id="resultDate"></p>

      <p style="margin-top:12px; font-weight:900; color:#1f2f45;">
        Энэ дэлгэцийг скриншот хийж багш руугаа илгээнэ үү.
      </p>
      <p class="note" id="logStatus"></p>
    </div>

    <div class="btnRow">
      <button class="btn" style="background:var(--ok);" onclick="openScreenshotHelp()">Капчер</button>
      <button class="btn btnGray" onclick="goBack()">Буцах</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeModal(event)">
  <div class="modal">
    <h2>Скриншот / Хуваалцах</h2>
    <p>
      <b>iPhone:</b> Талын товч + Дуу нэмэх товчийг зэрэг дарна уу.<br>
      <b>Android:</b> Асаах товч + Дуу хасах товчийг зэрэг дарна уу.
    </p>
    <p class="note">
      Хэрэв “share” (хуваалцах) ажиллавал шууд багш руугаа илгээж болно.
    </p>
    <button class="btn btnGray" onclick="closeModal()">Хаах</button>
  </div>
</div>

<script>
/* Google Apps Script */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBe6Y0W3IJKjWV8MLFnR5b9OMePDPHGVACPekJQpvLWRrlayRmHBJCezamKqN9rZg6/exec";

/* Lesson ID */
const lessonId = "GRAM-TOPIK-2-lesson01";

/* Sample TOPIK2 questions (editable later) */
const rawQ = [
  { q:"‘-(으)니까’는 보통 어떤 의미인가요?", a:"이유/원인", c:["대조", "선택", "나열"] },
  { q:"‘-(으)면’은 어떤 의미인가요?", a:"조건", c:["과거", "부정", "인과"] },
  { q:"‘-아/어 보다’는 어떤 의미인가요?", a:"경험(해 보다)", c:["의무", "추측", "약속"] },
  { q:"‘-기 때문에’는 어떤 의미인가요?", a:"이유/원인", c:["대조", "첨가", "선택"] },
  { q:"‘-(으)ㄹ 수 있다’는 어떤 의미인가요?", a:"가능/능력", c:["의무", "과거", "부정"] },
  { q:"‘-(으)려고 하다’는 어떤 의미인가요?", a:"의도/계획", c:["완료", "추측", "대조"] }
];

/* Utils */
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Date.now()+"_"+Math.floor(Math.random()*10000);
    window[cb]=(data)=>{ resolve(data); script.remove(); delete window[cb]; };
    const script=document.createElement("script");
    script.src=url+(url.includes("?")?"&":"?")+"callback="+cb;
    script.onerror=()=>{ reject(new Error("jsonp_error")); script.remove(); delete window[cb]; };
    document.body.appendChild(script);
  });
}
function getDeviceId(){
  const k="kquiz_deviceId";
  let id=localStorage.getItem(k);
  if(!id){
    id=(crypto&&crypto.randomUUID)?crypto.randomUUID():(Date.now()+"_"+Math.random()).replace(".","");
    localStorage.setItem(k,id);
  }
  return id;
}

/* State */
let name="", klass="", token="", deviceId="";
let attempts=0;
let questions=[], idx=0, score=0, wrong=[];
let lastFinalScore=0;
let lastPassed=false;

/* DOM */
const studentNameEl = document.getElementById("studentName");
const klassNameEl = document.getElementById("klassName");
const errorSection = document.getElementById("errorSection");
const quizSection = document.getElementById("quizSection");
const reviewSection = document.getElementById("reviewSection");
const resultSection = document.getElementById("resultSection");
const qnoEl = document.getElementById("qno");
const instEl = document.getElementById("inst");
const qtextEl = document.getElementById("qtext");
const choicesEl = document.getElementById("choices");
const reviewScoreEl = document.getElementById("reviewScore");
const wrongListEl = document.getElementById("wrongList");
const attemptInfoEl = document.getElementById("attemptInfo");
const resultLine1El = document.getElementById("resultLine1");
const finalScoreEl = document.getElementById("finalScore");
const resultLine2El = document.getElementById("resultLine2");
const resultDateEl = document.getElementById("resultDate");
const logStatusEl = document.getElementById("logStatus");
const logStatusReviewEl = document.getElementById("logStatusReview");
const overlay = document.getElementById("overlay");

/* UI helpers */
function showError(msg){
  errorSection.textContent = msg;
  errorSection.classList.remove("hidden");
  quizSection.classList.add("hidden");
  reviewSection.classList.add("hidden");
  resultSection.classList.add("hidden");
}
function showQuiz(){
  errorSection.classList.add("hidden");
  reviewSection.classList.add("hidden");
  resultSection.classList.add("hidden");
  quizSection.classList.remove("hidden");
  showQuestion();
}

/* Params / Token */
function getParams(){
  const p = new URLSearchParams(location.search);
  return {
    name:(p.get("name")||"").trim(),
    klass:(p.get("klass")||"").trim(),
    token:(p.get("token")||"").trim()
  };
}
async function validateToken(){
  const url = `${SCRIPT_URL}?action=validate`
    + `&token=${encodeURIComponent(token)}`
    + `&deviceId=${encodeURIComponent(deviceId)}`
    + `&klass=${encodeURIComponent(klass)}`
    + `&name=${encodeURIComponent(name)}`
    + `&t=${Date.now()}`;
  const res = await jsonp(url);
  return !!(res && res.ok);
}

/* Attempts */
function loadAttempts(){
  const k = `attempts_${lessonId}_${name}`;
  attempts = parseInt(localStorage.getItem(k)||"0",10) || 0;
}
function saveAttempts(){
  const k = `attempts_${lessonId}_${name}`;
  localStorage.setItem(k, String(attempts));
}
function clearAttempts(){
  const k = `attempts_${lessonId}_${name}`;
  localStorage.removeItem(k);
}

/* Quiz */
function prepareQuestions(){
  questions = shuffle(rawQ).map(item=>{
    const choices = shuffle([item.a, ...item.c]).slice(0,4);
    return { q:item.q, a:item.a, choices };
  });
  idx=0; score=0; wrong=[];
}
function showQuestion(){
  if(idx>=questions.length){ finish(); return; }
  const item = questions[idx];
  qnoEl.textContent = `${idx+1} / ${questions.length}`;
  instEl.textContent = "Зөв хариуг сонгоно уу.";
  qtextEl.textContent = item.q;
  choicesEl.innerHTML="";
  item.choices.forEach(c=>{
    const btn=document.createElement("button");
    btn.className="choice";
    btn.textContent=c;
    btn.onclick=()=>answer(c);
    choicesEl.appendChild(btn);
  });
}
function answer(choice){
  const item=questions[idx];
  if(choice===item.a){ score += (100/questions.length); }
  else{ wrong.push(item); }
  idx++;
  showQuestion();
}

/* ✅ 여기서부터 핵심 수정: 끝나는 순간 무조건 기록 */
async function finish(){
  attempts++;
  saveAttempts();

  const finalScore = Math.round(score);
  const passed = (finalScore>=80 || attempts>=5);

  lastFinalScore = finalScore;
  lastPassed = passed;

  // 기록 먼저 보냄(합격/불합격 상관없음)
  await sendLog(finalScore, passed);

  if(passed){
    showResult(finalScore);
  }else{
    showReview(finalScore);
  }
}

function showReview(finalScore){
  quizSection.classList.add("hidden");
  resultSection.classList.add("hidden");
  reviewSection.classList.remove("hidden");

  reviewScoreEl.innerHTML = `Таны дүн: <b style="color:var(--bad);">${finalScore} оноо</b>`;
  attemptInfoEl.textContent = `Оролдлого: ${attempts} (5 удаа хүрвэл автоматаар тэнцэнэ)`;

  wrongListEl.innerHTML="";
  wrong.forEach(w=>{
    const div=document.createElement("div");
    div.className="wrongItem";
    div.innerHTML = `❓ <b>${escapeHtml(w.q)}</b><br>✅ <b>${escapeHtml(w.a)}</b>`;
    wrongListEl.appendChild(div);
  });
}

/* Log (cache-bust + name/klass 포함 + lesson별 캐시 키 분리) */
async function sendLog(finalScore, passed){
  const key = `result_${token}_${lessonId}`;
  const cached = sessionStorage.getItem(key);
  if(cached){
    // 이미 이 레슨/이 토큰으로 기록한 적이 있으면 다시 안 보냄(중복 방지)
    try{
      const obj = JSON.parse(cached);
      if(obj && obj.sent) {
        if(logStatusEl) logStatusEl.textContent = "Бүртгэл (өмнө нь) илгээгдсэн байна.";
        if(logStatusReviewEl) logStatusReviewEl.textContent = "Бүртгэл (өмнө нь) илгээгдсэн байна.";
        return;
      }
    }catch(e){}
  }

  const setStatus = (msg)=>{
    if(logStatusEl) logStatusEl.textContent = msg;
    if(logStatusReviewEl) logStatusReviewEl.textContent = msg;
  };

  try{
    const ua = navigator.userAgent || "";
    setStatus("Бүртгэл илгээж байна...");

    const url =
      `${SCRIPT_URL}?action=log` +
      `&token=${encodeURIComponent(token)}` +
      `&deviceId=${encodeURIComponent(deviceId)}` +
      `&book=${encodeURIComponent("GRAMMAR")}` +
      `&lesson=${encodeURIComponent(lessonId)}` +
      `&name=${encodeURIComponent(name)}` +
      `&klass=${encodeURIComponent(klass)}` +
      `&score=${encodeURIComponent(String(finalScore))}` +
      `&attempts=${encodeURIComponent(String(attempts))}` +
      `&passed=${encodeURIComponent(passed ? "1" : "0")}` +
      `&ua=${encodeURIComponent(ua)}` +
      `&t=${Date.now()}`;

    const res = await jsonp(url);
    if(res && res.ok){
      setStatus("Бүртгэл амжилттай илгээгдлээ.");
      sessionStorage.setItem(key, JSON.stringify({ sent:true, name, klass, finalScore, attempts, passed, t:Date.now() }));
    }else{
      setStatus("Бүртгэл илгээхэд алдаа гарлаа. Дахин оролдоно уу.");
    }
  }catch(e){
    const msg = "Бүртгэл илгээхэд алдаа гарлаа. Дахин оролдоно уу.";
    if(logStatusEl) logStatusEl.textContent = msg;
    if(logStatusReviewEl) logStatusReviewEl.textContent = msg;
  }
}

function showResult(finalScore){
  quizSection.classList.add("hidden");
  reviewSection.classList.add("hidden");
  resultSection.classList.remove("hidden");

  // 합격하면 attempts 초기화는 유지
  clearAttempts();

  resultLine1El.textContent = `${name}, баяр хүргэе!`;
  finalScoreEl.textContent = `Дүн: ${finalScore} оноо`;
  resultLine2El.textContent = `Оролдлого: ${attempts}`;

  const now = new Date();
  const fmt = new Intl.DateTimeFormat("mn-MN", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  resultDateEl.textContent = `Огноо: ${fmt.format(now)}`;

  // finish()에서 이미 로그 전송 완료/실패가 표시됨
}

/* Buttons */
function retry(){ prepareQuestions(); showQuiz(); }
function goBack(){
  const qs =
    `?name=${encodeURIComponent(name)}` +
    `&klass=${encodeURIComponent(klass)}` +
    `&token=${encodeURIComponent(token)}`;
  location.href = "GRAM-TOPIK-2-hub.html" + qs;
}

/* Screenshot / Share */
async function tryShareText(){
  const text =
    `Нэр: ${name}\n` +
    `Анги: ${klass}\n` +
    `Дүн: ${lastFinalScore} оноо\n` +
    `Оролдлого: ${attempts}\n` +
    `Энэ дэлгэцийг скриншот хийж багш руугаа илгээнэ үү.`;
  try{
    if(navigator.share){
      await navigator.share({ text });
      return true;
    }
  }catch(e){}
  return false;
}
async function openScreenshotHelp(){
  await tryShareText();
  overlay.style.display="flex";
}
function closeModal(e){
  if(e && e.target && e.target !== overlay) return;
  overlay.style.display="none";
}

/* Init */
(async function init(){
  const p=getParams();
  name=p.name; klass=p.klass; token=p.token;
  deviceId=getDeviceId();

  studentNameEl.textContent = name || "—";
  klassNameEl.textContent = klass || "—";

  if(!name || !klass || !token){
    showError("Нэвтрэх мэдээлэл дутуу байна. Эхлэл хуудас руу буцаад дахин нэвтэрнэ үү.");
    return;
  }

  try{
    const ok = await validateToken();
    if(!ok){
      showError("Энэ холбоос хүчинтэй биш байна. Эхлэл хуудас руу буцаад дахин нэвтэрнэ үү.");
      return;
    }
  }catch(e){
    showError("Сервертэй холбогдож чадсангүй. Дахин оролдоно уу.");
    return;
  }

  loadAttempts();
  prepareQuestions();
  showQuiz();
})();
</script>
</body>
</html>
