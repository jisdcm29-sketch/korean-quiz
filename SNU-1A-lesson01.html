<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>SNU 1A Â· Lesson 01 Â· Ò®Ğ³Ğ¸Ğ¹Ğ½ Ñ‚ĞµÑÑ‚</title>

  <style>
 /* =========================================================
   Mobile Font Fit Patch (SNU 1A Lesson Common)
   - Keep top title OK
   - Shrink mode buttons + question + choices for mobile
   ========================================================= */
  :root{
    --bg:#f0f4f8; --card:#ffffff; --primary:#2d6cdf; --primary2:#1f4ea5;
    --line:#d9e4f5; --text:#223047; --muted:#6a7a8e; --ok:#0f7a3d; --bad:#c0392b;
    --warnbg:#fff5f5; --warnline:#feb2b2; --okbg:#f0fff4; --okline:#b7f0c7;
  }

  *{box-sizing:border-box}

  body{
    margin:0;
    padding:8px;
    background:var(--bg);
    color:var(--text);
    font-family: Arial, system-ui, -apple-system, "Segoe UI", sans-serif;
    text-align:center;
    -webkit-text-size-adjust:100%;
  }

  /* ì¹´ë“œ ì»¨í…Œì´ë„ˆ(ìŠ¤í¬ë¦°ìƒ·ì²˜ëŸ¼ í•˜ì–—ê²Œ â€œí’€í˜ì´ì§€â€ ë˜ëŠ” ê²ƒ ë°©ì§€) */
  .container{
    max-width:560px;
    margin:0 auto;
    height:calc(100vh - 16px);
    background:var(--card);
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow:0 10px 20px rgba(0,0,0,.08);
    display:flex;
    flex-direction:column;
    gap:6px;
    padding:10px;
  }

  .header{
    position:sticky;
    top:0;
    background:var(--card);
    padding:2px 4px 0;
    z-index:5;
  }

  .title{margin:0; font-size:18px; font-weight:900;}
  .sub{margin:4px 0 0; color:var(--muted); font-size:12px; line-height:1.25;}

  .row{
    display:flex;
    gap:6px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
  }

  .pill{
    font-size:11px;
    padding:5px 9px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#f7fbff;
  }
  .pill b{font-weight:900}

  /* =========================
     ì–¸ì–´ ëª¨ë“œ ë²„íŠ¼(ì•ˆì „ íƒ€ê²Ÿ)
     - .modeBtn ì—†ë”ë¼ë„ #modeKo/#modeMnìœ¼ë¡œ ì ìš©
     ========================= */
  .modeBtn,
  #modeKo, #modeMn{
    border:2px solid var(--primary);
    background:#fff;
    color:var(--text);
    padding:7px 9px;
    border-radius:12px;
    font-weight:900;
    cursor:pointer;
    min-width:132px;
    font-size: clamp(11px, 3.1vw, 13px);
    line-height:1.15;
    white-space:normal;
  }

  .modeBtn.active,
  #modeKo.active, #modeMn.active{
    background:var(--primary);
    color:#fff;
  }

  .main{
    flex:1;
    min-height:0;
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .qbox{
    border:1px solid var(--line);
    border-radius:16px;
    padding:10px;
    background:#fff;
    display:flex;
    flex-direction:column;
    gap:8px;
    flex:1;
    min-height:0;
  }

  .qNo{font-size:12px; color:var(--muted); text-align:left;}

  /* ì§ˆë¬¸ í…ìŠ¤íŠ¸ */
  .qText, #qText{
    font-size: clamp(20px, 5.8vw, 34px);
    font-weight:900;
    line-height:1.10;
    word-break:keep-all;
    overflow-wrap:anywhere;
    margin-top:0;
  }

  /* ë³´ê¸° ì˜ì—­ */
  .choices, #choices{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    margin-top:4px;
  }

  /* =========================
     ë³´ê¸° ë²„íŠ¼(ì•ˆì „ íƒ€ê²Ÿ)
     - .choice ì—†ë”ë¼ë„ #choices buttonìœ¼ë¡œ ì ìš©
     ========================= */
  .choice,
  #choices .choice,
  #choices button{
    width:100%;
    padding:12px 10px;
    border-radius:16px;
    border:2px solid var(--primary);
    background:#fff;
    color:var(--text);
    font-weight:900;
    cursor:pointer;
    transition:.15s;
    word-break:keep-all;
    overflow-wrap:anywhere;
    line-height:1.12;
    font-size: clamp(16px, 4.6vw, 24px);
    min-height:50px;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
  }

  .choice:hover,
  #choices button:hover{background:var(--primary); color:#fff;}

  .choice.disabled,
  #choices button:disabled{opacity:.55; cursor:not-allowed;}

  .choice.correct{border-color:var(--ok);}
  .choice.wrong{border-color:var(--bad);}

  .footerBtns{display:flex; gap:10px; margin-top:0;}

  .btn{
    flex:1;
    padding:10px;
    border:none;
    border-radius:12px;
    background:var(--primary);
    color:#fff;
    font-weight:900;
    cursor:pointer;
    font-size:13px;
  }
  .btn:hover{background:var(--primary2);}
  .btn.gray{background:#eef2f7; color:var(--text); border:1px solid #d7dee7;}
  .btn.gray:hover{background:#e2e8f0;}

  .msg{
    padding:9px 10px;
    border-radius:12px;
    text-align:left;
    font-size:12px;
    line-height:1.35;
    white-space:pre-line;
  }
  .msg.warn{background:var(--warnbg); border:1px solid var(--warnline); color:#7a1f1f;}
  .msg.ok{background:var(--okbg); border:1px solid var(--okline); color:#0f7a3d;}
  .hidden{display:none !important;}

  .reviewList{
    text-align:left;
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px;
    overflow:auto;
    max-height:38vh;
    background:#fff;
    font-size:12px;
    line-height:1.45;
  }
  .reviewItem{padding:8px 0; border-bottom:1px dashed #e6eefb;}
  .reviewItem:last-child{border-bottom:none;}
  .small{font-size:11px; color:var(--muted);}

  @media (max-width: 390px){
    body{padding:6px;}
    .container{height:calc(100vh - 12px); padding:9px; gap:5px;}
    .sub{font-size:11px;}
    .pill{font-size:10.5px; padding:4px 8px;}
    .modeBtn, #modeKo, #modeMn{
      min-width:128px; padding:6px 8px;
      font-size: clamp(10.5px, 3.0vw, 12px);
    }
    .qbox{padding:9px; gap:7px;}
    .qText, #qText{font-size: clamp(18px, 5.6vw, 30px);}
    .choices, #choices{gap:9px;}
    .choice, #choices button{min-height:48px; padding:11px 10px; font-size: clamp(15px, 4.5vw, 22px);}
    .btn{padding:9px; font-size:12.5px;}
  }
    
---

# âœ… 2) `<script>` (ë¬¸í•­ 10ê°œ ì œí•œ í•´ì œ) â€” â€œì•ˆì „ íŒ¨ì¹˜â€ ë³µë¶™ìš©
ì•„ë˜ ì½”ë“œë¥¼ **`<script>` ì•ˆ â€˜ë°ì´í„° ë°°ì—´(ë‹¨ì–´ ëª©ë¡)â€™ì´ ì¤€ë¹„ëœ ì§í›„**ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.  
(ë°°ì—´ ì´ë¦„ì„ ëª°ë¼ë„ ë˜ê²Œ ë§Œë“¤ì–´ë†¨ê³ , ê¸°ì¡´ ì½”ë“œì— ìµœì†Œ ì¹¨íˆ¬ ë°©ì‹ì…ë‹ˆë‹¤.)

```js
/* =========================
   [PATCH] ì§ˆë¬¸ ìˆ˜ 10ê°œ ì œí•œ í•´ì œ
   - ì—…ë¡œë“œëœ ì–´íœ˜(ë°ì´í„°) ì „ì²´ ê¸¸ì´ë§Œí¼ ì¶œì œ
   - Q 1 / 10 í‘œì‹œë„ ìë™ìœ¼ë¡œ ì „ì²´ë¡œ ë°”ê¿ˆ
   ========================= */

// 0) shuffleì´ ì—†ìœ¼ë©´ ì•ˆì „í•˜ê²Œ í•˜ë‚˜ ì œê³µ(ì´ë¯¸ ìˆìœ¼ë©´ ì´ ë¸”ë¡ì€ ë¬´ì‹œí•´ë„ ë¨)
if (typeof shuffle !== "function") {
  function shuffle(arr){
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }
}

// 1) "ë°ì´í„° ë°°ì—´"ì„ ìµœëŒ€í•œ ìë™ íƒì§€ (words/questions/items/data ë“±)
function detectDataArray() {
  const candidates = ["DATA","data","words","wordList","items","questions","quizData","VOCAB","vocab","BANK","bank"];
  for (const k of candidates) {
    try {
      const v = (typeof window !== "undefined") ? window[k] : undefined;
      if (Array.isArray(v) && v.length > 0) return { key: k, arr: v };
    } catch(e){}
  }
  return { key: null, arr: [] };
}

const __det = detectDataArray();
const __ALL = __det.arr;                 // ì „ì²´ ì–´íœ˜ í’€
const TOTAL_Q = __ALL.length;            // âœ… ì „ì²´ ë¬¸í•­ ìˆ˜
const __QUIZ = shuffle(__ALL).slice(0, TOTAL_Q); // âœ… ì „ì²´ ì¶œì œ(ì„ì–´ì„œ)

// 2) ê¸°ì¡´ ì½”ë“œê°€ ë°ì´í„°ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡, ê°€ëŠ¥í•œ ê²½ìš° windowì— "quizList"ë¡œ ë…¸ì¶œ
window.__QUIZ_LIST__ = __QUIZ;
window.__TOTAL_Q__ = TOTAL_Q;
window.__DATA_KEY__ = __det.key;

// 3) ë§Œì•½ ê¸°ì¡´ ì½”ë“œê°€ window[ë°ì´í„°ë³€ìˆ˜] ìì²´ë¥¼ ì“°ëŠ” êµ¬ì¡°ë©´(ëŒ€ë¶€ë¶„),
//    constê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë®ì–´ì¨ì„œ "ì „ì²´ ì¶œì œ"ë¡œ ê°•ì œ
try {
  if (__det.key && typeof window[__det.key] !== "undefined") {
    // constë©´ ì—¬ê¸°ì„œ ì—ëŸ¬ë‚  ìˆ˜ ìˆëŠ”ë°, tryë¡œ ì•ˆì „ ì²˜ë¦¬ë¨
    window[__det.key] = __QUIZ;
  }
} catch(e) {
  // constë¼ì„œ ë®ì–´ì“°ê¸° ì‹¤íŒ¨í•´ë„ ê´œì°®ìŒ: ì•„ë˜ 4)ì—ì„œ í‘œì‹œ/ì§„í–‰ë§Œ ë³´ì • ê°€ëŠ¥
}

// 4) Qí‘œì‹œê°€ '/ 10'ìœ¼ë¡œ ê³ ì •ë¼ ìˆìœ¼ë©´ ê°•ì œë¡œ ì „ì²´ë¡œ ë³´ì—¬ì£¼ê¸°(ë Œë” í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ê·¸ ì•ˆì—ì„œ ì“°ëŠ”ê²Œ ìµœì„ )
(function patchQNoDisplay(){
  const qNoEl = document.getElementById("qNo");
  if (!qNoEl) return;
  // ì´í›„ ì½”ë“œê°€ qNoë¥¼ ê°±ì‹ í•´ë„, ìµœì†Œí•œ "ì´ ë¬¸í•­"ì€ ì „ì—­ìœ¼ë¡œ ì“¸ ìˆ˜ ìˆê²Œ í•´ë‘ 
  // ê°œë°œìê°€ ì“°ëŠ” í…œí”Œë¦¿: `Q ${idx+1} / ${TOTAL_Q}`
})();

</style>


</head>

<body>
<div class="container">
  <div class="header">
    <h1 class="title">SNU 1A Â· Lesson 01</h1>
    <p class="sub" id="userLine">...</p>
    <div class="row">
      <span class="pill">Score: <b id="scorePill">0</b>/100</span>
      <span class="pill">Attempts: <b id="attemptPill">0</b></span>
      <span class="pill">Date: <b id="datePill">-</b></span>
    </div>

    <div class="row" style="margin-top:8px;">
      <button class="modeBtn active" id="modeKo" onclick="setMode('KOQ')">í•œêµ­ì–´ ì§ˆë¬¸ â†’ ëª½ê³¨ì–´ ë³´ê¸°</button>
      <button class="modeBtn" id="modeMn" onclick="setMode('MNQ')">ĞœĞ¾Ğ½Ğ³Ğ¾Ğ» Ğ°ÑÑƒÑƒĞ»Ñ‚ â†’ í•œêµ­ì–´ ë³´ê¸°</button>
    </div>

    <div class="msg warn hidden" id="topMsg"></div>
  </div>

  <div class="main">

    <!-- QUIZ -->
    <div class="qbox" id="quizBox">
      <div class="qNo" id="qNo">Q 1 / 10</div>
      <div class="qText" id="qText">...</div>
      <div class="choices" id="choices"></div>

      <div class="footerBtns">
        <button class="btn gray" onclick="goBackHub()">â† Hub</button>
        <button class="btn gray" onclick="restartQuiz()">Restart</button>
      </div>
      <div class="small">â€» 4 choices / Language-cross / JSONP log</div>
    </div>

    <!-- REVIEW -->
    <div class="qbox hidden" id="reviewBox">
      <div class="qText">Review</div>
      <div class="msg warn" id="reviewMsg"></div>
      <div class="reviewList" id="reviewList"></div>
      <div class="footerBtns">
        <button class="btn" onclick="restartQuiz()">Retry</button>
        <button class="btn gray" onclick="showResultScreen()">Result</button>
      </div>
    </div>

    <!-- RESULT -->
    <div class="qbox hidden" id="resultBox">
      <div class="qText" id="resultTitle">Result</div>
      <div class="msg ok" id="resultMsg"></div>

      <div class="footerBtns">
        <button class="btn" onclick="shareCapture()">ĞšĞ°Ğ¿Ñ‡ĞµÑ€</button>
        <button class="btn gray" onclick="goBackHub()">â† Hub</button>
      </div>
      <div class="small" style="margin-top:6px;">
        ğŸ“Œ <b>Ğ¡ĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚</b> Ñ…Ğ¸Ğ¹Ğ³ÑÑĞ´ Ğ±Ğ°Ğ³ÑˆĞ´Ğ°Ğ° ÑĞ²ÑƒÑƒĞ»Ğ°Ğ°Ñ€Ğ°Ğ¹!
      </div>
    </div>

  </div>
</div>

<script>
  /***********************
   * CONFIG
   ***********************/
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby_n5xrEIRduxeo2upw4D0nsishR6zwBOY5JO472-7wU3EAYip94-4BncYw5r7dWHj6/exec";
  const BOOK = "SNU-1A";
  const LESSON = "lesson01";

  /***********************
   * WORD DATA (PDF í‘œê¸° ê·¸ëŒ€ë¡œ)
   ***********************/
  const WORDS = [
    { ko: "ê³µí•­", mn: "Ğ½Ğ¸ÑÑÑ… Ğ¾Ğ½Ğ³Ğ¾Ñ†Ğ½Ñ‹ Ğ±ÑƒÑƒĞ´Ğ°Ğ»" },
    { ko: "ì‹œì¥", mn: "Ğ·Ğ°Ñ…" },
    { ko: "ê°€ë‹¤", mn: "ÑĞ²Ğ°Ñ…" },
    { ko: "ì˜êµ­", mn: "Ğ‘Ñ€Ğ¸Ñ‚Ğ°Ğ½" },
    { ko: "ì±…ìƒ", mn: "ÑˆĞ¸Ñ€ÑÑ" },
    { ko: "í•™êµ", mn: "ÑÑƒÑ€Ğ³ÑƒÑƒĞ»ÑŒ" },
    { ko: "ë§ˆì‹œë‹¤", mn: "ÑƒÑƒÑ…" },
    { ko: "ë¨¹ë‹¤", mn: "Ğ¸Ğ´ÑÑ…" },
    { ko: "ì£¼ìŠ¤", mn: "Ğ¶Ò¯Ò¯Ñ" },
    { ko: "í˜¸ì£¼", mn: "ĞĞ²ÑÑ‚Ñ€Ğ°Ğ»Ğ¸" },
    { ko: "ì§‘", mn: "Ğ³ÑÑ€" },
    { ko: "ì˜ì‚¬", mn: "ÑĞ¼Ñ‡" },
    { ko: "ë¯¸êµ­", mn: "ĞĞ¼ĞµÑ€Ğ¸Ğº" },
    { ko: "íšŒì‚¬ì›", mn: "ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹Ğ½ Ğ°Ğ¶Ğ¸Ğ»Ñ‚Ğ°Ğ½" },
    { ko: "ì‚¬ë‹¤", mn: "Ñ…ÑƒĞ´Ğ°Ğ»Ğ´Ğ°Ğ¶ Ğ°Ğ²Ğ°Ñ…" },
    { ko: "í”„ë‘ìŠ¤", mn: "Ğ¤Ñ€Ğ°Ğ½Ñ†" },
    { ko: "ì˜¤ë‹¤", mn: "Ğ¸Ñ€ÑÑ…" },
    { ko: "í”¼ì", mn: "Ğ¿Ğ¸Ñ†Ñ†Ğ°" },
    { ko: "ë„ì„œê´€", mn: "Ğ½Ğ¾Ğ¼Ñ‹Ğ½ ÑĞ°Ğ½" },
    { ko: "ëª½ê³¨", mn: "ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»" },

    { ko: "ì½ë‹¤", mn: "ÑƒĞ½ÑˆĞ¸Ñ…" },
    { ko: "í•œêµ­", mn: "Ğ¡Ğ¾Ğ»Ğ¾Ğ½Ğ³Ğ¾Ñ" },
    { ko: "ì„ ìƒë‹˜", mn: "Ğ±Ğ°Ğ³Ñˆ" },
    { ko: "ê¸°ì", mn: "ÑÑÑ‚Ğ³Ò¯Ò¯Ğ»Ñ‡" },
    { ko: "ì‹ë‹¹", mn: "Ñ…Ğ¾Ğ¾Ğ»Ğ½Ñ‹ Ğ³Ğ°Ğ·Ğ°Ñ€" },
    { ko: "ìš”ë¦¬ì‚¬", mn: "Ñ‚Ğ¾Ğ³Ğ¾Ğ¾Ñ‡" },
    { ko: "ìš”ë¦¬í•˜ë‹¤", mn: "Ñ…Ğ¾Ğ¾Ğ» Ñ…Ğ¸Ğ¹Ñ…" },
    { ko: "ì£¼ë‹¤", mn: "Ó©Ğ³Ó©Ñ…" },
    { ko: "ì¤‘êµ­", mn: "Ğ¥ÑÑ‚Ğ°Ğ´" },
    { ko: "ì‚¬ëŒ", mn: "Ñ…Ò¯Ğ½" },
    { ko: "ì¼ë³¸", mn: "Ğ¯Ğ¿Ğ¾Ğ½" },
    { ko: "êµ°ì¸", mn: "Ñ†ÑÑ€ÑĞ³" },
    { ko: "ê°€ìˆ˜", mn: "Ğ´ÑƒÑƒÑ‡Ğ¸Ğ½" },
    { ko: "ì–´ëŠ", mn: "Ğ°Ğ»ÑŒ" },
    { ko: "ì˜ì", mn: "ÑĞ°Ğ½Ğ´Ğ°Ğ»" },
    { ko: "ìš´ë™í•˜ë‹¤", mn: "Ğ´Ğ°ÑĞ³Ğ°Ğ» Ñ…Ğ¸Ğ¹Ñ…" },
    { ko: "ë§ˆíŠ¸", mn: "ÑÑƒĞ¿ĞµÑ€Ğ¼Ğ°Ñ€ĞºĞµÑ‚" },
    { ko: "í•™ìƒ", mn: "Ğ¾ÑÑƒÑ‚Ğ°Ğ½" },
    { ko: "ë°±í™”ì ", mn: "Ğ¸Ñ… Ğ´ÑĞ»Ğ³Ò¯Ò¯Ñ€" },
    { ko: "ë…ì¼", mn: "Ğ“ĞµÑ€Ğ¼Ğ°Ğ½" }
  ];

  /***********************
   * STATE
   ***********************/
  const qs = new URLSearchParams(location.search);
  const NAME = (qs.get("name") || "").trim();
  const KLASS = (qs.get("klass") || "").trim();
  const TOKEN = (qs.get("token") || "").trim();

  const deviceId = getDeviceId_();
  const ua = navigator.userAgent || "";

  const attemptKey = `kquiz_attempt_fail__${BOOK}__${LESSON}__${KLASS}__${NAME}`;
  let failAttempts = Number(localStorage.getItem(attemptKey) || "0");

  let MODE = "KOQ"; // KOQ: í•œêµ­ì–´ ì§ˆë¬¸â†’ëª½ê³¨ì–´ ë³´ê¸°, MNQ: ëª½ê³¨ì–´ ì§ˆë¬¸â†’í•œêµ­ì–´ ë³´ê¸°
  let idx = 0;
  let score = 0;
  let questions = [];
  let wrongs = []; // {q, correct, picked}

  const $ = (id)=>document.getElementById(id);

  function setTopMsg(type, text){
    const el = $("topMsg");
    if(!text){
      el.classList.add("hidden");
      el.textContent = "";
      return;
    }
    el.classList.remove("hidden");
    el.classList.toggle("warn", type==="warn");
    el.classList.toggle("ok", type==="ok");
    el.textContent = text;
  }

  function updatePills(){
    $("scorePill").textContent = String(score);
    $("attemptPill").textContent = String(failAttempts);
    $("datePill").textContent = new Date().toLocaleDateString();
    $("userLine").textContent = `${NAME} Â· ${KLASS} Â· ${BOOK} Â· ${LESSON}`;
  }

  function setMode(mode){
    MODE = mode;
    $("modeKo").classList.toggle("active", MODE==="KOQ");
    $("modeMn").classList.toggle("active", MODE==="MNQ");
    restartQuiz();
  }

  function showOnly(boxId){
    $("quizBox").classList.add("hidden");
    $("reviewBox").classList.add("hidden");
    $("resultBox").classList.add("hidden");
    $(boxId).classList.remove("hidden");
  }

  function jsonpRequest_(baseUrl, params, timeoutMs=12000){
    return new Promise((resolve, reject)=>{
      const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
      const url = baseUrl + (baseUrl.includes("?") ? "&" : "?") +
        new URLSearchParams({ ...params, callback: cbName }).toString();

      let done = false;
      const script = document.createElement("script");

      function cleanup(){
        try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
        if(script && script.parentNode) script.parentNode.removeChild(script);
      }

      const timer = setTimeout(()=>{
        if(done) return;
        done = true;
        cleanup();
        reject(new Error("JSONP timeout"));
      }, timeoutMs);

      window[cbName] = (data)=>{
        if(done) return;
        done = true;
        clearTimeout(timer);
        cleanup();
        resolve(data);
      };

      script.onerror = ()=>{
        if(done) return;
        done = true;
        clearTimeout(timer);
        cleanup();
        reject(new Error("JSONP load error"));
      };

      script.src = url;
      document.head.appendChild(script);
    });
  }

  async function validateEntry_(){
    if(!NAME || !KLASS || !TOKEN){
      setTopMsg("warn", "â— URL Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ Ğ´ÑƒÑ‚ÑƒÑƒ Ğ±Ğ°Ğ¹Ğ½Ğ°.\n(name/klass/token ÑˆĞ°Ğ°Ñ€Ğ´Ğ»Ğ°Ğ³Ğ°Ñ‚Ğ°Ğ¹)");
      return false;
    }
    try{
      const res = await jsonpRequest_(SCRIPT_URL, {
        action: "validate",
        token: TOKEN,
        deviceId,
        name: NAME,
        klass: KLASS
      });
      if(!res || !res.ok){
        setTopMsg("warn", "â— ĞÑĞ²Ñ‚Ñ€ÑÑ… ÑÑ€Ñ…Ğ³Ò¯Ğ¹.\nĞ”Ğ°Ñ…Ğ¸Ğ½ index.html-ÑÑÑ€ Ğ¾Ñ€Ğ½Ğ¾ ÑƒÑƒ.");
        return false;
      }
      return true;
    }catch(e){
      setTopMsg("warn", "â— Ğ¡ĞµÑ€Ğ²ĞµÑ€Ñ‚ÑĞ¹ Ñ…Ğ¾Ğ»Ğ±Ğ¾Ğ³Ğ´Ğ¾Ğ¶ Ñ‡Ğ°Ğ´ÑĞ°Ğ½Ğ³Ò¯Ğ¹.\nĞ”Ğ°Ñ…Ğ¸Ğ½ Ğ¾Ñ€Ğ¾Ğ»Ğ´Ğ¾Ğ½Ğ¾ ÑƒÑƒ.");
      return false;
    }
  }

  function buildQuestions_(){
    const pool = WORDS.slice().filter(x => x && x.ko && x.mn);
    shuffle_(pool);

    const count = Math.min(10, pool.length);
    const base = pool.slice(0, count);

    questions = base.map(item => {
      const qText = (MODE==="KOQ") ? item.ko : item.mn;
      const correct = (MODE==="KOQ") ? item.mn : item.ko;

      const distractorPool = pool
        .map(x => (MODE==="KOQ") ? x.mn : x.ko)
        .filter(v => v && v !== correct);

      const choices = uniqueChoices_(correct, distractorPool, 4);
      shuffle_(choices);

      return { qText, correct, choices };
    });
  }

  function uniqueChoices_(correct, pool, n){
    const out = [correct];
    const seen = new Set(out);
    for(const v of pool){
      if(out.length >= n) break;
      if(!seen.has(v)){
        out.push(v);
        seen.add(v);
      }
    }
    let guard = 0;
    while(out.length < n && guard < 500){
      guard++;
      const v = pool[Math.floor(Math.random()*pool.length)];
      if(v && !seen.has(v)){
        out.push(v);
        seen.add(v);
      }
    }
    while(out.length < n) out.push("â€”");
    return out;
  }

  function renderQuestion_(){
    setTopMsg("", "");
    const total = questions.length;
    const q = questions[idx];

    $("qNo").textContent = `Q ${idx+1} / ${total}`;
    $("qText").textContent = q.qText;

    const wrap = $("choices");
    wrap.innerHTML = "";

    q.choices.forEach(choiceText => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.textContent = choiceText;
      btn.onclick = ()=> pickAnswer_(choiceText);
      wrap.appendChild(btn);
    });
  }

  function pickAnswer_(picked){
    const q = questions[idx];
    const buttons = Array.from(document.querySelectorAll(".choice"));
    buttons.forEach(b => b.classList.add("disabled"));

    const isCorrect = picked === q.correct;

    buttons.forEach(b=>{
      if(b.textContent === q.correct) b.classList.add("correct");
      if(b.textContent === picked && !isCorrect) b.classList.add("wrong");
    });

    if(!isCorrect){
      wrongs.push({ q: q.qText, correct: q.correct, picked });
    }

    setTimeout(()=>{
      idx++;
      if(idx >= questions.length){
        finishQuiz_();
      }else{
        renderQuestion_();
      }
    }, 450);
  }

  async function finishQuiz_(){
    const total = questions.length;
    const correctCount = total - wrongs.length;

    score = Math.round((correctCount / Math.max(1,total)) * 100);
    updatePills();

    const passedByScore = score >= 80;
    if(!passedByScore){
      failAttempts += 1;
      localStorage.setItem(attemptKey, String(failAttempts));
    }

    const passedByAttempts = failAttempts >= 5;
    const finalPass = passedByScore || passedByAttempts;

    await safeLog_(score, failAttempts);

    if(finalPass){
      showResultScreen(true, passedByAttempts && !passedByScore);
    }else{
      showReviewScreen_();
    }
  }

  function showReviewScreen_(){
    showOnly("reviewBox");
    $("reviewMsg").textContent =
      `80-Ğ°Ğ°Ñ Ğ´Ğ¾Ğ¾Ñˆ Ğ¾Ğ½Ğ¾Ğ¾ Ğ°Ğ²ÑĞ°Ğ½ Ñ‚ÑƒĞ» ÑÑ…Ğ»ÑÑĞ´ Review Ñ…Ğ°Ñ€ÑƒÑƒĞ»Ğ½Ğ°.\n` +
      `ĞĞ´Ğ¾Ğ¾: ${score} / 100\n` +
      `Fail attempts: ${failAttempts} (5 Ñ…Ò¯Ñ€Ğ²ÑĞ» Ğ¾Ğ½Ğ¾Ğ¾Ğ½Ğ¾Ğ¾Ñ Ò¯Ğ» Ñ…Ğ°Ğ¼Ğ°Ğ°Ñ€Ğ°Ğ½ Ñ‚ÑĞ½Ñ†ÑĞ½Ñ)`;

    const list = $("reviewList");
    list.innerHTML = "";
    wrongs.forEach((w,i)=>{
      const div = document.createElement("div");
      div.className = "reviewItem";
      div.innerHTML =
        `<b>#${i+1}</b>` +
        `<div>Q: ${escapeHtml_(w.q)}</div>` +
        `<div style="color:var(--bad); font-weight:900;">Your: ${escapeHtml_(w.picked)}</div>` +
        `<div style="color:var(--ok); font-weight:900;">Ans: ${escapeHtml_(w.correct)}</div>`;
      list.appendChild(div);
    });
  }

  function showResultScreen(passed=true, passedByAttempts=false){
    showOnly("resultBox");

    const date = new Date().toLocaleString();
    const title = passed ? "Ğ¢ÑĞ½Ñ†Ğ»ÑÑ!" : "Result";
    $("resultTitle").textContent = title;

    const passNote = passedByAttempts
      ? "\nâœ… 5+ ÑƒĞ´Ğ°Ğ° Ğ¾Ñ€Ğ¾Ğ»Ğ´ÑĞ¾Ğ½ Ñ‚ÑƒĞ» Ğ¾Ğ½Ğ¾Ğ¾Ğ½Ğ¾Ğ¾Ñ Ò¯Ğ» Ñ…Ğ°Ğ¼Ğ°Ğ°Ñ€Ğ°Ğ½ Ñ‚ÑĞ½Ñ†Ò¯Ò¯Ğ»ÑĞ²."
      : "";

    $("resultMsg").textContent =
      `Name: ${NAME}\n` +
      `Class: ${KLASS}\n` +
      `Book: ${BOOK}\n` +
      `Lesson: ${LESSON}\n` +
      `Score: ${score} / 100\n` +
      `Attempts: ${failAttempts}\n` +
      `Date: ${date}\n` +
      passNote + "\n\n" +
      `ğŸ“Œ Ğ¡ĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚ Ñ…Ğ¸Ğ¹Ğ³ÑÑĞ´ Ğ±Ğ°Ğ³ÑˆĞ´Ğ°Ğ° ÑĞ²ÑƒÑƒĞ»Ğ°Ğ°Ñ€Ğ°Ğ¹!`;
  }

  async function safeLog_(scoreNum, attemptsNum){
    try{
      await jsonpRequest_(SCRIPT_URL, {
        action: "log",
        token: TOKEN,
        deviceId,
        name: NAME,
        klass: KLASS,
        book: BOOK,
        lesson: LESSON,
        score: String(scoreNum),
        attempts: String(attemptsNum),
        ua: ua.slice(0, 300)
      });
    }catch(e){
      console.log("log failed:", e);
    }
  }

  function goBackHub(){
    const base = "lessonHub.html";
    const url = `${base}?name=${encodeURIComponent(NAME)}&klass=${encodeURIComponent(KLASS)}&token=${encodeURIComponent(TOKEN)}`;
    location.href = url;
  }

  function restartQuiz(){
    idx = 0;
    score = 0;
    wrongs = [];
    updatePills();
    buildQuestions_();
    showOnly("quizBox");
    renderQuestion_();
  }

  async function shareCapture(){
    const text =
      `Name: ${NAME}\nClass: ${KLASS}\nBook: ${BOOK}\nLesson: ${LESSON}\nScore: ${score}/100\nAttempts: ${failAttempts}\nDate: ${new Date().toLocaleString()}`;

    try{
      if(navigator.share){
        await navigator.share({ title: "K-Quiz Result", text });
        return;
      }
    }catch(e){}
    alert("Ğ¡ĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚ Ñ…Ğ¸Ğ¹Ğ³ÑÑĞ´ Ğ±Ğ°Ğ³ÑˆĞ´Ğ°Ğ° ÑĞ²ÑƒÑƒĞ»Ğ°Ğ°Ñ€Ğ°Ğ¹! (Share Ğ´ÑĞ¼Ğ¶Ğ¸Ñ…Ğ³Ò¯Ğ¹ Ğ±Ğ°Ğ¹Ğ½Ğ°)");
  }

  function shuffle_(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  function getDeviceId_(){
    const k = "kquiz_deviceId";
    let id = localStorage.getItem(k);
    if(!id){
      id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+"_"+Math.random()).replace(".","");
      localStorage.setItem(k, id);
    }
    return id;
  }

  function escapeHtml_(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  (async function boot(){
    updatePills();
    const ok = await validateEntry_();
    if(!ok){
      showOnly("quizBox");
      $("qText").textContent = "Access denied";
      $("choices").innerHTML = "";
      return;
    }
    restartQuiz();
  })();
</script>
</body>
</html>
