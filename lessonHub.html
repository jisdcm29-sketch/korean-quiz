<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Хичээл сонгох</title>

  <style>
    :root{
      --bg:#f0f4f8; --card:#fff; --primary:#2d6cdf; --primary2:#1f4ea5; --line:#d9e4f5;
      --text:#223047; --muted:#6a7a8e;
      --warnbg:#fff5f5; --warnline:#feb2b2; --warntext:#7a1f1f;
      --okbg:#f0fff4; --okline:#b7f0c7; --oktext:#0f7a3d;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:20px; background:var(--bg); font-family:Arial,sans-serif; text-align:center; color:var(--text);}
    .container{max-width:680px; margin:0 auto; background:var(--card); padding:26px; border-radius:20px; border:1px solid var(--line); box-shadow:0 10px 20px rgba(0,0,0,0.08);}
    h1{margin:0; font-size:22px;}
    .sub{margin:10px 0 0; color:var(--muted); font-size:14px; line-height:1.45;}

    .top{
      display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:12px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #d7dee7;
      background:#f6f9ff; font-size:12px; font-weight:900; color:#2c3e50;
      max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .btn{
      padding:12px 14px; border-radius:12px; border:none; cursor:pointer;
      background:var(--primary); color:#fff; font-weight:900; font-size:14px;
    }
    .btn:hover{background:var(--primary2);}
    .btnGray{background:#eef2f7; color:#223047; border:1px solid #d7dee7;}
    .btnGray:hover{background:#e2e8f0;}

    /* ✅ 기본 2열 (아주 좁으면 1열) */
    .grid{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:14px; margin-top:16px;}
    @media (max-width:340px){ .grid{grid-template-columns:1fr;} }

    .cardBtn{
      padding:16px 12px; border-radius:14px; border:2px solid var(--primary);
      background:#fff; font-weight:900; cursor:pointer; font-size:16px;
      user-select:none;
    }
    .cardBtn:hover{background:var(--primary); color:#fff;}

    .warn{
      margin-top:14px; padding:12px; border-radius:12px; background:var(--warnbg);
      border:1px solid var(--warnline); color:var(--warntext);
      font-size:14px; line-height:1.45; text-align:left;
      white-space:pre-line;
    }
    .ok{
      margin-top:14px; padding:12px; border-radius:12px; background:var(--okbg);
      border:1px solid var(--okline); color:var(--oktext);
      font-size:14px; line-height:1.45; text-align:left;
      white-space:pre-line;
    }
    .hidden{display:none;}
    .meta{margin-top:10px; text-align:left; color:#4b5b6f; font-size:14px;}
    .meta b{color:#1f2f45;}
  </style>
</head>
<body>
<div class="container" id="app">
  <h1>Хичээл сонгох</h1>
  <p class="sub">Доорх хичээлээс сонгоно уу.</p>

  <div class="top">
    <div><span class="badge" id="badge">—</span></div>
    <div style="display:flex; gap:10px;">
      <button class="btn btnGray" onclick="goBack()">Буцах</button>
      <button class="btn" onclick="goHome()">Эхлэл</button>
    </div>
  </div>

  <div class="meta">
    Нэр: <b id="studentName">—</b><br/>
    Анги: <b id="klassName">—</b>
  </div>

  <div id="ok" class="ok hidden"></div>
  <div id="warn" class="warn hidden"></div>

  <div id="list" class="grid"></div>
</div>

<script>
  /******************************************************************
   * ✅ lessonHub (호환/복구 강화 버전)
   * - v2 저장소 + 예전(kquiz_state) 저장소 모두 지원
   * - URL에 name/klass/token 있으면 저장소로 복구
   * - URL에 book/level 없으면 index로 자동 이동
   ******************************************************************/

  const LESSON_RANGE = {
    "SNU-1A": { start: 1, end: 8 },
    "SNU-1B": { start: 9, end: 16 },
    "SNU-2A": { start: 1, end: 8 },
    "SNU-2B": { start: 9, end: 16 },
    "SNU-3A": { start: 1, end: 8 },
    "SNU-3B": { start: 9, end: 16 },
    "SNU-4A": { start: 1, end: 8 },
    "SNU-4B": { start: 9, end: 16 },

    "TOPIK-1": { start: 1, end: 20 },
    "TOPIK-2": { start: 1, end: 20 }
  };

  // v2 keys (새 버전)
  const STORAGE_KEY_V2 = "kquiz_state_v2";
  const SESSION_KEY_V2  = "kquiz_state_v2_session";

  // legacy key (예전 버전)
  const LEGACY_SESSION_KEY = "kquiz_state";

  const STATE_TTL_MS = 8 * 60 * 60 * 1000; // 8시간

  function pad2(n){ return String(n).padStart(2, "0"); }
  function $(id){ return document.getElementById(id); }

  function showWarn(msg){
    const w = $("warn");
    w.textContent = msg;
    w.classList.remove("hidden");
    $("ok").classList.add("hidden");
  }
  function showOk(msg){
    const o = $("ok");
    o.textContent = msg;
    o.classList.remove("hidden");
    $("warn").classList.add("hidden");
  }
  function clearMsg(){
    $("warn").classList.add("hidden");
    $("ok").classList.add("hidden");
  }

  function goHome(){ location.href = "index.html"; }
  function goBack(){ history.back(); }

  function getParams(){
    const p = new URLSearchParams(location.search);
    return {
      book: (p.get("book") || "").trim(),
      level:(p.get("level")|| "").trim(),
      name: (p.get("name") || "").trim(),
      klass:(p.get("klass")|| "").trim(),
      token:(p.get("token")|| "").trim()
    };
  }

  function prettyTitle(book, level){
    if(book === "SNU") return `SNU · ${level}`;
    if(book === "TOPIK") return `TOPIK · ${level}`;
    return "—";
  }
  function getKey(book, level){ return `${book}-${level}`; }
  function buildFilename(book, level, num){
    return `${book}-${level}-lesson${pad2(num)}.html`;
  }

  // v2 state 검증
  function validateV2State(s){
    if(!s || !s.token || !s.name || !s.klass) return false;
    const ts = s.ts || 0;
    if(!ts) return false;
    if((Date.now() - ts) > STATE_TTL_MS) return false;
    return String(s.token).length > 5;
  }

  // legacy state 검증(예전엔 ts가 없을 수 있음)
  function validateLegacyState(s){
    if(!s || !s.token || !s.name || !s.klass) return false;
    return String(s.token).length > 5;
  }

  function readStateAny(){
    // 1) v2 session
    try{
      const raw = sessionStorage.getItem(SESSION_KEY_V2);
      if(raw){
        const s = JSON.parse(raw);
        if(validateV2State(s)) return s;
      }
    }catch(e){}

    // 2) v2 local
    try{
      const raw = localStorage.getItem(STORAGE_KEY_V2);
      if(raw){
        const s = JSON.parse(raw);
        if(validateV2State(s)){
          // session에도 복원
          try{ sessionStorage.setItem(SESSION_KEY_V2, JSON.stringify(s)); }catch(e){}
          return s;
        }
      }
    }catch(e){}

    // 3) legacy session (kquiz_state)
    try{
      const raw = sessionStorage.getItem(LEGACY_SESSION_KEY);
      if(raw){
        const s = JSON.parse(raw);
        if(validateLegacyState(s)){
          // v2로 승격 저장(앞으로는 자동 호환)
          const upgraded = {
            pass: s.pass || "",
            name: s.name,
            klass: s.klass,
            deviceId: s.deviceId || "",
            token: s.token,
            ts: Date.now()
          };
          try{ sessionStorage.setItem(SESSION_KEY_V2, JSON.stringify(upgraded)); }catch(e){}
          try{ localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(upgraded)); }catch(e){}
          return upgraded;
        }
      }
    }catch(e){}

    return null;
  }

  function saveStateFromUrlIfPossible(){
    const p = getParams();
    if(p.name && p.klass && p.token){
      const s = {
        pass: "",
        name: p.name,
        klass: p.klass,
        deviceId: "",
        token: p.token,
        ts: Date.now()
      };
      try{ sessionStorage.setItem(SESSION_KEY_V2, JSON.stringify(s)); }catch(e){}
      try{ localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(s)); }catch(e){}
      return s;
    }
    return null;
  }

  function loadLessons(){
    clearMsg();

    const p = getParams();

    // ✅ book/level 없는 상태로 들어온 경우(스샷 케이스) → 홈으로 보냄
    if(!p.book || !p.level){
      $("badge").textContent = "—";
      showWarn("Буруу холбоос байна.\nЭхлэл товчийг дарж (Эхлэл) хуудаснаас дахин сонгоно уу.");
      return;
    }

    $("badge").textContent = prettyTitle(p.book, p.level);

    // ✅ 상태: 저장소 -> URL복구 순서
    let st = readStateAny();
    if(!st) st = saveStateFromUrlIfPossible();

    if(!st || !st.token || !st.name || !st.klass){
      showWarn("Нэвтрэх мэдээлэл олдсонгүй.\nЭхлэл хуудас руу буцаад дахин нэвтэрнэ үү.");
      return;
    }

    $("studentName").textContent = st.name;
    $("klassName").textContent = st.klass;

    const key = getKey(p.book, p.level);
    const cfg = LESSON_RANGE[key];

    if(!cfg || !cfg.start || !cfg.end || cfg.end < cfg.start){
      showWarn("Энэ түвшний хичээлийн тохиргоо олдсонгүй.\nLESSON_RANGE-д нэмнэ үү: " + key);
      return;
    }

    const listDiv = $("list");
    listDiv.innerHTML = "";
    showOk("Ачаалж байна...");

    for(let n = cfg.start; n <= cfg.end; n++){
      const btn = document.createElement("button");
      btn.className = "cardBtn";
      btn.textContent = `${n}-р хичээл`;
      btn.onclick = () => {
        const file = buildFilename(p.book, p.level, n);
        const url =
          `${file}?name=${encodeURIComponent(st.name)}` +
          `&klass=${encodeURIComponent(st.klass)}` +
          `&token=${encodeURIComponent(st.token)}`;
        location.href = url;
      };
      listDiv.appendChild(btn);
    }

    clearMsg();
    $("app").scrollIntoView({ behavior:"smooth", block:"start" });
  }

  loadLessons();
</script>
</body>
</html>
