<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Хичээл сонгох</title>

  <style>
    :root{
      --bg:#f0f4f8; --card:#fff; --primary:#2d6cdf; --primary2:#1f4ea5; --line:#d9e4f5;
      --text:#223047; --muted:#6a7a8e;
      --warnbg:#fff5f5; --warnline:#feb2b2; --warntext:#7a1f1f;
      --okbg:#f0fff4; --okline:#b7f0c7; --oktext:#0f7a3d;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:20px; background:var(--bg); font-family:Arial,sans-serif; text-align:center; color:var(--text);}
    .container{max-width:680px; margin:0 auto; background:var(--card); padding:26px; border-radius:20px; border:1px solid var(--line); box-shadow:0 10px 20px rgba(0,0,0,0.08);}
    h1{margin:0; font-size:22px;}
    .sub{margin:10px 0 0; color:var(--muted); font-size:14px; line-height:1.45;}
    .top{
      display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:12px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #d7dee7;
      background:#f6f9ff; font-size:12px; font-weight:900; color:#2c3e50;
    }
    .btn{
      padding:12px 14px; border-radius:12px; border:none; cursor:pointer;
      background:var(--primary); color:#fff; font-weight:900; font-size:14px;
    }
    .btn:hover{background:var(--primary2);}
    .btnGray{background:#eef2f7; color:#223047; border:1px solid #d7dee7;}
    .btnGray:hover{background:#e2e8f0;}
    .grid{display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; margin-top:16px;}
    @media (max-width:560px){ .grid{grid-template-columns:1fr;} }

    .cardBtn{
      padding:16px 12px; border-radius:14px; border:2px solid var(--primary);
      background:#fff; font-weight:900; cursor:pointer; font-size:16px;
      user-select:none;
    }
    .cardBtn:hover{background:var(--primary); color:#fff;}

    .warn{
      margin-top:14px; padding:12px; border-radius:12px; background:var(--warnbg);
      border:1px solid var(--warnline); color:var(--warntext);
      font-size:14px; line-height:1.45; text-align:left;
      white-space:pre-line;
    }
    .ok{
      margin-top:14px; padding:12px; border-radius:12px; background:var(--okbg);
      border:1px solid var(--okline); color:var(--oktext);
      font-size:14px; line-height:1.45; text-align:left;
      white-space:pre-line;
    }
    .hidden{display:none;}
    .meta{margin-top:10px; text-align:left; color:#4b5b6f; font-size:14px;}
    .meta b{color:#1f2f45;}
  </style>
</head>
<body>
<div class="container" id="app">
  <h1>Хичээл сонгох</h1>
  <p class="sub">Доорх хичээлээс сонгоно уу.</p>

  <div class="top">
    <div>
      <span class="badge" id="badge">—</span>
    </div>
    <div style="display:flex; gap:10px;">
      <button class="btn btnGray" onclick="goBack()">Буцах</button>
      <button class="btn" onclick="goHome()">Эхлэл</button>
    </div>
  </div>

  <div class="meta">
    Нэр: <b id="studentName">—</b><br/>
    Анги: <b id="klassName">—</b>
  </div>

  <div id="ok" class="ok hidden"></div>
  <div id="warn" class="warn hidden"></div>

  <div id="list" class="grid"></div>
</div>

<script>
  // ✅ GitHub 저장소 정보
  const GITHUB_USERNAME = "jisdcm29-sketch";
  const GITHUB_REPO = "korean-quiz";

  function $(id){ return document.getElementById(id); }

  function showWarn(msg){
    const w = $("warn");
    w.textContent = msg;
    w.classList.remove("hidden");
    $("ok").classList.add("hidden");
  }
  function showOk(msg){
    const o = $("ok");
    o.textContent = msg;
    o.classList.remove("hidden");
    $("warn").classList.add("hidden");
  }
  function clearMsg(){
    $("warn").classList.add("hidden");
    $("ok").classList.add("hidden");
  }

  function goHome(){
    location.href = "index.html?v=" + Date.now();
  }
  function goBack(){
    history.back();
  }

  function getState(){
    const s = sessionStorage.getItem("kquiz_state");
    if(!s) return null;
    try{ return JSON.parse(s); }catch(e){ return null; }
  }

  function getParams(){
    const p = new URLSearchParams(location.search);
    return {
      book: (p.get("book") || "").trim(),   // SNU / TOPIK
      level:(p.get("level")|| "").trim()    // 1A / 1B / 2A / 2B / 1 / 2
    };
  }

  function buildPrefix(book, level){
    // 파일명 규칙:
    // SNU:   SNU-1A-lesson01.html
    // TOPIK: TOPIK-1-lesson01.html
    if(book === "SNU") return `SNU-${level}-lesson`;
    if(book === "TOPIK") return `TOPIK-${level}-lesson`;
    return "";
  }

  function prettyTitle(book, level){
    // ✅ 언어 섞임 방지: 한국어 "서울대" 대신 SNU 사용
    if(book === "SNU") return `SNU · ${level}`;
    if(book === "TOPIK") return `TOPIK · ${level}`;
    return "—";
  }

  function lessonNumFromName(filename){
    const m = String(filename).match(/lesson(\d+)\.html$/i);
    return m ? parseInt(m[1], 10) : null;
  }

  function naturalSortByLesson(a, b){
    const na = lessonNumFromName(a.name);
    const nb = lessonNumFromName(b.name);
    if(na !== null && nb !== null) return na - nb;
    return String(a.name).localeCompare(String(b.name));
  }

  async function loadLessons(){
    clearMsg();

    const st = getState();
    if(!st || !st.token || !st.name || !st.klass){
      showWarn("Нэвтрэх мэдээлэл олдсонгүй.\nЭхлэл хуудас руу буцаад дахин нэвтэрнэ үү.");
      return;
    }

    $("studentName").textContent = st.name;
    $("klassName").textContent = st.klass;

    const {book, level} = getParams();
    const prefix = buildPrefix(book, level);
    $("badge").textContent = prettyTitle(book, level);

    if(!prefix){
      showWarn("Буруу хандалт байна.\nЭхлэл хуудас руу орж зөв сонголт хийнэ үү.");
      return;
    }

    const listDiv = $("list");
    listDiv.innerHTML = "";
    showOk("Ачаалж байна...");

    const api = `https://api.github.com/repos/${encodeURIComponent(GITHUB_USERNAME)}/${encodeURIComponent(GITHUB_REPO)}/contents/`;

    try{
      const res = await fetch(api, {
        cache:"no-store",
        headers: { "Accept": "application/vnd.github+json" }
      });

      // 레이트 리밋/차단/권한 등의 경우
      if(!res.ok){
        let extra = "";
        if(res.status === 403) extra = "\n(Сервер түр хязгаарласан байж магадгүй. Дахин оролдоно уу.)";
        showWarn(`GitHub-аас файлын жагсаалт авч чадсангүй. [${res.status}]${extra}`);
        return;
      }

      const files = await res.json();

      if(!Array.isArray(files)){
        showWarn("GitHub-аас буруу хариу ирлээ.\n(Файлын жагсаалт биш байна.)");
        return;
      }

      const lessonFiles = files
        .filter(f => f && f.name && f.name.endsWith(".html") && f.name.startsWith(prefix))
        .sort(naturalSortByLesson);

      if(lessonFiles.length === 0){
        showWarn("Энэ түвшний хичээлийн файл олдсонгүй.\nФайлын нэрийг шалгана уу.");
        return;
      }

      clearMsg();

      lessonFiles.forEach(f => {
        const btn = document.createElement("button");
        btn.className = "cardBtn";

        const num = lessonNumFromName(f.name);
        btn.textContent = num ? `${num}-р хичээл` : f.name.replace(".html","");

        btn.onclick = () => {
          // ✅ 레슨 파일로 name/klass/token 전달
          const url =
            `${f.name}?name=${encodeURIComponent(st.name)}` +
            `&klass=${encodeURIComponent(st.klass)}` +
            `&token=${encodeURIComponent(st.token)}`;
          location.href = url;
        };

        listDiv.appendChild(btn);
      });

      // 모바일에서 목록이 바로 보이게 살짝 스크롤
      const app = $("app");
      if(app) app.scrollIntoView({ behavior:"smooth", block:"start" });

    }catch(e){
      showWarn("Алдаа гарлаа.\nДахин оролдоно уу.");
    }
  }

  loadLessons();
</script>
</body>
</html>
