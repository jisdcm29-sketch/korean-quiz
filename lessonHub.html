<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Хичээл сонгох</title>

  <style>
    :root{
      --bg:#f0f4f8; --card:#fff; --primary:#2d6cdf; --primary2:#1f4ea5; --line:#d9e4f5;
      --text:#223047; --muted:#6a7a8e;
      --warnbg:#fff5f5; --warnline:#feb2b2; --warntext:#7a1f1f;
      --okbg:#f0fff4; --okline:#b7f0c7; --oktext:#0f7a3d;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:20px; background:var(--bg); font-family:Arial,sans-serif; text-align:center; color:var(--text);}
    .container{max-width:680px; margin:0 auto; background:var(--card); padding:26px; border-radius:20px; border:1px solid var(--line); box-shadow:0 10px 20px rgba(0,0,0,0.08);}
    h1{margin:0; font-size:22px;}
    .sub{margin:10px 0 0; color:var(--muted); font-size:14px; line-height:1.45;}

    .top{
      display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:12px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #d7dee7;
      background:#f6f9ff; font-size:12px; font-weight:900; color:#2c3e50;
    }
    .btn{
      padding:12px 14px; border-radius:12px; border:none; cursor:pointer;
      background:var(--primary); color:#fff; font-weight:900; font-size:14px;
    }
    .btn:hover{background:var(--primary2);}
    .btnGray{background:#eef2f7; color:#223047; border:1px solid #d7dee7;}
    .btnGray:hover{background:#e2e8f0;}

    /* ✅ 레슨 목록: 기본 2열 유지 (아주 좁을 때만 1열) */
    .grid{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:14px; margin-top:16px;}
    @media (max-width:340px){ .grid{grid-template-columns:1fr;} }

    .cardBtn{
      padding:16px 12px; border-radius:14px; border:2px solid var(--primary);
      background:#fff; font-weight:900; cursor:pointer; font-size:16px;
      user-select:none;
    }
    .cardBtn:hover{background:var(--primary); color:#fff;}

    .warn{
      margin-top:14px; padding:12px; border-radius:12px; background:var(--warnbg);
      border:1px solid var(--warnline); color:var(--warntext);
      font-size:14px; line-height:1.45; text-align:left;
      white-space:pre-line;
    }
    .ok{
      margin-top:14px; padding:12px; border-radius:12px; background:var(--okbg);
      border:1px solid var(--okline); color:var(--oktext);
      font-size:14px; line-height:1.45; text-align:left;
      white-space:pre-line;
    }
    .hidden{display:none;}
    .meta{margin-top:10px; text-align:left; color:#4b5b6f; font-size:14px;}
    .meta b{color:#1f2f45;}
  </style>
</head>
<body>
<div class="container" id="app">
  <h1>Хичээл сонгох</h1>
  <p class="sub">Доорх хичээлээс сонгоно уу.</p>

  <div class="top">
    <div><span class="badge" id="badge">—</span></div>
    <div style="display:flex; gap:10px;">
      <button class="btn btnGray" onclick="goBack()">Буцах</button>
      <button class="btn" onclick="goHome()">Эхлэл</button>
    </div>
  </div>

  <div class="meta">
    Нэр: <b id="studentName">—</b><br/>
    Анги: <b id="klassName">—</b>
  </div>

  <div id="ok" class="ok hidden"></div>
  <div id="warn" class="warn hidden"></div>

  <div id="list" class="grid"></div>
</div>

<script>
  /******************************************************************
   * ✅ 레슨 허브 (로그인 유지 대응 버전)
   * - index.html에서 저장한 kquiz_state_v2(session/local) 읽기
   * - URL에 name/klass/token 있으면 상태 복구 저장
   * - book/level은 URL로 받음
   * - 이동 시 name/klass/token 항상 전달
   ******************************************************************/

  /** ✅ 레슨 범위 설정 */
  const LESSON_RANGE = {
    "SNU-1A": { start: 1, end: 8 },
    "SNU-1B": { start: 9, end: 16 },
    "SNU-2A": { start: 1, end: 8 },
    "SNU-2B": { start: 9, end: 16 },
    "SNU-3A": { start: 1, end: 8 },
    "SNU-3B": { start: 9, end: 16 },
    "SNU-4A": { start: 1, end: 8 },
    "SNU-4B": { start: 9, end: 16 },

    "TOPIK-1": { start: 1, end: 20 },
    "TOPIK-2": { start: 1, end: 20 }
  };

  // ✅ index.html과 동일한 저장 키/TTL
  const STORAGE_KEY = "kquiz_state_v2";
  const SESSION_KEY = "kquiz_state_v2_session";
  const STATE_TTL_MS = 8 * 60 * 60 * 1000; // 8시간

  function pad2(n){ return String(n).padStart(2, "0"); }
  function $(id){ return document.getElementById(id); }

  function showWarn(msg){
    const w = $("warn");
    w.textContent = msg;
    w.classList.remove("hidden");
    $("ok").classList.add("hidden");
  }
  function showOk(msg){
    const o = $("ok");
    o.textContent = msg;
    o.classList.remove("hidden");
    $("warn").classList.add("hidden");
  }
  function clearMsg(){
    $("warn").classList.add("hidden");
    $("ok").classList.add("hidden");
  }

  function goHome(){ location.href = "index.html"; }
  function goBack(){ history.back(); }

  function getParams(){
    const p = new URLSearchParams(location.search);
    return {
      book: (p.get("book") || "").trim(),   // SNU / TOPIK
      level:(p.get("level")|| "").trim(),   // 1A..4B / 1 / 2
      name: (p.get("name") || "").trim(),
      klass:(p.get("klass")|| "").trim(),
      token:(p.get("token")|| "").trim()
    };
  }

  function prettyTitle(book, level){
    if(book === "SNU") return `SNU · ${level}`;
    if(book === "TOPIK") return `TOPIK · ${level}`;
    return "—";
  }
  function getKey(book, level){ return `${book}-${level}`; }
  function buildFilename(book, level, num){
    return `${book}-${level}-lesson${pad2(num)}.html`;
  }

  function readState(){
    // 1) session 우선
    let raw = null;
    try{ raw = sessionStorage.getItem(SESSION_KEY); }catch(e){}
    // 2) 없으면 local backup
    if(!raw){
      try{ raw = localStorage.getItem(STORAGE_KEY); }catch(e){}
    }

    if(!raw) return null;

    try{
      const s = JSON.parse(raw);
      const now = Date.now();
      const ts = s && s.ts ? s.ts : 0;
      const okTTL = ts && (now - ts) <= STATE_TTL_MS;
      const okToken = s && s.token && String(s.token).length > 5;
      if(okTTL && okToken) return s;
    }catch(e){}

    return null;
  }

  function saveStateFromUrlIfPossible(){
    // URL에 name/klass/token이 있으면 복구 저장(직접 링크로 열어도 OK)
    const p = getParams();
    if(p.name && p.klass && p.token){
      const s = {
        pass: "", // 허브에서는 필요 없음
        name: p.name,
        klass: p.klass,
        deviceId: "", // 허브에서는 필요 없음
        token: p.token,
        ts: Date.now()
      };
      try{ sessionStorage.setItem(SESSION_KEY, JSON.stringify(s)); }catch(e){}
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){}
      return s;
    }
    return null;
  }

  function loadLessons(){
    clearMsg();

    const urlp = getParams();
    const book = urlp.book;
    const level = urlp.level;

    $("badge").textContent = prettyTitle(book, level);

    if(!book || !level){
      showWarn("Буруу хандалт байна.\nЭхлэл хуудас руу орж зөв сонголт хийнэ үү.");
      return;
    }

    // 상태 복구 우선: 저장소 -> URL 복구
    let st = readState();
    if(!st) st = saveStateFromUrlIfPossible();

    if(!st || !st.token || !st.name || !st.klass){
      showWarn("Нэвтрэх мэдээлэл олдсонгүй.\nЭхлэл хуудас руу буцаад дахин нэвтэрнэ үү.");
      return;
    }

    $("studentName").textContent = st.name;
    $("klassName").textContent = st.klass;

    const key = getKey(book, level);
    const cfg = LESSON_RANGE[key];

    if(!cfg || !cfg.start || !cfg.end || cfg.end < cfg.start){
      showWarn(
        "Энэ түвшний хичээлийн тохиргоо олдсонгүй.\n" +
        "LESSON_RANGE-д энэ түлхүүрийг нэмнэ үү: " + key
      );
      return;
    }

    const listDiv = $("list");
    listDiv.innerHTML = "";
    showOk("Ачаалж байна...");

    for(let n = cfg.start; n <= cfg.end; n++){
      const btn = document.createElement("button");
      btn.className = "cardBtn";
      btn.textContent = `${n}-р хичээл`;

      btn.onclick = () => {
        const file = buildFilename(book, level, n);
        const url =
          `${file}?name=${encodeURIComponent(st.name)}` +
          `&klass=${encodeURIComponent(st.klass)}` +
          `&token=${encodeURIComponent(st.token)}`;
        location.href = url;
      };

      listDiv.appendChild(btn);
    }

    clearMsg();
    $("app").scrollIntoView({ behavior:"smooth", block:"start" });
  }

  loadLessons();
</script>
</body>
</html>
