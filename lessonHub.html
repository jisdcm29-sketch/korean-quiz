<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Хичээл сонгох</title>

  <style>
    :root{
      --bg:#f0f4f8; --card:#fff; --primary:#2d6cdf; --primary2:#1f4ea5; --line:#d9e4f5;
      --text:#223047; --muted:#6a7a8e;
      --warnbg:#fff5f5; --warnline:#feb2b2; --warntext:#7a1f1f;
      --okbg:#f0fff4; --okline:#b7f0c7; --oktext:#0f7a3d;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:20px; background:var(--bg); font-family:Arial,sans-serif; text-align:center; color:var(--text);}
    .container{max-width:680px; margin:0 auto; background:var(--card); padding:26px; border-radius:20px; border:1px solid var(--line); box-shadow:0 10px 20px rgba(0,0,0,0.08);}
    h1{margin:0; font-size:22px;}
    .sub{margin:10px 0 0; color:var(--muted); font-size:14px; line-height:1.45;}
    .top{
      display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:12px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #d7dee7;
      background:#f6f9ff; font-size:12px; font-weight:900; color:#2c3e50;
    }
    .btn{
      padding:12px 14px; border-radius:12px; border:none; cursor:pointer;
      background:var(--primary); color:#fff; font-weight:900; font-size:14px;
    }
    .btn:hover{background:var(--primary2);}
    .btnGray{background:#eef2f7; color:#223047; border:1px solid #d7dee7;}
    .btnGray:hover{background:#e2e8f0;}
    .grid{display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; margin-top:16px;}
    @media (max-width:560px){ .grid{grid-template-columns:1fr;} }

    .cardBtn{
      padding:16px 12px; border-radius:14px; border:2px solid var(--primary);
      background:#fff; font-weight:900; cursor:pointer; font-size:16px;
      user-select:none;
    }
    .cardBtn:hover{background:var(--primary); color:#fff;}

    .warn{
      margin-top:14px; padding:12px; border-radius:12px; background:var(--warnbg);
      border:1px solid var(--warnline); color:var(--warntext);
      font-size:14px; line-height:1.45; text-align:left;
      white-space:pre-line;
    }
    .ok{
      margin-top:14px; padding:12px; border-radius:12px; background:var(--okbg);
      border:1px solid var(--okline); color:var(--oktext);
      font-size:14px; line-height:1.45; text-align:left;
      white-space:pre-line;
    }
    .hidden{display:none;}
    .meta{margin-top:10px; text-align:left; color:#4b5b6f; font-size:14px;}
    .meta b{color:#1f2f45;}
  </style>
</head>
<body>
<div class="container" id="app">
  <h1>Хичээл сонгох</h1>
  <p class="sub">Доорх хичээлээс сонгоно уу.</p>

  <div class="top">
    <div>
      <span class="badge" id="badge">—</span>
    </div>
    <div style="display:flex; gap:10px;">
      <button class="btn btnGray" onclick="goBack()">Буцах</button>
      <button class="btn" onclick="goHome()">Эхлэл</button>
    </div>
  </div>

  <div class="meta">
    Нэр: <b id="studentName">—</b><br/>
    Анги: <b id="klassName">—</b>
  </div>

  <div id="ok" class="ok hidden"></div>
  <div id="warn" class="warn hidden"></div>

  <div id="list" class="grid"></div>
</div>

<script>
  /******************************************************************
   * ✅ GitHub API 제거 버전 (동시접속/속도 최적화)
   * - 레슨 목록을 "레슨 개수"로 즉시 생성합니다.
   * - 파일명 규칙: SNU-1A-lesson01.html, TOPIK-1-lesson01.html ...
   * - 이동 시 name/klass/token 항상 전달 (규칙 유지)
   ******************************************************************/

  /** ✅ 여기만 수정하면 됩니다: 각 과정의 "마지막 레슨 번호" */
  const LESSON_COUNT = {
    "SNU-1A": 20,
    "SNU-1B": 20,
    "SNU-2A": 20,
    "SNU-2B": 20,
    "TOPIK-1": 20,
    "TOPIK-2": 20
  };

  /** lesson01 처럼 2자리로 맞추기 (01~99) */
  function pad2(n){ return String(n).padStart(2, "0"); }

  function $(id){ return document.getElementById(id); }

  function showWarn(msg){
    const w = $("warn");
    w.textContent = msg;
    w.classList.remove("hidden");
    $("ok").classList.add("hidden");
  }
  function showOk(msg){
    const o = $("ok");
    o.textContent = msg;
    o.classList.remove("hidden");
    $("warn").classList.add("hidden");
  }
  function clearMsg(){
    $("warn").classList.add("hidden");
    $("ok").classList.add("hidden");
  }

  function goHome(){
    location.href = "index.html?v=" + Date.now();
  }
  function goBack(){
    history.back();
  }

  function getState(){
    const s = sessionStorage.getItem("kquiz_state");
    if(!s) return null;
    try{ return JSON.parse(s); }catch(e){ return null; }
  }

  function getParams(){
    const p = new URLSearchParams(location.search);
    return {
      book: (p.get("book") || "").trim(),   // SNU / TOPIK
      level:(p.get("level")|| "").trim()    // 1A / 1B / 2A / 2B / 1 / 2
    };
  }

  function prettyTitle(book, level){
    if(book === "SNU") return `SNU · ${level}`;
    if(book === "TOPIK") return `TOPIK · ${level}`;
    return "—";
  }

  function getKey(book, level){
    return `${book}-${level}`; // ex) SNU-1A, TOPIK-1
  }

  function buildFilename(book, level, num){
    // ex) SNU-1A-lesson01.html / TOPIK-1-lesson01.html
    return `${book}-${level}-lesson${pad2(num)}.html`;
  }

  function loadLessons(){
    clearMsg();

    const st = getState();
    if(!st || !st.token || !st.name || !st.klass){
      showWarn("Нэвтрэх мэдээлэл олдсонгүй.\nЭхлэл хуудас руу буцаад дахин нэвтэрнэ үү.");
      return;
    }

    $("studentName").textContent = st.name;
    $("klassName").textContent = st.klass;

    const {book, level} = getParams();
    $("badge").textContent = prettyTitle(book, level);

    if(!book || !level){
      showWarn("Буруу хандалт байна.\nЭхлэл хуудас руу орж зөв сонголт хийнэ үү.");
      return;
    }

    const key = getKey(book, level);
    const max = LESSON_COUNT[key];

    if(!max || max < 1){
      showWarn(
        "Энэ түвшний хичээлийн тохиргоо олдсонгүй.\n" +
        "LESSON_COUNT-д энэ түлхүүрийг нэмнэ үү: " + key
      );
      return;
    }

    const listDiv = $("list");
    listDiv.innerHTML = "";
    showOk("Ачаалж байна...");

    // ✅ 버튼 즉시 생성 (네트워크 요청 없음)
    for(let i=1; i<=max; i++){
      const btn = document.createElement("button");
      btn.className = "cardBtn";
      btn.textContent = `${i}-р хичээл`;

      btn.onclick = () => {
        const file = buildFilename(book, level, i);
        const url =
          `${file}?name=${encodeURIComponent(st.name)}` +
          `&klass=${encodeURIComponent(st.klass)}` +
          `&token=${encodeURIComponent(st.token)}`;
        location.href = url;
      };

      listDiv.appendChild(btn);
    }

    clearMsg();
    const app = $("app");
    if(app) app.scrollIntoView({ behavior:"smooth", block:"start" });
  }

  loadLessons();
</script>
</body>
</html>
