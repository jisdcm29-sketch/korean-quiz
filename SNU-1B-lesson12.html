<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>SNU-1B-lesson12</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111827;
      --card2:#0f172a;
      --muted:#9ca3af;
      --text:#e5e7eb;
      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --btn:#1f2937;
      --btn2:#0b1020;
      --line:#243042;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% 0%, #14213a 0%, var(--bg) 55%, #050812 100%);
      color:var(--text);
      min-height:100vh;
      padding: max(14px, env(safe-area-inset-top)) 14px max(14px, env(safe-area-inset-bottom));
    }
    .wrap{max-width:980px;margin:0 auto}
    header{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      margin: 10px 0 14px;
    }
    .title{
      display:flex;flex-direction:column;gap:4px;
    }
    h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      font-weight:800;
    }
    .sub{
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
    }
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      padding: 6px 10px;
      border-radius: 999px;
      font-size:12px;
      color: var(--text);
      display:flex;gap:6px;align-items:center;
      user-select:none;
    }
    .pill b{font-weight:800}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.09);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 16px;
      background: linear-gradient(180deg, rgba(0,0,0,.2), rgba(0,0,0,0));
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .cardHead .left{
      display:flex;flex-direction:column;gap:6px;
    }
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-size:12px;
      color: var(--muted);
    }
    .badge span{
      width:8px;height:8px;border-radius:999px;background:var(--warn);
      display:inline-block;
    }
    .qbox{
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .qtitle{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .qtitle .q{
      font-size:20px;
      font-weight:900;
      line-height:1.15;
      word-break:keep-all;
    }
    .qtitle .meta{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      text-align:right;
      min-width: 140px;
    }
    .choices{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width:720px){
      .choices{grid-template-columns:1fr 1fr}
    }
    button.choice{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding: 14px 12px;
      border-radius: 14px;
      text-align:left;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      transition: transform .06s ease, border-color .15s ease, background .15s ease;
      min-height: 52px;
      word-break:keep-all;
    }
    button.choice:active{transform: scale(.99)}
    button.choice[disabled]{opacity:.92; cursor:default}
    .ok{border-color: rgba(34,197,94,.7)!important; background: rgba(34,197,94,.12)!important}
    .no{border-color: rgba(239,68,68,.7)!important; background: rgba(239,68,68,.12)!important}
    .actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      padding: 0 16px 16px;
    }
    .btn{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight:800;
      cursor:pointer;
      font-size:14px;
      display:inline-flex;gap:8px;align-items:center;
      user-select:none;
    }
    .btn:active{transform: scale(.99)}
    .btn.secondary{background: rgba(255,255,255,.04)}
    .btn.danger{border-color: rgba(239,68,68,.45)}
    .btn.accent{border-color: rgba(34,197,94,.55)}
    .small{
      font-size:12px;color:var(--muted);
      padding: 0 16px 16px;
      line-height:1.5;
    }
    .result{
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .big{
      font-size:22px;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1.15;
      margin:0;
    }
    .scoreline{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    .scorebox{
      display:flex;align-items:baseline;gap:10px;flex-wrap:wrap;
      padding: 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
    }
    .scorebox .n{
      font-size:34px;
      font-weight:1000;
      color: var(--text);
    }
    .pass{color: var(--accent); font-weight:900}
    .fail{color: var(--danger); font-weight:900}
    .review{
      padding: 0 16px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .revItem{
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .revItem .k{font-weight:900;font-size:14px}
    .revItem .m{font-weight:800;color:#d1d5db;font-size:14px}
    .revItem .you{color:var(--muted);font-size:12px}
    .warnBox{
      background: rgba(245,158,11,.10);
      border: 1px solid rgba(245,158,11,.35);
      border-radius: 14px;
      padding: 12px;
      color: #fcd34d;
      font-weight:800;
      line-height:1.45;
    }
    .strongBox{
      background: rgba(34,197,94,.10);
      border: 1px solid rgba(34,197,94,.35);
      border-radius: 14px;
      padding: 12px;
      color: #bbf7d0;
      font-weight:900;
      line-height:1.45;
    }
    .dangerBox{
      background: rgba(239,68,68,.10);
      border: 1px solid rgba(239,68,68,.35);
      border-radius: 14px;
      padding: 12px;
      color: #fecaca;
      font-weight:900;
      line-height:1.45;
    }
    .mutebox{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 12px;
      color: var(--muted);
      line-height:1.45;
      font-size:12px;
    }
    .capRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    a{color:#93c5fd}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>SNU 1B ¬∑ Lesson 12 ¬∑ Word Quiz</h1>
      <div class="sub">4ÏßÄÏÑ†Îã§ ¬∑ ÍµêÏ∞®Ìòï(ÏßàÎ¨∏ Ïñ∏Ïñ¥ ‚Üî Î≥¥Í∏∞ Ïñ∏Ïñ¥) ¬∑ 80Ï†ê Ìï©Í≤©(–¢—ç–Ω—Ü–ª—ç—ç!) ¬∑ 5Ìöå Ïù¥ÏÉÅ Ïã§Ìå® Ïãú ÏûêÎèô Ìï©Í≤©</div>
    </div>
    <div class="pillrow">
      <div class="pill">Name: <b id="pillName">-</b></div>
      <div class="pill">Class: <b id="pillKlass">-</b></div>
      <div class="pill">Try: <b id="pillTry">0</b></div>
      <div class="pill">Token: <b class="mono" id="pillToken">-</b></div>
    </div>
  </header>

  <section class="card" id="mainCard" aria-live="polite">
    <div class="cardHead">
      <div class="left">
        <div style="font-weight:900">ÌÄ¥Ï¶à ÏßÑÌñâ</div>
        <div class="badge"><span></span><span id="badgeText">Ï§ÄÎπÑ Ï§ë‚Ä¶</span></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn secondary" id="btnRestart" type="button">‚ü≤ Îã§Ïãú ÏãúÏûë</button>
      </div>
    </div>

    <!-- QUIZ VIEW -->
    <div class="qbox" id="quizView" style="display:none">
      <div class="qtitle">
        <div>
          <div style="color:var(--muted);font-size:12px;margin-bottom:6px" id="qLabel">Q</div>
          <div class="q" id="qText">-</div>
        </div>
        <div class="meta">
          <div><b id="qIndex">1</b> / <b id="qTotal">40</b></div>
          <div>ÌòÑÏû¨ Ï†êÏàò: <b id="liveScore">0</b></div>
        </div>
      </div>
      <div class="choices" id="choices"></div>
    </div>

    <!-- RESULT VIEW -->
    <div class="result" id="resultView" style="display:none">
      <p class="big" id="resultTitle">Í≤∞Í≥º</p>

      <div class="scorebox">
        <div class="n" id="finalScore">0</div>
        <div style="display:flex;flex-direction:column;gap:4px">
          <div class="scoreline">
            <span>Name: <b id="rName">-</b></span>
            <span>Class: <b id="rKlass">-</b></span>
          </div>
          <div class="scoreline">
            <span>Try: <b id="rTry">0</b></span>
            <span>Date: <b id="rDate">-</b></span>
          </div>
          <div class="scoreline">
            <span>Token: <b class="mono" id="rToken">-</b></span>
          </div>
          <div class="scoreline" id="passFailLine"></div>
        </div>
      </div>

      <div id="reviewFirst" style="display:none">
        <div class="dangerBox">Review: –±—É—Ä—É—É —Ö–∞—Ä–∏—É–ª—Å–∞–Ω –∞—Å—É—É–ª—Ç—É—É–¥—ã–Ω –∑”©–≤ —Ö–∞—Ä–∏—É–ª—Ç (—ç—Ö–ª—ç—ç–¥ “Ø“Ø–Ω–∏–π–≥ —Ö–∞—Ä–Ω–∞)</div>
      </div>

      <div id="reviewList" class="review" style="display:none"></div>

      <div id="teacherMsg" class="strongBox">
        <span style="font-size:16px">‚ö†Ô∏è <b>–î—ç–ª–≥—ç—Ü–∏–π–Ω –∑—É—Ä–∞–≥ –∞–≤—á –±–∞–≥—à–¥–∞–∞ —è–≤—É—É–ª–∞–∞—Ä–∞–π!</b></span>
      </div>

      <div class="capRow">
        <button class="btn accent" id="btnCapture" type="button">üì∏ –ö–∞–ø—á–µ—Ä</button>
        <button class="btn secondary" id="btnStartOver" type="button">‚ü≤ Îã§Ïãú ÌíÄÍ∏∞</button>
      </div>

      <div class="mutebox" id="capHelp">
        ‚Ä¢ ‚Äú–ö–∞–ø—á–µ—Ä‚Äù —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–≤–∞–ª –±–æ–ª–æ–º–∂—Ç–æ–π —Ç”©—Ö”©”©—Ä”©–º–∂ –¥—ç—ç—Ä <b>share</b>-–∏–π–≥ —ç—Ö–ª—ç—ç–¥ –æ—Ä–æ–ª–¥–æ–Ω–æ.<br/>
        ‚Ä¢ –•—ç—Ä—ç–≤ share –∞–∂–∏–ª–ª–∞—Ö–≥“Ø–π –±–æ–ª –¥—ç–ª–≥—ç—Ü–∏–π–Ω –∑—É—Ä–∞–≥ –∞–≤–∞—Ö –∞—Ä–≥—ã–≥ –∑–∞–∞–∂ ”©–≥–Ω”©.
      </div>
    </div>

    <div class="small" id="footNote"></div>
  </section>
</div>

<script>
/**
 * SNU-1B Lesson 12 (PDF 1ÌéòÏù¥ÏßÄ "Ï†ïÎãµÏßÄ(ÏïîÍ∏∞Ïö©)" 40Ïåç Í∑∏ÎåÄÎ°ú)
 * - Ïñ∏Ïñ¥ ÏÑûÏûÑ Î∞©ÏßÄ: ko, mn Í∞ÅÍ∞Å Î∂ÑÎ¶¨ Îç∞Ïù¥ÌÑ∞
 * - 4ÏßÄÏÑ†Îã§ Ìï≠ÏÉÅ Î≥¥Ïû•: Ï§ëÎ≥µ Ï†úÍ±∞ + ÌíÄÏóêÏÑú Ï∂îÍ∞Ä Î≥¥Ï∂©
 * - ÍµêÏ∞®Ìòï: ÏßàÎ¨∏Ïù¥ ÌïúÍµ≠Ïñ¥Î©¥ Î≥¥Í∏∞=Î™ΩÍ≥®Ïñ¥ / ÏßàÎ¨∏Ïù¥ Î™ΩÍ≥®Ïñ¥Î©¥ Î≥¥Í∏∞=ÌïúÍµ≠Ïñ¥
 * - 100Ï†ê ÎßåÏ†ê, 80Ï†ê Ïù¥ÏÉÅ "–¢—ç–Ω—Ü–ª—ç—ç!"
 * - 5Ìöå Ïù¥ÏÉÅ Ïã§Ìå® Ïãú Ï†êÏàò Î¨¥Í¥Ä Ìï©Í≤©
 * - Ï∫°Ï≤ò Î≤ÑÌäº: Web Share API Í∞ÄÎä•ÌïòÎ©¥ Í≥µÏú† ÏãúÎèÑ, Î∂àÍ∞ÄÌïòÎ©¥ Ïä§ÌÅ¨Î¶∞ÏÉ∑ ÏïàÎÇ¥
 * - Ïô∏Î∂Ä ÌÜµÏã† ÏóÜÏùå(Í∏∞Ï¢Ö ÏïàÏ†ï). ÌïÑÏöî Ïãú JSONP ÌòïÌÉúÎ°ú Î∂ôÏùº Ïàò ÏûàÎèÑÎ°ù hook Ï†úÍ≥µ.
 */

// === URL params from index.html/lessonHub.html ===
function getParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name) || "";
}
const user = {
  name: getParam("name"),
  klass: getParam("klass"),
  token: getParam("token")
};

// === Required: do NOT ask name again ===
const safeName  = user.name  || "-";
const safeKlass = user.klass || "-";
const safeToken = user.token || "-";

document.getElementById("pillName").textContent  = safeName;
document.getElementById("pillKlass").textContent = safeKlass;
document.getElementById("pillToken").textContent = safeToken;

// === Vocabulary pairs (EXACT spellings from PDF page 1 "Ï†ïÎãµÏßÄ(ÏïîÍ∏∞Ïö©)") ===
const PAIRS = [
  { ko:"Ïó¨Î≥¥ÏÑ∏Ïöî", mn:"–ë–∞–π–Ω–∞ —É—É?" },
  { ko:"Ïã§Î°ÄÏßÄÎßå", mn:"–£—É—á–ª–∞–∞—Ä–∞–π, –≥—ç—Ö–¥—ç—ç" },
  { ko:"ÎàÑÍµ¨ÏÑ∏Ïöî", mn:"–•—ç–Ω –±—ç?" },
  { ko:"Ï†ÑÌôîÎ≤àÌò∏", mn:"—É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä" },
  { ko:"Ìú¥ÎåÄÌè∞", mn:"–≥–∞—Ä —É—Ç–∞—Å" },
  { ko:"Í≥µ(Ïà´Ïûê 0)", mn:"—Ç—ç–≥ (0)" },
  { ko:"ÏÇ¨Î¨¥Ïã§", mn:"–æ—Ñ—Ñ–∏—Å" },
  { ko:"ÏÇ¨Ïû•Îãò", mn:"–∑–∞—Ö–∏—Ä–∞–ª" },
  { ko:"(Ï†ÑÌôî/Î¨∏ÏûêÎ•º) Î∞õÎã§", mn:"—É—Ç–∞—Å/–º–µ—Å—Å–µ–∂ –∞–≤–∞—Ö" },
  { ko:"(Î¨∏ÏûêÎ•º) Î≥¥ÎÇ¥Îã§", mn:"–º–µ—Å—Å–µ–∂ –∏–ª–≥—ç—ç—Ö" },
  { ko:"Ïûò ÏßÄÎÇ¥Îã§", mn:"—Å–∞–π–Ω —è–≤–∞—Ö (—Å–∞–π–Ω –±–∞–π—Ö)" },
  { ko:"Î¨¥Ïä® Ïùº", mn:"—é—É –±–æ–ª—Å–æ–Ω –±—ç" },
  { ko:"ÏöîÎ¶¨ÌïòÎã§", mn:"—Ö–æ–æ–ª —Ö–∏–π—Ö" },
  { ko:"Î™ª", mn:"—á–∞–¥–∞—Ö–≥“Ø–π (Î™ª~)" },
  { ko:"Í∞êÍ∏∞", mn:"—Ö–∞–Ω–∏–∞–¥" },
  { ko:"Í∏∞Ïπ®", mn:"—Ö–∞–Ω–∏–∞–ª–≥–∞" },
  { ko:"Ïó¥", mn:"—Ö–∞–ª—É—É—Ä–∞–ª—Ç" },
  { ko:"ÏΩßÎ¨º", mn:"–Ω—É—Å" },
  { ko:"ÏïÑÌîÑÎã§", mn:"”©–≤–¥”©—Ö" },
  { ko:"ÎÇ´Îã§", mn:"—ç–¥–≥—ç—Ö" },
  { ko:"Î®∏Î¶¨", mn:"—Ç–æ–ª–≥–æ–π" },
  { ko:"Ïñ¥Íπ®", mn:"–º”©—Ä" },
  { ko:"Î∞∞", mn:"–≥—ç–¥—ç—Å" },
  { ko:"Î¨¥Î¶é", mn:"”©–≤–¥”©–≥" },
  { ko:"Îã§Î¶¨", mn:"—Ö”©–ª" },
  { ko:"ÏñºÍµ¥", mn:"–Ω“Ø“Ø—Ä" },
  { ko:"Ïò§Ï†Ñ", mn:"“Ø–¥–∏–π–Ω ”©–º–Ω”©" },
  { ko:"Ïò§ÌõÑ", mn:"“Ø–¥–∏–π–Ω —Ö–æ–π–Ω–æ" },
  { ko:"ÏÉàÎ≤Ω", mn:"“Ø“Ø—Ä—ç—ç—Ä" },
  { ko:"ÏïÑÏπ®", mn:"”©–≥–ª”©”©" },
  { ko:"Ï†êÏã¨", mn:"“Ø–¥–∏–π–Ω —Ö–æ–æ–ª" },
  { ko:"Ï†ÄÎÖÅ", mn:"–æ—Ä–æ–π–Ω —Ö–æ–æ–ª" },
  { ko:"ÏùºÏñ¥ÎÇòÎã§", mn:"—Å—ç—Ä—ç—Ö" },
  { ko:"ÏÑ∏ÏàòÌïòÎã§", mn:"–Ω“Ø“Ø—Ä—ç—ç —É–≥–∞–∞—Ö" },
  { ko:"Îã¶Îã§", mn:"–∞—Ä—á–∏—Ö (—É–≥–∞–∞—Ö)" },
  { ko:"ÏÉ§ÏõåÌïòÎã§", mn:"—à“Ø—Ä—à“Ø“Ø—Ä—Ç –æ—Ä–æ—Ö" },
  { ko:"ÌöåÏùòÌïòÎã§", mn:"—Ö—É—Ä–∞–ª —Ö–∏–π—Ö" },
  { ko:"Ï≤≠ÏÜåÌïòÎã§", mn:"—Ü—ç–≤—ç—Ä–ª—ç—Ö" },
  { ko:"Îπ®ÎûòÌïòÎã§", mn:"—Ö—É–≤—Ü–∞—Å —É–≥–∞–∞—Ö" },
  { ko:"ÏàôÏ†úÌïòÎã§", mn:"–≥—ç—Ä–∏–π–Ω –¥–∞–∞–ª–≥–∞–≤–∞—Ä —Ö–∏–π—Ö" }
];

// === Language safety checks (best-effort guard) ===
const reKorean = /[„Ñ±-„Öé„Öè-„Ö£Í∞Ä-Ìû£]/;
const reCyrillic = /[\u0400-\u04FF]/;

// Ensure: mn field does not contain Korean, ko field does not contain Cyrillic
for(const p of PAIRS){
  if(reKorean.test(p.mn)){
    console.warn("MN contains Korean (not allowed):", p);
  }
  if(reCyrillic.test(p.ko)){
    console.warn("KO contains Cyrillic (not allowed):", p);
  }
}

// === Quiz config ===
const TOTAL = PAIRS.length; // 40
const PASS_SCORE = 80;
const MAX_FAIL_AUTO_PASS = 5; // "5Î≤à Ïù¥ÏÉÅ Ïã§Ìå®ÌïòÎ©¥ Ï†êÏàòÏôÄ Í¥ÄÍ≥ÑÏóÜÏù¥ Ìï©Í≤©"
const POINT_PER_Q = 100 / TOTAL;

let tryCount = 0;
let currentIndex = 0;
let score = 0;
let questions = [];
let wrongLog = []; // {q, correct, your, mode}

// --- UI elements ---
const badgeText = document.getElementById("badgeText");
const quizView = document.getElementById("quizView");
const resultView = document.getElementById("resultView");
const qText = document.getElementById("qText");
const qIndex = document.getElementById("qIndex");
const qTotal = document.getElementById("qTotal");
const liveScore = document.getElementById("liveScore");
const choicesEl = document.getElementById("choices");
const qLabel = document.getElementById("qLabel");

const btnRestart = document.getElementById("btnRestart");
const btnStartOver = document.getElementById("btnStartOver");
const btnCapture = document.getElementById("btnCapture");

const footNote = document.getElementById("footNote");

// result fields
const rName = document.getElementById("rName");
const rKlass = document.getElementById("rKlass");
const rTry = document.getElementById("rTry");
const rDate = document.getElementById("rDate");
const rToken = document.getElementById("rToken");
const finalScore = document.getElementById("finalScore");
const passFailLine = document.getElementById("passFailLine");

const reviewFirst = document.getElementById("reviewFirst");
const reviewList = document.getElementById("reviewList");

qTotal.textContent = String(TOTAL);

// === Utilities ===
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function uniq(arr){
  const seen = new Set();
  const out = [];
  for(const x of arr){
    if(!seen.has(x)){
      seen.add(x);
      out.push(x);
    }
  }
  return out;
}

function todayStr(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}

// Mode: "KOQ" => question is Korean, options are Mongolian
// Mode: "MNQ" => question is Mongolian, options are Korean
function buildQuestions(){
  const base = PAIRS.map((p, idx)=>({ ...p, id: idx }));
  // ÎûúÎç§ÏúºÎ°ú KOQ/MNQ ÏÑûÍ∏∞(ÍµêÏ∞®Ìòï ÏûêÎèô)
  return shuffle(base).map(item=>{
    const mode = Math.random() < 0.5 ? "KOQ" : "MNQ";
    return { ...item, mode };
  });
}

function poolAnswers(mode){
  // returns answer pool in the option language
  if(mode === "KOQ") return PAIRS.map(p=>p.mn);
  return PAIRS.map(p=>p.ko);
}

function correctAnswerFor(q){
  return (q.mode === "KOQ") ? q.mn : q.ko;
}

function questionTextFor(q){
  return (q.mode === "KOQ") ? q.ko : q.mn;
}

// Always guarantee 4 unique options including correct.
// If insufficient after filtering, refill from full pool.
function makeOptions(q){
  const correct = correctAnswerFor(q);
  const mode = q.mode;
  const pool = poolAnswers(mode);

  // candidates excluding the correct
  let wrongCandidates = pool.filter(x => x !== correct);

  // pick 3 wrongs
  wrongCandidates = shuffle(wrongCandidates);
  let picked = wrongCandidates.slice(0, 3);

  // In case duplicates (shouldn't) or weird pool shortage, enforce uniqueness
  picked = uniq(picked).filter(x => x !== correct);

  // Refill if fewer than 3
  if(picked.length < 3){
    const refill = shuffle(wrongCandidates);
    for(const x of refill){
      if(picked.length >= 3) break;
      if(x !== correct && !picked.includes(x)){
        picked.push(x);
      }
    }
  }

  // Final safety: if still fewer than 3 (extremely unlikely), fallback by cycling pool
  if(picked.length < 3){
    for(const x of pool){
      if(picked.length >= 3) break;
      if(x !== correct && !picked.includes(x)){
        picked.push(x);
      }
    }
  }

  const options = shuffle([correct, ...picked].slice(0,4));
  // Ensure exactly 4 unique
  const final = uniq(options);
  // If uniq reduced length, pad again from pool
  if(final.length < 4){
    for(const x of shuffle(pool)){
      if(final.length >= 4) break;
      if(!final.includes(x)){
        final.push(x);
      }
    }
  }
  return final.slice(0,4);
}

function setBadge(text, color){
  badgeText.textContent = text;
  const dot = badgeText.previousElementSibling;
  if(dot){
    dot.style.background = color || "var(--warn)";
  }
}

// === Quiz Flow ===
function startQuiz(){
  tryCount += 1;
  document.getElementById("pillTry").textContent = String(tryCount);

  currentIndex = 0;
  score = 0;
  wrongLog = [];
  questions = buildQuestions();

  quizView.style.display = "";
  resultView.style.display = "none";
  setBadge("ÏßÑÌñâ Ï§ë‚Ä¶", "var(--warn)");
  renderQuestion();
}

function renderQuestion(){
  const q = questions[currentIndex];
  const qNum = currentIndex + 1;

  qIndex.textContent = String(qNum);
  liveScore.textContent = String(Math.round(score));

  const modeLabel = (q.mode === "KOQ")
    ? "ÏßàÎ¨∏: ÌïúÍµ≠Ïñ¥ / Î≥¥Í∏∞: Î™ΩÍ≥®Ïñ¥"
    : "ÏßàÎ¨∏: Î™ΩÍ≥®Ïñ¥ / Î≥¥Í∏∞: ÌïúÍµ≠Ïñ¥";
  qLabel.textContent = `Q${qNum} ¬∑ ${modeLabel}`;

  qText.textContent = questionTextFor(q);

  // build choices
  choicesEl.innerHTML = "";
  const opts = makeOptions(q);

  // Extra language-mix guard: filter out any option that contains forbidden script for that option language
  // KO options must not contain Cyrillic; MN options must not contain Korean
  const filtered = [];
  for(const opt of opts){
    if(q.mode === "KOQ"){
      // options are Mongolian: must not contain Korean
      if(reKorean.test(opt)) continue;
    }else{
      // options are Korean: must not contain Cyrillic
      if(reCyrillic.test(opt)) continue;
    }
    filtered.push(opt);
  }

  // If filtering reduced options, refill from pool safely
  let safeOpts = filtered;
  if(safeOpts.length < 4){
    const pool = poolAnswers(q.mode);
    for(const cand of shuffle(pool)){
      if(safeOpts.length >= 4) break;
      if(!safeOpts.includes(cand)){
        if(q.mode === "KOQ" && reKorean.test(cand)) continue;
        if(q.mode === "MNQ" && reCyrillic.test(cand)) continue;
        safeOpts.push(cand);
      }
    }
  }
  safeOpts = uniq(safeOpts).slice(0,4);

  // Final fallback: if still <4, rebuild without filter (but should not happen with clean data)
  if(safeOpts.length < 4){
    safeOpts = makeOptions(q);
  }

  for(const opt of safeOpts){
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "choice";
    btn.textContent = opt;
    btn.addEventListener("click", ()=> chooseAnswer(opt, btn));
    choicesEl.appendChild(btn);
  }
}

function chooseAnswer(selected, btnEl){
  // disable all
  const buttons = Array.from(document.querySelectorAll("button.choice"));
  buttons.forEach(b => b.disabled = true);

  const q = questions[currentIndex];
  const correct = correctAnswerFor(q);

  const isCorrect = (selected === correct);
  if(isCorrect){
    score += POINT_PER_Q;
    btnEl.classList.add("ok");
  }else{
    btnEl.classList.add("no");
    // mark correct button
    const correctBtn = buttons.find(b => b.textContent === correct);
    if(correctBtn) correctBtn.classList.add("ok");
    wrongLog.push({
      mode: q.mode,
      q: questionTextFor(q),
      correct: correct,
      your: selected
    });
  }

  liveScore.textContent = String(Math.round(score));

  setTimeout(()=>{
    currentIndex += 1;
    if(currentIndex >= TOTAL){
      finishQuiz();
    }else{
      renderQuestion();
    }
  }, 520);
}

function finishQuiz(){
  quizView.style.display = "none";
  resultView.style.display = "";

  const rawScore = Math.round(score);
  const passByScore = rawScore >= PASS_SCORE;
  const failedSoFar = countFailsBeforeThisTry(passByScore);
  // After incrementing tryCount in startQuiz, tryCount is current attempt count
  // "5Î≤à Ïù¥ÏÉÅ Ïã§Ìå®ÌïòÎ©¥ Ï†êÏàòÏôÄ Í¥ÄÍ≥ÑÏóÜÏù¥ Ìï©Í≤©" => if (fails >= 5) force pass.
  const forcePass = (failedSoFar >= MAX_FAIL_AUTO_PASS);

  // display
  rName.textContent = safeName;
  rKlass.textContent = safeKlass;
  rTry.textContent = String(tryCount);
  rDate.textContent = todayStr();
  rToken.textContent = safeToken;

  // Determine final pass/fail
  const finalPass = forcePass ? true : passByScore;
  finalScore.textContent = String(rawScore);

  const passFail = document.createElement("div");
  passFail.innerHTML = "";
  if(finalPass){
    const msg = forcePass
      ? `<span class="pass">–¢—ç–Ω—Ü–ª—ç—ç!</span> <span style="color:var(--muted)">(5+ —É–¥–∞–∞ —É–Ω–∞—Å–∞–Ω —Ç—É–ª –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä —Ç—ç–Ω—Ü“Ø“Ø–ª—ç–≤)</span>`
      : `<span class="pass">–¢—ç–Ω—Ü–ª—ç—ç!</span> <span style="color:var(--muted)">(80+)</span>`;
    passFailLine.innerHTML = msg;
    setBadge("ÏôÑÎ£å ¬∑ Ìï©Í≤©", "var(--accent)");
  }else{
    passFailLine.innerHTML = `<span class="fail">–£–Ω–∞—Å–∞–Ω</span> <span style="color:var(--muted)">(80-–∞–∞—Å –¥–æ–æ—à)</span>`;
    setBadge("ÏôÑÎ£å ¬∑ Î∂àÌï©Í≤©", "var(--danger)");
  }

  // Review rule: if <80, show Review first
  if(!finalPass){
    reviewFirst.style.display = "";
    renderReview();
  }else{
    // if passed, show review only if there were wrong answers (optional)
    if(wrongLog.length > 0){
      reviewFirst.style.display = "none";
      renderReview(true);
    }else{
      reviewFirst.style.display = "none";
      reviewList.style.display = "none";
    }
  }

  // Footer
  footNote.innerHTML = `
    ‚Ä¢ Ìï©Í≤© Í∏∞Ï§Ä: ${PASS_SCORE}Ï†ê ¬∑ Ïã§Ìå® ÎàÑÏ†Å 5Ìöå Ïù¥ÏÉÅÏù¥Î©¥ ÏûêÎèô Ìï©Í≤©<br/>
    ‚Ä¢ Ïù¥ ÌååÏùºÏùÄ Ïô∏Î∂Ä ÌÜµÏã† ÏóÜÏù¥ ÎèôÏûëÌï©ÎãàÎã§. (Í∏∞Ï¢Ö ÏïàÏ†ï)<br/>
    ‚Ä¢ ÌïÑÏöî Ïãú JSONP Î∞©Ïãù Ï†ÑÏÜ° hook(ÎØ∏ÏÇ¨Ïö©) Ï†úÍ≥µ: <span class="mono">window.__SEND_RESULT_JSONP__</span>
  `;

  // Attempt JSONP-like send if host page provides a hook (optional).
  // For stability, we do NOTHING unless a host defines window.__SEND_RESULT_JSONP__(payload).
  trySendResultJSONP({
    lesson: "SNU-1B-lesson12",
    name: safeName,
    klass: safeKlass,
    token: safeToken,
    score: rawScore,
    tryCount: tryCount,
    pass: finalPass,
    date: todayStr(),
    wrongCount: wrongLog.length
  });
}

// Count fails before this attempt (based on localStorage)
function countFailsBeforeThisTry(passByScore){
  const key = storageKey();
  const data = loadState(key);
  // data.fails counts previous fails
  return data.fails || 0;
}

function storageKey(){
  // token Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ name+klassÎ°ú
  const t = user.token ? `t:${user.token}` : `nk:${safeName}|${safeKlass}`;
  return `SNU1B12:${t}`;
}

function loadState(key){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : { fails:0 };
  }catch(e){
    return { fails:0 };
  }
}

function saveState(key, patch){
  const cur = loadState(key);
  const next = { ...cur, ...patch };
  try{
    localStorage.setItem(key, JSON.stringify(next));
  }catch(e){}
}

function renderReview(showEvenIfPass=false){
  // Update fail counter if not pass by score
  const key = storageKey();
  const rawScore = Math.round(score);
  const passByScore = rawScore >= PASS_SCORE;

  // Only count fail when score < 80
  if(!passByScore){
    const st = loadState(key);
    saveState(key, { fails: (st.fails||0) + 1 });
  }

  if(wrongLog.length === 0){
    if(showEvenIfPass){
      reviewList.style.display = "";
      reviewList.innerHTML = `<div class="strongBox">–ë“Ø–≥–¥ –∑”©–≤! (–∞–ª–¥–∞–∞ –±–∞–π—Ö–≥“Ø–π)</div>`;
    }else{
      reviewList.style.display = "none";
      reviewList.innerHTML = "";
    }
    return;
  }

  reviewList.style.display = "";
  reviewList.innerHTML = "";
  for(const item of wrongLog){
    const div = document.createElement("div");
    div.className = "revItem";
    // item.mode determines which is question language, but we show both correct pairing
    const label = (item.mode === "KOQ")
      ? "ÏßàÎ¨∏(ÌïúÍµ≠Ïñ¥) ‚Üí Ï†ïÎãµ(Î™ΩÍ≥®Ïñ¥)"
      : "ÏßàÎ¨∏(Î™ΩÍ≥®Ïñ¥) ‚Üí Ï†ïÎãµ(ÌïúÍµ≠Ïñ¥)";
    div.innerHTML = `
      <div class="you">${label}</div>
      <div class="k">${escapeHTML(item.q)}</div>
      <div class="m">‚úÖ ${escapeHTML(item.correct)}</div>
      <div class="you">‚ùå –¢–∞–Ω—ã —Ö–∞—Ä–∏—É–ª—Ç: ${escapeHTML(item.your)}</div>
    `;
    reviewList.appendChild(div);
  }

  // also show fails info
  const st = loadState(key);
  const failsNow = st.fails || 0;
  if(failsNow >= MAX_FAIL_AUTO_PASS){
    const box = document.createElement("div");
    box.className = "warnBox";
    box.innerHTML = `–ê–Ω—Ö–∞–∞—Ä: —É–Ω–∞—Å–Ω—ã —Ç–æ–æ <b>${failsNow}</b>. –î–∞—Ä–∞–∞–≥–∏–π–Ω –æ—Ä–æ–ª–¥–ª–æ–≥–æ–¥ –æ–Ω–æ–æ–Ω–æ–æ—Å “Ø–ª —Ö–∞–º–∞–∞—Ä–∞–Ω <b>–∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä —Ç—ç–Ω—Ü“Ø“Ø–ª–Ω—ç</b>.`;
    reviewList.prepend(box);
  }
}

function escapeHTML(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// Optional JSONP-like hook for maximum device stability (NO network by default).
function trySendResultJSONP(payload){
  if(typeof window.__SEND_RESULT_JSONP__ === "function"){
    try{ window.__SEND_RESULT_JSONP__(payload); }catch(e){}
  }
}

// === Capture / Share ===
async function doCaptureShare(){
  // We cannot guarantee full-page render-to-image without external libs.
  // Best effort: try Web Share with a text summary, and guide screenshot if not possible.
  const rawScore = Math.round(score);
  const summary =
`[SNU-1B-lesson12]
Name: ${safeName}
Class: ${safeKlass}
Score: ${rawScore}
Try: ${tryCount}
Date: ${todayStr()}
Token: ${safeToken}`;

  // Try share (text) first (stable across devices; iOS/Android vary)
  if(navigator.share){
    try{
      await navigator.share({ text: summary });
      alert("Share –∞–º–∂–∏–ª—Ç—Ç–∞–π. –û–¥–æ–æ –±–∞–≥—à —Ä—É—É —è–≤—É—É–ª–∞–∞—Ä–∞–π!");
      return;
    }catch(e){
      // fallthrough to screenshot guide
    }
  }

  // Screenshot guide
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  const isAndroid = /Android/i.test(navigator.userAgent);

  let msg = "Share –∞–∂–∏–ª–ª–∞—Ö–≥“Ø–π –±–∞–π–Ω–∞.\n\n";
  if(isIOS){
    msg += "iPhone: Side —Ç–æ–≤—á + Volume Up —Ç–æ–≤—á–∏–π–≥ –∑—ç—Ä—ç–≥ –¥–∞—Ä–∂ –¥—ç–ª–≥—ç—Ü–∏–π–Ω –∑—É—Ä–∞–≥ –∞–≤–∞–∞—Ä–∞–π.\n(–î–∞—Ä–∞–∞ –Ω—å –∑—É—Ä–∞–≥/Photos-–æ–æ—Å –±–∞–≥—à–¥–∞–∞ —è–≤—É—É–ª–Ω–∞.)";
  }else if(isAndroid){
    msg += "Android: Power —Ç–æ–≤—á + Volume Down —Ç–æ–≤—á–∏–π–≥ –∑—ç—Ä—ç–≥ –¥–∞—Ä–∂ –¥—ç–ª–≥—ç—Ü–∏–π–Ω –∑—É—Ä–∞–≥ –∞–≤–∞–∞—Ä–∞–π.\n(–î–∞—Ä–∞–∞ –Ω—å Gallery-–æ–æ—Å –±–∞–≥—à–¥–∞–∞ —è–≤—É—É–ª–Ω–∞.)";
  }else{
    msg += "Ïª¥Ìì®ÌÑ∞: ÌÇ§Î≥¥ÎìúÏùò Print Screen(PrtSc) ÎòêÎäî Ï∫°Ï≤ò ÎèÑÍµ¨Î•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.";
  }
  alert(msg);
}

// === Button bindings ===
btnRestart.addEventListener("click", ()=>{
  // Reset local fail count? NO. Keep fail count as required for 5 fails rule.
  startQuiz();
});
btnStartOver.addEventListener("click", ()=>{
  startQuiz();
});
btnCapture.addEventListener("click", ()=>{
  doCaptureShare();
});

// === Boot ===
(function init(){
  // ÏïàÎÇ¥: paramsÍ∞Ä ÏóÜÏúºÎ©¥(ÌÖåÏä§Ìä∏Ïö©) Í∑∏ÎûòÎèÑ ÎèôÏûë
  setBadge("ÏãúÏûë Ï§ÄÎπÑ ÏôÑÎ£å", "var(--warn)");
  startQuiz();
})();
</script>
</body>
</html>
