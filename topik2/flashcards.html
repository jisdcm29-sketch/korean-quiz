<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TOPIK II Flashcards</title>
  <style>
    :root{
      --bg1:#071226;
      --bg2:#0b1b37;
      --line:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.72);
      --muted2:rgba(234,242,255,.58);
      --shadow:0 20px 60px rgba(0,0,0,.45);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(900px 520px at 70% 22%, rgba(47,107,255,.22), transparent 60%),
        radial-gradient(700px 460px at 35% 60%, rgba(58,160,255,.12), transparent 65%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px 12px 26px;
    }

    .app{
      width:min(980px, 100%);
      background:rgba(9,18,33,.45);
      border:1px solid rgba(255,255,255,.08);
      border-radius:28px;
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
    }
    .leftControls{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform:translateY(1px)}
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      padding:10px 14px;
      border-radius:999px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .chip.active{
      background:linear-gradient(180deg, rgba(47,107,255,.95), rgba(47,107,255,.72));
      border-color:rgba(47,107,255,.85);
      box-shadow:0 12px 30px rgba(47,107,255,.25);
    }
    .rightInfo{
      text-align:right;
      font-size:12px;
      line-height:1.2;
      color:var(--muted);
      padding-right:4px;
      white-space:nowrap;
    }
    .rightInfo .strong{color:var(--text); font-weight:950}

    .header{
      padding:14px 16px 10px;
      text-align:center;
    }
    .header h1{
      margin:2px 0 2px;
      font-size:20px;
      letter-spacing:.4px;
    }
    .header .sub{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }

    .container{
      padding:10px 14px 16px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .panel{
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius:var(--radius);
      padding:12px;
    }

    .metaRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding:2px 4px 10px;
      border-bottom:1px solid var(--line);
      margin-bottom:12px;
    }
    .titleBox{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-start;
      min-width:0;
    }
    .lessonTitle{
      font-weight:950;
      font-size:14px;
      color:var(--text);
      opacity:.95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 76vw;
    }
    .mini{
      font-size:11px;
      color:var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 76vw;
    }
    .counter{
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:950;
      font-size:12px;
      min-width:64px;
    }

    .wordLine{
      display:flex;
      align-items:baseline;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      text-align:center;
      padding:6px 8px 14px;
    }
    .wordKo{
      font-weight:1000;
      font-size:38px;
      letter-spacing:-.6px;
      text-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .wordMn{
      font-weight:950;
      font-size:22px;
      color:rgba(234,242,255,.88);
      letter-spacing:-.2px;
    }

    .funcChips{
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
      padding:0 6px 10px;
    }
    .funcChip{
      border:1px solid rgba(58,160,255,.35);
      background:rgba(58,160,255,.12);
      color:rgba(234,242,255,.92);
      padding:6px 10px;
      border-radius:999px;
      font-weight:950;
      font-size:12px;
      letter-spacing:.2px;
    }

    /* 유의어/반의어 */
    .synAntGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:8px;
      padding:2px 2px 10px;
    }
    @media (min-width: 740px){
      .synAntGrid{grid-template-columns:1fr 1fr;}
    }
    .infoBox{
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(13,27,45,.92), rgba(15,34,57,.70));
      border-radius:18px;
      padding:12px 12px;
      min-height:74px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .infoLabel{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
    }
    .labelText{
      font-size:16.9px;            /* 13 * 1.3 */
      font-weight:1000;
      color:rgba(234,242,255,.98);
      letter-spacing:.2px;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      box-shadow:0 12px 30px rgba(0,0,0,.22);
    }
    .infoText{
      font-size:19.5px;            /* 15 * 1.3 */
      line-height:1.35;
      font-weight:900;
      color:rgba(234,242,255,.95);
      word-break:keep-all;
      white-space:pre-wrap;
    }

    /* 예문 */
    .examplesGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      padding-top:8px;
      border-top:1px dashed rgba(255,255,255,.10);
      margin-top:10px;
    }
    @media (min-width: 740px){
      .examplesGrid{grid-template-columns:1fr 1fr;}
    }
    .exBox{
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
    }
    .exBox.mn{
      border-color:rgba(27,191,136,.22);
      background:linear-gradient(180deg, rgba(27,191,136,.14), rgba(255,255,255,.02));
    }
    .exLabel{
      font-size:12px;
      color:rgba(234,242,255,.92);
      font-weight:1000;
      letter-spacing:.2px;
      margin-bottom:6px;
    }
    .exText{
      font-size:18px;
      font-weight:900;
      line-height:1.4;
      color:rgba(234,242,255,.95);
      white-space:pre-wrap;
      word-break:keep-all;
    }

    .navRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding-top:8px;
    }
    .navBtn{
      border:none;
      border-radius:18px;
      padding:16px 14px;
      font-size:20px;
      font-weight:1000;
      cursor:pointer;
      color:rgba(234,242,255,.96);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      -webkit-tap-highlight-color: transparent;
    }
    .navBtn.primary{
      background:linear-gradient(180deg, rgba(47,107,255,.95), rgba(47,107,255,.70));
      border-color:rgba(47,107,255,.72);
    }
    .navBtn:active{transform:translateY(1px)}

    .error{
      margin-top:10px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,80,80,.28);
      background:rgba(255,80,80,.12);
      color:rgba(255,235,235,.95);
      font-weight:900;
      font-size:13px;
      white-space:pre-wrap;
    }

    .loading{
      padding:10px 0 2px;
      color:var(--muted);
      font-weight:900;
      font-size:13px;
    }

    @media (max-width: 420px){
      .wordKo{font-size:34px}
      .wordMn{font-size:19px}
      .exText{font-size:17px}
      .navBtn{font-size:19px}
      .infoText{font-size:18.5px}
      .labelText{font-size:16px}
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="leftControls">
        <button class="btn" id="btnBack">← 뒤로</button>
        <div class="chip active" id="chipKo">한국어</div>
        <div class="chip" id="chipMn">Монгол</div>
      </div>
      <div class="rightInfo">
        <div><span class="strong" id="whoName">-</span> · <span class="strong" id="whoClass">-</span></div>
        <div id="langHint">lang=ko</div>
      </div>
    </div>

    <div class="header">
      <h1>TOPIK II</h1>
      <p class="sub">단어 카드 · 다음 버튼으로 넘기기</p>
    </div>

    <div class="container">
      <div class="panel">
        <div class="metaRow">
          <div class="titleBox">
            <div class="lessonTitle" id="lessonTitle">로드 중…</div>
            <div class="mini" id="fileHint">file: -</div>
            <div class="loading" id="loadingMsg">데이터를 불러오는 중입니다.</div>
          </div>
          <div class="counter">
            <span class="badge" id="countBadge">0 / 0</span>
          </div>
        </div>

        <div class="funcChips" id="funcChips" style="display:none;"></div>

        <div class="wordLine">
          <div class="wordKo" id="wordKo">…</div>
          <div class="wordMn" id="wordMn">…</div>
        </div>

        <div class="synAntGrid">
          <div class="infoBox">
            <div class="infoLabel">
              <div class="labelText">유의어</div>
            </div>
            <div class="infoText" id="synText">—</div>
          </div>
          <div class="infoBox">
            <div class="infoLabel">
              <div class="labelText">반의어</div>
            </div>
            <div class="infoText" id="antText">—</div>
          </div>
        </div>

        <div class="examplesGrid">
          <div class="exBox">
            <div class="exLabel">예문</div>
            <div class="exText" id="exKo">—</div>
          </div>
          <div class="exBox mn">
            <div class="exLabel">Жишээ</div>
            <div class="exText" id="exMn">—</div>
          </div>
        </div>

        <div class="navRow">
          <button class="navBtn" id="btnPrev">이전</button>
          <button class="navBtn primary" id="btnNext">다음</button>
        </div>

        <div class="error" id="errorBox" style="display:none;"></div>
      </div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const name = qs.get("name") || "";
    const klass = qs.get("klass") || "";
    const token = qs.get("token") || "";
    const fileParam = qs.get("file") || "";

    const $ = (id) => document.getElementById(id);

    $("whoName").textContent = name || "-";
    $("whoClass").textContent = klass || "-";

    // repo base (/korean-quiz) 자동 추정: 요구사항(REPO_BASE) 반영
    function getRepoBase(){
      const p = location.pathname || "/";
      const m = p.match(/^(.*?\/korean-quiz)(\/|$)/);
      return m ? m[1] : "";
    }
    const REPO_BASE = getRepoBase();

    // lang toggle (표시용)
    let lang = (qs.get("lang") || "ko").toLowerCase() === "mn" ? "mn" : "ko";
    function setLang(next){
      lang = next;
      $("langHint").textContent = "lang=" + lang;
      $("chipKo").classList.toggle("active", lang === "ko");
      $("chipMn").classList.toggle("active", lang === "mn");
    }
    $("chipKo").addEventListener("click", () => setLang("ko"));
    $("chipMn").addEventListener("click", () => setLang("mn"));
    setLang(lang);

    // 뒤로가기: history 우선, 안되면 level.html로(파라미터 유지)
    $("btnBack").addEventListener("click", () => {
      try{
        if (history.length > 1) {
          history.back();
          // iOS/Safari에서 back이 막히는 경우 대비: 350ms 후에도 페이지가 그대로면 fallback
          const current = location.href;
          setTimeout(() => {
            if (location.href === current) fallbackToLevel();
          }, 350);
        } else {
          fallbackToLevel();
        }
      }catch(e){
        fallbackToLevel();
      }
    });

    function fallbackToLevel(){
      const levelUrl = new URL(location.origin + (REPO_BASE || "") + "/topik2/level.html");
      ["name","klass","token","cat","level","lang"].forEach(k=>{
        const v = qs.get(k);
        if (v) levelUrl.searchParams.set(k, v);
      });
      location.href = levelUrl.toString();
    }

    // Normalize file URL robustly (absolute / relative / // / repo-base)
    function normalizeFileUrl(input){
      if(!input) return "";
      let raw = input.trim();
      try { raw = decodeURIComponent(raw); } catch(e) {}
      if(/^https?:\/\//i.test(raw)) return raw;
      if(/^\/\//.test(raw)) return location.protocol + raw;
      if(raw.startsWith("/")) return location.origin + raw;

      // 상대경로인 경우: REPO_BASE 기준으로도 해석 가능하게
      // 1) 현재 폴더 기준
      const base = new URL(location.href);
      base.pathname = base.pathname.replace(/\/[^\/]*$/, "/");
      const u1 = new URL(raw, base.toString()).toString();

      // 2) 혹시 data/... 같은 repo-root 상대라면 REPO_BASE 붙인 버전도 시도 가능
      // (fetch는 한 번만 하므로, 여기서는 "가능성 높은" 쪽으로 정규화)
      if (raw.startsWith("data/") && REPO_BASE){
        return location.origin + REPO_BASE + "/" + raw;
      }
      return u1;
    }

    function showError(msg){
      $("errorBox").style.display = "block";
      $("errorBox").textContent = msg;
      $("loadingMsg").textContent = "로드 실패";
    }

    let deck = null;
    let items = [];
    let idx = 0;

    function parseFuncChip(text){
      if(!text) return { func: "", head: text || "" };
      const parts = String(text).split("·").map(s => s.trim()).filter(Boolean);
      if(parts.length >= 2){
        return { func: parts[0], head: parts.slice(1).join(" · ") };
      }
      return { func: "", head: String(text) };
    }

    function setFuncChips(func){
      const box = $("funcChips");
      box.innerHTML = "";
      if(!func){
        box.style.display = "none";
        return;
      }
      const chip = document.createElement("div");
      chip.className = "funcChip";
      chip.textContent = func;
      box.appendChild(chip);
      box.style.display = "flex";
    }

    // script detect
    const reHangul = /[가-힣]/;
    const reCyr = /[\u0400-\u04FF]/;

    function isMostlyHangul(s){
      s = String(s||"");
      const h = (s.match(/[가-힣]/g)||[]).length;
      const c = (s.match(/[\u0400-\u04FF]/g)||[]).length;
      return h > c && h >= 1;
    }
    function isMostlyCyrillic(s){
      s = String(s||"");
      const h = (s.match(/[가-힣]/g)||[]).length;
      const c = (s.match(/[\u0400-\u04FF]/g)||[]).length;
      return c > h && c >= 1;
    }

    function cleanLabelPrefix(s){
      if(!s) return "";
      return String(s)
        .replace(/^유의어\s*:\s*/,"")
        .replace(/^반의어\s*:\s*/,"")
        .trim();
    }

    function fallbackSynAntFromEx(exKo){
      if(!exKo) return {syn:"", ant:"", ex:""};
      const lines = String(exKo).split("\n");
      if(lines.length >= 2 && (lines[0].includes("유의어") || lines[0].includes("반의어"))){
        const first = lines[0];
        let syn = "";
        let ant = "";
        const synMatch = first.match(/유의어\s*:\s*([^|]+)(\||$)/);
        const antMatch = first.match(/반의어\s*:\s*(.+)$/);
        if(synMatch) syn = synMatch[1].trim();
        if(antMatch) ant = antMatch[1].trim();
        return { syn, ant, ex: lines.slice(1).join("\n").trim() };
      }
      return {syn:"", ant:"", ex: String(exKo).trim()};
    }

    // 예문에 한 칸에 한/몽이 섞여 들어오는 데이터(기존 레벨 데이터) 자동 분리
    function splitBilingualExample(exKoRaw, exMnRaw){
      let ko = (exKoRaw || "").trim();
      let mn = (exMnRaw || "").trim();

      // 이미 ex_mn이 있으면 그대로
      if (mn) return {ko, mn};

      if (!ko) return {ko:"", mn:""};

      const lines = ko.split("\n").map(s=>s.trim()).filter(Boolean);
      const koLines = [];
      const mnLines = [];

      for (const line of lines){
        const hasH = reHangul.test(line);
        const hasC = reCyr.test(line);

        if (hasH && !hasC) koLines.push(line);
        else if (hasC && !hasH) mnLines.push(line);
        else {
          // 섞임: 문장 내에 한/몽이 같이 있으면, 간단히 공백 기준으로 반으로 쪼개기보다
          // "한글이 더 많으면 ko, 키릴이 더 많으면 mn"으로 배치
          if (isMostlyHangul(line)) koLines.push(line);
          else if (isMostlyCyrillic(line)) mnLines.push(line);
          else koLines.push(line); // 애매하면 ko로
        }
      }

      return {
        ko: koLines.join("\n").trim(),
        mn: mnLines.join("\n").trim()
      };
    }

    function render(){
      if(!items.length){
        $("lessonTitle").textContent = deck?.title_kr || deck?.title || "데이터 없음";
        $("countBadge").textContent = "0 / 0";
        $("wordKo").textContent = "…";
        $("wordMn").textContent = "…";
        $("synText").textContent = "—";
        $("antText").textContent = "—";
        $("exKo").textContent = "—";
        $("exMn").textContent = "—";
        return;
      }

      const it = items[idx];

      $("lessonTitle").textContent = deck?.title_kr || deck?.title || "TOPIK II";
      $("loadingMsg").textContent = "";
      $("countBadge").textContent = (idx + 1) + " / " + items.length;

      // (핵심) 데이터가 ko/mn이 뒤집혀 들어오는 경우 자동 교정:
      // ko에 키릴(몽골어) + mn에 한글(한국어) => 표시만 swap
      const rawKo = String(it.ko || "");
      const rawMn = String(it.mn || "");
      const shouldSwap = isMostlyCyrillic(rawKo) && isMostlyHangul(rawMn);

      const dispKo = shouldSwap ? rawMn : rawKo;
      const dispMn = shouldSwap ? rawKo : rawMn;

      const koParsed = parseFuncChip(dispKo);
      const mnParsed = parseFuncChip(dispMn);

      $("wordKo").textContent = koParsed.head || "—";
      $("wordMn").textContent = mnParsed.head || "—";

      setFuncChips(koParsed.func || mnParsed.func || "");

      // 유의어/반의어: 중요어휘1(level08)은 syn_ko/ant_ko가 존재해야 함
      // 다른 레벨(예: 인물 태도 어휘)은 원래 없을 수 있으므로 '—' 표시가 정상임
      const fb = fallbackSynAntFromEx(it.ex_ko || "");
      const synRaw = it.syn_ko ? cleanLabelPrefix(it.syn_ko) : (fb.syn || "");
      const antRaw = it.ant_ko ? cleanLabelPrefix(it.ant_ko) : (fb.ant || "");

      $("synText").textContent = synRaw ? synRaw : "—";
      $("antText").textContent = antRaw ? antRaw : "—";

      // 예문: ex_ko에 한/몽이 섞여 들어오면 자동 분리해서 오른쪽(몽골어)로 이동
      const exKoBase = it.ex_ko ? fb.ex : "";
      const exMnBase = it.ex_mn || "";

      // swap 상태면 예문도 같이 swap (데이터가 뒤집힌 경우)
      const exPair = shouldSwap
        ? splitBilingualExample(exMnBase, exKoBase)
        : splitBilingualExample(exKoBase, exMnBase);

      $("exKo").textContent = exPair.ko ? exPair.ko : "—";
      $("exMn").textContent = exPair.mn ? exPair.mn : "—";
    }

    $("btnPrev").addEventListener("click", () => {
      if(!items.length) return;
      idx = (idx - 1 + items.length) % items.length;
      render();
    });
    $("btnNext").addEventListener("click", () => {
      if(!items.length) return;
      idx = (idx + 1) % items.length;
      render();
    });

    window.addEventListener("keydown", (e) => {
      if(e.key === "ArrowLeft") $("btnPrev").click();
      if(e.key === "ArrowRight") $("btnNext").click();
    });

    (async function init(){
      const url = normalizeFileUrl(fileParam);
      $("fileHint").textContent = "file: " + (url ? url : "-");

      if(!url){
        showError("file 파라미터가 없습니다.\n예: flashcards.html?file=https%3A%2F%2F...json&name=...&klass=...&token=...");
        return;
      }
      try{
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        if(!data || typeof data !== "object" || !Array.isArray(data.items)){
          throw new Error("JSON 형식이 다릅니다.\n{ title/title_kr/title_mn, items:[{ko,mn,ex_ko,ex_mn}] } 형태여야 합니다.");
        }
        deck = data;
        items = data.items.filter(x => x && (x.ko || x.mn || x.ex_ko || x.ex_mn));
        idx = 0;
        render();
      }catch(err){
        showError("로드 실패: " + (err?.message || String(err)));
      }
    })();
  </script>
</body>
</html>
