<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Flashcards</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e7ecff;
      --muted:#aab6e6;
      --line:rgba(255,255,255,.10);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:22px;

      --blueA: rgba(59,130,246,.16);
      --blueB: rgba(59,130,246,.36);

      --greenA: rgba(34,197,94,.14);
      --greenB: rgba(34,197,94,.32);

      --amberA: rgba(245,158,11,.14);
      --amberB: rgba(245,158,11,.34);

      --koA: rgba(59,130,246,.14);
      --koB: rgba(59,130,246,.34);

      --mnA: rgba(34,197,94,.14);
      --mnB: rgba(34,197,94,.34);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, sans-serif;
      background: radial-gradient(1000px 800px at 30% -10%, rgba(59,130,246,.35), transparent 55%),
                  radial-gradient(900px 700px at 90% 0%, rgba(34,197,94,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
      min-height:100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px 14px 22px;
    }
    .wrap{width:min(720px, 100%);}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topBar{
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.16);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .leftTop{display:flex; gap:10px; align-items:center; min-width:0;}
    .btnSmall{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(231,236,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .langToggle{display:flex; gap:8px; align-items:center;}
    .langBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(231,236,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      min-width:84px;
      text-align:center;
    }
    .langBtn.active{
      background: linear-gradient(180deg, rgba(79,140,255,.95), rgba(37,99,235,.95));
      border-color: rgba(79,140,255,.9);
      color:#fff;
      box-shadow: 0 8px 18px rgba(37,99,235,.25);
    }
    .rightTop{
      display:flex; flex-direction:column; align-items:flex-end; gap:2px;
      color: rgba(231,236,255,.65);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}

    .hdr{padding: 14px 16px 6px; text-align:center;}
    .title{margin:0; font-size:20px; font-weight:1000; letter-spacing:.2px;}
    .subtitle{margin:6px 0 0; color: var(--muted); font-size:13px; font-weight:800; line-height:1.35;}

    .content{padding: 12px 14px 16px;}
    .deckInfo{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
    }
    .deckLeft{min-width:0; width:100%;}
    .deckName{
      font-size:14px;
      font-weight:1000;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .deckMeta{
      margin-top:6px;
      font-size:12px;
      color: rgba(231,236,255,.65);
      font-weight:900;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:1000;
      color: rgba(231,236,255,.85);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      padding: 6px 10px;
      border-radius: 999px;
      min-height:32px;
      text-align:center;
      line-height:1.2;
      white-space:nowrap;
    }

    /* ✅ 기능(한국어/몽골어) 한 줄에 같이 보이게: 줄바꿈 금지 + 가로 스크롤 허용 */
    .funcTop{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      align-items:center;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
      padding-bottom: 2px;
    }
    .funcTop::-webkit-scrollbar{height:6px}
    .funcTop::-webkit-scrollbar-thumb{background:rgba(255,255,255,.14);border-radius:999px}

    .pillFunc{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:1000;
      color: rgba(231,236,255,.95);
      padding: 6px 10px;
      border-radius: 999px;
      min-height:32px;
      text-align:center;
      line-height:1.2;
      white-space:nowrap;
      flex: 0 0 auto;
    }
    .pillFuncKo{
      background: var(--koA);
      border: 1px solid var(--koB);
    }
    .pillFuncMn{
      background: var(--mnA);
      border: 1px solid var(--mnB);
    }

    .cardBox{
      margin-top: 12px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(10,15,25,.38);
      padding: 14px 14px 16px;
    }
    .koWord{
      text-align:center;
      font-size:34px;
      font-weight:1000;
      line-height:1.15;
      margin: 6px 0 6px;
      word-break:keep-all;
    }
    .mnWord{
      text-align:center;
      font-size:26px;
      font-weight:1000;
      color: rgba(231,236,255,.92);
      margin: 0 0 10px;
      word-break:break-word;
    }

    .exBox{
      margin-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.14);
      padding-top: 10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .exItem{
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    .exKoBox{
      background: linear-gradient(180deg, var(--blueA), rgba(0,0,0,.10));
      border-color: var(--blueB);
    }
    .exMnBox{
      background: linear-gradient(180deg, var(--greenA), rgba(0,0,0,.10));
      border-color: var(--greenB);
    }

    .exLabel{
      font-size:12px;
      font-weight:1000;
      color: rgba(231,236,255,.70);
      margin-bottom:6px;
    }
    .exText{
      font-size:18px;
      font-weight:900;
      line-height:1.35;
      word-break:keep-all;
      white-space:pre-wrap;
    }

    .actions{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .btn{
      width:100%;
      border:0;
      border-radius: 18px;
      padding: 15px 14px;
      font-size:20px;
      font-weight:1000;
      color:white;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.30);
      transition: transform .06s ease, filter .15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: translateY(1px) scale(.99)}
    .btnPrimary{background: linear-gradient(180deg, #4f8cff, #2563eb);}
    .btnGhost{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:none;
      color: var(--text);
      font-size:18px;
      padding: 14px 12px;
      border-radius: 18px;
      font-weight:1000;
    }

    .err{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(239,68,68,.14);
      border:1px solid rgba(239,68,68,.35);
      color: #ffd3d3;
      font-size:14px;
      font-weight:1000;
      text-align:center;
      display:none;
      white-space:pre-wrap;
      line-height:1.4;
    }

    @media (min-width: 720px){
      .exBox{grid-template-columns: 1fr 1fr;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="app"></div>
  </div>

<script>
(() => {
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz6WBgnJXTAperJK2NwX-VwkmPEQrU4SluCcXjbmYYgcywYM2AcHZwkymBse6E9Kaqg/exec";

  function getRepoBase(){
    const p = location.pathname.split("/").filter(Boolean);
    return p.length ? ("/" + p[0]) : "";
  }
  const REPO_BASE = getRepoBase();
  const TOPIK2_HOME = REPO_BASE + "/topik2/index.html";

  const $app = document.getElementById("app");
  const DEV_KEY = "kq_deviceId_v1";
  const LANG_KEY = "kq_lang_v1";

  const qs = (k) => new URLSearchParams(location.search).get(k);
  const safe = (s) => (s || "").toString();
  const esc = (str) => safe(str).replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
  const nowISO = () => new Date().toISOString();

  function getDeviceId(){
    let id = localStorage.getItem(DEV_KEY);
    if (!id){
      id = "dev_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
      localStorage.setItem(DEV_KEY, id);
    }
    return id;
  }

  function getLang(){
    const urlLang = qs("lang");
    if (urlLang === "ko" || urlLang === "mn") return urlLang;
    const v = localStorage.getItem(LANG_KEY);
    return (v === "mn" || v === "ko") ? v : "ko";
  }
  function setLang(v){
    localStorage.setItem(LANG_KEY, (v === "mn") ? "mn" : "ko");
    document.documentElement.lang = getLang();
  }

  function buildUrl(base, params){
    const u = new URL(base, location.origin);
    Object.keys(params).forEach(k => {
      if (params[k] === undefined || params[k] === null) return;
      u.searchParams.set(k, String(params[k]));
    });
    return u.toString();
  }

  function jsonp(url, params, timeoutMs = 8000){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const timer = setTimeout(() => { cleanup(); reject(new Error("JSONP timeout")); }, timeoutMs);

      function cleanup(){
        clearTimeout(timer);
        try{ delete window[cb]; }catch(e){}
        if (script && script.parentNode) script.parentNode.removeChild(script);
      }

      window[cb] = (data) => { cleanup(); resolve(data); };

      const p = new URLSearchParams();
      Object.keys(params).forEach(k => {
        if (params[k] === undefined || params[k] === null) return;
        p.set(k, String(params[k]));
      });
      p.set("callback", cb);

      const full = url + (url.includes("?") ? "&" : "?") + p.toString();
      const script = document.createElement("script");
      script.src = full;
      script.async = true;
      script.onerror = () => { cleanup(); reject(new Error("JSONP network error")); };
      document.head.appendChild(script);
    });
  }

  async function logEvent(action, extra){
    try{
      const payload = {
        action: "log",
        book: "TOPIK2",
        lesson: "flashcards",
        score: 0,
        attempts: 0,
        name: qs("name") || "",
        klass: qs("klass") || "",
        token: qs("token") || "",
        deviceId: getDeviceId(),
        ua: navigator.userAgent || "",
        lang: getLang(),
        ...extra,
        event: action,
        ts: nowISO()
      };
      await jsonp(SCRIPT_URL, payload, 8000);
    }catch(e){}
  }

  const reHangul = /[ㄱ-ㅎㅏ-ㅣ가-힣]/;
  const reCyril  = /[\u0400-\u04FF]/;
  function hasHangul(s){ return reHangul.test(s || ""); }
  function hasCyril(s){ return reCyril.test(s || ""); }

  function fixPair(ko, mn){
    const koIsMn = hasCyril(ko) && !hasHangul(ko);
    const mnIsKo = hasHangul(mn) && !hasCyril(mn);
    if (koIsMn && mnIsKo) return { ko: mn, mn: ko };
    return { ko, mn };
  }

  function splitExample(exKo, exMn){
    const a = safe(exKo).trim();
    const b = safe(exMn).trim();

    if (a && !b && hasHangul(a) && hasCyril(a)){
      const idx = a.search(reCyril);
      if (idx > 0){
        const left = a.slice(0, idx).trim();
        const right = a.slice(idx).trim();
        return { ex_ko: left, ex_mn: right };
      }
    }

    if (a && b){
      const aIsMn = hasCyril(a) && !hasHangul(a);
      const bIsKo = hasHangul(b) && !hasCyril(b);
      if (aIsMn && bIsKo) return { ex_ko: b, ex_mn: a };
    }

    return { ex_ko: a, ex_mn: b };
  }

  function splitFuncAndWord(text){
    const t = safe(text).trim();
    const seps = [" · ", "|", " - ", " — ", " —", "—", "•"];
    for (const sep of seps){
      const idx = t.indexOf(sep);
      if (idx > 0){
        const func = t.slice(0, idx).trim();
        const word = t.slice(idx + sep.length).trim();
        if (func && word) return { func, word };
      }
    }
    return { func: "", word: t };
  }

  // ✅ file 파라미터를 "항상 절대 URL"로 정규화 (404 방지)
  function normalizeFileParam(){
    const raw = qs("file") || "";
    if (!raw) return "";

    let v = raw;
    try { v = decodeURIComponent(raw); } catch(_) {}

    // file이 이미 https://... 이면 그대로 사용
    if (/^https?:\/\//i.test(v)) return v;

    // "/korean-quiz/..." 또는 "/data/..." 처럼 "/"로 시작하는 경우: origin 붙이기
    if (v.startsWith("/")) return new URL(v, location.origin).toString();

    // "data/..." 같은 상대경로: "/" 붙여서 origin 기준으로 절대화
    return new URL("/" + v, location.origin).toString();
  }

  const state = {
    file: normalizeFileParam(),   // ✅ 여기서 이미 절대 URL이 됨
    data: null,
    idx: 0,
    startedAt: Date.now()
  };

  function showError(msg){
    const $err = document.getElementById("err");
    if (!$err) return;
    $err.textContent = msg;
    $err.style.display = "block";
  }

  function renderShell(title, sub){
    const lang = getLang();
    const name = qs("name") || "";
    const klass = qs("klass") || "";
    $app.innerHTML = `
      <div class="topBar">
        <div class="leftTop">
          <button class="btnSmall" id="btnBack">← 뒤로</button>
          <div class="langToggle">
            <button class="langBtn ${lang==="ko"?"active":""}" id="langKo">한국어</button>
            <button class="langBtn ${lang==="mn"?"active":""}" id="langMn">Монгол</button>
          </div>
        </div>
        <div class="rightTop">
          <div class="mono">${esc(name)} · ${esc(klass)}</div>
          <div class="mono">lang=${esc(lang)}</div>
        </div>
      </div>

      <div class="hdr">
        <h1 class="title">${esc(title || "Flashcards")}</h1>
        <p class="subtitle">${esc(sub || "다음 버튼을 눌러 단어를 넘기세요")}</p>
      </div>

      <div class="content">
        <div class="deckInfo">
          <div class="deckLeft">
            <div class="deckName" id="deckName">로드 중…</div>
            <div class="deckMeta">
              <span class="pill" id="posInfo">0 / 0</span>
              <span class="funcTop" id="funcTop" style="display:none;">
                <span class="pillFunc pillFuncKo" id="funcKo"></span>
                <span class="pillFunc pillFuncMn" id="funcMn"></span>
              </span>
            </div>
          </div>
        </div>

        <div class="cardBox">
          <div class="koWord" id="koWord">…</div>
          <div class="mnWord" id="mnWord"></div>

          <div class="exBox">
            <div class="exItem exKoBox">
              <div class="exLabel">예문 (한국어)</div>
              <div class="exText" id="exKo"></div>
            </div>
            <div class="exItem exMnBox">
              <div class="exLabel">Жишээ (Монгол)</div>
              <div class="exText" id="exMn"></div>
            </div>
          </div>

          <div class="actions">
            <button class="btn btnGhost" id="btnPrev">이전</button>
            <button class="btn btnPrimary" id="btnNext">다음</button>
          </div>

          <div class="err" id="err"></div>
        </div>
      </div>
    `;

    document.getElementById("btnBack").addEventListener("click", async () => {
      await logEvent("back", { idx: state.idx, file: state.file });
      location.href = buildUrl(TOPIK2_HOME, {
        name: qs("name") || "",
        klass: qs("klass") || "",
        token: qs("token") || "",
        lang: getLang()
      });
    });

    document.getElementById("langKo").addEventListener("click", () => { setLang("ko"); render(true); });
    document.getElementById("langMn").addEventListener("click", () => { setLang("mn"); render(true); });
  }

  function renderCard(){
    const items = (state.data && Array.isArray(state.data.items)) ? state.data.items : [];
    const total = items.length;

    const $deckName = document.getElementById("deckName");
    const $posInfo = document.getElementById("posInfo");
    const $koWord = document.getElementById("koWord");
    const $mnWord = document.getElementById("mnWord");
    const $exKo = document.getElementById("exKo");
    const $exMn = document.getElementById("exMn");

    const $funcTop = document.getElementById("funcTop");
    const $funcKo = document.getElementById("funcKo");
    const $funcMn = document.getElementById("funcMn");

    $posInfo.textContent = `${total ? (state.idx + 1) : 0} / ${total}`;

    const deckTitle = (getLang() === "mn")
      ? (state.data && state.data.title_mn) || (state.data && state.data.title_kr) || (state.data && state.data.title) || "Flashcards"
      : (state.data && state.data.title_kr) || (state.data && state.data.title) || "Flashcards";
    $deckName.textContent = deckTitle;

    if (!total){
      $koWord.textContent = "데이터가 없습니다";
      $mnWord.textContent = "";
      $exKo.textContent = "";
      $exMn.textContent = "";
      $funcTop.style.display = "none";
      showError("items 배열이 비어 있습니다.\nJSON에 items가 들어있는지 확인하세요.");
      return;
    }

    const it = items[state.idx] || {};

    const fixed = fixPair(safe(it.ko).trim(), safe(it.mn).trim());
    const koSplit = splitFuncAndWord(fixed.ko);
    const mnSplit = splitFuncAndWord(fixed.mn);
    const exFixed = splitExample(it.ex_ko, it.ex_mn);

    const funcKoVal = koSplit.func;
    const funcMnVal = mnSplit.func;

    if (funcKoVal || funcMnVal){
      $funcTop.style.display = "flex";
      $funcKo.textContent = funcKoVal ? ("기능 · " + funcKoVal) : "기능";
      $funcMn.textContent = funcMnVal ? ("Үүрэг · " + funcMnVal) : "Үүрэг";
    } else {
      $funcTop.style.display = "none";
    }

    $koWord.textContent = koSplit.word || "(빈 단어)";
    $mnWord.textContent = mnSplit.word || "";

    $exKo.textContent = exFixed.ex_ko || "";
    $exMn.textContent = exFixed.ex_mn || "";

    document.getElementById("btnPrev").disabled = (state.idx <= 0);
    document.getElementById("btnPrev").style.opacity = (state.idx <= 0) ? 0.55 : 1;
  }

  function bindNav(){
    document.getElementById("btnNext").addEventListener("click", async () => {
      const items = state.data.items || [];
      if (!items.length) return;
      state.idx = (state.idx + 1) % items.length;
      renderCard();
      await logEvent("next", { idx: state.idx, file: state.file });
    });

    document.getElementById("btnPrev").addEventListener("click", async () => {
      const items = state.data.items || [];
      if (!items.length) return;
      state.idx = Math.max(0, state.idx - 1);
      renderCard();
      await logEvent("prev", { idx: state.idx, file: state.file });
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === " " || e.key === "Enter") {
        e.preventDefault();
        const $n = document.getElementById("btnNext");
        if ($n) $n.click();
      }
    });
  }

  async function loadData(){
    if (!state.file){
      throw new Error("URL에 file 파라미터가 없습니다.\n예: ?file=/data/topik2/vocab/level01_attitude.json");
    }
    const res = await fetch(state.file, { cache: "no-store" });
    if (!res.ok) throw new Error("데이터 로드 실패: " + res.status + " " + res.statusText + "\n" + state.file);
    const json = await res.json();
    if (!json || !Array.isArray(json.items)) {
      throw new Error("JSON 형식이 다릅니다.\n{ title/title_kr/title_mn, items:[{ko,mn,ex_ko,ex_mn}] } 형태여야 합니다.");
    }
    state.data = json;
  }

  async function render(keepIndex){
    document.documentElement.lang = getLang();
    renderShell("TOPIK II", "단어 카드 · 다음 버튼으로 넘기기");

    try{
      if (!state.data) {
        await loadData();
        await logEvent("start", { file: state.file });
      }
      if (!keepIndex) state.idx = 0;
      renderCard();
      bindNav();
    }catch(e){
      showError(String(e && e.message ? e.message : e));
    }
  }

  window.addEventListener("beforeunload", () => {
    const elapsedSec = Math.max(0, Math.round((Date.now() - state.startedAt) / 1000));
    try{
      jsonp(SCRIPT_URL, {
        action: "log",
        event: "end",
        book: "TOPIK2",
        lesson: "flashcards",
        name: qs("name") || "",
        klass: qs("klass") || "",
        token: qs("token") || "",
        deviceId: getDeviceId(),
        ua: navigator.userAgent || "",
        lang: getLang(),
        file: state.file,
        idx: state.idx,
        elapsedSec,
        ts: nowISO()
      }, 1500);
    }catch(e){}
  });

  render(false);
})();
</script>
</body>
</html>
