<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Flashcards</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e7ecff;
      --muted:#aab6e6;
      --line:rgba(255,255,255,.10);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:22px;

      --blueA: rgba(59,130,246,.16);
      --blueB: rgba(59,130,246,.36);

      --greenA: rgba(34,197,94,.14);
      --greenB: rgba(34,197,94,.32);

      --amberA: rgba(245,158,11,.14);
      --amberB: rgba(245,158,11,.34);

      --koA: rgba(59,130,246,.14);
      --koB: rgba(59,130,246,.34);

      --mnA: rgba(34,197,94,.14);
      --mnB: rgba(34,197,94,.34);

      --descA: rgba(255,255,255,.06);
      --descB: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, sans-serif;
      background: radial-gradient(1000px 800px at 30% -10%, rgba(59,130,246,.35), transparent 55%),
                  radial-gradient(900px 700px at 90% 0%, rgba(34,197,94,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
      min-height:100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px 14px 22px;
    }
    .wrap{width:min(720px, 100%);}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topBar{
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.16);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .leftTop{display:flex; gap:10px; align-items:center; min-width:0; flex-wrap:wrap;}
    .btnSmall{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(231,236,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .langToggle{display:flex; gap:8px; align-items:center;}
    .langBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(231,236,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      min-width:84px;
      text-align:center;
    }
    .langBtn.active{
      background: linear-gradient(180deg, rgba(79,140,255,.95), rgba(37,99,235,.95));
      border-color: rgba(79,140,255,.9);
      color:#fff;
      box-shadow: 0 8px 18px rgba(37,99,235,.25);
    }
    .rightTop{
      display:flex; flex-direction:column; align-items:flex-end; gap:2px;
      color: rgba(231,236,255,.65);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}

    .hdr{padding: 14px 16px 6px; text-align:center;}
    .title{margin:0; font-size:20px; font-weight:1000; letter-spacing:.2px;}
    .subtitle{margin:6px 0 0; color: var(--muted); font-size:13px; font-weight:800; line-height:1.35;}

    .content{padding: 12px 14px 16px;}
    .deckInfo{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
    }
    .deckLeft{min-width:0; width:100%;}
    .deckName{
      font-size:14px;
      font-weight:1000;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .deckMeta{
      margin-top:6px;
      font-size:12px;
      color: rgba(231,236,255,.65);
      font-weight:900;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:1000;
      color: rgba(231,236,255,.85);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      padding: 6px 10px;
      border-radius: 999px;
      min-height:32px;
      text-align:center;
      line-height:1.2;
      white-space:nowrap;
    }

    /* âœ… ê¸°ëŠ¥(í•œêµ­ì–´/ëª½ê³¨ì–´) í•œ ì¤„ ê³ ì • + ê°€ë¡œ ìŠ¤í¬ë¡¤ */
    .funcTop{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      align-items:center;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
      padding-bottom: 2px;
    }
    .funcTop::-webkit-scrollbar{height:6px}
    .funcTop::-webkit-scrollbar-thumb{background:rgba(255,255,255,.14);border-radius:999px}

    .pillFunc{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:1000;
      color: rgba(231,236,255,.95);
      padding: 6px 10px;
      border-radius: 999px;
      min-height:32px;
      text-align:center;
      line-height:1.2;
      white-space:nowrap;
      flex: 0 0 auto;
    }
    .pillFuncKo{
      background: var(--koA);
      border: 1px solid var(--koB);
    }
    .pillFuncMn{
      background: var(--mnA);
      border: 1px solid var(--mnB);
    }

    .cardBox{
      margin-top: 12px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(10,15,25,.38);
      padding: 14px 14px 16px;
    }

    /* âœ… 1ì¤„(ê°€ì¥ í¼): í•œêµ­ì–´ ë‹¨ì–´ + ëª½ê³¨ì–´ ë²ˆì—­ì–´ë¥¼ ê°™ì€ ì¤„ */
    .wordRow{
      display:flex;
      justify-content:center;
      align-items:baseline;
      gap: 12px;
      flex-wrap:wrap; /* ëª¨ë°”ì¼ ì¤„ë°”ê¿ˆ í—ˆìš© */
      text-align:center;
      margin: 6px 0 10px;
    }
    .koWord{
      font-size:34px;
      font-weight:1000;
      line-height:1.12;
      margin:0;
      word-break:keep-all;
    }
    .mnWordInline{
      font-size:26px;
      font-weight:1000;
      line-height:1.12;
      opacity:.95;
      margin:0;
      word-break:break-word;
    }

    /* âœ… (ê¸°ì¡´) ì„¤ëª…: ì˜ˆë¬¸ ìœ„ */
    .descBox{
      margin-top: 4px;
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, var(--descA), rgba(0,0,0,.10));
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .descItem{
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }
    .descLabel{
      font-size:11px;
      font-weight:1000;
      color: rgba(231,236,255,.62);
      margin-bottom:6px;
    }
    .descText{
      font-size:14px;
      font-weight:900;
      line-height:1.35;
      word-break:keep-all;
      white-space:pre-wrap;
      opacity:.95;
    }

    /* âœ… (ì¤‘ìš”ì–´íœ˜1 ì „ìš©) ìœ ì˜ì–´/ë°˜ì˜ì–´: ë‹¤ë¥¸ ë±ì—ëŠ” ì ˆëŒ€ ì˜í–¥ ì—†ìŒ */
    .synAntBox{
      margin-top: 4px;
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.10));
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .synAntItem{
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      min-height:64px;
    }
    .synLabel{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;            /* ë¼ë²¨ ì„ ëª…/í° ê¸€ì”¨ */
      font-weight:1000;
      color: rgba(231,236,255,.96);
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
      margin-bottom:8px;
      line-height:1.1;
      white-space:nowrap;
    }
    .synText{
      font-size:19px;            /* ë³¸ë¬¸ë„ í¬ê²Œ */
      font-weight:900;
      line-height:1.35;
      word-break:keep-all;
      white-space:pre-wrap;
      opacity:.98;
    }

    .exBox{
      margin-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.14);
      padding-top: 10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .exItem{
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    .exKoBox{
      background: linear-gradient(180deg, var(--blueA), rgba(0,0,0,.10));
      border-color: var(--blueB);
    }
    .exMnBox{
      background: linear-gradient(180deg, var(--greenA), rgba(0,0,0,.10));
      border-color: var(--greenB);
    }
    .exLabel{
      font-size:12px;
      font-weight:1000;
      color: rgba(231,236,255,.70);
      margin-bottom:6px;
    }
    .exText{
      font-size:18px;
      font-weight:900;
      line-height:1.35;
      word-break:keep-all;
      white-space:pre-wrap;
    }

    .actions{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .btn{
      width:100%;
      border:0;
      border-radius: 18px;
      padding: 15px 14px;
      font-size:20px;
      font-weight:1000;
      color:white;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.30);
      transition: transform .06s ease, filter .15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: translateY(1px) scale(.99)}
    .btnPrimary{background: linear-gradient(180deg, #4f8cff, #2563eb);}
    .btnGhost{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:none;
      color: var(--text);
      font-size:18px;
      padding: 14px 12px;
      border-radius: 18px;
      font-weight:1000;
    }

    .err{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(239,68,68,.14);
      border:1px solid rgba(239,68,68,.35);
      color: #ffd3d3;
      font-size:14px;
      font-weight:1000;
      text-align:center;
      display:none;
      white-space:pre-wrap;
      line-height:1.4;
    }

    @media (min-width: 720px){
      .exBox{grid-template-columns: 1fr 1fr;}
      .descBox{grid-template-columns: 1fr 1fr;}
      .synAntBox{grid-template-columns: 1fr 1fr;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="app"></div>
  </div>

<script>
(() => {
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz6WBgnJXTAperJK2NwX-VwkmPEQrU4SluCcXjbmYYgcywYM2AcHZwkymBse6E9Kaqg/exec";

  function getRepoBase(){
    const p = location.pathname.split("/").filter(Boolean);
    return p.length ? ("/" + p[0]) : "";
  }
  const REPO_BASE = getRepoBase();
  const TOPIK2_HOME = REPO_BASE + "/topik2/index.html";
  const TOPIK2_LEVEL = REPO_BASE + "/topik2/level.html";

  const $app = document.getElementById("app");
  const DEV_KEY = "kq_deviceId_v1";
  const LANG_KEY = "kq_lang_v1";

  const qs = (k) => new URLSearchParams(location.search).get(k);
  const safe = (s) => (s || "").toString();
  const esc = (str) => safe(str).replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
  const nowISO = () => new Date().toISOString();

  function getDeviceId(){
    let id = localStorage.getItem(DEV_KEY);
    if (!id){
      id = "dev_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
      localStorage.setItem(DEV_KEY, id);
    }
    return id;
  }

  function getLang(){
    const urlLang = qs("lang");
    if (urlLang === "ko" || urlLang === "mn") return urlLang;
    const v = localStorage.getItem(LANG_KEY);
    return (v === "mn" || v === "ko") ? v : "ko";
  }
  function setLang(v){
    localStorage.setItem(LANG_KEY, (v === "mn") ? "mn" : "ko");
    document.documentElement.lang = getLang();
  }

  function buildUrl(base, params){
    const u = new URL(base, location.origin);
    Object.keys(params).forEach(k => {
      if (params[k] === undefined || params[k] === null) return;
      u.searchParams.set(k, String(params[k]));
    });
    return u.toString();
  }

  function jsonp(url, params, timeoutMs = 8000){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const timer = setTimeout(() => { cleanup(); reject(new Error("JSONP timeout")); }, timeoutMs);

      function cleanup(){
        clearTimeout(timer);
        try{ delete window[cb]; }catch(e){}
        if (script && script.parentNode) script.parentNode.removeChild(script);
      }

      window[cb] = (data) => { cleanup(); resolve(data); };

      const p = new URLSearchParams();
      Object.keys(params).forEach(k => {
        if (params[k] === undefined || params[k] === null) return;
        p.set(k, String(params[k]));
      });
      p.set("callback", cb);

      const full = url + (url.includes("?") ? "&" : "?") + p.toString();
      const script = document.createElement("script");
      script.src = full;
      script.async = true;
      script.onerror = () => { cleanup(); reject(new Error("JSONP network error")); };
      document.head.appendChild(script);
    });
  }

  async function logEvent(action, extra){
    try{
      const payload = {
        action: "log",
        book: "TOPIK2",
        lesson: "flashcards",
        score: 0,
        attempts: 0,
        name: qs("name") || "",
        klass: qs("klass") || "",
        token: qs("token") || "",
        deviceId: getDeviceId(),
        ua: navigator.userAgent || "",
        lang: getLang(),
        ...extra,
        event: action,
        ts: nowISO()
      };
      await jsonp(SCRIPT_URL, payload, 8000);
    }catch(e){}
  }

  const reHangul = /[ã„±-ã…ã…-ã…£ê°€-í£]/;
  const reCyril  = /[\u0400-\u04FF]/;
  function hasHangul(s){ return reHangul.test(s || ""); }
  function hasCyril(s){ return reCyril.test(s || ""); }

  function fixPair(ko, mn){
    const koIsMn = hasCyril(ko) && !hasHangul(ko);
    const mnIsKo = hasHangul(mn) && !hasCyril(mn);
    if (koIsMn && mnIsKo) return { ko: mn, mn: ko };
    return { ko, mn };
  }

  function splitExample(exKo, exMn){
    const a = safe(exKo).trim();
    const b = safe(exMn).trim();

    if (a && !b && hasHangul(a) && hasCyril(a)){
      const idx = a.search(reCyril);
      if (idx > 0){
        const left = a.slice(0, idx).trim();
        const right = a.slice(idx).trim();
        return { ex_ko: left, ex_mn: right };
      }
    }

    if (a && b){
      const aIsMn = hasCyril(a) && !hasHangul(a);
      const bIsKo = hasHangul(b) && !hasCyril(b);
      if (aIsMn && bIsKo) return { ex_ko: b, ex_mn: a };
    }

    return { ex_ko: a, ex_mn: b };
  }

  function splitFuncAndWord(text){
    const t = safe(text).trim();
    const seps = [" Â· ", "|", " - ", " â€” ", " â€”", "â€”", "â€¢"];
    for (const sep of seps){
      const idx = t.indexOf(sep);
      if (idx > 0){
        const func = t.slice(0, idx).trim();
        const word = t.slice(idx + sep.length).trim();
        if (func && word) return { func, word };
      }
    }
    return { func: "", word: t };
  }

  // âœ… file íŒŒë¼ë¯¸í„°ë¥¼ "í•­ìƒ ì ˆëŒ€ URL"ë¡œ ì •ê·œí™” (404 ë°©ì§€)
  function normalizeFileParam(){
    const raw = qs("file") || "";
    if (!raw) return "";

    let v = raw;
    try { v = decodeURIComponent(raw); } catch(_) {}

    if (/^https?:\/\//i.test(v)) return v;
    if (v.startsWith("/")) return new URL(v, location.origin).toString();
    return new URL("/" + v, location.origin).toString();
  }

  // âœ… ì„¤ëª…/ì˜ˆë¬¸ ë¶„ë¦¬: ex_ko/ex_mnì— ì¤„ë°”ê¿ˆì´ ìˆìœ¼ë©´ (ì²« ì¤„=ì„¤ëª…, ë‚˜ë¨¸ì§€=ì˜ˆë¬¸)
  function splitDescAndExample(text){
    const t = safe(text).trim();
    if (!t) return { desc: "", ex: "" };
    const lines = t.split("\n").map(s => s.trim()).filter(Boolean);
    if (lines.length >= 2){
      const desc = lines[0].replace(/^â€¢\s*/, "").trim();
      const ex = lines.slice(1).join("\n").trim();
      return { desc, ex };
    }
    return { desc: "", ex: t };
  }

  // âœ… ì¤‘ìš”ì–´íœ˜1ë§Œ "ë³„ë„ êµ¬ì¡°"ë¡œ ë Œë”ë§ (ë‹¤ë¥¸ ë±ì—ëŠ” ì˜í–¥ X)
  function isKeyVocabDeck(fileUrl){
    return /level08_key_vocab1\.json(\?|$)/i.test(fileUrl || "");
  }
  function stripLabelPrefix(s){
    return safe(s).replace(/^ìœ ì˜ì–´\s*:\s*/,"").replace(/^ë°˜ì˜ì–´\s*:\s*/,"").trim();
  }

  const state = {
    file: normalizeFileParam(),
    data: null,
    idx: 0,
    startedAt: Date.now()
  };

  function showError(msg){
    const $err = document.getElementById("err");
    if (!$err) return;
    $err.textContent = msg;
    $err.style.display = "block";
  }

  function renderShell(title, sub){
    const lang = getLang();
    const name = qs("name") || "";
    const klass = qs("klass") || "";

    $app.innerHTML = `
      <div class="topBar">
        <div class="leftTop">
          <button class="btnSmall" id="btnBack">â† ë’¤ë¡œ</button>
          <button class="btnSmall" id="btnPick">ğŸ“š ë‹¤ë¥¸ ì–´íœ˜</button>
          <div class="langToggle">
            <button class="langBtn ${lang==="ko"?"active":""}" id="langKo">í•œêµ­ì–´</button>
            <button class="langBtn ${lang==="mn"?"active":""}" id="langMn">ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»</button>
          </div>
        </div>
        <div class="rightTop">
          <div class="mono">${esc(name)} Â· ${esc(klass)}</div>
          <div class="mono">lang=${esc(lang)}</div>
        </div>
      </div>

      <div class="hdr">
        <h1 class="title">${esc(title || "Flashcards")}</h1>
        <p class="subtitle">${esc(sub || "ë‹¤ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¨ì–´ë¥¼ ë„˜ê¸°ì„¸ìš”")}</p>
      </div>

      <div class="content">
        <div class="deckInfo">
          <div class="deckLeft">
            <div class="deckName" id="deckName">ë¡œë“œ ì¤‘â€¦</div>
            <div class="deckMeta">
              <span class="pill" id="posInfo">0 / 0</span>
              <span class="funcTop" id="funcTop" style="display:none;">
                <span class="pillFunc pillFuncKo" id="funcKo"></span>
                <span class="pillFunc pillFuncMn" id="funcMn"></span>
              </span>
            </div>
          </div>
        </div>

        <div class="cardBox">
          <div class="wordRow">
            <div class="koWord" id="koWord">â€¦</div>
            <div class="mnWordInline" id="mnWordInline"></div>
          </div>

          <!-- (ê¸°ì¡´) ì„¤ëª… ë°•ìŠ¤: ê¸°ë³¸ êµ¬ì¡° ìœ ì§€ -->
          <div class="descBox" id="descBox" style="display:none;">
            <div class="descItem">
              <div class="descLabel">ì„¤ëª… (í•œêµ­ì–´)</div>
              <div class="descText" id="descKo"></div>
            </div>
            <div class="descItem">
              <div class="descLabel">Ğ¢Ğ°Ğ¹Ğ»Ğ±Ğ°Ñ€ (ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»)</div>
              <div class="descText" id="descMn"></div>
            </div>
          </div>

          <!-- (ì¤‘ìš”ì–´íœ˜1 ì „ìš©) ìœ ì˜ì–´/ë°˜ì˜ì–´ -->
          <div class="synAntBox" id="synAntBox" style="display:none;">
            <div class="synAntItem">
              <div class="synLabel">ìœ ì˜ì–´</div>
              <div class="synText" id="synKo"></div>
            </div>
            <div class="synAntItem">
              <div class="synLabel">ë°˜ì˜ì–´</div>
              <div class="synText" id="antKo"></div>
            </div>
          </div>

          <div class="exBox">
            <div class="exItem exKoBox">
              <div class="exLabel">ì˜ˆë¬¸ (í•œêµ­ì–´)</div>
              <div class="exText" id="exKo"></div>
            </div>
            <div class="exItem exMnBox">
              <div class="exLabel">Ğ–Ğ¸ÑˆÑÑ (ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»)</div>
              <div class="exText" id="exMn"></div>
            </div>
          </div>

          <div class="actions">
            <button class="btn btnGhost" id="btnPrev">ì´ì „</button>
            <button class="btn btnPrimary" id="btnNext">ë‹¤ìŒ</button>
          </div>

          <div class="err" id="err"></div>
        </div>
      </div>
    `;

    // âœ… ë’¤ë¡œ: TOPIK2 í™ˆ(ì™„ì „ ë¹ ì ¸ë‚˜ê°€ê¸°)
    document.getElementById("btnBack").addEventListener("click", async () => {
      await logEvent("back", { idx: state.idx, file: state.file });
      location.href = buildUrl(TOPIK2_HOME, {
        name: qs("name") || "",
        klass: qs("klass") || "",
        token: qs("token") || "",
        lang: getLang()
      });
    });

    // âœ… ë‹¤ë¥¸ ì–´íœ˜ ì„ íƒ: level.htmlë¡œ ì´ë™(ê°€ëŠ¥í•˜ë©´ cat/level ìœ ì§€)
    document.getElementById("btnPick").addEventListener("click", async () => {
      await logEvent("pick_list", { idx: state.idx, file: state.file });
      const cat = qs("cat") || "";
      const level = qs("level") || "";
      const target = (cat && level)
        ? buildUrl(TOPIK2_LEVEL, { cat, level, name: qs("name")||"", klass: qs("klass")||"", token: qs("token")||"", lang: getLang() })
        : buildUrl(TOPIK2_HOME, { name: qs("name")||"", klass: qs("klass")||"", token: qs("token")||"", lang: getLang() });
      location.href = target;
    });

    document.getElementById("langKo").addEventListener("click", () => { setLang("ko"); render(true); });
    document.getElementById("langMn").addEventListener("click", () => { setLang("mn"); render(true); });
  }

  function renderCard(){
    const items = (state.data && Array.isArray(state.data.items)) ? state.data.items : [];
    const total = items.length;

    const $deckName = document.getElementById("deckName");
    const $posInfo = document.getElementById("posInfo");

    const $koWord = document.getElementById("koWord");
    const $mnWordInline = document.getElementById("mnWordInline");

    const $descBox = document.getElementById("descBox");
    const $descKo = document.getElementById("descKo");
    const $descMn = document.getElementById("descMn");

    const $synAntBox = document.getElementById("synAntBox");
    const $synKo = document.getElementById("synKo");
    const $antKo = document.getElementById("antKo");

    const $exKo = document.getElementById("exKo");
    const $exMn = document.getElementById("exMn");

    const $funcTop = document.getElementById("funcTop");
    const $funcKo = document.getElementById("funcKo");
    const $funcMn = document.getElementById("funcMn");

    $posInfo.textContent = `${total ? (state.idx + 1) : 0} / ${total}`;

    const deckTitle = (getLang() === "mn")
      ? (state.data && state.data.title_mn) || (state.data && state.data.title_kr) || (state.data && state.data.title) || "Flashcards"
      : (state.data && state.data.title_kr) || (state.data && state.data.title) || "Flashcards";
    $deckName.textContent = deckTitle;

    if (!total){
      $koWord.textContent = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤";
      $mnWordInline.textContent = "";
      $descBox.style.display = "none";
      $synAntBox.style.display = "none";
      $exKo.textContent = "";
      $exMn.textContent = "";
      $funcTop.style.display = "none";
      showError("items ë°°ì—´ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.\nJSONì— itemsê°€ ë“¤ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
      return;
    }

    const it = items[state.idx] || {};
    const fixed = fixPair(safe(it.ko).trim(), safe(it.mn).trim());
    const koSplit = splitFuncAndWord(fixed.ko);
    const mnSplit = splitFuncAndWord(fixed.mn);

    const exFixed = splitExample(it.ex_ko, it.ex_mn);
    const koDescEx = splitDescAndExample(exFixed.ex_ko);
    const mnDescEx = splitDescAndExample(exFixed.ex_mn);

    // ìƒë‹¨ ê¸°ëŠ¥ì¹©(ë¶„ì•¼)
    const funcKoVal = koSplit.func;
    const funcMnVal = mnSplit.func;

    if (funcKoVal || funcMnVal){
      $funcTop.style.display = "flex";
      $funcKo.textContent = funcKoVal ? ("ê¸°ëŠ¥ Â· " + funcKoVal) : "ê¸°ëŠ¥";
      $funcMn.textContent = funcMnVal ? ("Ò®Ò¯Ñ€ÑĞ³ Â· " + funcMnVal) : "Ò®Ò¯Ñ€ÑĞ³";
    } else {
      $funcTop.style.display = "none";
    }

    // 1ì¤„: ë‹¨ì–´(ko) + ë²ˆì—­ì–´(mn)
    $koWord.textContent = koSplit.word || "(ë¹ˆ ë‹¨ì–´)";
    $mnWordInline.textContent = mnSplit.word || "";

    // âœ… ì¤‘ìš”ì–´íœ˜1ë§Œ syn/ant êµ¬ì¡°ë¥¼ ì‚¬ìš© (ë‹¤ë¥¸ ë±ì€ ê¸°ì¡´ desc êµ¬ì¡° ìœ ì§€)
    const keyDeck = isKeyVocabDeck(state.file);

    if (keyDeck) {
      // ë‹¤ë¥¸ ë±ì— ì˜í–¥ ê¸ˆì§€: descBox ìˆ¨ê¸°ê³  synAntBoxë§Œ ë³´ì—¬ì¤Œ
      $descBox.style.display = "none";
      $descKo.textContent = "";
      $descMn.textContent = "";

      $synAntBox.style.display = "grid";
      const syn = stripLabelPrefix(it.syn_ko || "");
      const ant = stripLabelPrefix(it.ant_ko || "");
      $synKo.textContent = syn || "â€”";
      $antKo.textContent = ant || "â€”";
    } else {
      // ê¸°ì¡´ êµ¬ì¡° ê·¸ëŒ€ë¡œ
      $synAntBox.style.display = "none";
      $synKo.textContent = "";
      $antKo.textContent = "";

      const descKo = koDescEx.desc || "";
      const descMn = mnDescEx.desc || "";
      if (descKo || descMn){
        $descBox.style.display = "grid";
        $descKo.textContent = descKo;
        $descMn.textContent = descMn;
      } else {
        $descBox.style.display = "none";
        $descKo.textContent = "";
        $descMn.textContent = "";
      }
    }

    // ì˜ˆë¬¸ í‘œì‹œ(ì„¤ëª… ì œì™¸ ì˜ˆë¬¸ë§Œ)
    $exKo.textContent = koDescEx.ex || "";
    $exMn.textContent = mnDescEx.ex || "";

    document.getElementById("btnPrev").disabled = (state.idx <= 0);
    document.getElementById("btnPrev").style.opacity = (state.idx <= 0) ? 0.55 : 1;
  }

  function bindNav(){
    document.getElementById("btnNext").addEventListener("click", async () => {
      const items = state.data.items || [];
      if (!items.length) return;
      state.idx = (state.idx + 1) % items.length;
      renderCard();
      await logEvent("next", { idx: state.idx, file: state.file });
    });

    document.getElementById("btnPrev").addEventListener("click", async () => {
      const items = state.data.items || [];
      if (!items.length) return;
      state.idx = Math.max(0, state.idx - 1);
      renderCard();
      await logEvent("prev", { idx: state.idx, file: state.file });
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === " " || e.key === "Enter") {
        e.preventDefault();
        const $n = document.getElementById("btnNext");
        if ($n) $n.click();
      }
    });
  }

  async function loadData(){
    if (!state.file){
      throw new Error("URLì— file íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\nì˜ˆ: ?file=/data/topik2/vocab/level01_attitude.json");
    }
    const res = await fetch(state.file, { cache: "no-store" });
    if (!res.ok) throw new Error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + res.status + " " + res.statusText + "\n" + state.file);
    const json = await res.json();
    if (!json || !Array.isArray(json.items)) {
      throw new Error("JSON í˜•ì‹ì´ ë‹¤ë¦…ë‹ˆë‹¤.\n{ title/title_kr/title_mn, items:[{ko,mn,ex_ko,ex_mn}] } í˜•íƒœì—¬ì•¼ í•©ë‹ˆë‹¤.");
    }
    state.data = json;
  }

  async function render(keepIndex){
    document.documentElement.lang = getLang();
    renderShell("TOPIK II", "ë‹¨ì–´ ì¹´ë“œ Â· ë‹¤ìŒ ë²„íŠ¼ìœ¼ë¡œ ë„˜ê¸°ê¸°");

    try{
      if (!state.data) {
        await loadData();
        await logEvent("start", { file: state.file });
      }
      if (!keepIndex) state.idx = 0;
      renderCard();
      bindNav();
    }catch(e){
      showError(String(e && e.message ? e.message : e));
    }
  }

  window.addEventListener("beforeunload", () => {
    const elapsedSec = Math.max(0, Math.round((Date.now() - state.startedAt) / 1000));
    try{
      jsonp(SCRIPT_URL, {
        action: "log",
        event: "end",
        book: "TOPIK2",
        lesson: "flashcards",
        name: qs("name") || "",
        klass: qs("klass") || "",
        token: qs("token") || "",
        deviceId: getDeviceId(),
        ua: navigator.userAgent || "",
        lang: getLang(),
        file: state.file,
        idx: state.idx,
        elapsedSec,
        ts: nowISO()
      }, 1500);
    }catch(e){}
  });

  render(false);
})();
</script>
</body>
</html>
