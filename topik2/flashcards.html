<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TOPIK II Flashcards</title>
  <style>
    :root{
      --bg1:#071226;
      --bg2:#0b1b37;
      --line:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.72);
      --muted2:rgba(234,242,255,.58);
      --shadow:0 20px 60px rgba(0,0,0,.45);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(900px 520px at 70% 22%, rgba(47,107,255,.22), transparent 60%),
        radial-gradient(700px 460px at 35% 60%, rgba(58,160,255,.12), transparent 65%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px 12px 26px;
    }

    .app{
      width:min(980px, 100%);
      background:rgba(9,18,33,.45);
      border:1px solid rgba(255,255,255,.08);
      border-radius:28px;
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
    }
    .leftControls{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform:translateY(1px)}
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      padding:10px 14px;
      border-radius:999px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .chip.active{
      background:linear-gradient(180deg, rgba(47,107,255,.95), rgba(47,107,255,.72));
      border-color:rgba(47,107,255,.85);
      box-shadow:0 12px 30px rgba(47,107,255,.25);
    }
    .rightInfo{
      text-align:right;
      font-size:12px;
      line-height:1.2;
      color:var(--muted);
      padding-right:4px;
      white-space:nowrap;
    }
    .rightInfo .strong{color:var(--text); font-weight:950}

    .header{
      padding:14px 16px 10px;
      text-align:center;
    }
    .header h1{
      margin:2px 0 2px;
      font-size:20px;
      letter-spacing:.4px;
    }
    .header .sub{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }

    .container{
      padding:10px 14px 16px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .panel{
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius:var(--radius);
      padding:12px;
    }

    .metaRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding:2px 4px 10px;
      border-bottom:1px solid var(--line);
      margin-bottom:12px;
    }
    .titleBox{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-start;
      min-width:0;
    }
    .lessonTitle{
      font-weight:950;
      font-size:14px;
      color:var(--text);
      opacity:.95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 76vw;
    }
    .mini{
      font-size:11px;
      color:var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 76vw;
    }
    .counter{
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:950;
      font-size:12px;
      min-width:64px;
    }

    .wordLine{
      display:flex;
      align-items:baseline;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      text-align:center;
      padding:6px 8px 14px;
    }
    .wordKo{
      font-weight:1000;
      font-size:38px;
      letter-spacing:-.6px;
      text-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .wordMn{
      font-weight:950;
      font-size:22px;
      color:rgba(234,242,255,.88);
      letter-spacing:-.2px;
    }

    .funcChips{
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
      padding:0 6px 10px;
    }
    .funcChip{
      border:1px solid rgba(58,160,255,.35);
      background:rgba(58,160,255,.12);
      color:rgba(234,242,255,.92);
      padding:6px 10px;
      border-radius:999px;
      font-weight:950;
      font-size:12px;
      letter-spacing:.2px;
    }

    /* 중요어휘1 전용(기본은 완전 숨김) */
    .synAntGrid{ display:none; }
    .synAntGrid.show{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:8px;
      padding:2px 2px 10px;
    }
    @media (min-width: 740px){
      .synAntGrid.show{grid-template-columns:1fr 1fr;}
    }
    .infoBox{
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(13,27,45,.92), rgba(15,34,57,.70));
      border-radius:18px;
      padding:12px 12px;
      min-height:74px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .infoLabel{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
    }
    .labelText{
      font-size:16.9px;            /* 13 * 1.3 */
      font-weight:1000;
      color:rgba(234,242,255,.98);
      letter-spacing:.2px;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      box-shadow:0 12px 30px rgba(0,0,0,.22);
    }
    .infoText{
      font-size:19.5px;            /* 15 * 1.3 */
      line-height:1.35;
      font-weight:900;
      color:rgba(234,242,255,.95);
      word-break:keep-all;
      white-space:pre-wrap;
    }

    /* 예문 */
    .examplesGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      padding-top:8px;
      border-top:1px dashed rgba(255,255,255,.10);
      margin-top:10px;
    }
    @media (min-width: 740px){
      .examplesGrid{grid-template-columns:1fr 1fr;}
    }
    .exBox{
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
    }
    .exBox.mn{
      border-color:rgba(27,191,136,.22);
      background:linear-gradient(180deg, rgba(27,191,136,.14), rgba(255,255,255,.02));
    }
    .exLabel{
      font-size:12px;
      color:rgba(234,242,255,.92);
      font-weight:1000;
      letter-spacing:.2px;
      margin-bottom:6px;
    }
    .exText{
      font-size:18px;
      font-weight:900;
      line-height:1.4;
      color:rgba(234,242,255,.95);
      white-space:pre-wrap;
      word-break:keep-all;
    }

    .navRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding-top:8px;
    }
    .navBtn{
      border:none;
      border-radius:18px;
      padding:16px 14px;
      font-size:20px;
      font-weight:1000;
      cursor:pointer;
      color:rgba(234,242,255,.96);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      -webkit-tap-highlight-color: transparent;
    }
    .navBtn.primary{
      background:linear-gradient(180deg, rgba(47,107,255,.95), rgba(47,107,255,.70));
      border-color:rgba(47,107,255,.72);
    }
    .navBtn:active{transform:translateY(1px)}

    .error{
      margin-top:10px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,80,80,.28);
      background:rgba(255,80,80,.12);
      color:rgba(255,235,235,.95);
      font-weight:900;
      font-size:13px;
      white-space:pre-wrap;
    }

    .loading{
      padding:10px 0 2px;
      color:var(--muted);
      font-weight:900;
      font-size:13px;
    }

    @media (max-width: 420px){
      .wordKo{font-size:34px}
      .wordMn{font-size:19px}
      .exText{font-size:17px}
      .navBtn{font-size:19px}
      .infoText{font-size:18.5px}
      .labelText{font-size:16px}
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="leftControls">
        <button class="btn" id="btnBack">← 뒤로</button>
        <div class="chip active" id="chipKo">한국어</div>
        <div class="chip" id="chipMn">Монгол</div>
      </div>
      <div class="rightInfo">
        <div><span class="strong" id="whoName">-</span> · <span class="strong" id="whoClass">-</span></div>
        <div id="langHint">lang=ko</div>
      </div>
    </div>

    <div class="header">
      <h1>TOPIK II</h1>
      <p class="sub">단어 카드 · 다음 버튼으로 넘기기</p>
    </div>

    <div class="container">
      <div class="panel">
        <div class="metaRow">
          <div class="titleBox">
            <div class="lessonTitle" id="lessonTitle">로드 중…</div>
            <div class="mini" id="fileHint">file: -</div>
            <div class="loading" id="loadingMsg">데이터를 불러오는 중입니다.</div>
          </div>
          <div class="counter">
            <span class="badge" id="countBadge">0 / 0</span>
          </div>
        </div>

        <div class="funcChips" id="funcChips" style="display:none;"></div>

        <div class="wordLine">
          <div class="wordKo" id="wordKo">…</div>
          <div class="wordMn" id="wordMn">…</div>
        </div>

        <!-- 중요어휘1(level08_key_vocab1.json)에서만 보이도록 강제 -->
        <div class="synAntGrid" id="synAntGrid">
          <div class="infoBox">
            <div class="infoLabel"><div class="labelText">유의어</div></div>
            <div class="infoText" id="synText">—</div>
          </div>
          <div class="infoBox">
            <div class="infoLabel"><div class="labelText">반의어</div></div>
            <div class="infoText" id="antText">—</div>
          </div>
        </div>

        <div class="examplesGrid">
          <div class="exBox">
            <div class="exLabel">예문</div>
            <div class="exText" id="exKo">—</div>
          </div>
          <div class="exBox mn">
            <div class="exLabel">Жишээ</div>
            <div class="exText" id="exMn">—</div>
          </div>
        </div>

        <div class="navRow">
          <button class="navBtn" id="btnPrev">이전</button>
          <button class="navBtn primary" id="btnNext">다음</button>
        </div>

        <div class="error" id="errorBox" style="display:none;"></div>
      </div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const name = qs.get("name") || "";
    const klass = qs.get("klass") || "";
    const token = qs.get("token") || "";
    const fileParam = qs.get("file") || "";

    const $ = (id) => document.getElementById(id);

    $("whoName").textContent = name || "-";
    $("whoClass").textContent = klass || "-";

    function getRepoBase(){
      const p = location.pathname || "/";
      const m = p.match(/^(.*?\/korean-quiz)(\/|$)/);
      return m ? m[1] : "";
    }
    const REPO_BASE = getRepoBase();

    let lang = (qs.get("lang") || "ko").toLowerCase() === "mn" ? "mn" : "ko";
    function setLang(next){
      lang = next;
      $("langHint").textContent = "lang=" + lang;
      $("chipKo").classList.toggle("active", lang === "ko");
      $("chipMn").classList.toggle("active", lang === "mn");
    }
    $("chipKo").addEventListener("click", () => setLang("ko"));
    $("chipMn").addEventListener("click", () => setLang("mn"));
    setLang(lang);

    // referrer 저장
    (function rememberLevel(){
      try{
        const ref = document.referrer || "";
        if (ref.includes("/topik2/level.html")) {
          sessionStorage.setItem("topik2_lastLevelUrl", ref);
        }
      }catch(e){}
    })();

    $("btnBack").addEventListener("click", () => {
      try{
        const ref = document.referrer || "";
        const saved = sessionStorage.getItem("topik2_lastLevelUrl") || "";
        if (ref && ref.includes("/topik2/level.html")) { location.href = ref; return; }
        if (saved && saved.includes("/topik2/level.html")) { location.href = saved; return; }
        if (history.length > 1) { history.back(); return; }
        fallbackToLevel();
      }catch(e){
        fallbackToLevel();
      }
    });

    function fallbackToLevel(){
      const levelUrl = new URL(location.origin + (REPO_BASE || "") + "/topik2/level.html");
      ["name","klass","token","cat","level","lang"].forEach(k=>{
        const v = qs.get(k);
        if (v) levelUrl.searchParams.set(k, v);
      });
      location.href = levelUrl.toString();
    }

    function normalizeFileUrl(input){
      if(!input) return "";
      let raw = input.trim();
      try { raw = decodeURIComponent(raw); } catch(e) {}
      if(/^https?:\/\//i.test(raw)) return raw;
      if(/^\/\//.test(raw)) return location.protocol + raw;
      if(raw.startsWith("/")) return location.origin + raw;

      if (raw.startsWith("data/") && REPO_BASE){
        return location.origin + REPO_BASE + "/" + raw;
      }

      const base = new URL(location.href);
      base.pathname = base.pathname.replace(/\/[^\/]*$/, "/");
      return new URL(raw, base.toString()).toString();
    }

    function showError(msg){
      $("errorBox").style.display = "block";
      $("errorBox").textContent = msg;
      $("loadingMsg").textContent = "로드 실패";
    }

    let deck = null;
    let items = [];
    let idx = 0;

    function parseFuncChip(text){
      if(!text) return { func: "", head: text || "" };
      const parts = String(text).split("·").map(s => s.trim()).filter(Boolean);
      if(parts.length >= 2){
        return { func: parts[0], head: parts.slice(1).join(" · ") };
      }
      return { func: "", head: String(text) };
    }

    function setFuncChips(func){
      const box = $("funcChips");
      box.innerHTML = "";
      if(!func){
        box.style.display = "none";
        return;
      }
      const chip = document.createElement("div");
      chip.className = "funcChip";
      chip.textContent = func;
      box.appendChild(chip);
      box.style.display = "flex";
    }

    const reHangul = /[가-힣]/;
    const reCyr = /[\u0400-\u04FF]/;

    function countHangul(s){ return (String(s||"").match(/[가-힣]/g)||[]).length; }
    function countCyr(s){ return (String(s||"").match(/[\u0400-\u04FF]/g)||[]).length; }

    function isMostlyHangul(s){
      const h = countHangul(s), c = countCyr(s);
      return h > c && h >= 1;
    }
    function isMostlyCyrillic(s){
      const h = countHangul(s), c = countCyr(s);
      return c > h && c >= 1;
    }

    function cleanLabelPrefix(s){
      if(!s) return "";
      return String(s)
        .replace(/^유의어\s*:\s*/,"")
        .replace(/^반의어\s*:\s*/,"")
        .trim();
    }

    function fallbackSynAntFromEx(exKo){
      if(!exKo) return {syn:"", ant:"", ex:""};
      const lines = String(exKo).split("\n");
      if(lines.length >= 2 && (lines[0].includes("유의어") || lines[0].includes("반의어"))){
        const first = lines[0];
        let syn = "";
        let ant = "";
        const synMatch = first.match(/유의어\s*:\s*([^|]+)(\||$)/);
        const antMatch = first.match(/반의어\s*:\s*(.+)$/);
        if(synMatch) syn = synMatch[1].trim();
        if(antMatch) ant = antMatch[1].trim();
        return { syn, ant, ex: lines.slice(1).join("\n").trim() };
      }
      return {syn:"", ant:"", ex: String(exKo).trim()};
    }

    // 핵심: "중요어휘1"은 파일명으로만 판정(다른 덱에 절대 영향 X)
    function isKeyVocabDeckByFile(url){
      return /level08_key_vocab1\.json(\?|$)/i.test(url || "");
    }

    // 예문 정리: ex_ko/ex_mn이 섞이거나 한쪽에만 몰리면 자동 분리/이동
    function normalizeExamples(exKoRaw, exMnRaw){
      let ko = String(exKoRaw || "").trim();
      let mn = String(exMnRaw || "").trim();

      // 1) 둘 다 있는데 뒤집힌 경우(ko가 키릴, mn이 한글) -> swap
      if (ko && mn && isMostlyCyrillic(ko) && isMostlyHangul(mn)) {
        const tmp = ko; ko = mn; mn = tmp;
      }

      // 2) ko가 비어있고 mn에 한글+키릴이 같이 있으면 라인 기준으로 분리
      if (!ko && mn && reHangul.test(mn) && reCyr.test(mn)) {
        const lines = mn.split("\n").map(s=>s.trim()).filter(Boolean);
        const koLines = [], mnLines = [];
        for (const line of lines){
          const hasH = reHangul.test(line);
          const hasC = reCyr.test(line);
          if (hasH && !hasC) koLines.push(line);
          else if (hasC && !hasH) mnLines.push(line);
          else {
            if (isMostlyHangul(line)) koLines.push(line);
            else if (isMostlyCyrillic(line)) mnLines.push(line);
            else koLines.push(line);
          }
        }
        ko = koLines.join("\n").trim();
        mn = mnLines.join("\n").trim();
      }

      // 3) mn이 비어있고 ko에 한글+키릴이 같이 있으면 라인 기준으로 분리
      if (!mn && ko && reHangul.test(ko) && reCyr.test(ko)) {
        const lines = ko.split("\n").map(s=>s.trim()).filter(Boolean);
        const koLines = [], mnLines = [];
        for (const line of lines){
          const hasH = reHangul.test(line);
          const hasC = reCyr.test(line);
          if (hasH && !hasC) koLines.push(line);
          else if (hasC && !hasH) mnLines.push(line);
          else {
            if (isMostlyHangul(line)) koLines.push(line);
            else if (isMostlyCyrillic(line)) mnLines.push(line);
            else koLines.push(line);
          }
        }
        ko = koLines.join("\n").trim();
        mn = mnLines.join("\n").trim();
      }

      // 4) ko에 키릴만 잔뜩 들어가 있고 mn은 비어있거나 거의 없으면 -> 이동
      if (ko && !mn && isMostlyCyrillic(ko) && !reHangul.test(ko)) {
        mn = ko; ko = "";
      }

      // 5) mn에 한글만 잔뜩 들어가 있고 ko는 비어있거나 거의 없으면 -> 이동
      if (mn && !ko && isMostlyHangul(mn) && !reCyr.test(mn)) {
        ko = mn; mn = "";
      }

      return { ko, mn };
    }

    function render(currentFileUrl){
      if(!items.length){
        $("lessonTitle").textContent = deck?.title_kr || deck?.title || "데이터 없음";
        $("countBadge").textContent = "0 / 0";
        $("wordKo").textContent = "…";
        $("wordMn").textContent = "…";
        $("synText").textContent = "—";
        $("antText").textContent = "—";
        $("exKo").textContent = "—";
        $("exMn").textContent = "—";
        $("synAntGrid").classList.remove("show");
        return;
      }

      const it = items[idx];

      $("lessonTitle").textContent = deck?.title_kr || deck?.title || "TOPIK II";
      $("loadingMsg").textContent = "";
      $("countBadge").textContent = (idx + 1) + " / " + items.length;

      // 단어 ko/mn 뒤집힘 자동 교정(표시만)
      const rawKo = String(it.ko || "");
      const rawMn = String(it.mn || "");
      const shouldSwapWord = isMostlyCyrillic(rawKo) && isMostlyHangul(rawMn);

      const dispKo = shouldSwapWord ? rawMn : rawKo;
      const dispMn = shouldSwapWord ? rawKo : rawMn;

      const koParsed = parseFuncChip(dispKo);
      const mnParsed = parseFuncChip(dispMn);

      $("wordKo").textContent = koParsed.head || "—";
      $("wordMn").textContent = mnParsed.head || "—";
      setFuncChips(koParsed.func || mnParsed.func || "");

      // 중요어휘1에서만 유의어/반의어 UI 노출 + 값 세팅
      const isKey = isKeyVocabDeckByFile(currentFileUrl);
      $("synAntGrid").classList.toggle("show", !!isKey);

      if (isKey) {
        const fb = fallbackSynAntFromEx(it.ex_ko || "");
        const synRaw = it.syn_ko ? cleanLabelPrefix(it.syn_ko) : (fb.syn || "");
        const antRaw = it.ant_ko ? cleanLabelPrefix(it.ant_ko) : (fb.ant || "");
        $("synText").textContent = synRaw ? synRaw : "—";
        $("antText").textContent = antRaw ? antRaw : "—";
      } else {
        // 다른 덱은 절대 영향 주지 않도록 값도 초기화
        $("synText").textContent = "—";
        $("antText").textContent = "—";
      }

      // 예문 정리(덱 전체 공통): 섞임/역전만 교정
      const exKoRaw = String(it.ex_ko || "");
      const exMnRaw = String(it.ex_mn || "");
      const ex = normalizeExamples(exKoRaw, exMnRaw);

      $("exKo").textContent = ex.ko ? ex.ko : "—";
      $("exMn").textContent = ex.mn ? ex.mn : "—";
    }

    $("btnPrev").addEventListener("click", () => {
      if(!items.length) return;
      idx = (idx - 1 + items.length) % items.length;
      render(currentFileUrl);
    });
    $("btnNext").addEventListener("click", () => {
      if(!items.length) return;
      idx = (idx + 1) % items.length;
      render(currentFileUrl);
    });

    window.addEventListener("keydown", (e) => {
      if(e.key === "ArrowLeft") $("btnPrev").click();
      if(e.key === "ArrowRight") $("btnNext").click();
    });

    let currentFileUrl = "";

    (async function init(){
      const url = normalizeFileUrl(fileParam);
      currentFileUrl = url;
      $("fileHint").textContent = "file: " + (url ? url : "-");

      if(!url){
        showError("file 파라미터가 없습니다.\n예: flashcards.html?file=https%3A%2F%2F...json&name=...&klass=...&token=...");
        return;
      }
      try{
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        if(!data || typeof data !== "object" || !Array.isArray(data.items)){
          throw new Error("JSON 형식이 다릅니다.\n{ title/title_kr/title_mn, items:[{ko,mn,ex_ko,ex_mn}] } 형태여야 합니다.");
        }
        deck = data;
        items = data.items.filter(x => x && (x.ko || x.mn || x.ex_ko || x.ex_mn));
        idx = 0;
        render(currentFileUrl);
      }catch(err){
        showError("로드 실패: " + (err?.message || String(err)));
      }
    })();
  </script>
</body>
</html>
