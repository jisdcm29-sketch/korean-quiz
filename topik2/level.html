<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>TOPIK II - Level</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e7ecff;
      --muted:#aab6e6;
      --line:rgba(255,255,255,.10);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --btnA: rgba(255,255,255,.06);
      --btnB: rgba(255,255,255,.14);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, sans-serif;
      background:
        radial-gradient(1000px 800px at 30% -10%, rgba(59,130,246,.35), transparent 55%),
        radial-gradient(900px 700px at 90% 0%, rgba(34,197,94,.18), transparent 50%),
        var(--bg);
      color:var(--text);
      min-height:100svh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding: 18px 14px 22px;
    }
    .wrap{width:min(980px, 100%);}
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: 28px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .header{
      padding: 18px 18px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background: rgba(0,0,0,.12);
    }
    .hLeft{min-width:0}
    .title{
      margin:0;
      font-size:22px;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .sub{
      margin:8px 0 0;
      color: var(--muted);
      font-size:13px;
      font-weight:800;
      line-height:1.35;
    }
    .hRight{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
      min-width: 190px;
    }
    .status{
      color: rgba(231,236,255,.70);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .btnSmall{
      border:1px solid var(--btnB);
      background: var(--btnA);
      color: rgba(231,236,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight:1000;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .content{padding: 16px 18px 18px;}
    .sectionLabel{
      color: rgba(231,236,255,.70);
      font-size:12px;
      font-weight:1000;
      margin-bottom:4px;
    }
    .selected{
      font-size:22px;
      font-weight:1000;
      margin:0 0 4px;
    }
    .range{
      font-size:13px;
      color: rgba(231,236,255,.70);
      font-weight:900;
      margin:0 0 14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 760px){
      .grid{grid-template-columns: 1fr 1fr 1fr 1fr;}
    }
    .btn{
      border:1px solid rgba(79,140,255,.20);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.12));
      border-radius: 18px;
      padding: 16px 14px;
      font-size:16px;
      font-weight:1000;
      color: rgba(231,236,255,.96);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      min-height:58px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      line-height:1.15;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      box-shadow:none;
      opacity:.65;
    }
    .hint{
      margin-top:14px;
      color: rgba(231,236,255,.55);
      font-size:12px;
      font-weight:900;
      line-height:1.35;
    }
    .err{
      margin-top:14px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(239,68,68,.14);
      border:1px solid rgba(239,68,68,.35);
      color: #ffd3d3;
      font-size:14px;
      font-weight:1000;
      display:none;
      white-space:pre-wrap;
      line-height:1.4;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <div class="header">
        <div class="hLeft">
          <h1 class="title">TOPIK II</h1>
          <p class="sub" id="subtitle">먼저 영역(버튼)을 고르고, 그 다음 레벨(1~10)을 고릅니다.</p>
        </div>
        <div class="hRight">
          <div class="status" id="statusText">로드 중…</div>
          <button class="btnSmall" id="btnReset" type="button">영역 다시 선택</button>
        </div>
      </div>

      <div class="content">
        <div class="sectionLabel" id="sectionLabel">선택됨</div>
        <div class="selected" id="selectedText">-</div>
        <div class="range" id="rangeText">레벨 1~10</div>

        <div class="grid" id="grid"></div>

        <div class="hint">
          • 버튼을 누르면 flashcards로 이동합니다.<br/>
          • name/klass/token/lang 파라미터는 그대로 전달됩니다.
        </div>

        <div class="err" id="err"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const qs = new URLSearchParams(location.search);
  const cat = (qs.get("cat") || "vocab").toLowerCase(); // vocab | grammar | writing
  const levelParam = qs.get("level"); // 있을 수도 있고 없을 수도 있음(기존 정상 흐름: 있으면 redirect)
  const name = qs.get("name") || "";
  const klass = qs.get("klass") || "";
  const token = qs.get("token") || "";
  const lang = qs.get("lang") || "ko";

  function getRepoBase(){
    const p = location.pathname || "/";
    const m = p.match(/^(.*?\/korean-quiz)(\/|$)/);
    return m ? m[1] : "";
  }
  const REPO_BASE = getRepoBase();

  const $ = (id) => document.getElementById(id);

  function showError(msg){
    $("err").style.display = "block";
    $("err").textContent = msg;
    $("statusText").textContent = "오류";
  }

  // /data/... → https://.../korean-quiz/data/...
  function abs(path){
    return location.origin + (REPO_BASE || "") + path;
  }

  function goIndex(){
    const u = new URL(location.origin + (REPO_BASE || "") + "/topik2/index.html");
    if (name) u.searchParams.set("name", name);
    if (klass) u.searchParams.set("klass", klass);
    if (token) u.searchParams.set("token", token);
    if (lang) u.searchParams.set("lang", lang);
    location.href = u.toString();
  }

  function goFlashcardsWithFilePath(filePath){
    const u = new URL(location.origin + (REPO_BASE || "") + "/topik2/flashcards.html");
    // flashcards 기존 정책(이미 운영 중): file은 "절대URL"로 전달
    u.searchParams.set("file", abs(filePath));
    if (name) u.searchParams.set("name", name);
    if (klass) u.searchParams.set("klass", klass);
    if (token) u.searchParams.set("token", token);
    if (lang) u.searchParams.set("lang", lang);
    location.replace(u.toString()); // 뒤로 눌렀을 때 레벨화면으로 자연스럽게
  }

  $("btnReset").addEventListener("click", goIndex);

  // ---- 레벨 매핑(1~10) ----
  // vocab: 1~9까지 운영/추가, 10은 placeholder
  const vocabLevels = [
    "/data/topik2/vocab/level01_attitude.json",
    "/data/topik2/vocab/level02_connectors.json",
    "/data/topik2/vocab/level03_causative_passive.json",
    "/data/topik2/vocab/level04_emotions.json",
    "/data/topik2/vocab/level05_idioms1.json",
    "/data/topik2/vocab/level06_idioms2.json",
    "/data/topik2/vocab/level07_news_vocab1.json",
    "/data/topik2/vocab/level08_key_vocab1.json",
    "/data/topik2/vocab/level09_key_vocab2.json",
    "" // level10 placeholder
  ];

  // grammar: 현재 1~2만 운영(나머지 placeholder)
  const grammarLevels = [
    "/data/topik2/grammar/level01_connective_endings1.json",
    "/data/topik2/grammar/level02_final_endings1.json",
    "", "", "", "", "", "", "", ""
  ];

  // writing(53): 현재 레벨1만 운영
  const writingLevels = [
    "/data/topik2/writing53/level01_intro_list.json",
    "", "", "", "", "", "", "", "", ""
  ];

  // ✅ 핵심: level 파라미터가 있으면 “자동 redirect” (기존 정상 흐름 복구)
  const levelNum = levelParam ? parseInt(levelParam, 10) : NaN;
  if (!Number.isNaN(levelNum) && levelNum >= 1 && levelNum <= 10) {
    const table = (cat === "vocab") ? vocabLevels : (cat === "grammar") ? grammarLevels : (cat === "writing") ? writingLevels : null;
    if (!table) {
      showError("cat 파라미터가 올바르지 않습니다. (vocab 또는 grammar 또는 writing)\n현재: " + cat);
      return;
    }
    const filePath = table[levelNum - 1];
    if (!filePath) {
      showError("아직 준비되지 않은 레벨입니다.\ncat=" + cat + " level=" + levelNum);
      return;
    }
    goFlashcardsWithFilePath(filePath);
    return;
  }

  // ---- level 파라미터가 없으면: 버튼 화면 보여주기 ----
  function setHeader(){
    const isV = cat === "vocab";
    const isG = cat === "grammar";
    const isW = cat === "writing";
    $("selectedText").textContent = isV ? "어휘" : (isG ? "문법" : (isW ? "쓰기" : "-"));
    $("rangeText").textContent = "레벨 1~10";
    $("statusText").textContent = "로드 완료";
  }

  function renderButtons(levels, firstLabelOverride){
    const grid = $("grid");
    grid.innerHTML = "";
    for (let i = 0; i < 10; i++){
      const filePath = levels[i];
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn";

      // 표시 텍스트
      if (i === 0 && firstLabelOverride) btn.textContent = firstLabelOverride;
      else btn.textContent = "Level " + (i + 1);

      if (!filePath){
        btn.classList.add("secondary");
        btn.disabled = true;
      } else {
        btn.addEventListener("click", () => {
          // 버튼 클릭 시에도 “자동 흐름과 동일하게” level 파라미터를 붙여 이동 (일관성)
          const u = new URL(location.origin + (REPO_BASE || "") + "/topik2/level.html");
          u.searchParams.set("cat", cat);
          u.searchParams.set("level", String(i + 1));
          if (name) u.searchParams.set("name", name);
          if (klass) u.searchParams.set("klass", klass);
          if (token) u.searchParams.set("token", token);
          if (lang) u.searchParams.set("lang", lang);
          location.href = u.toString();
        });
      }

      grid.appendChild(btn);
    }
  }

  setHeader();

  if (cat === "vocab"){
    renderButtons(vocabLevels);
    return;
  }
  if (cat === "grammar"){
    renderButtons(grammarLevels);
    return;
  }
  if (cat === "writing"){
    renderButtons(writingLevels, "도입·나열");
    return;
  }

  showError("cat 파라미터가 올바르지 않습니다. (vocab 또는 grammar 또는 writing)\n현재: " + cat);
})();
</script>
</body>
</html>
