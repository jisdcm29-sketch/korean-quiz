<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TOPIK II</title>
  <style>
    :root{
      --bg:#0b1220;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--line:#243044;
      --accent:#60a5fa;
    }
    *{box-sizing:border-box}
    html,body{overflow-x:hidden}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif;
      background:linear-gradient(180deg,#050814,var(--bg));
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .topbar{
      position:sticky;top:0;z-index:50;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;
      background:rgba(5,8,20,.78);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
    .right{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .btn{
      padding:12px 14px;border-radius:14px;border:1px solid var(--line);
      background:#0b1020;color:var(--text);cursor:pointer;display:inline-block;
      -webkit-tap-highlight-color:transparent;
    }
    .btn:hover{border-color:rgba(96,165,250,.6)}
    .container{max-width:980px;margin:0 auto;padding:14px}
    .card{
      background:rgba(17,24,39,.9);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .muted{color:var(--muted);line-height:1.6}
    .small{font-size:12px}
    .bar{height:1px;background:var(--line);margin:12px 0}

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:12px;
    }
    .tile{
      display:block;
      padding:18px 16px;
      border-radius:18px;
      border:1px solid var(--line);
      background:#0b1020;
      -webkit-tap-highlight-color: transparent;
    }
    .tile:hover{border-color:rgba(96,165,250,.6)}
    .tileTitle{font-size:18px;font-weight:900;line-height:1.15}
    .tileDesc{font-size:13px;line-height:1.25;margin-top:6px;color:var(--muted)}

    .levels{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
      margin-top:12px;
    }
    .lvlBtn{
      padding:14px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#0b1020;
      color:var(--text);
      cursor:pointer;
      text-align:center;
      font-weight:800;
      -webkit-tap-highlight-color:transparent;
      white-space:normal;
      overflow-wrap:anywhere;
    }
    .lvlBtn:hover{border-color:rgba(96,165,250,.6)}

    @media(min-width:860px){
      .container{padding:16px}
      .card{padding:16px}
      .grid{grid-template-columns:repeat(2,1fr)}
      .levels{grid-template-columns:repeat(5,1fr)}
    }
    @media(max-width:520px){
      .container{padding:12px}
      .card{padding:12px}
      .tile{padding:16px 14px}
      .tileTitle{font-size:18px}
      .lvlBtn{padding:14px 10px}
    }

    .err{
      border:1px solid rgba(248,113,113,.35);
      background:rgba(248,113,113,.06);
      padding:12px;border-radius:14px;
      margin-top:12px;
    }
    .hidden{display:none !important;}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="dot"></span>
      <a id="homeLink" href="../index.html">Korean Quiz</a>
    </div>
    <div class="right">
      <button class="btn" id="btnBack" type="button">←</button>
      <button class="btn" id="btnLang" type="button">KR</button>
      <a class="btn" id="btnDash" href="../index.html">대시보드</a>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-end">
        <div>
          <h1 style="margin:0 0 6px;" id="title">TOPIK II</h1>
          <div class="muted" id="subtitle">먼저 영역(버튼)을 고르고, 그 다음 레벨(1~10)을 고릅니다.</div>
        </div>
        <div class="muted small" id="status"></div>
      </div>

      <div class="bar"></div>

      <div id="catWrap">
        <div class="grid" id="catGrid"></div>
      </div>

      <div id="levelWrap" class="hidden">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
          <div>
            <div class="muted small" id="pickedLabel">선택됨</div>
            <div style="font-weight:900;font-size:18px;margin-top:4px" id="pickedTitle">-</div>
          </div>
          <button class="btn" id="btnReset" type="button">영역 다시 선택</button>
        </div>
        <div class="levels" id="levelGrid"></div>
      </div>

      <div id="errBox" class="err hidden"></div>
    </section>
  </main>

  <script>
    const I18N = {
      KR: {
        dashboard:"대시보드",
        title:"TOPIK II",
        subtitle:"먼저 영역(버튼)을 고르고, 그 다음 레벨(1~10)을 고릅니다.",
        picked:"선택됨",
        reset:"영역 다시 선택",
        loading:"불러오는 중...",
        loaded:"로드 완료",
        errManifest:"manifest.json을 불러오지 못했습니다."
      },
      MN: {
        dashboard:"Самбар",
        title:"TOPIK II",
        subtitle:"Эхлээд хэсэг (товч) сонгоод, дараа нь Level (1~10) сонгоно.",
        picked:"Сонгосон",
        reset:"Хэсэг дахин сонгох",
        loading:"Ачаалж байна...",
        loaded:"Ачааллаа",
        errManifest:"manifest.json уншиж чадсангүй."
      }
    };

    function getLang(){
      const u = new URL(location.href);
      const q = (u.searchParams.get("lang")||"").toUpperCase();
      const s = (localStorage.getItem("kq_lang")||localStorage.getItem("lang")||"").toUpperCase();
      const pick = (q==="MN"||q==="KR") ? q : s;
      return (pick==="MN") ? "MN" : "KR";
    }
    function setLang(l){
      localStorage.setItem("kq_lang", l);
      localStorage.setItem("lang", l);
    }
    function tr(k){
      const L = getLang();
      return (I18N[L] && I18N[L][k]) ? I18N[L][k] : (I18N.KR[k] || k);
    }

    function passthroughQS(){
      const u = new URL(location.href);
      const p = new URLSearchParams();
      ["name","klass","token","lang"].forEach(k=>{
        const v = u.searchParams.get(k);
        if(v) p.set(k, v);
      });
      if(!p.get("lang")) p.set("lang", getLang());
      return p.toString();
    }
    function withQS(url){
      const qs = passthroughQS();
      return url + (url.includes("?") ? "&" : "?") + qs;
    }

    const btnLang = document.getElementById("btnLang");
    const btnBack = document.getElementById("btnBack");
    const btnDash = document.getElementById("btnDash");
    const homeLink = document.getElementById("homeLink");
    const statusEl = document.getElementById("status");
    const errBox = document.getElementById("errBox");

    const catWrap = document.getElementById("catWrap");
    const catGrid = document.getElementById("catGrid");
    const levelWrap = document.getElementById("levelWrap");
    const levelGrid = document.getElementById("levelGrid");
    const pickedLabel = document.getElementById("pickedLabel");
    const pickedTitle = document.getElementById("pickedTitle");
    const btnReset = document.getElementById("btnReset");

    let MANIFEST = null;
    let PICKED_CAT = null;

    function applyTexts(){
      document.documentElement.lang = (getLang()==="MN") ? "mn" : "ko";
      document.getElementById("title").textContent = tr("title");
      document.getElementById("subtitle").textContent = tr("subtitle");
      pickedLabel.textContent = tr("picked");
      btnReset.textContent = tr("reset");
      btnDash.textContent = tr("dashboard");
      btnLang.textContent = getLang();

      const qs = passthroughQS();
      homeLink.href = "../index.html" + (qs ? "?" + qs : "");
      btnDash.href = "../index.html" + (qs ? "?" + qs : "");
    }

    function showErr(msg){
      errBox.textContent = msg;
      errBox.classList.remove("hidden");
    }
    function clearErr(){
      errBox.classList.add("hidden");
      errBox.textContent = "";
    }

    function renderCategories(){
      catGrid.innerHTML = "";
      if(!MANIFEST || !Array.isArray(MANIFEST.categories)) return;

      MANIFEST.categories.forEach(cat=>{
        const a = document.createElement("a");
        a.className = "tile";
        a.href = "javascript:void(0)";
        a.innerHTML = `
          <div class="tileTitle">${cat.title || cat.id || "-"}</div>
          <div class="tileDesc">${cat.subtitle || ""}</div>
        `;
        a.addEventListener("click", ()=>{
          PICKED_CAT = cat;
          renderLevels();
        });
        catGrid.appendChild(a);
      });
    }

    function renderLevels(){
      if(!PICKED_CAT) return;

      pickedTitle.textContent = PICKED_CAT.title || PICKED_CAT.id || "-";
      levelGrid.innerHTML = "";

      const levels = Array.isArray(PICKED_CAT.levels) ? PICKED_CAT.levels : [];
      levels.forEach(lv=>{
        const b = document.createElement("button");
        b.type = "button";
        b.className = "lvlBtn";
        b.textContent = lv;

        b.addEventListener("click", ()=>{
          const u = new URL("./level.html", location.href);
          u.searchParams.set("cat", PICKED_CAT.id || "");
          u.searchParams.set("level", lv);
          u.searchParams.set("manifest", "../data/topik2/manifest.json");
          const qs = passthroughQS();
          if(qs){
            const p = new URLSearchParams(qs);
            p.forEach((v,k)=>u.searchParams.set(k,v));
          }
          location.href = u.toString();
        });

        levelGrid.appendChild(b);
      });

      catWrap.classList.add("hidden");
      levelWrap.classList.remove("hidden");
    }

    btnReset.addEventListener("click", ()=>{
      PICKED_CAT = null;
      levelWrap.classList.add("hidden");
      catWrap.classList.remove("hidden");
    });

    btnBack.addEventListener("click", ()=>{
      if(history.length > 1) history.back();
      else location.href = withQS("../index.html");
    });

    btnLang.addEventListener("click", ()=>{
      const next = (getLang()==="KR") ? "MN" : "KR";
      setLang(next);
      applyTexts();
      if(PICKED_CAT) renderLevels();
    });

    async function loadManifest(){
      clearErr();
      applyTexts();
      statusEl.textContent = tr("loading");

      try{
        const url = new URL("../data/topik2/manifest.json", location.href).toString();
        const res = await fetch(url, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        MANIFEST = await res.json();

        statusEl.textContent = tr("loaded");
        renderCategories();
      }catch(e){
        statusEl.textContent = "오류";
        showErr(tr("errManifest") + " (" + (e.message || e) + ")");
      }
    }

    loadManifest();
  </script>
</body>
</html>
