# K-Quiz Logger · 구글 앱스 스크립트 배포 가이드 (한글)

학생이 퀴즈를 제출해도 **텔레그램 알림이 오지 않는** 경우, 거의 항상 **배포 시 "실행 사용자" 설정**이 잘못된 때문입니다. 아래 순서대로 확인하세요.

---

## 1. 왜 학생 접속 시에는 알림이 안 올까?

- **선생님이 직접 테스트할 때**: 스크립트가 **선생님 계정으로** 실행됩니다. 그래서 스크립트 속성에 저장한 `TELEGRAM_TOKEN`, `TELEGRAM_CHAT_ID`를 읽을 수 있고, 텔레그램 전송이 됩니다.
- **학생이 접속할 때**: 배포가 **"앱에 접속한 사용자"** 로 되어 있으면, 스크립트가 **학생 계정으로** 실행됩니다. 이 경우 선생님 프로젝트의 스크립트 속성을 읽지 못하거나 접근이 제한될 수 있어, 텔레그램 설정이 비어 있고 알림이 가지 않습니다.

**해결**: 배포 시 **"실행 사용자: 나"** 로 설정하면, 학생이 링크를 열어도 스크립트는 **항상 선생님(나) 계정으로** 실행됩니다. 그래서 스크립트 속성과 스프레드시트 접근이 정상적으로 되고, 텔레그램 알림도 갑니다.

---

## 2. 배포(Deploy) 설정 방법 — 단계별

### 2-1. 스크립트가 들어 있는 구글 시트 열기

- K-Quiz 기록용으로 사용하는 **구글 스프레드시트**를 엽니다.
- 상단 메뉴에서 **확장 프로그램** → **Apps Script** 를 클릭해 스크립트 편집기를 엽니다.

### 2-2. 배포할 버전 준비

1. 스크립트 편집기에서 **K-Quiz-Logger.gs** 등 필요한 코드가 모두 저장되어 있는지 확인합니다.
2. 상단 **배포** → **새 배포** 를 클릭합니다.  
   (이미 배포가 있다면 **배포** → **배포 관리** 로 들어가서 **편집** 또는 **새 배포**를 선택합니다.)

### 2-3. 배포 유형 선택

1. **새 배포** 창에서 **유형 선택** 옆의 **선택** 버튼을 클릭합니다.
2. **웹 앱** 을 선택합니다.

### 2-4. ★ 중요: "실행 사용자" 반드시 "나"로

배포 설정 화면에서 아래 두 가지를 꼭 확인합니다.

| 설정 항목 | 선택할 값 | 설명 |
|-----------|------------|------|
| **실행 사용자** | **나** (또는 "나 (본인 이메일)") | 학생이 접속해도 스크립트가 **선생님 계정**으로 실행됩니다. 스크립트 속성·시트·텔레그램 전송이 정상 동작합니다. |
| **액세스 권한** | **모든 사용자** 또는 **Google 계정이 있는 모든 사용자** | 링크를 가진 **누구나** (또는 구글 로그인한 사용자만) 호출할 수 있게 합니다. 학생은 로그인하지 않아도 되게 하려면 "모든 사용자"를 선택합니다. |

- **실행 사용자**가 **"앱에 접속한 사용자"** 로 되어 있으면 학생 접속 시 텔레그램이 안 오는 경우가 대부분이므로, 반드시 **"나"** 로 바꿉니다.
- 변경 후 **배포** 또는 **버전 저장** 버튼을 눌러 저장합니다.

### 2-5. 권한 승인(최초 1회)

- **실행 사용자: 나** 로 처음 배포하면, **권한 승인** 창이 뜰 수 있습니다.
1. **권한 검토** → 본인(선생님) 구글 계정 선택 → **허용** 으로 진행합니다.
2. "이 앱이 확인되지 않음"이 나오면 **고급** → **(프로젝트 이름)(으)로 이동** → **허용** 을 선택하면 됩니다.  
   (본인이 만든 스크립트이므로 안전합니다.)

### 2-6. 웹 앱 URL 확인

- 배포가 완료되면 **웹 앱 URL** 이 나옵니다.  
  예: `https://script.google.com/macros/s/AKfy.../exec`
- 퀴즈 앱(학생이 쓰는 페이지)에서 **이 URL** 로 `action=issue`, `action=validate`, `action=log` 를 호출하도록 설정되어 있어야 합니다.
- **테스트용 URL** (`/dev`) 이 아니라 **배포된 URL** (`/exec`) 을 사용해야 합니다. 학생에게 배포된 `/exec` URL 을 쓰는 쪽으로 연결해 주세요.

---

## 3. 스크립트 속성 확인(텔레그램이 안 올 때)

배포를 "실행 사용자: 나" 로 했는데도 알림이 안 오면, 아래를 확인합니다.

1. 스크립트 편집기 왼쪽 **프로젝트 설정** (톱니바퀴) → **스크립트 속성**.
2. 다음이 들어 있는지 확인합니다.
   - `MASTER_PASSWORD` : 선생님 비밀번호
   - `TELEGRAM_TOKEN` : 봇 토큰 (예: `123456:ABC-DEF...`)
   - `TELEGRAM_CHAT_ID` : 채팅 ID (예: `-1001234567890`)

값이 비어 있거나 잘못되었으면 텔레그램이 가지 않습니다. 수정 후 **배포를 다시 저장**할 필요는 없고, 스크립트 속성만 바꿔도 다음 호출부터 적용됩니다.

---

## 4. 시트로 실패 원인 확인하기

스크립트는 텔레그램 전송 시도 결과를 항상 시트에 남깁니다.

- **TELEGRAM_LOG** 시트: 전송 성공/실패 모두 기록.  
  - `tgOk` = FALSE 이고 `tgHttp` = `NO_CONFIG` 이면 → 스크립트 속성이 비어 있거나, 실행 사용자가 "나"가 아닐 가능성이 큽니다.
- **TELEGRAM_FAIL** 시트: 실패한 건만 모아 둔 탭.  
  - 여기에 학생 제출 건이 쌓인다면, 해당 행의 `tgHttp`, `tgBody` 를 보면 원인(토큰 오류, 채팅 ID 오류 등)을 알 수 있습니다.

학생이 제출한 뒤 위 시트를 보면서 `NO_CONFIG` / 401 / 400 등이 나오는지 확인하면 됩니다.

---

## 5. 요약 체크리스트

- [ ] 배포 유형: **웹 앱**
- [ ] **실행 사용자: 나** (절대 "앱에 접속한 사용자" 가 아님)
- [ ] 액세스: **모든 사용자** 또는 **Google 계정이 있는 모든 사용자** (필요에 따라)
- [ ] 스크립트 속성에 `MASTER_PASSWORD`, `TELEGRAM_TOKEN`, `TELEGRAM_CHAT_ID` 입력됨
- [ ] 퀴즈 앱에서 호출하는 URL 이 **배포된 URL** (`/exec`) 임
- [ ] 텔레그램이 안 올 때는 **TELEGRAM_LOG**, **TELEGRAM_FAIL** 시트로 원인 확인

이렇게 설정하면 학생이 접속해도 선생님 텔레그램으로 알림이 갑니다.
